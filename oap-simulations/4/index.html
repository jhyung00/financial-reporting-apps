<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module 4: Credit Analysis Simulation</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom Scrollbar for financial statements */
        .scroller::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .scroller::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .scroller::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .scroller::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        /* Disable number input spinner */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        /* Disable selection in some areas to discourage copying */
        .no-select {
            user-select: none;
            -webkit-user-select: none;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex flex-col overflow-hidden font-sans" oncontextmenu="return false;">

    <div id="root" class="h-full flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // ==========================================
        // UTILITIES
        // ==========================================
        
        // Base64 Decoder for Obfuscation
        const d = (str) => {
            try {
                return atob(str);
            } catch (e) {
                return "";
            }
        };

        // ==========================================
        // DATASETS (UPDATED WITH USER DATA)
        // ==========================================
        const DATA_SETS = {
            ITW: {
                name: "Illinois Tool Works (ITW)",
                currency: "$ Millions",
                CASE_DATA: {
                    supp: {
                        title: "Supplemental Data (ITW)",
                        headers: ["Item", "2022 Value"],
                        rows: [
                            ["Funds From Operations (FFO)", "3,357"],
                            ["Market Capitalization", "67,191.5"]
                        ]
                    },
                    bs: {
                        title: "Balance Sheet (ITW)",
                        headers: ["Item", "Dec 31, 2022", "Dec 31, 2021"],
                        rows: [
                            ["Current Assets", "", ""],
                            ["Cash and equivalents", "708", "1,527"],
                            ["Trade receivables", "3,171", "2,840"],
                            ["Inventories", "2,054", "1,694"],
                            ["Prepaid expenses and other", "329", "313"],
                            ["Assets held for sale", "8", "0"],
                            ["Total Current Assets", "6,270", "6,374"],
                            ["Net plant and equipment", "1,848", "1,809"],
                            ["Goodwill", "4,864", "4,965"],
                            ["Intangible assets", "768", "972"],
                            ["Deferred income taxes", "494", "552"],
                            ["Other assets", "1,178", "1,405"],
                            ["Total Assets", "15,422", "16,077"],
                            ["Current Liabilities", "", ""],
                            ["Short-term debt", "1,590", "778"],
                            ["Accounts payable", "594", "585"],
                            ["Current lease liabilities", "55", "61"],
                            ["Accrued expenses", "1,673", "1,587"],
                            ["Cash dividends payable", "400", "382"],
                            ["Income taxes payable", "147", "77"],
                            ["Liabilities held for sale", "1", "0"],
                            ["Total Current Liabilities", "4,460", "3,470"],
                            ["Long-term debt", "6,173", "6,909"],
                            ["Deferred income taxes", "484", "654"],
                            ["Noncurrent income taxes payable", "273", "365"],
                            ["Long-term lease liabilities", "131", "133"],
                            ["Other liabilities", "812", "920"],
                            ["Total Liabilities", "12,333", "12,451"],
                            ["Shareholders' Equity", "", ""],
                            ["Common stock", "6", "6"],
                            ["Additional paid-in-capital", "1,501", "1,432"],
                            ["Retained earnings", "25,799", "24,325"],
                            ["Common stock held in treasury", "(22,377)", "(20,636)"],
                            ["Accumulated other comp. income", "(1,841)", "(1,502)"],
                            ["Noncontrolling interest", "1", "1"],
                            ["Total Equity", "3,089", "3,626"]
                        ]
                    },
                    is: {
                        title: "Income Statement (ITW)",
                        headers: ["Item", "2022", "2021"],
                        rows: [
                            ["Operating revenue", "15,932", "14,455"],
                            ["Cost of revenue", "9,429", "8,489"],
                            ["Gross profit", "6,503", "5,966"],
                            ["SG&A and R&D expenses", "2,579", "2,356"],
                            ["Amortization/impairment", "134", "133"],
                            ["Operating Income", "3,790", "3,477"],
                            ["Interest expense", "203", "202"],
                            ["Other (income) expense", "(255)", "(51)"],
                            ["Income Before Taxes", "3,842", "3,326"],
                            ["Income taxes", "808", "632"],
                            ["Net Income", "3,034", "2,694"]
                        ]
                    },
                    scf: {
                        title: "Cash Flow Statement (ITW)",
                        headers: ["Item", "2022", "2021"],
                        rows: [
                            ["Net income", "3,034", "2,694"],
                            ["Depreciation", "276", "277"],
                            ["Amortization and impairment", "134", "133"],
                            ["Deferred income taxes", "(150)", "(148)"],
                            ["Other non-cash adjustments", "-123", "-13"],
                            ["Changes in working capital", "-823", "-386"],
                            ["Net cash from operating activities", "2,348", "2,557"],
                            ["Acquisition of businesses", "(2)", "(731)"],
                            ["Additions to plant and equipment", "(412)", "(296)"],
                            ["Proceeds from investments/sales", "304", "43"],
                            ["Net cash used for investing activities", "(110)", "(984)"],
                            ["Cash dividends paid", "(1,542)", "(1,463)"],
                            ["Repurchases of common stock", "(1,750)", "(1,000)"],
                            ["Net debt proceeds (repayments)", "276", "(141)"],
                            ["Net cash used for financing activities", "(3,000)", "(2,564)"],
                            ["Effect of Exchange Rate Changes", "(57)", "(46)"],
                            ["Net Increase (Decrease) in Cash", "(819)", "(1,037)"],
                            ["Cash at End of Year", "708", "1,527"]
                        ]
                    }
                }
            },
            PH: {
                name: "Parker-Hannifin (PH)",
                currency: "$ Thousands",
                CASE_DATA: {
                    supp: {
                        title: "Supplemental Data (PH)",
                        headers: ["Item", "2022 Value"],
                        rows: [
                            ["Funds From Operations (FFO)", "2,024,893"],
                            ["Market Capitalization", "31,605,411"]
                        ]
                    },
                    bs: {
                        title: "Balance Sheet (PH)",
                        headers: ["Item", "Jun 30, 2022", "Jun 30, 2021"],
                        rows: [
                            ["Current Assets", "", ""],
                            ["Cash and cash equivalents", "535,799", "733,117"],
                            ["Marketable securities", "27,862", "39,116"],
                            ["Trade accounts receivable, net", "2,341,504", "2,183,594"],
                            ["Non-trade and notes receivable", "543,757", "326,315"],
                            ["Inventories", "2,214,553", "2,090,642"],
                            ["Prepaid expenses and other", "6,383,169", "243,966"],
                            ["Total Current Assets", "12,046,644", "5,616,750"],
                            ["Property, plant and equipment, net", "2,122,758", "2,266,476"],
                            ["Goodwill", "7,740,082", "8,059,687"],
                            ["Intangible assets, net", "3,135,817", "3,519,797"],
                            ["Deferred income taxes", "110,585", "104,251"],
                            ["Investments and other assets", "788,057", "774,239"],
                            ["Total Assets", "25,943,943", "20,341,200"],
                            ["Current Liabilities", "", ""],
                            ["Notes/debt payable within one year", "1,724,310", "2,824"],
                            ["Accounts payable, trade", "1,731,925", "1,667,878"],
                            ["Accrued payrolls", "470,132", "507,027"],
                            ["Accrued taxes", "250,292", "236,384"],
                            ["Current operating lease liabilities", "36,023", "40,193"],
                            ["Other accrued liabilities", "1,646,636", "642,197"],
                            ["Total Current Liabilities", "5,859,318", "3,096,503"],
                            ["Long-term debt", "9,755,825", "6,582,053"],
                            ["Pensions/postretirement", "639,939", "1,055,638"],
                            ["Deferred income taxes", "307,044", "553,981"],
                            ["Long-term operating lease liabilities", "100,337", "93,904"],
                            ["Other liabilities", "421,560", "545,451"],
                            ["Total Liabilities", "17,084,023", "11,927,530"],
                            ["Shareholders' Equity", "", ""],
                            ["Common stock & Capital", "417,830", "420,142"],
                            ["Retained earnings", "15,661,808", "14,915,497"],
                            ["Accumulated other comp. loss", "(1,543,198)", "(1,566,727)"],
                            ["Treasury stock", "(5,688,429)", "(5,370,605)"],
                            ["Noncontrolling interests", "11,909", "15,363"],
                            ["Total Equity", "8,859,920", "8,413,670"]
                        ]
                    },
                    is: {
                        title: "Income Statement (PH)",
                        headers: ["Item", "2022", "2021"],
                        rows: [
                            ["Net Sales", "15,861,608", "14,347,640"],
                            ["Cost of sales", "11,387,267", "10,449,680"],
                            ["Gross profit", "4,474,341", "3,897,960"],
                            ["SG&A expenses", "1,627,116", "1,527,302"],
                            ["Gain on disposal of assets", "(7,121)", "(109,332)"],
                            ["Operating income", "2,854,346", "2,479,990"],
                            ["Interest expense", "255,252", "250,036"],
                            ["Loss on forward contracts", "1,015,426", "0"],
                            ["Other expense (income), net", "(30,558)", "(17,003)"],
                            ["Income before income taxes", "1,614,226", "2,246,957"],
                            ["Income taxes", "298,040", "500,096"],
                            ["Net Income", "1,316,186", "1,746,861"]
                        ]
                    },
                    scf: {
                        title: "Cash Flow Statement (PH)",
                        headers: ["Item", "2022", "2021"],
                        rows: [
                            ["Net Income", "1,316,186", "1,746,861"],
                            ["Depreciation", "257,314", "269,943"],
                            ["Amortization", "314,450", "325,447"],
                            ["Deferred income taxes", "(351,201)", "(51,500)"],
                            ["Other non-cash items", "167,951", "111,771"],
                            ["Changes in working capital", "737,030", "172,480"],
                            ["Net cash provided by operating activities", "2,441,730", "2,575,001"],
                            ["Capital expenditures", "(230,044)", "(209,957)"],
                            ["Other investing activities", "(188,793)", "209,944"],
                            ["Net cash used in investing activities", "(418,837)", "(13)"],
                            ["Dividends paid", "(569,855)", "(475,174)"],
                            ["Net financing activities", "4,485,491", "(2,148,165)"],
                            ["Effect of exchange rate changes", "(23,770)", "95,954"],
                            ["Net increase (decrease) in cash", "5,914,759", "47,603"],
                            ["Cash at end of year", "6,647,876", "733,117"]
                        ]
                    }
                }
            }
        };

        // ==========================================
        // ANSWER KEY LOGIC (OBFUSCATED)
        // ==========================================
        // The values below are Base64 encoded to prevent easy viewing in source code.
        const _DATA_MATRIX = {
            PH: {
                'liab_equity_2022': "MS45Mjg=", 'liab_equity_2021': "MS40MTg=",
                'debt_equity_2022': "MS4zMTE=", 'debt_equity_2021': "MC43OTk=",
                'tie_2022': "MTEuMTg=", 'tie_2021': "OS45Mg==",
                'ebitda_val_2022': "MzQyNjExMA==", 'ebitda_val_2021': "MzA3NTM4MA==",
                'ebitda_cov_2022': "MTMuNDI=", 'ebitda_cov_2021': "MTIuMzA=",
                'cfo_debt_2022': "MC4yMTA=", 'cfo_debt_2021': "MC4zODM=",
                'focf_debt_2022': "MC4xOTA=", 'focf_debt_2021': "MC4zNTI=",
                'current_ratio_2022': "Mi4wNg==", 'current_ratio_2021': "MS44MQ==",
                'quick_ratio_2022': "MC41MA==", 'quick_ratio_2021': "MC45Ng==",
                'moody_debt_ebitda': "My4zOQ==", 'moody_debt_ebitda_rating': 'Ba',
                'ebita_val': "MzE2ODc5Ng==", 
                'moody_ebita_int': "MTIuNDE=", 'moody_ebita_int_rating': 'Baa',
                'moody_rev': "MTUuODY=", 'moody_rev_rating': 'Baa',
                'moody_ebita_marg': "MTkuOTg=", 'moody_ebita_marg_rating': 'A',
                'moody_op_marg': "MTguMDA=", 'moody_op_marg_rating': 'A',
                'moody_ffo_debt': "MTcuNDM=", 'moody_ffo_debt_rating': 'Ba',
                'moody_ffo_int_int': "OC45Mw==", 'moody_ffo_int_int_rating': 'Baa',
                'moody_ebita_assets': "MTMuNjk=", 'moody_ebita_assets_rating': 'Ba',
                'moody_capex_dep': "MC44OQ==", 'moody_capex_dep_rating': 'B',
                'z_wc_ta': "MC4yMzg1", 'z_re_ta': "MC42MDM3", 'z_ebit_ta': "MC4xMTAw",
                'z_mve_tl': "MS44NTAw", 'z_sales_ta': "MC42MTE0", 'z_score_total': "My4yMQ=="
            },
            ITW: {
                'liab_equity_2022': "My45OTM=", 'liab_equity_2021': "My40MzQ=",
                'debt_equity_2022': "Mi41NzM=", 'debt_equity_2021': "Mi4xNzM=",
                'tie_2022': "MTguNjc=", 'tie_2021': "MTcuMjE=",
                'ebitda_val_2022': "NDIwMA==", 'ebitda_val_2021': "Mzg4Nw==",
                'ebitda_cov_2022': "MjAuNjk=", 'ebitda_cov_2021': "MTkuMjQ=",
                'cfo_debt_2022': "MC4yOTU=", 'cfo_debt_2021': "MC4zMjQ=",
                'focf_debt_2022': "MC4yNDQ=", 'focf_debt_2021': "MC4yODc=",
                'current_ratio_2022': "MS40MQ==", 'current_ratio_2021': "MS44NA==",
                'quick_ratio_2022': "MC44Nw==", 'quick_ratio_2021': "MS4yNg==",
                'moody_debt_ebitda': "MS44OQ==", 'moody_debt_ebitda_rating': 'A',
                'ebita_val': "MzkyNA==",
                'moody_ebita_int': "MTkuMzM=", 'moody_ebita_int_rating': 'A',
                'moody_rev': "MTUuOTM=", 'moody_rev_rating': 'Baa',
                'moody_ebita_marg': "MjQuNjM=", 'moody_ebita_marg_rating': 'Aa',
                'moody_op_marg': "MjMuNzk=", 'moody_op_marg_rating': 'Aa',
                'moody_ffo_debt': "NDIuMjM=", 'moody_ffo_debt_rating': 'A',
                'moody_ffo_int_int': "MTcuNTQ=", 'moody_ffo_int_int_rating': 'A',
                'moody_ebita_assets': "MjQuOTI=", 'moody_ebita_assets_rating': 'Aa',
                'moody_capex_dep': "MS40OQ==", 'moody_capex_dep_rating': 'Aa',
                'z_wc_ta': "MC4xMTc0", 'z_re_ta': "MS42NzI5", 'z_ebit_ta': "MC4yNDU4",
                'z_mve_tl': "NS40NDgx", 'z_sales_ta': "MS4wMzMx", 'z_score_total': "Ny41OQ=="
            }
        };

        const MOODY_RATINGS = ["Aaa", "Aa", "A", "Baa", "Ba", "B", "Caa"];

        // ==========================================
        // COMPONENTS
        // ==========================================

        const InfoIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="inline text-blue-500 hover:text-blue-700 cursor-help"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>
        );

        // Updated SmartInput: Decodes correct value, Handles Percentages
        const SmartInput = ({ id, value, onChange, correctValueEnc, tolerance = 0.05, label, isPercent = false, activeId, setActiveId, showCorrectness = true }) => {
            const [isCorrect, setIsCorrect] = useState(null);
            
            // Decode correct value on fly
            const correctValue = useMemo(() => {
                if(!correctValueEnc) return undefined;
                return parseFloat(d(correctValueEnc));
            }, [correctValueEnc]);

            useEffect(() => {
                if(showCorrectness) checkCorrectness(value);
            }, [value, correctValue]); 

            const evaluateMath = (str) => {
                if (!str) return "";
                try {
                    // Pre-process percentages: "22%" -> "0.22"
                    // Regex matches number followed by %
                    let sanitized = str.replace(/[^0-9+\-*/()., %]/g, ''); 
                    
                    // Replace "XX%" with "(XX/100)" for correct eval
                    sanitized = sanitized.replace(/(\d+(\.\d+)?)%/g, '($1/100)');

                    if (!sanitized) return "";
                    
                    // Evaluate math
                    return Function('"use strict";return (' + sanitized + ')')();
                } catch (e) {
                    return str;
                }
            };

            const checkCorrectness = (val) => {
                if (!val || val === "" || correctValue === undefined || isNaN(correctValue)) {
                    setIsCorrect(null);
                    return;
                }
                const numVal = parseFloat(val);
                if (isNaN(numVal)) {
                    setIsCorrect(false);
                    return;
                }

                let valid = false;
                
                // Direct comparison
                if (Math.abs(numVal - correctValue) <= tolerance) valid = true;
                else if (Math.abs(numVal - correctValue) <= (correctValue * tolerance)) valid = true; // Relative tolerance

                // Percent handling (if user typed 20 for 20%)
                if (!valid && isPercent) {
                    if (Math.abs((numVal * 100) - correctValue) <= tolerance) valid = true;
                }

                setIsCorrect(valid);
            };

            const handleBlur = () => {
                const computed = evaluateMath(value);
                // If computed is a number with many decimals, round it slightly for display
                let displayVal = computed;
                if (typeof computed === 'number' && !Number.isInteger(computed)) {
                     displayVal = Math.round(computed * 10000) / 10000;
                }
                if (displayVal !== undefined && displayVal !== null) {
                     onChange(id, displayVal.toString());
                }
                setActiveId(null);
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') e.target.blur();
            };

            let borderColor = "border-slate-300";
            if (showCorrectness) {
                if (isCorrect === true) borderColor = "border-green-500 bg-green-50";
                else if (isCorrect === false) borderColor = "border-red-400 bg-red-50";
            }
            if (activeId === id) borderColor = "border-blue-500 ring-1 ring-blue-500";

            return (
                <div className="flex flex-col">
                    <div className="flex justify-between items-center mb-1">
                         <label className="text-xs font-medium text-slate-600 truncate mr-2" title={label}>{label}</label>
                         {showCorrectness && isCorrect === true && <span className="text-green-600 text-[10px]">✔</span>}
                    </div>
                    <input
                        type="text"
                        className={`w-full text-sm p-1.5 rounded border ${borderColor} focus:outline-none transition-colors text-right font-mono`}
                        value={value || ""}
                        onChange={(e) => onChange(id, e.target.value)}
                        onBlur={handleBlur}
                        onKeyDown={handleKeyDown}
                        onFocus={() => setActiveId(id)}
                        placeholder={isPercent ? "%" : "#"}
                    />
                </div>
            );
        };

        const RatingSelect = ({ id, value, onChange }) => {
             const [isCorrect, setIsCorrect] = useState(null);
             useEffect(() => { if(!value) { setIsCorrect(null); return; } setIsCorrect(true); }, [value]);

             return (
                 <select 
                    value={value || ""} 
                    onChange={(e) => onChange(id, e.target.value)}
                    className="w-full text-sm p-1.5 rounded border border-slate-300 focus:border-blue-500 bg-white"
                 >
                    <option value="">Select Rating</option>
                    {MOODY_RATINGS.map(r => <option key={r} value={r}>{r}</option>)}
                 </select>
             )
        }

        const SectionHeader = ({ title, isOpen, toggle }) => (
            <div 
                className="flex items-center justify-between bg-slate-100 p-2 cursor-pointer hover:bg-slate-200 border-b border-slate-200"
                onClick={toggle}
            >
                <h3 className="font-bold text-slate-700 text-sm uppercase tracking-wide">{title}</h3>
                <span className="text-slate-500 transform transition-transform duration-200" style={{ transform: isOpen ? 'rotate(180deg)' : 'rotate(0deg)' }}>
                    ▼
                </span>
            </div>
        );

        // ==========================================
        // MAIN APP
        // ==========================================
        const App = () => {
            const [company, setCompany] = useState("PH");
            const [inputs, setInputs] = useState({ PH: {}, ITW: {} });
            const [activeInputId, setActiveInputId] = useState(null);
            
            // Layout State
            const [sidebarWidth, setSidebarWidth] = useState(50); // percentage
            const isDraggingRef = useRef(false);

            // UI State
            const [sections, setSections] = useState({
                capStructure: true,
                coverage: true,
                liquidity: true,
                cashFlow: true,
                moody: true,
                zScore: true
            });
            const [teacherMode, setTeacherMode] = useState(false);
            const [showTeacherLogin, setShowTeacherLogin] = useState(false);
            const [password, setPassword] = useState("");
            const [showRefTable, setShowRefTable] = useState(false);

            // Modals State
            const [modal, setModal] = useState({ isOpen: false, type: null, studentName: "" });

            const workspaceRef = useRef(null);

            const toggleSection = (sec) => setSections(prev => ({...prev, [sec]: !prev[sec]}));

            const handleInputChange = (id, val) => {
                setInputs(prev => ({
                    ...prev,
                    [company]: { ...prev[company], [id]: val }
                }));
            };

            const handleDataClick = (valStr) => {
                if (!activeInputId) return;
                const cleanVal = valStr.replace(/,/g, '').replace(/\(/g, '-').replace(/\)/g, '');
                setInputs(prev => {
                    const currentVal = prev[company][activeInputId] || "";
                    return {
                        ...prev,
                        [company]: { ...prev[company], [activeInputId]: currentVal + cleanVal }
                    };
                });
            };

            // Sidebar Resizer Logic
            const startResize = (e) => {
                isDraggingRef.current = true;
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            };

            useEffect(() => {
                const handleMouseMove = (e) => {
                    if (!isDraggingRef.current) return;
                    const newWidth = (e.clientX / window.innerWidth) * 100;
                    if (newWidth > 20 && newWidth < 80) setSidebarWidth(newWidth);
                };
                const handleMouseUp = () => {
                    isDraggingRef.current = false;
                    document.body.style.cursor = 'default';
                    document.body.style.userSelect = 'auto';
                };
                window.addEventListener('mousemove', handleMouseMove);
                window.addEventListener('mouseup', handleMouseUp);
                return () => {
                    window.removeEventListener('mousemove', handleMouseMove);
                    window.removeEventListener('mouseup', handleMouseUp);
                };
            }, []);


            // Download & Clear Logic
            const requestDownload = () => setModal({ isOpen: true, type: 'download', studentName: "" });
            const requestClear = () => setModal({ isOpen: true, type: 'clear', studentName: "" });

            const handleConfirmDownload = () => {
                const name = modal.studentName.trim();
                if (!name) return;
                
                let content = `Student: ${name}\nDate: ${new Date().toLocaleString()}\nCompany: ${company}\n\n`;
                const currInputs = inputs[company];
                content += "--- INPUTS ---\n";
                Object.keys(currInputs).forEach(k => {
                    content += `${k}: ${currInputs[k]}\n`;
                });
                
                const blob = new Blob([content], { type: "text/plain" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `${name.replace(/ /g, '_')}_Module4_CreditAnalysis.txt`;
                a.click();
                setModal({ isOpen: false, type: null, studentName: "" });
            };

            const handleConfirmClear = () => {
                setInputs(prev => ({ ...prev, [company]: {} }));
                setModal({ isOpen: false, type: null, studentName: "" });
            };

            const closeModal = () => setModal({ isOpen: false, type: null, studentName: "" });

            const handleTeacherLogin = () => {
                // Hashed comparison (btoa("OAP4-Key3M") === "T0FQNC1LZXkzTQ==")
                if (btoa(password) === "T0FQNC1LZXkzTQ==") {
                    setTeacherMode(true);
                    setShowTeacherLogin(false);
                    setPassword("");
                } else {
                    setPassword("");
                }
            };

            const autoFill = () => {
                const key = _DATA_MATRIX[company];
                const newInputs = {};
                Object.keys(key).forEach(k => {
                    // Skip ratings, decode others
                    if (k.endsWith('_rating')) {
                        newInputs[k] = key[k];
                    } else {
                        newInputs[k] = d(key[k]);
                    }
                });
                setInputs(prev => ({ ...prev, [company]: newInputs }));
            };

            // Render Helpers
            const renderRow = (label, idPrefix, isPercent=false, hint="", showCorrectness=true) => (
                <div className="grid grid-cols-3 gap-2 mb-2 items-end border-b border-slate-100 pb-2">
                    <div className="col-span-1 text-sm text-slate-700 flex items-center">
                        {label}
                        {hint && <div className="ml-1 group relative">
                            <InfoIcon />
                            <div className="hidden group-hover:block absolute z-50 bottom-full left-0 w-48 bg-slate-800 text-white text-xs p-2 rounded shadow-lg pointer-events-none">
                                {hint}
                            </div>
                        </div>}
                    </div>
                    <SmartInput 
                        id={`${idPrefix}_2022`} 
                        label="2022" 
                        value={inputs[company][`${idPrefix}_2022`]} 
                        onChange={handleInputChange} 
                        correctValueEnc={_DATA_MATRIX[company][`${idPrefix}_2022`]} 
                        isPercent={isPercent}
                        activeId={activeInputId}
                        setActiveId={setActiveInputId}
                        showCorrectness={showCorrectness}
                    />
                    <SmartInput 
                        id={`${idPrefix}_2021`} 
                        label="2021" 
                        value={inputs[company][`${idPrefix}_2021`]} 
                        onChange={handleInputChange} 
                        correctValueEnc={_DATA_MATRIX[company][`${idPrefix}_2021`]} 
                        isPercent={isPercent}
                        activeId={activeInputId}
                        setActiveId={setActiveInputId}
                        showCorrectness={showCorrectness}
                    />
                </div>
            );

            // Special Renderer for Moody's (Single Year)
            const renderMoodyRow = (label, id, unit, hint) => (
                <div className="grid grid-cols-4 gap-2 mb-2 items-center border-b border-slate-100 pb-1">
                    <div className="col-span-2 text-sm text-slate-700 flex items-center">
                        {label}
                        <div className="ml-1 group relative"><InfoIcon />
                            <div className="hidden group-hover:block absolute z-50 left-0 bottom-full mb-1 w-64 bg-slate-800 text-white text-xs p-2 rounded shadow-lg pointer-events-none">{hint}</div>
                        </div>
                    </div>
                    <div className="col-span-1">
                        <SmartInput 
                            id={id} 
                            label={`Value (${unit})`} 
                            value={inputs[company][id]} 
                            onChange={handleInputChange} 
                            correctValueEnc={_DATA_MATRIX[company][id]} 
                            isPercent={unit==="%"}
                            activeId={activeInputId}
                            setActiveId={setActiveInputId}
                        />
                    </div>
                    <div className="col-span-1 pt-4">
                        <RatingSelect 
                            id={`${id}_rating`} 
                            value={inputs[company][`${id}_rating`]} 
                            onChange={handleInputChange} 
                        />
                    </div>
                </div>
            );

            // Special Renderer for Z-Score
            const renderZRow = (label, id, weight, hint) => (
                <div className="grid grid-cols-12 gap-2 mb-2 items-center border-b border-slate-100 pb-1">
                    <div className="col-span-4 text-sm text-slate-700 flex items-center">
                        {label}
                        <div className="ml-1 group relative"><InfoIcon />
                            <div className="hidden group-hover:block absolute z-50 left-0 bottom-full mb-1 w-56 bg-slate-800 text-white text-xs p-2 rounded shadow-lg pointer-events-none">{hint}</div>
                        </div>
                    </div>
                    <div className="col-span-2 text-xs text-center text-slate-400 font-mono pt-4">x {weight}</div>
                    <div className="col-span-3">
                        <SmartInput 
                            id={id} 
                            label="Ratio Value" 
                            value={inputs[company][id]} 
                            onChange={handleInputChange} 
                            correctValueEnc={_DATA_MATRIX[company][id]} 
                            activeId={activeInputId}
                            setActiveId={setActiveInputId}
                        />
                    </div>
                    <div className="col-span-3 pt-5 text-xs text-right text-slate-400">
                         = {(parseFloat(inputs[company][id] || 0) * weight).toFixed(4)}
                    </div>
                </div>
            );

            const companyData = DATA_SETS[company];

            return (
                <div className="flex flex-col h-full">
                    {/* TOP BAR */}
                    <div className="bg-slate-900 text-white p-3 flex justify-between items-center shadow-md z-10 no-select">
                        <div className="flex items-center gap-4">
                            <h1 className="font-bold text-lg tracking-tight">Financial Simulation <span className="text-slate-400 font-normal">| Module 4 Credit Analysis</span></h1>
                            <div className="bg-slate-700 rounded p-1 flex">
                                <button 
                                    className={`px-3 py-1 rounded text-sm font-medium transition-all ${company === 'ITW' ? 'bg-blue-500 text-white shadow' : 'text-slate-300 hover:text-white'}`}
                                    onClick={() => setCompany('ITW')}
                                >ITW</button>
                                <button 
                                    className={`px-3 py-1 rounded text-sm font-medium transition-all ${company === 'PH' ? 'bg-blue-500 text-white shadow' : 'text-slate-300 hover:text-white'}`}
                                    onClick={() => setCompany('PH')}
                                >Parker Hannifin</button>
                            </div>
                        </div>
                        <div className="flex gap-2 items-center">
                             <button onClick={() => setShowRefTable(!showRefTable)} className="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded transition">
                                {showRefTable ? "Hide" : "Show"} Moody's Matrix
                            </button>
                            <button onClick={requestDownload} className="text-xs bg-green-600 hover:bg-green-700 px-3 py-1.5 rounded transition flex items-center gap-1">
                                <span>Save Work</span>
                            </button>
                            {!teacherMode ? (
                                <button onClick={() => setShowTeacherLogin(true)} className="text-slate-600 hover:text-slate-400 transition opacity-30 hover:opacity-100 p-1" title="Instructor Access">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                                </button>
                            ) : (
                                <div className="flex gap-2">
                                    <button onClick={autoFill} className="text-xs bg-yellow-600 hover:bg-yellow-700 px-2 py-1 rounded">Auto-Fill</button>
                                    <button onClick={requestClear} className="text-xs bg-red-600 hover:bg-red-700 px-2 py-1 rounded">Clear</button>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* MODALS (Simplified for brevity) */}
                    {modal.isOpen && (
                        <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-lg shadow-2xl w-80 animate-fade-in">
                                {modal.type === 'download' && (
                                    <>
                                        <h3 className="font-bold text-lg mb-2 text-slate-800">Save Your Work</h3>
                                        <input 
                                            type="text" 
                                            className="w-full border border-slate-300 p-2 rounded mb-4" 
                                            placeholder="Student Name"
                                            value={modal.studentName}
                                            onChange={(e) => setModal(prev => ({ ...prev, studentName: e.target.value }))}
                                            autoFocus
                                        />
                                        <div className="flex justify-end gap-2">
                                            <button onClick={closeModal} className="text-slate-500 text-sm">Cancel</button>
                                            <button onClick={handleConfirmDownload} className="bg-green-600 text-white px-4 py-1.5 rounded text-sm">Download</button>
                                        </div>
                                    </>
                                )}
                                {modal.type === 'clear' && (
                                    <>
                                        <h3 className="font-bold text-lg mb-2 text-red-600">Clear Data?</h3>
                                        <div className="flex justify-end gap-2 mt-4">
                                            <button onClick={closeModal} className="text-slate-500 text-sm">Cancel</button>
                                            <button onClick={handleConfirmClear} className="bg-red-600 text-white px-4 py-1.5 rounded text-sm">Yes</button>
                                        </div>
                                    </>
                                )}
                            </div>
                        </div>
                    )}

                    {/* MOODY'S TABLE MODAL */}
                    {showRefTable && (
                        <div className="absolute top-16 right-4 z-50 bg-white shadow-xl border rounded p-4 w-[600px] text-xs">
                            <div className="flex justify-between mb-2 font-bold text-slate-700 border-b pb-1">
                                <span>Exhibit 4.4: Moody's Ratios & Risk Classes</span>
                                <button onClick={() => setShowRefTable(false)} className="text-red-500">Close</button>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-left border-collapse">
                                    <thead>
                                        <tr className="bg-slate-100">
                                            <th className="p-1 border">Rating</th>
                                            <th className="p-1 border">Debt/EBITDA</th>
                                            <th className="p-1 border">EBITA/Int</th>
                                            <th className="p-1 border">Rev ($B)</th>
                                            <th className="p-1 border">EBITA %</th>
                                            <th className="p-1 border">Op %</th>
                                            <th className="p-1 border">FFO/Debt %</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {[
                                            ["Aaa", "1.1", "63.0", "146.0", "38.3", "34.1", "83.5"],
                                            ["Aa", "1.3", "29.7", "143.2", "22.9", "22.2", "65.4"],
                                            ["A", "2.1", "14.4", "22.4", "19.7", "16.9", "41.7"],
                                            ["Baa", "2.6", "8.4", "10.7", "17.0", "15.0", "32.6"],
                                            ["Ba", "3.3", "5.1", "3.5", "14.3", "12.3", "24.9"],
                                            ["B", "6.0", "2.1", "0.9", "12.3", "7.4", "9.7"],
                                            ["Caa", "9.5", "0.8", "0.5", "7.1", "2.2", "3.1"],
                                        ].map((r, i) => (
                                            <tr key={i} className={i%2===0 ? "bg-white" : "bg-slate-50"}>
                                                <td className="font-bold border p-1 text-center">{r[0]}</td>
                                                {r.slice(1).map((c, j) => <td key={j} className="border p-1 text-center">{c}</td>)}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {/* INSTRUCTOR LOGIN MODAL */}
                    {showTeacherLogin && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded shadow-lg w-64">
                                <h3 className="font-bold mb-4">Instructor Access</h3>
                                <input 
                                    type="password" 
                                    className="w-full border p-2 mb-4 rounded" 
                                    placeholder="Password" 
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    onKeyDown={(e) => e.key === 'Enter' && handleTeacherLogin()}
                                    autoFocus
                                />
                                <div className="flex justify-end gap-2">
                                    <button onClick={() => setShowTeacherLogin(false)} className="text-slate-500">Cancel</button>
                                    <button onClick={handleTeacherLogin} className="bg-blue-600 text-white px-3 py-1 rounded">Login</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* MAIN CONTENT AREA WITH RESIZABLE SPLIT */}
                    <div className="flex flex-1 overflow-hidden">
                        
                        {/* LEFT PANEL: DATA */}
                        <div 
                            className="bg-white border-r border-slate-200 overflow-y-auto scroller p-4" 
                            style={{ width: `${sidebarWidth}%` }}
                        >
                            <h2 className="text-xl font-bold text-slate-800 mb-1">{companyData.name}</h2>
                            <p className="text-xs text-slate-500 mb-6 font-mono">Currency: {companyData.currency}</p>

                            {Object.entries(companyData.CASE_DATA).map(([key, section]) => (
                                <div key={key} className="mb-8">
                                    <h3 className="font-bold text-blue-800 border-b-2 border-blue-100 mb-2 pb-1">{section.title}</h3>
                                    <table className="w-full text-sm text-left border-collapse">
                                        <thead>
                                            <tr className="text-xs text-slate-500 border-b">
                                                {section.headers.map((h, i) => (
                                                    <th key={i} className={`p-2 ${i > 0 ? 'text-right' : ''}`}>{h}</th>
                                                ))}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {section.rows.map((row, rIndex) => (
                                                <tr key={rIndex} className="hover:bg-blue-50 transition-colors group">
                                                    {row.map((cell, cIndex) => (
                                                        <td 
                                                            key={cIndex} 
                                                            className={`p-1.5 border-b border-slate-50 ${cIndex > 0 ? 'text-right font-mono text-slate-700 cursor-pointer hover:bg-blue-100 hover:text-blue-700 hover:font-bold' : 'text-slate-600'}`}
                                                            onMouseDown={(e) => e.preventDefault()} 
                                                            onClick={() => cIndex > 0 && handleDataClick(cell)}
                                                            title={cIndex > 0 ? "Click to insert value" : ""}
                                                        >
                                                            {cell}
                                                        </td>
                                                    ))}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            ))}
                        </div>

                        {/* RESIZE HANDLE */}
                        <div 
                            className="w-1 bg-slate-200 hover:bg-blue-400 cursor-col-resize flex items-center justify-center transition-colors z-20"
                            onMouseDown={startResize}
                        >
                            <div className="h-8 w-1 bg-slate-400 rounded-full"></div>
                        </div>

                        {/* RIGHT PANEL: WORKSPACE */}
                        <div 
                            className="bg-slate-50 overflow-y-auto scroller p-4 pb-20" 
                            style={{ width: `${100 - sidebarWidth}%` }}
                            ref={workspaceRef}
                        >
                            <h2 className="text-xl font-bold text-slate-700 mb-4">Credit Analysis Workspace</h2>

                            {/* 1. LIQUIDITY */}
                            <div className="bg-white rounded shadow-sm border border-slate-200 mb-4">
                                <SectionHeader title="1. Liquidity Ratios" isOpen={sections.liquidity} toggle={() => toggleSection('liquidity')} />
                                {sections.liquidity && <div className="p-4">
                                    {renderRow("Current Ratio", "current_ratio", false, "Current Assets / Current Liabilities")}
                                    {renderRow("Quick Ratio", "quick_ratio", false, "Cash + Marketable Securities + Trade AR / Current Liabilities")}
                                </div>}
                            </div>

                            {/* 2. CAPITAL STRUCTURE */}
                            <div className="bg-white rounded shadow-sm border border-slate-200 mb-4">
                                <SectionHeader title="2. Capital Structure" isOpen={sections.capStructure} toggle={() => toggleSection('capStructure')} />
                                {sections.capStructure && <div className="p-4">
                                    {renderRow("Liabilities to Equity", "liab_equity", false, "Total Liabilities / Total Equity")}
                                    {renderRow("Debt to Equity", "debt_equity", false, "Total Debt (incl. Leases) / Total Equity")}
                                </div>}
                            </div>

                            {/* 3. COVERAGE */}
                            <div className="bg-white rounded shadow-sm border border-slate-200 mb-4">
                                <SectionHeader title="3. Coverage Ratios" isOpen={sections.coverage} toggle={() => toggleSection('coverage')} />
                                {sections.coverage && <div className="p-4">
                                    {renderRow("Times Interest Earned", "tie", false, "Operating Income / Interest Expense")}
                                    {/* Intermittent Calculation Step */}
                                    {renderRow("EBITDA ($)", "ebitda_val", false, "Operating Income + Depreciation + Amortization", true)}
                                    {renderRow("EBITDA Coverage", "ebitda_cov", false, "EBITDA / Interest Expense")}
                                </div>}
                            </div>

                            {/* 4. CASH FLOW */}
                            <div className="bg-white rounded shadow-sm border border-slate-200 mb-4">
                                <SectionHeader title="4. Cash Flow Protection" isOpen={sections.cashFlow} toggle={() => toggleSection('cashFlow')} />
                                {sections.cashFlow && <div className="p-4">
                                    {renderRow("CFO to Debt", "cfo_debt", false, "Cash from Ops / Total Debt")}
                                    {renderRow("Free Op Cash Flow to Debt", "focf_debt", false, "(CFO - Capex) / Total Debt")}
                                </div>}
                            </div>

                            {/* 5. MOODY'S ANALYSIS */}
                            <div className="bg-white rounded shadow-sm border border-indigo-100 ring-1 ring-indigo-50 mb-4">
                                <div 
                                    className="flex items-center justify-between bg-indigo-50 p-2 cursor-pointer hover:bg-indigo-100 border-b border-indigo-200"
                                    onClick={() => toggleSection('moody')}
                                >
                                    <h3 className="font-bold text-indigo-900 text-sm uppercase tracking-wide">5. Moody's Credit Rating (2022)</h3>
                                    <span className="text-indigo-500">{sections.moody ? '▼' : '▶'}</span>
                                </div>
                                {sections.moody && <div className="p-4 bg-white">
                                    <div className="grid grid-cols-4 gap-2 mb-2 font-bold text-xs text-slate-400 uppercase">
                                        <div className="col-span-2">Metric</div>
                                        <div className="col-span-1">Computed Value</div>
                                        <div className="col-span-1">Implied Rating</div>
                                    </div>
                                    {renderMoodyRow("Debt / EBITDA", "moody_debt_ebitda", "x", "Total Debt / EBITDA")}
                                    
                                    {/* New Intermittent Step for EBITA */}
                                    <div className="grid grid-cols-4 gap-2 mb-2 items-center border-b border-indigo-50 bg-indigo-50/50 p-1 rounded">
                                        <div className="col-span-2 text-sm text-indigo-800 flex items-center font-medium">
                                            EBITA ($)
                                            <div className="ml-1 group relative"><InfoIcon />
                                                <div className="hidden group-hover:block absolute z-50 left-0 bottom-full mb-1 w-64 bg-slate-800 text-white text-xs p-2 rounded shadow-lg pointer-events-none">Operating Income + Amortization Expense</div>
                                            </div>
                                        </div>
                                        <div className="col-span-1">
                                            <SmartInput 
                                                id="ebita_val" 
                                                label="" 
                                                value={inputs[company]["ebita_val"]} 
                                                onChange={handleInputChange} 
                                                correctValueEnc={_DATA_MATRIX[company]["ebita_val"]} 
                                                activeId={activeInputId}
                                                setActiveId={setActiveInputId}
                                            />
                                        </div>
                                    </div>

                                    {renderMoodyRow("EBITA / Interest", "moody_ebita_int", "x", "EBITA / Interest Expense")}
                                    {renderMoodyRow("Revenue ($Bn)", "moody_rev", "$", "Revenue in Billions")}
                                    {renderMoodyRow("EBITA Margin", "moody_ebita_marg", "%", "EBITA / Revenue")}
                                    {renderMoodyRow("Operating Margin", "moody_op_marg", "%", "Operating Income / Revenue")}
                                    {renderMoodyRow("FFO / Debt", "moody_ffo_debt", "%", "Funds From Ops / Total Debt")}
                                    {renderMoodyRow("(FFO+Int) / Int", "moody_ffo_int_int", "x", "(FFO + Interest) / Interest")}
                                    {renderMoodyRow("EBITA / Avg Assets", "moody_ebita_assets", "%", "EBITA / Average Assets")}
                                    {renderMoodyRow("Capex / Depreciation", "moody_capex_dep", "x", "Capex / Depreciation")}
                                </div>}
                            </div>

                            {/* 6. ALTMAN Z-SCORE */}
                            <div className="bg-white rounded shadow-sm border border-slate-200 mb-4">
                                <SectionHeader title="6. Altman Z-Score (2022)" isOpen={sections.zScore} toggle={() => toggleSection('zScore')} />
                                {sections.zScore && <div className="p-4">
                                    <p className="text-xs text-slate-500 mb-3 italic">Formula: Z = 1.2A + 1.4B + 3.3C + 0.6D + 0.99E</p>
                                    {renderZRow("(A) Working Cap / Assets", "z_wc_ta", 1.2, "Working Capital / Total Assets")}
                                    {renderZRow("(B) Retained Earnings / Assets", "z_re_ta", 1.4, "Retained Earnings / Total Assets")}
                                    {renderZRow("(C) EBIT / Assets", "z_ebit_ta", 3.3, "EBIT / Total Assets")}
                                    {renderZRow("(D) Mkt Value Equity / Liabs", "z_mve_tl", 0.6, "Market Cap / Total Liabilities")}
                                    {renderZRow("(E) Sales / Assets", "z_sales_ta", 0.99, "Revenue / Total Assets")}
                                    
                                    <div className="mt-4 pt-3 border-t-2 border-slate-100 flex justify-between items-center">
                                        <label className="font-bold text-slate-800">Total Z-Score:</label>
                                        <div className="w-32">
                                            <SmartInput 
                                                id="z_score_total" 
                                                label="" 
                                                value={inputs[company]["z_score_total"]} 
                                                onChange={handleInputChange} 
                                                correctValueEnc={_DATA_MATRIX[company]["z_score_total"]} 
                                                activeId={activeInputId}
                                                setActiveId={setActiveInputId}
                                            />
                                        </div>
                                    </div>

                                    {/* Z-SCORE LEGEND */}
                                    <div className="mt-6 border border-slate-200 rounded-md overflow-hidden">
                                        <div className="bg-slate-100 px-3 py-1.5 text-xs font-bold text-slate-600 border-b border-slate-200">
                                            Z-Score Interpretation Guide
                                        </div>
                                        <div className="divide-y divide-slate-100">
                                            <div className="grid grid-cols-2 p-2 bg-green-50 text-green-800 text-xs">
                                                <span className="font-mono font-bold">&gt; 3.0</span>
                                                <span className="font-semibold text-right">Low Bankruptcy Risk</span>
                                            </div>
                                            <div className="grid grid-cols-2 p-2 bg-yellow-50 text-yellow-800 text-xs">
                                                <span className="font-mono font-bold">1.8 – 3.0</span>
                                                <span className="font-semibold text-right">Grey Zone</span>
                                            </div>
                                            <div className="grid grid-cols-2 p-2 bg-red-50 text-red-800 text-xs">
                                                <span className="font-mono font-bold">&lt; 1.8</span>
                                                <span className="font-semibold text-right">High Bankruptcy Risk</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                </div>}
                            </div>

                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
