<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Reporting & Analysis Simulation</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom scrollbar for sidebar */
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        body {
            background-color: #f3f4f6;
            user-select: none; /* Light deterrence for selection */
        }
        .math-font {
            font-family: 'Courier New', Courier, monospace;
        }
        /* Table Input Styling */
        .table-input input {
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 4px 8px;
            width: 100%;
            font-size: 0.9em;
        }
        .table-input input:focus {
            border-color: #2563eb;
            outline: none;
            box-shadow: 0 0 0 1px #2563eb;
        }
        .fade-in { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        /* Resizer Handle */
        .resizer {
            width: 5px;
            cursor: col-resize;
            background-color: #e5e7eb;
            transition: background-color 0.2s;
            z-index: 20;
        }
        .resizer:hover, .resizer.active {
            background-color: #3b82f6;
        }
    </style>
</head>
<body oncontextmenu="return false;"> <!-- Anti-Tampering: Disable Right Click -->
    <div id="root"></div>

    <script type="text/babel">
        // --- SECURITY & HELPERS ---

        // Helper to decode Base64 values
        const d = (str) => {
            try {
                if (Array.isArray(str)) return str.map(s => d(s));
                return atob(str);
            } catch (e) {
                return str;
            }
        };

        // --- CONSTANTS & DATA ---

        // Reference Data
        const RAW_DATA = {
            PH: {
                "Balance Sheet": [
                    { account: "Cash and cash equivalents", 2022: 535799, 2021: 733117 },
                    { account: "Marketable securities", 2022: 27862, 2021: 39116 },
                    { account: "Trade accounts receivable", 2022: 2341504, 2021: 2183594 },
                    { account: "Non-trade/notes receivable", 2022: 543757, 2021: 326315 },
                    { account: "Inventories", 2022: 2214553, 2021: 2090642 },
                    { account: "Prepaid expenses/other", 2022: 6383169, 2021: 243966 },
                    { account: "Total current assets", 2022: 12046644, 2021: 5616750 },
                    { account: "PPE Gross", 2022: 5897955, 2021: 6040220 },
                    { account: "Accumulated depreciation", 2022: 3775197, 2021: 3773744 },
                    { account: "PPE Net", 2022: 2122758, 2021: 2266476 },
                    { account: "Deferred income taxes", 2022: 110585, 2021: 104251 },
                    { account: "Investments/other assets", 2022: 788057, 2021: 774239 },
                    { account: "Intangible assets, net", 2022: 3135817, 2021: 3519797 },
                    { account: "Goodwill", 2022: 7740082, 2021: 8059687 },
                    { account: "Total Assets", 2022: 25943943, 2021: 20341200 },
                    { account: "Notes payable/ST debt", 2022: 1724310, 2021: 2824 },
                    { account: "Accounts payable, trade", 2022: 1731925, 2021: 1667878 },
                    { account: "Accrued payrolls", 2022: 470132, 2021: 507027 },
                    { account: "Accrued taxes", 2022: 250292, 2021: 236384 },
                    { account: "Current op. lease liab", 2022: 36023, 2021: 40193 },
                    { account: "Other accrued liabilities", 2022: 1646636, 2021: 642197 },
                    { account: "Total current liabilities", 2022: 5859318, 2021: 3096503 },
                    { account: "Long-term debt", 2022: 9755825, 2021: 6582053 },
                    { account: "Pensions/postretirement", 2022: 639939, 2021: 1055638 },
                    { account: "Deferred income taxes (Liab)", 2022: 307044, 2021: 553981 },
                    { account: "Long-term op. lease liab", 2022: 100337, 2021: 93904 },
                    { account: "Other liabilities", 2022: 421560, 2021: 545451 },
                    { account: "Total Liabilities", 2022: 17084023, 2021: 11927530 },
                    { account: "Total Shareholders' Equity", 2022: 8848011, 2021: 8398307 },
                    { account: "Total Equity", 2022: 8859920, 2021: 8413670 }
                ],
                "Income Statement": [
                    { account: "Net Sales", 2022: 15861608, 2021: 14347640, 2020: 13695520 },
                    { account: "Cost of sales", 2022: 11387267, 2021: 10449680, 2020: 10292291 },
                    { account: "Gross profit", 2022: 4474341, 2021: 3897960, 2020: 3403229 },
                    { account: "SG&A expenses", 2022: 1627116, 2021: 1527302, 2020: 1656553 },
                    { account: "Gain on disposal", 2022: -7121, 2021: -109332, 2020: -1227 },
                    { account: "Operating income", 2022: 2854346, 2021: 2479990, 2020: 1747903 },
                    { account: "Interest expense", 2022: 255252, 2021: 250036, 2020: 308161 },
                    { account: "Loss on forward contracts", 2022: 1015426, 2021: 0, 2020: 0 },
                    { account: "Other expense (income)", 2022: -30558, 2021: -17003, 2020: -67112 },
                    { account: "Income before taxes", 2022: 1614226, 2021: 2246957, 2020: 1506854 },
                    { account: "Income taxes", 2022: 298040, 2021: 500096, 2020: 304522 },
                    { account: "Net Income", 2022: 1316186, 2021: 1746861, 2020: 1202332 },
                    { account: "Net Income (Common)", 2022: 1315605, 2021: 1746100, 2020: 1201970 }
                ],
                "Cash Flow": [
                    { account: "Net cash from operating", 2022: 2441730, 2021: 2575001 },
                    { account: "Capital expenditures", 2022: -230044, 2021: -209957 },
                    { account: "Sale of PPE", 2022: 39353, 2021: 140590 },
                    { account: "Sale of businesses", 2022: 3366, 2021: 0 },
                    { account: "Net cash from investing", 2022: -418837, 2021: -13 },
                    { account: "Payments for common shares", 2022: -460056, 2021: -218818 },
                    { account: "Dividends paid", 2022: -569855, 2021: -475174 },
                    { account: "Net cash from financing", 2022: 3915636, 2021: -2623339 }
                ]
            },
            ITW: {
                "Balance Sheet": [
                    { account: "Cash and equivalents", 2022: 708, 2021: 1527 },
                    { account: "Trade receivables", 2022: 3171, 2021: 2840 },
                    { account: "Inventories", 2022: 2054, 2021: 1694 },
                    { account: "Prepaid expenses and other", 2022: 329, 2021: 313 },
                    { account: "Assets held for sale", 2022: 8, 2021: 0 },
                    { account: "Total current assets", 2022: 6270, 2021: 6374 },
                    { account: "Net plant and equipment", 2022: 1848, 2021: 1809 },
                    { account: "Goodwill", 2022: 4864, 2021: 4965 },
                    { account: "Intangible assets", 2022: 768, 2021: 972 },
                    { account: "Deferred income taxes", 2022: 494, 2021: 552 },
                    { account: "Other assets", 2022: 1178, 2021: 1405 },
                    { account: "Total Assets", 2022: 15422, 2021: 16077 },
                    { account: "Short-term debt", 2022: 1590, 2021: 778 },
                    { account: "Accounts payable", 2022: 594, 2021: 585 },
                    { account: "Current portion op. lease", 2022: 55, 2021: 61 },
                    { account: "Accrued expenses", 2022: 1673, 2021: 1587 },
                    { account: "Cash dividends payable", 2022: 400, 2021: 382 },
                    { account: "Income taxes payable", 2022: 147, 2021: 77 },
                    { account: "Liabilities held for sale", 2022: 1, 2021: 0 },
                    { account: "Total current liabilities", 2022: 4460, 2021: 3470 },
                    { account: "Long-term debt", 2022: 6173, 2021: 6909 },
                    { account: "Deferred income taxes (Liab)", 2022: 484, 2021: 654 },
                    { account: "Noncurrent income taxes", 2022: 273, 2021: 365 },
                    { account: "Long-term op. lease liab", 2022: 131, 2021: 133 },
                    { account: "Other liabilities", 2022: 812, 2021: 920 },
                    { account: "Total noncurrent liabilities", 2022: 7873, 2021: 8981 },
                    { account: "Total stockholders' equity", 2022: 3089, 2021: 3626 }
                ],
                "Income Statement": [
                    { account: "Operating revenue", 2022: 15932, 2021: 14455, 2020: 12574 },
                    { account: "Cost of revenue", 2022: 9429, 2021: 8489, 2020: 7375 },
                    { account: "Gross profit", 2022: 6503, 2021: 5966, 2020: 5199 },
                    { account: "Selling, admin, R&D", 2022: 2579, 2021: 2356, 2020: 2163 },
                    { account: "Amortization/Impairment", 2022: 134, 2021: 133, 2020: 154 },
                    { account: "Operating Income", 2022: 3790, 2021: 3477, 2020: 2882 },
                    { account: "Interest expense", 2022: 203, 2021: 202, 2020: 206 },
                    { account: "Other (income) expense", 2022: -255, 2021: -51, 2020: -28 },
                    { account: "Income Before Taxes", 2022: 3842, 2021: 3326, 2020: 2704 },
                    { account: "Income taxes", 2022: 808, 2021: 632, 2020: 595 },
                    { account: "Net Income", 2022: 3034, 2021: 2694, 2020: 2109 }
                ],
                "Cash Flow": [
                    { account: "Net cash from operating", 2022: 2348, 2021: 2557 },
                    { account: "Acquisition of businesses", 2022: -2, 2021: -731 },
                    { account: "Additions to plant/equip", 2022: -412, 2021: -296 },
                    { account: "Proceeds from investments", 2022: 12, 2021: 38 },
                    { account: "Proceeds sale plant/equip", 2022: 15, 2021: 8 },
                    { account: "Net cash from investing", 2022: -110, 2021: -984 },
                    { account: "Cash dividends paid", 2022: -1542, 2021: -1463 },
                    { account: "Repurchases of stock", 2022: -1750, 2021: -1000 },
                    { account: "Net cash from financing", 2022: -3000, 2021: -2564 }
                ]
            }
        };

        // Obfuscated Answer Matrix
        const _DATA_MATRIX = [
            {
                id: 'income_revenue',
                title: '1. Income Statement & Revenue',
                subsections: [
                    {
                        title: '1.a Horizontal Analysis of the Income Statement',
                        gridCols: 2,
                        guidance: {
                            task: `On the Income Statement tab, determine the year-over-year percentage change for each income statement line item. At a minimum, compute Net sales (Parker Hannifin) and Operating revenue (Illinois Tool Works).`,
                            source: `Consolidated Income Statement in the Form 10-K (2022 vs 2021).`
                        },
                        questions: [
                            { id: '2b_ph_2022', label: 'PH Net Sales Growth 2022', correct: 'MTAuNg==', isPct: true, suffix: '%' },
                            { id: '2b_ph_2021', label: 'PH Net Sales Growth 2021', correct: 'NC44', isPct: true, suffix: '%' },
                            { id: '2b_itw_2022', label: 'ITW Operating Revenue Growth 2022', correct: 'MTAuMg==', isPct: true, suffix: '%' },
                            { id: '2b_itw_2021', label: 'ITW Operating Revenue Growth 2021', correct: 'MTUuMA==', isPct: true, suffix: '%' }
                        ]
                    }
                ]
            },
            {
                id: 'revenue',
                title: '2. Revenue',
                subsections: [
                    {
                        title: '2.a Revenue Recognition Policy',
                        gridCols: 1,
                        guidance: {
                            task: `Read the Revenue Recognition footnote and assess whether the policy aligns with concepts from the module. Determine whether the company has multiple-element contracts.`,
                            source: `Form 10-K → Notes: "Revenue Recognition". Segment details in MD&A.`
                        },
                        questions: [
                            { id: '2a_ph_policy', label: 'Does PH recognize revenue for both products and services?', correct: 'WWVz', type: 'choice' },
                            { id: '2a_itw_policy', label: 'Does ITW recognize revenue for both products and services?', correct: 'WWVz', type: 'choice' }
                        ]
                    },
                    {
                        title: '2.c Revenue by Segment (2022 Focus)',
                        guidance: {
                            task: `Find the footnote on segment revenues. Fill out the 2022 data based on the 10-K. The 2021 and 2020 data has been pre-filled for you.`,
                            source: `Revenue Recognition footnote, Segment Information footnote, or MD&A "Results by Segment".`
                        },
                        flexibleTable: {
                            views: {
                                PH: {
                                    headers: ["Segment ($ thousands)", "2022 (Input)", "2021 (Ref)", "2020 (Ref)"],
                                    rows: [
                                        [
                                            { type: 'text', value: 'Diversified Industrial' },
                                            { type: 'input', id: '2c_ph_div_rev', correct: 'MTMzNDIwNDY=' },
                                            { type: 'static', value: '11,960,159' },
                                            { type: 'static', value: '10,960,885' }
                                        ],
                                        [
                                            { type: 'text', value: 'Aerospace Systems' },
                                            { type: 'input', id: '2c_ph_aero_rev', correct: 'MjUxOTU2Mg==' },
                                            { type: 'static', value: '2,387,481' },
                                            { type: 'static', value: '2,734,635' }
                                        ],
                                        [
                                            { type: 'text', value: 'PH Total Revenue' },
                                            { type: 'computed', operation: 'sum', dependsOn: ['2c_ph_div_rev', '2c_ph_aero_rev'] },
                                            { type: 'static', value: '14,347,640' },
                                            { type: 'static', value: '13,695,520' }
                                        ]
                                    ]
                                },
                                ITW: {
                                    headers: ["Segment ($ millions)", "2022 Revenue", "2021 (Ref)", "2020 (Ref)"],
                                    rows: [
                                        [
                                            { type: 'text', value: 'Automotive OEM' },
                                            { type: 'input', id: '2c_itw_auto_rev', correct: 'Mjk2OQ==' },
                                            { type: 'static', value: '2,800' },
                                            { type: 'static', value: '2,571' }
                                        ],
                                        [
                                            { type: 'text', value: 'Food Equipment' },
                                            { type: 'input', id: '2c_itw_food_rev', correct: 'MjQ0NA==' },
                                            { type: 'static', value: '2,078' },
                                            { type: 'static', value: '1,739' }
                                        ],
                                        [
                                            { type: 'text', value: 'Test & Measurement' },
                                            { type: 'input', id: '2c_itw_test_rev', correct: 'MjgyOA==' },
                                            { type: 'static', value: '2,346' },
                                            { type: 'static', value: '1,963' }
                                        ],
                                        [
                                            { type: 'text', value: 'Welding' },
                                            { type: 'input', id: '2c_itw_weld_rev', correct: 'MTg5NA==' },
                                            { type: 'static', value: '1,650' },
                                            { type: 'static', value: '1,384' }
                                        ],
                                        [
                                            { type: 'text', value: 'Polymers & Fluids' },
                                            { type: 'input', id: '2c_itw_poly_rev', correct: 'MTkwNQ==' },
                                            { type: 'static', value: '1,804' },
                                            { type: 'static', value: '1,622' }
                                        ],
                                        [
                                            { type: 'text', value: 'Construction Products' },
                                            { type: 'input', id: '2c_itw_cons_rev', correct: 'MjExMw==' },
                                            { type: 'static', value: '1,945' },
                                            { type: 'static', value: '1,652' }
                                        ],
                                        [
                                            { type: 'text', value: 'Specialty Products' },
                                            { type: 'input', id: '2c_itw_spec_rev', correct: 'MTc5OQ==' },
                                            { type: 'static', value: '1,854' },
                                            { type: 'static', value: '1,660' }
                                        ],
                                        [
                                            { type: 'text', value: 'Total Revenue' },
                                            { type: 'computed', operation: 'sum', dependsOn: ['2c_itw_auto_rev', '2c_itw_food_rev', '2c_itw_test_rev', '2c_itw_weld_rev', '2c_itw_poly_rev', '2c_itw_cons_rev', '2c_itw_spec_rev'] },
                                            { type: 'static', value: '14,477' },
                                            { type: 'static', value: '12,591' }
                                        ]
                                    ]
                                }
                            }
                        }
                    },
                    {
                        title: '2.c Segment Mix % (Auto-Calculated)',
                        guidance: {
                            task: `This table automatically calculates the Mix % based on the revenue numbers you entered above.`,
                            source: `Calculated from table above.`
                        },
                        flexibleTable: {
                            views: {
                                PH: {
                                    headers: ["Segment Mix (%)", "2022 (Auto)", "2021 (Ref)", "2020 (Ref)"],
                                    rows: [
                                        [
                                            { type: 'text', value: 'Diversified Industrial' },
                                            { type: 'computed', dependsOn: ['2c_ph_div_rev', '2c_ph_total_rev'] },
                                            { type: 'static', value: '83.4%' },
                                            { type: 'static', value: '80.0%' }
                                        ],
                                        [
                                            { type: 'text', value: 'Aerospace Systems' },
                                            { type: 'computed', dependsOn: ['2c_ph_aero_rev', '2c_ph_total_rev'] },
                                            { type: 'static', value: '16.6%' },
                                            { type: 'static', value: '20.0%' }
                                        ],
                                        [
                                            { type: 'text', value: 'Total' },
                                            { type: 'static', value: '100%' },
                                            { type: 'static', value: '100%' },
                                            { type: 'static', value: '100%' }
                                        ]
                                    ]
                                },
                                ITW: {
                                    headers: ["Segment Mix (%)", "2022 (Auto)", "2021 (Ref)", "2020 (Ref)"],
                                    rows: [
                                        [
                                            { type: 'text', value: 'Automotive OEM' },
                                            { type: 'computed', dependsOn: ['2c_itw_auto_rev', '2c_itw_total_rev'] },
                                            { type: 'static', value: '19.3%' },
                                            { type: 'static', value: '20.4%' }
                                        ],
                                        [
                                            { type: 'text', value: 'Food Equipment' },
                                            { type: 'computed', dependsOn: ['2c_itw_food_rev', '2c_itw_total_rev'] },
                                            { type: 'static', value: '14.4%' },
                                            { type: 'static', value: '13.8%' }
                                        ],
                                        [
                                            { type: 'text', value: 'Test & Measurement' },
                                            { type: 'computed', dependsOn: ['2c_itw_test_rev', '2c_itw_total_rev'] },
                                            { type: 'static', value: '16.2%' },
                                            { type: 'static', value: '15.6%' }
                                        ],
                                        [
                                            { type: 'text', value: 'Welding' },
                                            { type: 'computed', dependsOn: ['2c_itw_weld_rev', '2c_itw_total_rev'] },
                                            { type: 'static', value: '11.4%' },
                                            { type: 'static', value: '11.0%' }
                                        ],
                                        [
                                            { type: 'text', value: 'Polymers & Fluids' },
                                            { type: 'computed', dependsOn: ['2c_itw_poly_rev', '2c_itw_total_rev'] },
                                            { type: 'static', value: '12.5%' },
                                            { type: 'static', value: '12.9%' }
                                        ],
                                        [
                                            { type: 'text', value: 'Construction Products' },
                                            { type: 'computed', dependsOn: ['2c_itw_cons_rev', '2c_itw_total_rev'] },
                                            { type: 'static', value: '13.4%' },
                                            { type: 'static', value: '13.1%' }
                                        ],
                                        [
                                            { type: 'text', value: 'Specialty Products' },
                                            { type: 'computed', dependsOn: ['2c_itw_spec_rev', '2c_itw_total_rev'] },
                                            { type: 'static', value: '12.8%' },
                                            { type: 'static', value: '13.2%' }
                                        ],
                                        [
                                            { type: 'text', value: 'Total' },
                                            { type: 'static', value: '100%' },
                                            { type: 'static', value: '100%' },
                                            { type: 'static', value: '100%' }
                                        ]
                                    ]
                                }
                            }
                        }
                    },
                    {
                        title: '2.d Year-Over-Year Segment Growth',
                        guidance: {
                            task: `Calculate the growth rates for PH segments and ITW Automotive OEM. Other ITW segments are pre-filled.`,
                            source: `Segment revenue tables in 10-K footnotes or MD&A.`
                        },
                        openQuestions: {
                            PH: "Compare the growth rates of the two segments in 2022. Which segment is growing faster?",
                            ITW: "Which segments grew in 2022? Which segment had the largest increase?"
                        },
                        flexibleTable: {
                            views: {
                                PH: {
                                    headers: ["Segment", "2022 Growth (Calc)", "2021 Growth (Ref)"],
                                    rows: [
                                        [
                                            { type: 'text', value: 'PH Diversified Industrial' },
                                            { type: 'input', id: '2d_ph_div_growth', correct: 'MTEuNg==', isPct: true, suffix: '%' },
                                            { type: 'static', value: '9.1%' }
                                        ],
                                        [
                                            { type: 'text', value: 'PH Aerospace Systems' },
                                            { type: 'input', id: '2d_ph_aero_growth', correct: 'NS41', isPct: true, suffix: '%' },
                                            { type: 'static', value: '-12.7%' }
                                        ]
                                    ]
                                },
                                ITW: {
                                    headers: ["Segment", "2022 Growth (Calc)", "2021 Growth (Ref)"],
                                    rows: [
                                        [
                                            { type: 'text', value: 'ITW Automotive OEM' },
                                            { type: 'input', id: '2d_itw_auto_growth', correct: 'Ni4w', isPct: true, suffix: '%' },
                                            { type: 'static', value: '8.9%' }
                                        ],
                                        [
                                            { type: 'text', value: 'ITW Food Equipment' },
                                            { type: 'static', value: '17.6%' },
                                            { type: 'static', value: '19.5%' }
                                        ],
                                        [
                                            { type: 'text', value: 'ITW Test & Measurement' },
                                            { type: 'static', value: '20.5%' },
                                            { type: 'static', value: '19.5%' }
                                        ],
                                        [
                                            { type: 'text', value: 'ITW Welding' },
                                            { type: 'static', value: '14.8%' },
                                            { type: 'static', value: '19.2%' }
                                        ],
                                        [
                                            { type: 'text', value: 'ITW Polymers & Fluids' },
                                            { type: 'static', value: '5.6%' },
                                            { type: 'static', value: '11.2%' }
                                        ],
                                        [
                                            { type: 'text', value: 'ITW Construction Products' },
                                            { type: 'static', value: '8.6%' },
                                            { type: 'static', value: '17.7%' }
                                        ],
                                        [
                                            { type: 'text', value: 'ITW Specialty Products' },
                                            { type: 'static', value: '-3.0%' },
                                            { type: 'static', value: '11.7%' }
                                        ]
                                    ]
                                }
                            }
                        }
                    },
                    {
                        title: '2.e Revenue by Geography (2022 Focus)',
                        guidance: {
                            task: `Fill in the 2022 columns using the 10-K data. Calculate the % International Sales for 2022 yourself.`,
                            source: `Geographic Information footnote.`
                        },
                        flexibleTable: {
                            views: {
                                PH: {
                                    headers: ["Region / Item", "2022 (Input)", "2021 (Ref)", "2020 (Ref)"],
                                    rows: [
                                        [
                                            { type: 'text', value: 'PH Div. Ind. - North America' },
                                            { type: 'input', id: '2e_ph_div_na', correct: 'NzcwMzE1MA==', },
                                            { type: 'static', value: '6,676,449' },
                                            { type: 'static', value: '6,456,298' }
                                        ],
                                        [
                                            { type: 'text', value: 'PH Aerospace Systems (All NA)' },
                                            { type: 'input', id: '2e_ph_aero_na', correct: 'MjUxOTU2Mg==' },
                                            { type: 'static', value: '2,387,481' },
                                            { type: 'static', value: '2,734,635' }
                                        ],
                                        [
                                            { type: 'text', value: 'PH Total North America' },
                                            { type: 'input', id: '2e_ph_total_na', correct: 'MTAyMjI3MTI=' },
                                            { type: 'static', value: '9,063,930' },
                                            { type: 'static', value: '9,190,933' }
                                        ],
                                        [
                                            { type: 'text', value: 'PH Div. Ind. - International' },
                                            { type: 'input', id: '2e_ph_div_int', correct: 'NTYzODg5Ng==' },
                                            { type: 'static', value: '5,283,710' },
                                            { type: 'static', value: '4,504,587' }
                                        ],
                                        [
                                            { type: 'text', value: 'PH Total Revenue' },
                                            { type: 'input', id: '2e_ph_total_geo', correct: 'MTU4NjE2MDg=' },
                                            { type: 'static', value: '14,347,640' },
                                            { type: 'static', value: '13,695,520' }
                                        ],
                                        [
                                            { type: 'text', value: 'PH % International' },
                                            { type: 'input', id: '2e_ph_pct_int', correct: 'MzUuNg==', isPct: true, suffix: '%' },
                                            { type: 'static', value: '36.8%' },
                                            { type: 'static', value: '32.9%' }
                                        ]
                                    ]
                                },
                                ITW: {
                                    headers: ["Region / Item", "2022 (Input)", "2021 (Ref)", "2020 (Ref)"],
                                    rows: [
                                        [
                                            { type: 'text', value: 'ITW United States' },
                                            { type: 'input', id: '2e_itw_us', correct: 'NzYwOQ==' },
                                            { type: 'static', value: '6,578' },
                                            { type: 'static', value: '5,834' }
                                        ],
                                        [
                                            { type: 'text', value: 'ITW Canada / Mexico' },
                                            { type: 'input', id: '2e_itw_can_mex', correct: 'MTA5NQ==' },
                                            { type: 'static', value: '940' },
                                            { type: 'static', value: '778' }
                                        ],
                                        [
                                            { type: 'text', value: 'ITW EMEA' },
                                            { type: 'input', id: '2e_itw_emea', correct: 'MzkxMw==' },
                                            { type: 'static', value: '3,870' },
                                            { type: 'static', value: '3,447' }
                                        ],
                                        [
                                            { type: 'text', value: 'ITW Asia Pacific' },
                                            { type: 'input', id: '2e_itw_asia', correct: 'Mjk5MQ==' },
                                            { type: 'static', value: '2,802' },
                                            { type: 'static', value: '2,291' }
                                        ],
                                        [
                                            { type: 'text', value: 'ITW South America' },
                                            { type: 'input', id: '2e_itw_sa', correct: 'MzI0' },
                                            { type: 'static', value: '265' },
                                            { type: 'static', value: '224' }
                                        ],
                                        [
                                            { type: 'text', value: 'ITW Total Revenue' },
                                            { type: 'input', id: '2e_itw_total_geo', correct: 'MTU5MzI=' },
                                            { type: 'static', value: '14,455' },
                                            { type: 'static', value: '12,574' }
                                        ],
                                        [
                                            { type: 'text', value: 'ITW % International' },
                                            { type: 'input', id: '2e_itw_pct_int', correct: 'NTIuMg==', isPct: true, suffix: '%' },
                                            { type: 'static', value: '54.5%' },
                                            { type: 'static', value: '53.6%' }
                                        ]
                                    ]
                                }
                            }
                        }
                    }
                ]
            },
            {
                id: 'deferred',
                title: '3. Deferred Revenue',
                subsections: [
                    {
                        title: '3.a Source of Deferred Revenue',
                        guidance: {
                            task: `Explain what gives rise to deferred revenue for the company. Select all that apply based on the Revenue Recognition notes.`,
                            source: `Form 10-K → Notes: "Revenue Recognition".`
                        },
                        questions: [
                            { 
                                id: '3a_ph_sources', 
                                type: 'multiselect', 
                                label: 'Parker Hannifin Sources:', 
                                options: [
                                    'Customer receives control as work is performed',
                                    'Customer controls the asset being produced',
                                    'Contracts with multiple performance obligations',
                                    'Product has no alternative use & right to payment exists',
                                    'Sale of scrap material'
                                ],
                                correct: [
                                    'Q3VzdG9tZXIgcmVjZWl2ZXMgY29udHJvbCBhcyB3b3JrIGlzIHBlcmZvcm1lZA==',
                                    'Q3VzdG9tZXIgY29udHJvbHMgdGhlIGFzc2V0IGJlaW5nIHByb2R1Y2Vk',
                                    'Q29udHJhY3RzIHdpdGggbXVsdGlwbGUgcGVyZm9ybWFuY2Ugb2JsaWdhdGlvbnM=',
                                    'UHJvZHVjdCBoYXMgbm8gYWx0ZXJuYXRpdmUgdXNlICYgcmlnaHQgdG8gcGF5bWVudCBleGlzdHM='
                                ] 
                            },
                            { 
                                id: '3a_itw_sources', 
                                type: 'multiselect', 
                                label: 'Illinois Tool Works Sources:', 
                                options: [
                                    'Installation, acceptance, or service obligations remain after shipment',
                                    'Revenue recognized over time based on costs incurred',
                                    'Long-term defense contracts',
                                    'Sale of scrap material'
                                ],
                                correct: [
                                    'SW5zdGFsbGF0aW9uLCBhY2NlcHRhbmNlLCBvciBzZXJ2aWNlIG9ibGlnYXRpb25zIHJlbWFpbiBhZnRlciBzaGlwbWVudA==',
                                    'UmV2ZW51ZSByZWNvZ25pemVkIG92ZXIgdGltZSBiYXNlZCBvbiBjb3N0cyBpbmN1cnJlZA=='
                                ] 
                            }
                        ]
                    },
                    {
                        title: '3.b Deferred Revenue Balances',
                        guidance: {
                            task: `Identify deferred revenue balances for the two most recent fiscal years (2022 & 2021). Compute common size deferred revenue (Deferred / Total Revenue).`,
                            source: `Form 10-K Notes (PH: "Contract Balances", ITW: "Revenue Recognition"). Look for "Other accrued liabilities".`
                        },
                        flexibleTable: {
                            views: {
                                PH: {
                                    textContent: [
                                        { title: 'PH: Contract Balances', body: [
                                            'Contract assets and contract liabilities are reported on a contract-by-contract basis.',
                                            'Contract assets reflect revenue recognized and performance obligations satisfied in advance of customer billing.',
                                            'Contract liabilities relate to payments received in advance of the satisfaction of performance under the contract.',
                                            'PH’s business involves long-term contracts. They collect from customers before they complete the project.',
                                            'Therefore, for them, Deferred Revenue takes the form of contract liabilities.'
                                        ]}
                                    ],
                                    headers: ["Line Item", "2022", "2021"],
                                    rows: [
                                        [
                                            { type: 'text', value: 'PH Current (in Other accrued liabilities)' },
                                            { type: 'input', id: '3b_ph_curr_22', correct: 'NjA0NzI=' },
                                            { type: 'static', value: '51,211' }
                                        ],
                                        [
                                            { type: 'text', value: 'PH Noncurrent (in Other liabilities)' },
                                            { type: 'input', id: '3b_ph_non_22', correct: 'MjIyNQ==' },
                                            { type: 'static', value: '3,080' }
                                        ],
                                        [
                                            { type: 'text', value: 'PH Total Deferred Revenue' },
                                            { type: 'computed', operation: 'sum', dependsOn: ['3b_ph_curr_22', '3b_ph_non_22'] },
                                            { type: 'static', value: '54,291' }
                                        ],
                                        [
                                            { type: 'text', value: 'PH Common Size (%)' },
                                            { type: 'computed', dependsOn: ['3b_ph_tot_22', '2c_ph_total_rev'] },
                                            { type: 'static', value: '0.3%' }
                                        ]
                                    ]
                                },
                                ITW: {
                                    headers: ["Line Item", "2022", "2021"],
                                    rows: [
                                        [
                                            { type: 'text', value: 'ITW Total Deferred Revenue' },
                                            { type: 'input', id: '3b_itw_tot_22', correct: 'NDI3' },
                                            { type: 'static', value: '394' }
                                        ],
                                        [
                                            { type: 'text', value: 'ITW Common Size (%)' },
                                            { type: 'input', id: '3b_itw_common_22', correct: 'Mi43', isPct: true, suffix: '%' },
                                            { type: 'static', value: '2.5%' }
                                        ]
                                    ]
                                }
                            }
                        }
                    }
                ]
            },
            {
                id: 'ar',
                title: '4. Accounts Receivable',
                subsections: [
                    {
                        title: '4.a Size of Accounts Receivable',
                        gridCols: 1,
                        guidance: {
                            task: `Determine the size of Accounts Receivable relative to Total Assets.`,
                            source: `Balance Sheet and Notes.`
                        },
                        questions: [
                            { id: '5a_ph_pct', label: 'PH A/R as % of Total Assets 2022', correct: 'OS4w', isPct: true, suffix: '%' },
                            { id: '5a_itw_pct', label: 'ITW A/R as % of Total Assets 2022', correct: 'MjAuNg==', isPct: true, suffix: '%' }
                        ]
                    },
                    {
                        title: '4.d Days Sales Outstanding (DSO)',
                        gridCols: 1,
                        guidance: {
                            task: `Calculate Days Sales Outstanding to measure collection efficiency. Formula: (Average Accounts Receivable / Net Sales) * 365.`,
                            source: `Balance Sheet (A/R) and Income Statement (Total Revenue).`
                        },
                        questions: [
                            { id: '5d_ph_dso', label: 'PH DSO 2022 (Days)', correct: 'NTIuMDY=', isPct: false, suffix: 'days' },
                            { id: '5d_itw_dso', label: 'ITW DSO 2022 (Days)', correct: 'NjguODY=', isPct: false, suffix: 'days' }
                        ]
                    },
                    {
                        title: '4.e Cash Flow Impact of DSO Change (2022)',
                        guidance: {
                            task: `Calculate the cash flow impact of the change in DSO. Formula: (Prior DSO - Current DSO) * (Revenue / 365). Note: A decrease in DSO releases cash (positive), an increase uses cash (negative).`,
                            source: `Prior DSO calculations and Income Statement.`
                        },
                        flexibleTable: {
                            headers: ["Metric", "Parker Hannifin", "Illinois Tool Works"],
                            rows: [
                                [
                                    { type: 'text', value: 'DSO 2021 (Ref)' },
                                    { type: 'static', value: '51.36 days' },
                                    { type: 'static', value: '67.50 days' }
                                ],
                                [
                                    { type: 'text', value: 'DSO 2022 (Calculated in 4.d)' },
                                    { type: 'input', id: '5e_ph_dso_22', correct: 'NTIuMDY=' },
                                    { type: 'input', id: '5e_itw_dso_22', correct: 'NjguODY=' }
                                ],
                                [
                                    { type: 'text', value: 'Change in DSO (Prior - Current)' },
                                    { type: 'input', id: '5e_ph_dso_change', correct: 'LTAuNzA=' },
                                    { type: 'input', id: '5e_itw_dso_change', correct: 'LTEuMzY=' }
                                ],
                                [
                                    { type: 'text', value: 'Revenue per Day (Net Sales / 365)' },
                                    { type: 'input', id: '5e_ph_rev_day', correct: 'NDM0NTY=' },
                                    { type: 'input', id: '5e_itw_rev_day', correct: 'NDQ=' }
                                ],
                                [
                                    { type: 'text', value: 'Cash Flow Impact ($)' },
                                    { type: 'input', id: '5e_ph_impact', correct: 'LTMwNDE5' },
                                    { type: 'input', id: '5e_itw_impact', correct: 'LTU5' }
                                ]
                            ]
                        }
                    }
                ]
            },
            {
                id: 'quality',
                title: '5. Accounting Quality',
                subsections: [
                    {
                        title: '5.a One-Time / Non-Persistent Items',
                        gridCols: 1,
                        guidance: {
                            task: `Identify any one-time or non-persistent items reported in the income statement each year. Select all that apply.`,
                            source: `Consolidated Income Statement, MD&A, and Notes.`
                        },
                        questions: [
                            { 
                                id: '6a_ph_items', 
                                type: 'multiselect', 
                                label: 'Select PH Non-Persistent Items:', 
                                options: ['Gain on disposal', 'Loss on forward contracts', 'Other expense (income)', 'Restructuring charges', 'Inventory write-down'],
                                correct: ['R2FpbiBvbiBkaXNwb3NhbA==', 'TG9zcyBvbiBmb3J3YXJkIGNvbnRyYWN0cw==', 'T3RoZXIgZXhwZW5zZSAoaW5jb21lKQ=='] 
                            },
                            { 
                                id: '6a_itw_items', 
                                type: 'multiselect', 
                                label: 'Select ITW Non-Persistent Items:', 
                                options: ['Gain on sale of operations', 'Asset impairment', 'Legal settlement', 'Restructuring charges'],
                                correct: ['R2FpbiBvbiBzYWxlIG9mIG9wZXJhdGlvbnM='] 
                            }
                        ]
                    }
                ]
            }
        ];

        // --- COMPONENTS ---

        const Icon = ({ name, size = 18, className = "" }) => {
            const iconRef = React.useRef(null);

            React.useEffect(() => {
                if (window.lucide && iconRef.current) {
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    if (className) {
                        i.setAttribute('class', className);
                    }
                    iconRef.current.innerHTML = '';
                    iconRef.current.appendChild(i);
                    window.lucide.createIcons({
                        root: iconRef.current,
                        attrs: {
                            width: size,
                            height: size
                        }
                    });
                }
            }, [name, size, className]);

            return <span ref={iconRef} style={{ display: 'inline-flex', alignItems: 'center' }} />;
        };

        const GuidanceBlock = ({ guidance, openQuestions }) => {
            if (!guidance) return null;
            return (
                <div className="mb-6 bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-md">
                    <div className="mb-2">
                        <span className="font-bold text-blue-800 flex items-center gap-1 text-sm uppercase tracking-wide">
                            <Icon name="clipboard-list" size={14} /> Task
                        </span>
                        <p className="text-gray-700 text-sm mt-1 leading-relaxed">{guidance.task}</p>
                    </div>
                    <div className="mb-2">
                        <span className="font-bold text-blue-800 flex items-center gap-1 text-sm uppercase tracking-wide">
                            <Icon name="search" size={14} /> Where to find this information
                        </span>
                        <p className="text-gray-700 text-sm mt-1 italic">{guidance.source}</p>
                    </div>
                    {openQuestions && (
                        <div className="mt-3 pt-3 border-t border-blue-200">
                             <span className="font-bold text-blue-800 flex items-center gap-1 text-sm uppercase tracking-wide">
                                <Icon name="message-circle" size={14} /> Questions to Consider
                            </span>
                             <div className="mt-1 space-y-2">
                                {Object.entries(openQuestions).map(([key, q]) => (
                                    <div key={key} className="text-sm text-gray-800">
                                        <span className="font-bold">{key}:</span> {q}
                                    </div>
                                ))}
                             </div>
                        </div>
                    )}
                </div>
            );
        };

        const TextBlock = ({ content }) => {
            if (!content) return null;
            return (
                <div className="mb-6 bg-gray-50 p-4 rounded border border-gray-200">
                    <div className="grid grid-cols-1 md:grid-cols-1 gap-6">
                        {content.map((item, idx) => (
                            <div key={idx} className="bg-white p-3 rounded shadow-sm border border-gray-100">
                                <h4 className="font-bold text-blue-800 mb-2 border-b pb-1 text-sm">{item.title}</h4>
                                <div className="text-sm text-gray-700 space-y-1">
                                    {Array.isArray(item.body) ? item.body.map((line, lIdx) => (
                                        <p key={lIdx}>{line}</p>
                                    )) : <p>{item.body}</p>}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // Component for Yes/No Questions
        const ChoiceInput = ({ id, label, correct, value, onChange, showKey }) => {
            const decodedCorrect = d(correct);
            const isCorrect = value === decodedCorrect;

            return (
                <div className="mb-4">
                    <label className="block text-sm font-medium text-gray-700 mb-2">{label}</label>
                    <div className="flex gap-4">
                        {['Yes', 'No'].map((opt) => (
                            <label key={opt} className="flex items-center gap-2 cursor-pointer">
                                <input
                                    type="radio"
                                    name={id}
                                    value={opt}
                                    checked={value === opt}
                                    onChange={(e) => onChange(id, e.target.value)}
                                    className="text-blue-600 focus:ring-blue-500"
                                />
                                {opt}
                            </label>
                        ))}
                    </div>
                    {value && (
                        <div className="mt-1">
                            {isCorrect ? <span className="text-green-600 text-sm font-bold flex items-center gap-1"><Icon name="check" size={14}/> Correct</span> :
                            <span className="text-red-500 text-sm font-bold flex items-center gap-1"><Icon name="x" size={14}/> Incorrect</span>}
                        </div>
                    )}
                    {showKey && (
                         <div className="mt-1 text-sm font-bold text-purple-700 bg-purple-100 p-1 rounded inline-block">
                            Key: {decodedCorrect}
                        </div>
                    )}
                </div>
            );
        };

        const SmartInput = ({ id, label, correct, isPct, suffix, value, onChange, onFocus, showKey, compact }) => {
            const [localValue, setLocalValue] = React.useState(value || '');
            const [isValid, setIsValid] = React.useState(null);

            // Decode the correct answer on render
            const decodedCorrect = parseFloat(d(correct));

            React.useEffect(() => {
                setLocalValue(value || '');
                // Force reset state if value is cleared externally
                if (value === '' || value === undefined) {
                    setIsValid(null);
                } else {
                    validate(value);
                }
            }, [value]);

            const evaluateExpression = (expression) => {
                try {
                    // Handle percentage inputs like "10%" -> 0.1 or "100 * 5%" -> 5
                    const withPercent = expression.replace(/(\d+(\.\d+)?)%/g, '($1/100)');
                    const sanitized = withPercent.replace(/[^0-9+\-*/().]/g, '');
                    if (!sanitized) return null;
                    // eslint-disable-next-line no-new-func
                    return Function('"use strict";return (' + sanitized + ')')();
                } catch (e) {
                    return null;
                }
            };

            const validate = (val) => {
                if (!val && val !== 0) {
                    setIsValid(null);
                    return;
                }

                let numVal = parseFloat(val);
                if (isNaN(numVal) || typeof val === 'string') {
                    const evaluated = evaluateExpression(val);
                    if (evaluated !== null) numVal = evaluated;
                }

                if (isNaN(numVal)) {
                    setIsValid(false);
                    return;
                }

                let userVal = numVal;
                let targetVal = decodedCorrect;

                // Percent Tolerance Logic
                if (isPct) {
                     // If user enters 0.106 and target is 10.6 -> Multiply user by 100
                     if (Math.abs(userVal) < 1 && Math.abs(targetVal) > 1) {
                         userVal = userVal * 100;
                     } 
                     // If user enters 10.6 and target is 0.106 -> Multiply target by 100
                     else if (Math.abs(userVal) > 1 && Math.abs(targetVal) < 1) {
                         targetVal = targetVal * 100;
                     }
                }

                const diff = Math.abs(userVal - targetVal);
                // Updated Tolerance: 5% of the target value (increased from 2% to accept 0.11 for 10.6)
                const tolerance = Math.abs(targetVal * 0.05); 
                
                if (diff <= tolerance || (targetVal === 0 && Math.abs(userVal) < 0.001)) {
                    setIsValid(true);
                } else {
                    setIsValid(false);
                }
            };

            const handleBlur = (e) => {
                const val = e.target.value;
                const evaluated = evaluateExpression(val);
                
                if (evaluated !== null && evaluated !== parseFloat(val)) {
                    // Increased precision from 2 to 4 decimal places to prevent rounding errors on percentage calc
                    const displayVal = Number.isInteger(evaluated) ? evaluated : parseFloat(evaluated.toFixed(4));
                    onChange(id, displayVal.toString());
                } else {
                    validate(val);
                }
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    e.target.blur(); // Trigger blur to evaluate
                }
            };

            const handleChange = (e) => {
                setLocalValue(e.target.value);
                onChange(id, e.target.value);
            };

            if (compact) {
                return (
                    <div className="relative table-input">
                        <input
                            id={id} 
                            type="text"
                            value={localValue}
                            onChange={handleChange}
                            onBlur={handleBlur}
                            onKeyDown={handleKeyDown}
                            onFocus={() => onFocus(id)}
                            className={`${isValid === true ? 'border-green-500 bg-green-50' : 
                                      isValid === false ? 'border-red-400 bg-red-50' : ''}`}
                            placeholder="..."
                        />
                        {isValid === true && <div className="absolute right-2 top-1.5"><Icon name="check" size={14} className="text-green-600" /></div>}
                        {isValid === false && <div className="absolute right-2 top-1.5"><Icon name="x" size={14} className="text-red-500" /></div>}
                    </div>
                );
            }

            return (
                <div className="mb-4">
                    <label className="block text-sm font-medium text-gray-700 mb-1">{label}</label>
                    <div className="relative">
                        <input
                            id={id}
                            type="text"
                            value={localValue}
                            onChange={handleChange}
                            onBlur={handleBlur}
                            onKeyDown={handleKeyDown}
                            onFocus={() => onFocus(id)}
                            className={`w-full p-2 border-2 rounded pr-10 outline-none transition-colors 
                                ${isValid === true ? 'border-green-500 bg-green-50' : 
                                  isValid === false ? 'border-red-400 bg-red-50' : 'border-gray-300 focus:border-blue-500'}`}
                            placeholder="Calculate or enter value..."
                        />
                        <div className="absolute right-3 top-2.5 text-gray-400">
                            {isValid === true ? <Icon name="check" size={20} className="text-green-600" /> :
                             isValid === false ? <Icon name="x" size={20} className="text-red-500" /> :
                             <span className="text-xs font-bold text-gray-400">{suffix || '#'}</span>}
                        </div>
                    </div>
                    {showKey && (
                        <div className="mt-1 text-sm font-bold text-purple-700 flex items-center gap-1 bg-purple-100 p-1 rounded inline-block">
                            <Icon name="key" size={14} />
                            Key: {decodedCorrect} {suffix}
                        </div>
                    )}
                </div>
            );
        };

        const MultiSelect = ({ id, label, options, correct, value, onChange, showKey }) => {
             const selected = Array.isArray(value) ? value : [];
             const decodedCorrect = d(correct); // Decode array of strings
             
             const isCorrect = React.useMemo(() => {
                 if (selected.length === 0) return null;
                 if (selected.length !== decodedCorrect.length) return false;
                 const sortedSelected = [...selected].sort();
                 const sortedCorrect = [...decodedCorrect].sort();
                 return sortedSelected.every((val, index) => val === sortedCorrect[index]);
             }, [selected, decodedCorrect]);

             const toggleOption = (opt) => {
                 let newSelected;
                 if (selected.includes(opt)) {
                     newSelected = selected.filter(s => s !== opt);
                 } else {
                     newSelected = [...selected, opt];
                 }
                 onChange(id, newSelected);
             };

             return (
                <div className="mb-4 bg-white border p-4 rounded shadow-sm">
                    <label className="block text-sm font-bold text-gray-700 mb-2">{label}</label>
                    <div className="space-y-2">
                        {options.map((opt, idx) => (
                            <label key={idx} className="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                                <input 
                                    type="checkbox" 
                                    checked={selected.includes(opt)}
                                    onChange={() => toggleOption(opt)}
                                    className="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                                />
                                <span className="text-gray-700 text-sm">{opt}</span>
                            </label>
                        ))}
                    </div>
                    <div className="mt-2 h-6">
                        {isCorrect === true && <span className="text-green-600 text-sm font-bold flex items-center gap-1"><Icon name="check" size={14}/> Correct</span>}
                        {isCorrect === false && <span className="text-red-500 text-sm font-bold flex items-center gap-1"><Icon name="x" size={14}/> Incorrect</span>}
                    </div>
                    {showKey && (
                        <div className="mt-1 text-sm text-purple-700 bg-purple-100 p-2 rounded">
                            <span className="font-bold">Key:</span> {decodedCorrect.join(", ")}
                        </div>
                    )}
                </div>
             );
        };

        const ComputedCell = ({ dependsOn, operation, answers }) => {
            const clean = (val) => {
                if(!val && val !== 0) return 0;
                
                // Logic for aggregating totals that might not be in 'answers' directly if they are computed rows
                // Section 2.c: PH Total Revenue
                if (val === '2c_ph_total_rev') {
                    // dependsOn: ['2c_ph_div_rev', '2c_ph_aero_rev']
                    const sum = clean('2c_ph_div_rev') + clean('2c_ph_aero_rev');
                    return sum;
                }
                // Section 2.c: ITW Total Revenue
                if (val === '2c_itw_total_rev') {
                     const itwSegs = ['2c_itw_auto_rev', '2c_itw_food_rev', '2c_itw_test_rev', '2c_itw_weld_rev', '2c_itw_poly_rev', '2c_itw_cons_rev', '2c_itw_spec_rev'];
                     return itwSegs.reduce((acc, key) => acc + clean(key), 0);
                }
                // Section 3.b: PH Total Deferred Revenue
                if (val === '3b_ph_tot_22') {
                     return clean('3b_ph_curr_22') + clean('3b_ph_non_22');
                }
                
                // If it's a standard input key
                if (answers[val] !== undefined) {
                    return parseFloat(answers[val].toString().replace(/,/g, ''));
                }
                
                return 0;
            };

            let computedValue = 0;

            if (operation === 'sum') {
                const sum = dependsOn.reduce((acc, key) => acc + clean(key), 0);
                computedValue = sum;
                return (
                    <div className="p-2 text-sm font-bold text-blue-700 bg-blue-50 border border-blue-100 rounded text-center">
                        {sum.toLocaleString()}
                    </div>
                );
            }

            // Default: Percentage (Div)
            let val1 = clean(dependsOn[0]);
            let val2 = clean(dependsOn[1]);
            
            let display = "—";
            if (val2 !== 0) {
                const pct = (val1 / val2) * 100;
                display = pct.toFixed(1) + "%";
            }

            return (
                <div className="p-2 text-sm font-bold text-blue-700 bg-blue-50 border border-blue-100 rounded text-center">
                    {display}
                </div>
            );
        };

        const FlexibleTable = ({ headers, rows, views, answers, handleInputChange, setFocusedInput, showKey }) => {
            const [activeView, setActiveView] = React.useState(views ? Object.keys(views)[0] : null);

            let renderHeaders = headers;
            let renderRows = rows;
            let textContent = null;
            
            if (views) {
                renderHeaders = views[activeView].headers;
                renderRows = views[activeView].rows;
                textContent = views[activeView].textContent;
            }

            return (
                <div>
                    {views && (
                        <div className="flex border-b border-gray-200 mb-4">
                            {Object.keys(views).map(viewKey => (
                                <button
                                    key={viewKey}
                                    onClick={() => setActiveView(viewKey)}
                                    className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
                                        activeView === viewKey 
                                        ? 'border-blue-500 text-blue-600' 
                                        : 'border-transparent text-gray-500 hover:text-gray-700'
                                    }`}
                                >
                                    {viewKey === 'PH' ? 'Parker Hannifin' : 'Illinois Tool Works'}
                                </button>
                            ))}
                        </div>
                    )}
                    
                    {textContent && <TextBlock content={textContent} />}

                    <div className="overflow-x-auto border border-gray-200 rounded-lg">
                        <table className="w-full text-left border-collapse">
                            <thead>
                                <tr className="bg-gray-100 text-sm uppercase text-gray-600">
                                    {renderHeaders.map((h, i) => (
                                        <th key={i} className="p-3 border-b border-gray-200 font-bold">{h}</th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody>
                                {renderRows.map((row, rIdx) => (
                                    <tr key={rIdx} className="hover:bg-gray-50 border-b border-gray-100 last:border-0">
                                        {row.map((cell, cIdx) => (
                                            <td key={cIdx} className="p-2 align-middle">
                                                {cell.type === 'text' && (
                                                    <span className="text-sm font-medium text-gray-700">{cell.value}</span>
                                                )}
                                                {cell.type === 'static' && (
                                                    <span className="text-sm text-gray-500 font-mono block text-center bg-gray-50 p-1 rounded">
                                                        {cell.value}
                                                    </span>
                                                )}
                                                {cell.type === 'input' && (
                                                    <div className="flex flex-col">
                                                        <SmartInput
                                                            id={cell.id}
                                                            correct={cell.correct}
                                                            isPct={cell.isPct}
                                                            suffix={cell.suffix}
                                                            value={answers[cell.id]}
                                                            onChange={handleInputChange}
                                                            onFocus={setFocusedInput}
                                                            showKey={false} 
                                                            compact={true}
                                                        />
                                                        {showKey && (
                                                            <div className="text-xs text-purple-700 font-bold mt-1 text-center">
                                                                {d(cell.correct)}{cell.suffix || ''}
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                                {cell.type === 'computed' && (
                                                    <ComputedCell dependsOn={cell.dependsOn} operation={cell.operation} answers={answers} />
                                                )}
                                            </td>
                                        ))}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const Sidebar = ({ onDataClick, width }) => {
            const [openCompany, setOpenCompany] = React.useState('PH');

            // Generate header years dynamically based on the first row of data
            const getYears = (rows) => {
                if (!rows || rows.length === 0) return ['2022', '2021'];
                return Object.keys(rows[0]).filter(k => k !== 'account').sort().reverse();
            };

            return (
                <div 
                    style={{ width: width }}
                    className="bg-white border-r border-gray-200 h-full flex flex-col overflow-hidden shadow-lg z-10 shrink-0"
                >
                    <div className="p-4 bg-gray-800 text-white flex items-center gap-2">
                        <Icon name="database" size={20} />
                        <h2 className="font-bold">Reference Data</h2>
                    </div>
                    <div className="p-2 bg-blue-50 text-xs text-blue-800 border-b border-blue-100">
                        <p className="flex gap-1 items-center">
                            <Icon name="mouse-pointer-click" size={14} />
                            Click any number to insert it into your calculation.
                        </p>
                    </div>
                    <div className="flex-1 overflow-y-auto scrollbar-thin p-2 overflow-x-auto">
                        {Object.entries(RAW_DATA).map(([company, statements]) => (
                            <div key={company} className="mb-4 border border-gray-200 rounded-lg overflow-hidden">
                                <button 
                                    onClick={() => setOpenCompany(openCompany === company ? null : company)}
                                    className="w-full p-3 bg-gray-100 font-bold flex justify-between items-center hover:bg-gray-200"
                                >
                                    {company} Data
                                    <Icon name={openCompany === company ? "chevron-up" : "chevron-down"} size={16} />
                                </button>
                                
                                {openCompany === company && (
                                    <div className="bg-white">
                                        {Object.entries(statements).map(([stmtName, rows]) => {
                                            const years = getYears(rows);
                                            return (
                                                <div key={stmtName} className="border-b last:border-0">
                                                    <div className="px-3 py-2 bg-gray-50 text-xs font-bold text-gray-500 uppercase tracking-wider">
                                                        {stmtName}
                                                    </div>
                                                    {/* Header Row for Years */}
                                                    <div className="flex justify-between px-3 py-1 bg-gray-100 text-[10px] font-bold text-gray-500 border-b border-gray-200">
                                                        <div className="flex-1 min-w-[120px]">Account</div>
                                                        <div className="flex gap-4">
                                                            {years.map(year => (
                                                                <div key={year} className="w-24 text-center">{year}</div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                    {rows.map((row, idx) => (
                                                        <div key={idx} className="flex justify-between items-center px-3 py-2 border-b last:border-0 hover:bg-yellow-50 text-xs group cursor-pointer transition-colors">
                                                            <span className="text-gray-700 whitespace-nowrap mr-4 font-medium flex-1 min-w-[120px]" title={row.account}>{row.account}</span>
                                                            <div className="flex gap-4 shrink-0">
                                                                {years.map(year => (
                                                                    <button
                                                                        key={year}
                                                                        onClick={() => onDataClick(row[year])}
                                                                        className="w-24 text-right text-blue-600 hover:text-blue-800 font-mono text-xs p-1"
                                                                        title={`Insert ${year} value`}
                                                                    >
                                                                        {row[year] !== undefined ? row[year].toLocaleString() : '-'}
                                                                    </button>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [answers, setAnswers] = React.useState({});
            const [focusedInput, setFocusedInput] = React.useState(null);
            const [instructorMode, setInstructorMode] = React.useState(false);
            const [showLogin, setShowLogin] = React.useState(false);
            const [password, setPassword] = React.useState('');
            const [confirmation, setConfirmation] = React.useState({ isOpen: false, message: '', onConfirm: null });
            
            // Resizing State
            const [sidebarWidth, setSidebarWidth] = React.useState(420); // Default wider
            const [isResizing, setIsResizing] = React.useState(false);

            React.useEffect(() => {
                const handleMouseMove = (e) => {
                    if (isResizing) {
                        const newWidth = Math.max(200, Math.min(e.clientX, 800)); // Constraints
                        setSidebarWidth(newWidth);
                    }
                };

                const handleMouseUp = () => {
                    setIsResizing(false);
                };

                if (isResizing) {
                    window.addEventListener('mousemove', handleMouseMove);
                    window.addEventListener('mouseup', handleMouseUp);
                }

                return () => {
                    window.removeEventListener('mousemove', handleMouseMove);
                    window.removeEventListener('mouseup', handleMouseUp);
                };
            }, [isResizing]);

            const handleDataClick = (value) => {
                if (!focusedInput) return;
                
                const currentVal = answers[focusedInput] || '';
                let newVal = currentVal.toString();

                // Append logic
                if (/[\+\-\*\/]$/.test(newVal)) {
                    newVal += value;
                } else if (newVal === '') {
                    newVal = value.toString();
                } else {
                    newVal += `+${value}`;
                }

                setAnswers(prev => ({ ...prev, [focusedInput]: newVal }));

                // Focus restoration logic: Keep focus so user can type next operator immediately
                setTimeout(() => {
                    const inputEl = document.getElementById(focusedInput);
                    if (inputEl) {
                        inputEl.focus();
                        // Move cursor to end
                        const len = inputEl.value.length;
                        inputEl.setSelectionRange(len, len);
                    }
                }, 0);
            };

            const handleInputChange = (id, val) => {
                setAnswers(prev => ({ ...prev, [id]: val }));
            };

            const login = () => {
                // Password: OAP5-Key9R (Base64: T0FQNS1LZXk5Ug==)
                if (btoa(password) === 'T0FQNS1LZXk5Ug==') {
                    setInstructorMode(true);
                    setShowLogin(false);
                    setPassword('');
                } else {
                    alert('Incorrect password');
                }
            };

            const autoFill = () => {
                const newAnswers = { ...answers };
                _DATA_MATRIX.forEach(sec => {
                    sec.subsections.forEach(sub => {
                        if (sub.flexibleTable) {
                            if(sub.flexibleTable.rows) {
                                sub.flexibleTable.rows.forEach(row => {
                                    row.forEach(cell => { if(cell.type === 'input') newAnswers[cell.id] = d(cell.correct); });
                                });
                            }
                            if(sub.flexibleTable.views) {
                                Object.values(sub.flexibleTable.views).forEach(view => {
                                    view.rows.forEach(row => {
                                        row.forEach(cell => { if(cell.type === 'input') newAnswers[cell.id] = d(cell.correct); });
                                    });
                                });
                            }
                        } else if (sub.questions) {
                            sub.questions.forEach(q => {
                                if (q.type === 'multiselect') {
                                    newAnswers[q.id] = d(q.correct);
                                } else if (q.type === 'choice') {
                                    newAnswers[q.id] = d(q.correct);
                                } else {
                                    newAnswers[q.id] = d(q.correct);
                                }
                            });
                        }
                    });
                });
                setAnswers(newAnswers);
            };

            const performClear = () => {
                 setAnswers({}); 
                 setInstructorMode(false);
                 setConfirmation({ isOpen: false, message: '', onConfirm: null });
            };

            const clearAll = () => {
                setConfirmation({
                    isOpen: true,
                    message: "Are you sure you want to clear all answers? This will also exit Instructor Mode.",
                    onConfirm: performClear
                });
            };

            const downloadWork = () => {
                let content = "Financial Reporting Simulation - Student Work\n\n";
                _DATA_MATRIX.forEach(sec => {
                    content += `--- ${sec.title} ---\n`;
                    sec.subsections.forEach(sub => {
                        content += `  [${sub.title}]\n`;
                        if (sub.flexibleTable) {
                             if(sub.flexibleTable.rows) {
                                 sub.flexibleTable.rows.forEach(row => {
                                    row.forEach(cell => {
                                        if(cell.type === 'input') {
                                             content += `    ${cell.id}: ${answers[cell.id] || '(No Answer)'}\n`;
                                        }
                                    });
                                 });
                             }
                             if(sub.flexibleTable.views) {
                                 Object.entries(sub.flexibleTable.views).forEach(([viewName, view]) => {
                                     content += `    [View: ${viewName}]\n`;
                                     view.rows.forEach(row => {
                                        row.forEach(cell => {
                                            if(cell.type === 'input') {
                                                 content += `      ${cell.id}: ${answers[cell.id] || '(No Answer)'}\n`;
                                            }
                                        });
                                     });
                                 });
                             }
                        } else if (sub.questions) {
                            sub.questions.forEach(q => {
                                content += `    ${q.label}: ${answers[q.id] || '(No Answer)'}\n`;
                            });
                        }
                    });
                    content += "\n";
                });

                const element = document.createElement("a");
                const file = new Blob([content], {type: 'text/plain'});
                element.href = URL.createObjectURL(file);
                element.download = "financial_simulation_work.txt";
                document.body.appendChild(element);
                element.click();
            };

            return (
                <div className="flex h-screen flex-row overflow-hidden font-sans text-gray-800">
                    {/* Sidebar */}
                    <Sidebar onDataClick={handleDataClick} width={sidebarWidth} />

                    {/* Resizer Handle */}
                    <div 
                        className={`resizer ${isResizing ? 'active' : ''}`} 
                        onMouseDown={() => setIsResizing(true)}
                    ></div>

                    {/* Main Content */}
                    <div className="flex-1 flex flex-col h-full bg-white relative min-w-0">
                        {/* Instructor Toolbar */}
                        {instructorMode && (
                            <div className="bg-purple-600 text-white p-2 flex justify-between items-center shadow-md z-20 sticky top-0">
                                <div className="flex items-center gap-2 font-bold">
                                    <Icon name="graduation-cap" className="text-white" />
                                    Instructor Mode Active
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={autoFill} className="bg-white text-purple-700 px-3 py-1 rounded text-sm font-bold hover:bg-gray-100 flex items-center gap-1">
                                        <Icon name="wand-2" size={14} /> Auto-Fill Key
                                    </button>
                                    <button onClick={clearAll} className="bg-red-500 text-white px-3 py-1 rounded text-sm font-bold hover:bg-red-600 flex items-center gap-1">
                                        <Icon name="trash-2" size={14} /> Clear & Exit
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* Header */}
                        <header className="border-b border-gray-200 p-4 bg-white flex flex-col md:flex-row justify-between items-center gap-4 shadow-sm z-10">
                            <div>
                                <h1 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                                    <Icon name="calculator" className="text-blue-600" />
                                    Financial Analysis Simulation
                                </h1>
                                <div className="text-sm text-gray-500 mt-1 flex gap-4">
                                    <a href="https://www.sec.gov/ix?doc=/Archives/edgar/data/0000076334/000007633422000034/ph-20220630.htm" target="_blank" className="text-blue-600 hover:underline flex items-center gap-1">
                                        <Icon name="external-link" size={12} /> PH 10-K
                                    </a>
                                    <a href="https://www.sec.gov/ix?doc=/Archives/edgar/data/0000049826/000004982623000008/itw-20221231.htm" target="_blank" className="text-blue-600 hover:underline flex items-center gap-1">
                                        <Icon name="external-link" size={12} /> ITW 10-K
                                    </a>
                                </div>
                            </div>

                            <div className="flex gap-2">
                                <button 
                                    onClick={() => setShowLogin(true)}
                                    className="px-2 py-2 text-gray-400 hover:text-gray-600 rounded flex items-center gap-2 opacity-50 hover:opacity-100"
                                    title="Instructor Access"
                                >
                                    <Icon name="lock" size={16} />
                                </button>
                                <button 
                                    onClick={downloadWork}
                                    className="px-4 py-2 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 shadow flex items-center gap-2"
                                >
                                    <Icon name="save" size={16} /> Save Work
                                </button>
                            </div>
                        </header>

                        {/* Content Area */}
                        <div className="flex-1 overflow-y-auto p-6 scrollbar-thin bg-gray-50">
                            <div className="max-w-5xl mx-auto space-y-8 pb-12">
                                {_DATA_MATRIX.map((sec) => (
                                    <div key={sec.id} className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                                        <h2 className="text-xl font-bold text-gray-800 mb-6 border-b pb-3 flex items-center gap-2">
                                            <Icon name="hash" size={24} className="text-blue-500" />
                                            {sec.title}
                                        </h2>
                                        
                                        <div className="space-y-8">
                                            {sec.subsections.map((sub, subIdx) => (
                                                <div key={subIdx} className="bg-white rounded-md">
                                                    <h3 className="text-md font-bold text-gray-800 mb-4 flex items-center gap-2">
                                                        <span className="bg-gray-100 text-gray-600 py-1 px-2 rounded text-xs uppercase tracking-wide border border-gray-200">
                                                            Section {sub.title.split(' ')[0]}
                                                        </span>
                                                        {sub.title.split(' ').slice(1).join(' ')}
                                                    </h3>
                                                    
                                                    {/* Guidance Block */}
                                                    <GuidanceBlock guidance={sub.guidance} openQuestions={sub.openQuestions} />

                                                    {/* Text Block */}
                                                    {sub.textContent && <TextBlock content={sub.textContent} />}

                                                    {/* Render Table or Standard Inputs */}
                                                    {sub.flexibleTable ? (
                                                        <FlexibleTable 
                                                            headers={sub.flexibleTable.headers}
                                                            rows={sub.flexibleTable.rows}
                                                            views={sub.flexibleTable.views}
                                                            answers={answers}
                                                            handleInputChange={handleInputChange}
                                                            setFocusedInput={setFocusedInput}
                                                            showKey={instructorMode}
                                                        />
                                                    ) : (
                                                        <div className={`grid gap-4 pl-4 border-l-2 border-gray-100 ${sub.gridCols === 2 ? 'grid-cols-1 md:grid-cols-2' : 'grid-cols-1'}`}>
                                                            {sub.questions && sub.questions.map(q => (
                                                                <div key={q.id}>
                                                                    {q.type === 'multiselect' ? (
                                                                        <MultiSelect
                                                                            id={q.id}
                                                                            label={q.label}
                                                                            options={q.options}
                                                                            correct={q.correct}
                                                                            value={answers[q.id]}
                                                                            onChange={handleInputChange}
                                                                            showKey={instructorMode}
                                                                        />
                                                                    ) : q.type === 'choice' ? (
                                                                        <ChoiceInput
                                                                            id={q.id}
                                                                            label={q.label}
                                                                            correct={q.correct}
                                                                            value={answers[q.id]}
                                                                            onChange={handleInputChange}
                                                                            showKey={instructorMode}
                                                                        />
                                                                    ) : (
                                                                        <SmartInput
                                                                            id={q.id}
                                                                            label={q.label}
                                                                            correct={q.correct}
                                                                            isPct={q.isPct}
                                                                            suffix={q.suffix}
                                                                            value={answers[q.id]}
                                                                            onChange={handleInputChange}
                                                                            onFocus={setFocusedInput}
                                                                            showKey={instructorMode}
                                                                        />
                                                                    )}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Confirmation Modal */}
                        {confirmation.isOpen && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 fade-in">
                                <div className="bg-white p-6 rounded-lg shadow-xl w-80">
                                    <h3 className="font-bold text-lg mb-4 text-gray-800">Confirm Action</h3>
                                    <p className="text-sm text-gray-600 mb-6">{confirmation.message}</p>
                                    <div className="flex justify-end gap-2">
                                        <button onClick={() => setConfirmation({ isOpen: false, message: '', onConfirm: null })} className="px-3 py-1 text-sm text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                                        <button onClick={confirmation.onConfirm} className="px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-sm font-medium">Confirm</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Login Modal */}
                        {showLogin && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 fade-in">
                                <div className="bg-white p-6 rounded-lg shadow-xl w-80">
                                    <h3 className="font-bold text-lg mb-4 flex items-center gap-2">
                                        <Icon name="shield-check" className="text-purple-600" />
                                        Instructor Access
                                    </h3>
                                    <input 
                                        type="password" 
                                        placeholder="Password"
                                        className="w-full border p-2 rounded mb-4 outline-none focus:border-purple-500"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        onKeyDown={(e) => e.key === 'Enter' && login()}
                                    />
                                    <div className="flex justify-end gap-2">
                                        <button onClick={() => setShowLogin(false)} className="px-3 py-1 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                                        <button onClick={login} className="px-3 py-1 bg-purple-600 text-white rounded hover:bg-purple-700">Unlock</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
