<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Financial Statement Analysis Simulation - Parker Hannifin</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; user-select: none; -webkit-tap-highlight-color: transparent; }
        .input-correct { @apply bg-green-50 border-green-500 text-green-700; }
        .input-incorrect { @apply bg-white border-gray-300; }
        /* Calculator Glassmorphism */
        .calc-glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1em;
        }
        .clickable-cell {
            cursor: pointer;
            transition: background-color 0.15s ease;
        }
        .clickable-cell:hover {
            background-color: #dbeafe; /* bg-blue-100 */
            color: #1e40af; /* text-blue-800 */
            font-weight: 600;
        }
        .active-input-ring {
            box-shadow: 0 0 0 2px #3b82f6; /* ring-blue-500 */
        }
        /* Custom Radio Button */
        input[type="radio"]:checked + span {
            color: #2563eb;
            font-weight: 600;
        }
        /* Resizer Handle */
        .resizer {
            width: 5px;
            cursor: col-resize;
            background: transparent;
            transition: background 0.2s;
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            z-index: 50;
        }
        .resizer:hover, .resizer.active {
            background: #3b82f6;
        }
        /* Mobile overrides for sidebar width */
        @media (max-width: 768px) {
            #sidebar-container {
                width: 80% !important;
                max-width: 320px;
            }
            .resizer { display: none; }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen overflow-hidden" oncontextmenu="return false;">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- ICONS (Lucide Style SVGs) ---
        const Icons = {
            Calculator: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="14"/><line x1="16" x2="16" y1="18" y2="18"/><line x1="12" x2="12" y1="14" y2="14"/><line x1="12" x2="12" y1="18" y2="18"/><line x1="8" x2="8" y1="14" y2="14"/><line x1="8" x2="8" y1="18" y2="18"/></svg>,
            BookOpen: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
            PieChart: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>,
            FileText: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>,
            BarChart: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>,
            Unlock: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>,
            Lock: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            HelpCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            ChevronRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"/></svg>,
            ChevronDown: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"/></svg>,
            Database: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>,
            ExternalLink: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>,
            Link: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            Menu: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        };

        // --- GLOBAL UTILS ---
        const parseMoney = (str) => {
            if (!str) return 0;
            const clean = str.replace(/,/g, '');
            if (clean.includes('(')) {
                return -parseFloat(clean.replace(/[()]/g, ''));
            }
            return parseFloat(clean);
        };
        const formatMoney = (num) => num.toLocaleString();

        const evaluateMathExpression = (expression) => {
            try {
                // Remove commas for calculation
                let cleanExpr = expression.replace(/,/g, '');
                // Handle percentage input: 20% -> (20/100)
                cleanExpr = cleanExpr.replace(/(\d+(?:\.\d+)?)%/g, '($1/100)');
                
                // Check for allowed characters (numbers, operators, parens, spaces) to prevent injection
                if (!/^[\d\.\+\-\*\/\(\)\s]+$/.test(cleanExpr)) {
                    return expression; // Return original if invalid chars found
                }
                // Evaluate
                // eslint-disable-next-line no-eval
                const result = eval(cleanExpr);
                if (!isFinite(result) || isNaN(result)) return expression;
                
                // Format: If decimal, limit to 1 place, otherwise integer
                if (Number.isInteger(result)) {
                    return result.toString();
                } else {
                    return result.toFixed(1).toString();
                }
            } catch (e) {
                return expression; // Return original on error
            }
        };

        // --- GLOBAL DATA ---
        const ASSET_ITEMS_2022 = [
            { id: "cash", label: "Cash and cash equivalents", value: "535,799", correctType: "current" },
            { id: "mkt", label: "Marketable securities and other investments", value: "27,862", correctType: "current" },
            { id: "ar", label: "Trade accounts receivable, net", value: "2,341,504", correctType: "current" },
            { id: "notes", label: "Non-trade and notes receivable", value: "543,757", correctType: "current" },
            { id: "inv", label: "Inventories", value: "2,214,553", correctType: "current" },
            { id: "pre", label: "Prepaid expenses and other", value: "6,383,169", correctType: "current" },
            { id: "ppe", label: "Property, plant and equipment, net", value: "2,122,758", correctType: "non-current" },
            { id: "def", label: "Deferred income taxes", value: "110,585", correctType: "non-current" },
            { id: "invest", label: "Investments and other assets", value: "788,057", correctType: "non-current" },
            { id: "int", label: "Intangible assets, net", value: "3,135,817", correctType: "non-current" },
            { id: "good", label: "Goodwill", value: "7,740,082", correctType: "non-current" },
        ];

        const LIAB_EQ_ITEMS_2022 = [
            { id: "notes_pay", label: "Notes payable and long-term debt payable within one year", value: "1,724,310", correctType: "current" },
            { id: "ap", label: "Accounts payable, trade", value: "1,731,925", correctType: "current" },
            { id: "acc_pay", label: "Accrued payrolls and other compensation", value: "470,132", correctType: "current" },
            { id: "acc_tax", label: "Accrued domestic and foreign taxes", value: "250,292", correctType: "current" },
            { id: "curr_lease", label: "Current operating lease liabilities", value: "36,023", correctType: "current" },
            { id: "other_acc", label: "Other accrued liabilities", value: "1,646,636", correctType: "current" },
            { id: "lt_debt", label: "Long-term debt", value: "9,755,825", correctType: "non-current" },
            { id: "pension", label: "Pensions and other postretirement benefits", value: "639,939", correctType: "non-current" },
            { id: "def_tax_l", label: "Deferred income taxes (Liab)", value: "307,044", correctType: "non-current" },
            { id: "lt_lease", label: "Long-term operating lease liabilities", value: "100,337", correctType: "non-current" },
            { id: "other_l", label: "Other liabilities", value: "421,560", correctType: "non-current" },
            { id: "common", label: "Common stock", value: "90,523", correctType: "equity" },
            { id: "add_cap", label: "Additional capital", value: "327,307", correctType: "equity" },
            { id: "ret_earn", label: "Retained earnings", value: "15,661,808", correctType: "equity" },
            { id: "aoci", label: "Accumulated other comprehensive (loss)", value: "(1,543,198)", correctType: "equity" },
            { id: "treasury", label: "Treasury stock", value: "(5,688,429)", correctType: "equity" },
            { id: "nci", label: "Noncontrolling interests", value: "11,909", correctType: "equity" },
        ];

        const CASE_DATA = {
            ph_bs: {
                title: "PH Balance Sheet (Exh 1.3)",
                unit: "$ thousands",
                headers: ["Item", "June 30, 2022", "June 30, 2021"],
                rows: [
                    ["Current Assets", "", ""],
                    ["Cash and cash equivalents", "535,799", "733,117"],
                    ["Marketable securities and other investments", "27,862", "39,116"],
                    ["Trade accounts receivable, net", "2,341,504", "2,183,594"],
                    ["Non-trade and notes receivable", "543,757", "326,315"],
                    ["Inventories", "2,214,553", "2,090,642"],
                    ["Prepaid expenses and other", "6,383,169", "243,966"],
                    ["Total current assets", "12,046,644", "5,616,750"],
                    ["", "", ""],
                    ["Property, plant and equipment", "5,897,955", "6,040,220"],
                    ["Less: Accumulated depreciation", "3,775,197", "3,773,744"],
                    ["Property, plant and equipment, net", "2,122,758", "2,266,476"],
                    ["Deferred income taxes", "110,585", "104,251"],
                    ["Investments and other assets", "788,057", "774,239"],
                    ["Intangible assets, net", "3,135,817", "3,519,797"],
                    ["Goodwill", "7,740,082", "8,059,687"],
                    ["Total Assets", "25,943,943", "20,341,200"],
                    ["", "", ""],
                    ["Current Liabilities", "", ""],
                    ["Notes payable and long-term debt payable within one year", "1,724,310", "2,824"],
                    ["Accounts payable, trade", "1,731,925", "1,667,878"],
                    ["Accrued payrolls and other compensation", "470,132", "507,027"],
                    ["Accrued domestic and foreign taxes", "250,292", "236,384"],
                    ["Current operating lease liabilities", "36,023", "40,193"],
                    ["Other accrued liabilities", "1,646,636", "642,197"],
                    ["Total current liabilities", "5,859,318", "3,096,503"],
                    ["", "", ""],
                    ["Long-term debt", "9,755,825", "6,582,053"],
                    ["Pensions and other postretirement benefits", "639,939", "1,055,638"],
                    ["Deferred income taxes", "307,044", "553,981"],
                    ["Long-term operating lease liabilities", "100,337", "93,904"],
                    ["Other liabilities", "421,560", "545,451"],
                    ["Total Liabilities", "17,084,023", "11,927,530"],
                    ["", "", ""],
                    ["Shareholders' Equity", "", ""],
                    ["Serial preferred stock, $.50 par value", "0", "0"],
                    ["Common stock, $.50 par value", "90,523", "90,523"],
                    ["Additional capital", "327,307", "329,619"],
                    ["Retained earnings", "15,661,808", "14,915,497"],
                    ["Accumulated other comprehensive (loss)", "(1,543,198)", "(1,566,727)"],
                    ["Treasury stock", "(5,688,429)", "(5,370,605)"],
                    ["Total Shareholders' Equity", "8,848,011", "8,398,307"],
                    ["Noncontrolling interests", "11,909", "15,363"],
                    ["Total Equity", "8,859,920", "8,413,670"],
                    ["Total Liabilities and Equity", "25,943,943", "20,341,200"],
                    ["", "", ""],
                      
                ]
            },
            ph_is: {
                title: "PH Income Statement (Exh 1.4)",
                unit: "$ thousands (except per share)",
                headers: ["Item", "June 30, 2022", "June 30, 2021"],
                rows: [
                    ["Net Sales", "15,861,608", "14,347,640"],
                    ["Cost of sales", "11,387,267", "10,449,680"],
                    ["Gross profit", "4,474,341", "3,897,960"],
                    ["Selling, general and administrative expenses", "1,627,116", "1,527,302"],
                    ["Gain on disposal of assets", "(7,121)", "(109,332)"],
                    ["Operating income", "2,854,346", "2,479,990"],
                    ["Interest expense", "255,252", "250,036"],
                    ["Other expense (income), net", "984,868", "(17,003)"],
                    ["Income before income taxes", "1,614,226", "2,246,957"],
                    ["Income taxes", "298,040", "500,096"],
                    ["Net Income", "1,316,186", "1,746,861"],
                    ["Less: Noncontrolling interest in subsidiaries' earnings", "581", "761"],
                    ["Net Income Attributable to Common Shareholders", "1,315,605", "1,746,100"],
                    ["Earnings per Share - Basic ($)", "10.24", "13.54"],
                    ["Earnings per Share - Diluted ($)", "10.09", "13.35"]
                ]
            },
            ph_scf: {
                title: "PH Cash Flow (Exh 1.6)",
                unit: "$ thousands",
                headers: ["Item", "2022", "2021"],
                rows: [
                    ["Cash Flows From Operating Activities", "", ""],
                    ["Net Income", "1,316,186", "1,746,861"],
                    ["Adjustments to reconcile net income to net cash provided by operating activities:", "", ""],
                    ["Depreciation", "257,314", "269,943"],
                    ["Amortization", "314,450", "325,447"],
                    ["Stock incentive plan compensation", "137,093", "121,483"],
                    ["Deferred income taxes", "(351,201)", "(51,500)"],
                    ["Foreign currency transaction gain", "(39,987)", "(10,948)"],
                    ["Gain on sale of property, plant and equipment", "(5,727)", "(109,332)"],
                    ["Gain on sale of businesses", "(1,394)", "0"],
                    ["Gain on investments", "(3,972)", "(12,616)"],
                    ["Loss (gain) on marketable securities", "5,131", "(11,570)"],
                    ["Other", "70,443", "14,424"],
                    ["Changes in assets and liabilities:", "", ""],
                    ["Accounts receivable", "(179,126)", "(298,511)"],
                    ["Inventories", "(212,134)", "(85,597)"],
                    ["Prepaid expenses and other", "37,630", "(25,508)"],
                    ["Other assets", "(11,167)", "(8,779)"],
                    ["Accounts payable, trade", "131,384", "526,781"],
                    ["Accrued payrolls and other compensation", "(15,524)", "72,412"],
                    ["Accrued domestic and foreign taxes", "32,514", "36,552"],
                    ["Other accrued liabilities", "999,831", "11,397"],
                    ["Pensions and other postretirement benefits", "1,822", "17,875"],
                    ["Other liabilities", "(41,836)", "46,187"],
                    ["Net cash provided by operating activities", "2,441,730", "2,575,001"],
                    ["", "", ""],
                    ["Cash Flows From Investing Activities", "", ""],
                    ["Acquisitions (net of cash acquired of $82,192 in 2020)", "0", "0"],
                    ["Capital expenditures", "(230,044)", "(209,957)"],
                    ["Proceeds from sale of property, plant and equipment", "39,353", "140,590"],
                    ["Proceeds from sale of businesses", "3,366", "0"],
                    ["Purchase of marketable securities and other investments", "(27,895)", "(34,809)"],
                    ["Maturities and sales of marketable securities and other investments", "31,809", "79,419"],
                    ["Other", "(235,426)", "24,744"],
                    ["Net cash used in investing activities", "(418,837)", "(13)"],
                    ["", "", ""],
                    ["Cash Flows From Financing Activities", "", ""],
                    ["Proceeds from exercise of stock options", "2,831", "4,684"],
                    ["Payments for common shares", "(460,056)", "(218,818)"],
                    ["Acquisition of noncontrolling interests", "0", "0"],
                    ["Proceeds from (payments of) notes payable, net", "1,422,026", "(723,496)"],
                    ["Proceeds from long-term borrowings", "3,598,056", "1,213"],
                    ["Payments for long-term borrowings", "(18,737)", "(1,211,748)"],
                    ["Financing fees paid", "(58,629)", "0"],
                    ["Dividends paid", "(569,855)", "(475,174)"],
                    ["Net cash provided by (used in) financing activities", "3,915,636", "(2,623,339)"],
                    ["", "", ""],
                    ["Effect of exchange rate changes on cash", "(23,770)", "95,954"],
                    ["Net increase (decrease) in cash and cash equivalents and restricted cash", "5,914,759", "47,603"],
                    ["Cash, cash equivalents and restricted cash at beginning of year", "733,117", "685,514"],
                    ["Cash, cash equivalents and restricted cash at end of year", "6,647,876", "733,117"],
                    ["", "", ""],
                    ["Supplemental Information", "", ""],
                    ["Cash paid during the year for:", "", ""],
                    ["Interest", "240,313", "236,979"],
                    ["Income taxes", "549,223", "485,885"]
                ]
            }
        };

        // --- DATA OBFUSCATION ---
        const d = (s) => { try { return atob(s); } catch (e) { return s; } };

        // Construct _DATA_MATRIX at runtime to include all CASE_DATA values plus obfuscated specific answers
        const _DATA_MATRIX = {
            // Intro
            "intro_fiscal_end": "SnVuZSAzMA==", "intro_auditor": "RGVsb2l0dGU=", "intro_opinion": "VW5xdWFsaWZpZWQ=",
            // Ratios & Misc
            "m3_cs_bs_sta_pct": "NDYuNA==", "m3_cs_bs_lta_pct": "NTMuNg==", "m3_cs_bs_ta_pct": "MTAwLjA=",
            "m3_cs_bs_stl_pct": "MjIuNg==", "m3_cs_bs_ltl_pct": "NDMuMw==", "m3_cs_bs_te_pct": "MzQuMQ==",
            "m3_cs_is_sales_22": "MTAwLjA=", "m3_cs_is_sales_21": "MTAwLjA=",
            "m3_cs_is_cos_22": "NzEuOA==", "m3_cs_is_cos_21": "NzIuOA==",
            "m3_cs_is_gp_22": "MjguMg==", "m3_cs_is_gp_21": "MjcuMg==",
            "m3_cs_is_sga_22": "MTAuMw==", "m3_cs_is_sga_21": "MTAuNg==", // Fixed SG&A to 10.3 (MTAuMw==)
            "m3_cs_is_gain_22": "MC4w", "m3_cs_is_gain_21": "LTAuOA==",
            "m3_cs_is_opinc_22": "MTguMA==", "m3_cs_is_opinc_21": "MTcuMw==",
            "m3_cs_is_int_exp_22": "MS42", "m3_cs_is_int_exp_21": "MS43",
            "m3_cs_is_other_22": "Ni4y", "m3_cs_is_other_21": "LTAuMQ==",
            "m3_cs_is_ibt_22": "MTAuMg==", "m3_cs_is_ibt_21": "MTUuNw==",
            "m3_cs_is_tax_22": "MS45", "m3_cs_is_tax_21": "My41",
            "m3_cs_is_ni_22": "OC4z", "m3_cs_is_ni_21": "MTIuMg==",
            "m3_cs_is_ncin_22": "MC4w", "m3_cs_is_ncin_21": "MC4w",
            "m3_cs_is_nic_22": "OC4z", "m3_cs_is_nic_21": "MTIuMg==",
            "m3_ph_sta_p_22": "NDYuNA==", "m3_ph_lta_p_22": "NTMuNg==",
            "m3_ph_le_22": "MS45Mw==", "m3_ph_roa_22": "NS43",
            "m4_ph_mkt_cap": "MzE3NDUzMTY=",
            // Simplified BS Amounts (Added Answer Keys)
            "m3_cs_bs_sta_val": "MTIsMDQ2LDY0NA==", // 12,046,644
            "m3_cs_bs_lta_val": "MTMsODk3LDI5OQ==", // 13,897,299
            "m3_cs_bs_ta_val": "MjUsOTQzLDk0Mw==",  // 25,943,943
            "m3_cs_bs_stl_val": "NSw4NTksMzE4",     // 5,859,318
            "m3_cs_bs_ltl_val": "MTEsMjI0LDcwNQ==", // 11,224,705
            "m3_cs_bs_te_val": "OCw4NTksOTIw"       // 8,859,920
        };

        // Helper to populate matrix from case data (obfuscation through runtime generation)
        // This ensures the read-only values for 2021 are available
        const populateMatrix = () => {
            // Map CASE_DATA to Answer Keys
            const maps = [
                { data: CASE_DATA.ph_bs, prefix: 'm1_bs_ph' },
                { data: CASE_DATA.ph_is, prefix: 'm1_is_ph' },
                { data: CASE_DATA.ph_scf, prefix: 'm1_cf_ph' }
            ];
            
            // IS Map Logic (simplified)
            const isMap = {
                'Net Sales': 'sales', 'Cost of sales': 'cos', 'Gross profit': 'gp',
                'Selling, general and administrative expenses': 'sga', 'Gain on disposal of assets': 'gain',
                'Operating income': 'opinc', 'Interest expense': 'int_exp', 'Other expense (income), net': 'other',
                'Income before income taxes': 'ibt', 'Income taxes': 'tax', 'Net Income': 'ni',
                "Less: Noncontrolling interest in subsidiaries' earnings": 'ncin',
                "Net Income Attributable to Common Shareholders": 'nic'
            };

            // Process IS Data for M1
            CASE_DATA.ph_is.rows.forEach(row => {
                const label = row[0];
                const key = isMap[label];
                if (key) {
                    // Encode 2022 and 2021 values
                    _DATA_MATRIX[`m1_is_ph_${key}_22`] = btoa(row[1]);
                    _DATA_MATRIX[`m1_is_ph_${key}_21`] = btoa(row[2]);
                }
            });
            
            // Add specific Hardcoded BS/Equity/CF items that are simple string matches
             _DATA_MATRIX["m1_bs_ph_stl_22"] = btoa("5,859,318"); _DATA_MATRIX["m1_bs_ph_stl_21"] = btoa("3,096,503");
             _DATA_MATRIX["m1_bs_ph_ltl_22"] = btoa("11,224,705"); _DATA_MATRIX["m1_bs_ph_ltl_21"] = btoa("8,831,027");
             _DATA_MATRIX["m1_bs_ph_tl_22"] = btoa("17,084,023"); _DATA_MATRIX["m1_bs_ph_tl_21"] = btoa("11,927,530");
             _DATA_MATRIX["m1_bs_ph_te_22"] = btoa("8,859,920"); _DATA_MATRIX["m1_bs_ph_te_21"] = btoa("8,413,670");
             _DATA_MATRIX["m1_bs_ph_tle_22"] = btoa("25,943,943"); _DATA_MATRIX["m1_bs_ph_tle_21"] = btoa("20,341,200");
             
             // Equity
             _DATA_MATRIX["m1_eq_ni_re"] = btoa("1,315,605"); _DATA_MATRIX["m1_eq_ni_other"] = btoa("581");
             _DATA_MATRIX["m1_eq_div_re"] = btoa("-569,294"); _DATA_MATRIX["m1_eq_div_other"] = btoa("-561");
             _DATA_MATRIX["m1_eq_rep_ts"] = btoa("-380,334");
             _DATA_MATRIX["m1_eq_oth_cc"] = btoa("-2,312"); _DATA_MATRIX["m1_eq_oth_ts"] = btoa("62,510"); _DATA_MATRIX["m1_eq_oth_other"] = btoa("20,055");
             
             // CF
             _DATA_MATRIX["m1_cf_ph_op_22"] = btoa("2,441,730");
             _DATA_MATRIX["m1_cf_ph_inv_22"] = btoa("-418,837");
             _DATA_MATRIX["m1_cf_ph_fin_22"] = btoa("3,915,636");
             _DATA_MATRIX["m1_cf_ph_fx_22"] = btoa("-23,770");
             _DATA_MATRIX["m1_cf_ph_net_22"] = btoa("5,914,759");
             _DATA_MATRIX["m1_cf_ph_beg_22"] = btoa("733,117");
             _DATA_MATRIX["m1_cf_ph_end_22"] = btoa("6,647,876");
             
             // Articulation
             _DATA_MATRIX["m2_art_cash_op"] = btoa("2,441,730");
             _DATA_MATRIX["m2_art_cash_inv"] = btoa("-418,837");
             _DATA_MATRIX["m2_art_cash_fin"] = btoa("3,891,866"); // Adjusted
             _DATA_MATRIX["m2_art_cc_iss"] = btoa("-2,312");
             _DATA_MATRIX["m2_art_re_ni"] = btoa("1,316,186");
             _DATA_MATRIX["m2_art_re_div"] = btoa("-569,875");
             _DATA_MATRIX["m2_art_ts_rep"] = btoa("-317,824");
        };
        
        populateMatrix(); // Initialize

        // Updated Row Definitions
        const isRows = [
            { id: 'sales', label: 'Net Sales' },
            { id: 'cos', label: 'Cost of sales' },
            { type: 'total', id: 'gp', label: 'Gross profit' },
            { id: 'sga', label: 'Selling, general and administrative expenses' },
            { id: 'gain', label: 'Gain on disposal of assets' },
            { type: 'total', id: 'opinc', label: 'Operating income' },
            { id: 'int_exp', label: 'Interest expense' },
            { id: 'other', label: 'Other expense (income), net' },
            { type: 'total', id: 'ibt', label: 'Income before income taxes' },
            { id: 'tax', label: 'Income taxes' },
            { type: 'total', id: 'ni', label: 'Net Income' },
            { id: 'ncin', label: "Less: Noncontrolling interest in subsidiaries' earnings" },
            { type: 'total', id: 'nic', label: 'Net Income Attributable to Common Shareholders' },
        ];


        // --- REUSABLE COMPONENTS ---

        const SmartInput = ({ id, value, onChange, correctValue, teacherMode, placeholder = "", onFocus, isFocused, disabled = false }) => {
            const isCorrect = useMemo(() => {
                if (!value || !correctValue) return false;
                const cleanVal = String(value).toLowerCase().replace(/,/g, '').replace(/%/g, '').replace('$', '').trim();
                const cleanCorrect = String(correctValue).toLowerCase().replace(/,/g, '').trim();
                
                // Numeric comparison with 2% tolerance
                const numVal = parseMoney(String(value)); 
                const numCorrect = parseMoney(String(correctValue));
                
                if (!isNaN(numVal) && !isNaN(numCorrect)) {
                    if (numCorrect === 0) return Math.abs(numVal) < 0.1;
                    const diff = Math.abs((numVal - numCorrect) / numCorrect);
                    const absDiff = Math.abs(numVal - numCorrect);
                    return diff <= 0.02 || absDiff <= 1.0; 
                }
                
                return cleanVal === cleanCorrect;
            }, [value, correctValue]);

            const handleKeyDown = (e) => {
                if (e.key === 'Enter' || e.key === 'Tab') {
                    const newVal = evaluateMathExpression(value);
                    if (newVal !== value) {
                        onChange(id, newVal);
                    }
                }
            };

            const handleBlur = () => {
                const newVal = evaluateMathExpression(value);
                if (newVal !== value) {
                    onChange(id, newVal);
                }
            };

            if (disabled) {
                 return (
                    <div className="w-full px-2 py-1 text-base sm:text-sm text-right border border-gray-200 bg-gray-100 rounded text-slate-500 font-mono">
                        {value}
                    </div>
                );
            }

            return (
                <div className="relative w-full">
                    <input
                        id={id}
                        type="text"
                        value={value}
                        onChange={(e) => onChange(id, e.target.value)}
                        onFocus={() => onFocus && onFocus(id)}
                        onKeyDown={handleKeyDown}
                        onBlur={handleBlur}
                        className={`w-full px-2 py-1 text-base sm:text-sm text-right border rounded transition-colors focus:outline-none ${isFocused ? 'active-input-ring z-10' : ''} ${
                            value && isCorrect ? 'input-correct' : value ? 'border-red-300 bg-red-50' : 'border-gray-300'
                        }`}
                        placeholder={placeholder}
                    />
                    {value && isCorrect && (
                        <div className="absolute left-2 top-1/2 -translate-y-1/2 text-green-600 pointer-events-none">
                            <Icons.Check />
                        </div>
                    )}
                    {teacherMode && !isCorrect && (
                        <div className="absolute -top-6 right-0 bg-yellow-100 text-yellow-800 text-xs px-1 rounded shadow z-10">
                            {correctValue}
                        </div>
                    )}
                </div>
            );
        };

        const Calculator = ({ onClose }) => {
            const [display, setDisplay] = useState("0");
            const [equation, setEquation] = useState("");

            const handlePress = (val) => {
                if (val === 'C') {
                    setDisplay("0");
                    setEquation("");
                } else if (val === '=') {
                    try {
                        const parsedEq = evaluateMathExpression(equation + display);
                        setDisplay(parsedEq);
                        setEquation("");
                    } catch {
                        setDisplay("Error");
                    }
                } else if (['+', '-', '*', '/'].includes(val)) {
                    setEquation(equation + display + val);
                    setDisplay("0");
                } else {
                    setDisplay(display === "0" ? val : display + val);
                }
            };

            const btnClass = "h-12 bg-white rounded shadow text-slate-700 font-medium hover:bg-blue-50 active:bg-blue-100 transition";
            const opClass = "h-12 bg-blue-100 rounded shadow text-blue-800 font-bold hover:bg-blue-200 transition";

            return (
                <div className="fixed bottom-4 right-4 w-72 max-w-[90vw] p-4 rounded-xl border border-gray-200 z-50 calc-glass">
                    <div className="flex justify-between items-center mb-2">
                        <span className="text-xs font-semibold text-slate-500 uppercase tracking-wider">Calculator</span>
                        <button onClick={onClose} className="text-slate-400 hover:text-red-500"><Icons.X /></button>
                    </div>
                    <div className="bg-slate-800 text-green-400 font-mono text-2xl p-3 rounded mb-3 text-right overflow-hidden">
                        {display}
                    </div>
                    <div className="grid grid-cols-4 gap-2">
                        {['7','8','9','/','4','5','6','*','1','2','3','-','0','.','=','+'].map(key => (
                            <button 
                                key={key} 
                                onClick={() => handlePress(key)}
                                className={['/','*','-','+','='].includes(key) ? opClass : btnClass}
                            >
                                {key}
                            </button>
                        ))}
                        <button onClick={() => handlePress('C')} className="col-span-4 h-10 bg-red-100 text-red-600 rounded font-bold hover:bg-red-200">Clear</button>
                    </div>
                </div>
            );
        };

        const QuestionBox = ({ title, children, hint, solution, teacherMode }) => {
            const [showHint, setShowHint] = useState(false);

            return (
                <div className="bg-white border border-slate-200 rounded-lg p-4 sm:p-6 mb-6 shadow-sm">
                    <div className="flex items-start justify-between mb-4">
                        <h3 className="text-lg font-semibold text-slate-800">{title}</h3>
                        <button 
                            onClick={() => setShowHint(!showHint)} 
                            className="text-blue-500 hover:text-blue-700 flex items-center text-sm ml-2 shrink-0"
                        >
                            <Icons.HelpCircle /> <span className="ml-1 hidden sm:inline">{showHint ? 'Hide Hint' : 'Show Hint'}</span>
                        </button>
                    </div>
                    <div className="text-slate-600 mb-4 space-y-2">{children}</div>
                    
                    {showHint && (
                        <div className="bg-blue-50 p-4 rounded text-sm text-blue-800 mb-4 border-l-4 border-blue-400">
                            <strong>Hint:</strong> {hint}
                        </div>
                    )}

                    {teacherMode && (
                        <div className="bg-yellow-50 p-4 rounded text-sm text-yellow-800 border-l-4 border-yellow-400 mt-4">
                            <strong>Instructor Solution / Insight:</strong>
                            <div className="mt-1 whitespace-pre-wrap">{solution}</div>
                        </div>
                    )}
                </div>
            );
        };

        const MultipleChoiceQuestion = ({ id, title, options, correctOptionId, explanation, teacherMode, onSelect, selectedOptionId }) => {
            const isCorrect = selectedOptionId === correctOptionId;
            const [showExplanation, setShowExplanation] = useState(false);

            useEffect(() => {
                if (isCorrect) setShowExplanation(true);
            }, [isCorrect]);

            return (
                <div className="bg-white border border-slate-200 rounded-lg p-4 sm:p-6 mb-6 shadow-sm">
                    <h3 className="text-lg font-semibold text-slate-800 mb-4">{title}</h3>
                    <div className="space-y-2 mb-4">
                        {options.map((option) => (
                            <label 
                                key={option.id} 
                                className={`flex items-center p-3 rounded border cursor-pointer transition-colors ${
                                    selectedOptionId === option.id 
                                        ? (isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200')
                                        : 'hover:bg-slate-50 border-gray-200'
                                }`}
                            >
                                <input 
                                    type="radio" 
                                    name={id} 
                                    value={option.id} 
                                    checked={selectedOptionId === option.id} 
                                    onChange={() => onSelect(id, option.id)}
                                    className="mr-3 h-4 w-4 text-blue-600 shrink-0"
                                />
                                <span className={selectedOptionId === option.id ? (isCorrect ? 'text-green-800' : 'text-red-800') : 'text-slate-700'}>
                                    {option.text}
                                </span>
                                {selectedOptionId === option.id && (
                                    <span className="ml-auto pl-2">
                                        {isCorrect ? <span className="text-green-600 font-bold text-xs sm:text-sm">Correct!</span> : <span className="text-red-500 font-bold text-xs sm:text-sm">Incorrect</span>}
                                    </span>
                                )}
                            </label>
                        ))}
                    </div>
                    {(showExplanation || teacherMode) && (
                        <div className="bg-blue-50 p-4 rounded text-sm text-blue-800 border-l-4 border-blue-400">
                            <strong>Explanation:</strong> {explanation}
                        </div>
                    )}
                </div>
            );
        };

        const DataAccordion = ({ dataKey, onValueClick }) => {
            const [isOpen, setIsOpen] = useState(false);
            const data = CASE_DATA[dataKey];
            if (!data) return null;

            return (
                <div className="border border-slate-200 rounded-lg bg-white overflow-hidden shadow-sm">
                    <button 
                        onClick={() => setIsOpen(!isOpen)}
                        className="w-full flex items-center justify-between p-3 bg-slate-50 hover:bg-slate-100 transition text-sm font-semibold text-slate-700"
                    >
                        <span>{data.title}</span>
                        <div className={`transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`}>
                            <Icons.ChevronDown />
                        </div>
                    </button>
                    {isOpen && (
                        <div className="p-0 overflow-x-auto">
                             <table className="w-full text-xs text-left border-t border-slate-200">
                                <thead className="bg-slate-50 text-slate-500">
                                    <tr>
                                        {data.headers.map((h, i) => (
                                            <th key={i} className={`p-2 font-medium border-b border-slate-200 ${i>0 ? 'text-right' : ''}`}>{h}</th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {data.rows.map((row, i) => (
                                        <tr key={i} className="hover:bg-blue-50/50">
                                            <td className="p-2 font-medium text-slate-700">{row[0]}</td>
                                            {row.slice(1).map((cell, j) => (
                                                <td 
                                                    key={j} 
                                                    className="p-2 text-right text-slate-600 font-mono whitespace-nowrap clickable-cell"
                                                    onClick={() => onValueClick && onValueClick(cell)}
                                                    title="Click to insert value"
                                                >
                                                    {cell}
                                                </td>
                                            ))}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            <div className="p-2 bg-slate-50 text-[10px] text-slate-400 text-center border-t border-slate-200">
                                Values in {data.unit}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const AssetClassifier = ({ inputs, handleInputChange, teacherMode }) => {
            const calcSTA = ASSET_ITEMS_2022.reduce((acc, item) => {
                return inputs[`class_${item.id}`] === 'current' ? acc + parseMoney(item.value) : acc;
            }, 0);

            const calcLTA = ASSET_ITEMS_2022.reduce((acc, item) => {
                return inputs[`class_${item.id}`] === 'non-current' ? acc + parseMoney(item.value) : acc;
            }, 0);
            
            const CORRECT_STA = 12046644; 
            const CORRECT_LTA = 13897299;

            return (
                <div className="bg-white rounded-lg shadow-sm border border-slate-200 mb-8 overflow-hidden">
                    <div className="bg-blue-50 p-4 border-b border-blue-100">
                        <h3 className="font-bold text-blue-900">Asset Classification Challenge (2022)</h3>
                        <p className="text-sm text-blue-700 mt-1">
                            Instead of calculating totals manually, classify each line item below. 
                            The totals will update automatically.
                        </p>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm min-w-[500px]">
                            <thead className="bg-slate-50 text-slate-500 font-medium border-b border-slate-200">
                                <tr>
                                    <th className="p-3 text-left w-1/2">Balance Sheet Item (Assets)</th>
                                    <th className="p-3 text-right w-1/4">Amount ($)</th>
                                    <th className="p-3 text-left w-1/4 pl-6">Classification</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {ASSET_ITEMS_2022.map((item) => {
                                    const currentVal = inputs[`class_${item.id}`] || "";
                                    const isCorrect = currentVal === item.correctType;
                                    
                                    return (
                                        <tr key={item.id} className="hover:bg-slate-50 transition group">
                                            <td className="p-3 pl-4 font-medium text-slate-700">{item.label}</td>
                                            <td className="p-3 text-right font-mono text-slate-600">{item.value}</td>
                                            <td className="p-3 pl-6">
                                                <div className="relative">
                                                    <select
                                                        value={currentVal}
                                                        onChange={(e) => handleInputChange(`class_${item.id}`, e.target.value)}
                                                        className={`w-full p-2 pr-8 border rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 cursor-pointer appearance-none ${
                                                            currentVal && isCorrect ? 'bg-green-50 border-green-500 text-green-700' :
                                                            currentVal ? 'bg-red-50 border-red-300 text-red-700' : 'bg-white border-gray-300'
                                                        }`}
                                                    >
                                                        <option value="" disabled>Select Type...</option>
                                                        <option value="current">Current Asset</option>
                                                        <option value="non-current">Long-Term Asset</option>
                                                    </select>
                                                    {teacherMode && !isCorrect && (
                                                        <div className="absolute right-0 top-0 -mt-2 mr-2 bg-yellow-100 text-yellow-800 text-[10px] px-1 rounded shadow pointer-events-none">
                                                            {item.correctType === 'current' ? 'Curr' : 'Long'}
                                                        </div>
                                                    )}
                                                </div>
                                            </td>
                                        </tr>
                                    );
                                })}
                                
                                <tr className="bg-slate-50 border-t-2 border-slate-200 font-bold">
                                    <td className="p-3 text-right text-slate-900">Total Current Assets</td>
                                    <td className="p-3 text-right font-mono text-lg">
                                        <span className={Math.abs(calcSTA - CORRECT_STA) < 2 ? "text-green-600" : "text-slate-800"}>
                                            {formatMoney(calcSTA)}
                                        </span>
                                    </td>
                                    <td className="p-3 text-xs text-slate-500 italic pl-6 align-middle">
                                        (Auto-calculated from items marked "Current")
                                    </td>
                                </tr>
                                <tr className="bg-slate-50 border-b-2 border-slate-200 font-bold">
                                    <td className="p-3 text-right text-slate-900">Total Long-Term Assets</td>
                                    <td className="p-3 text-right font-mono text-lg">
                                        <span className={Math.abs(calcLTA - CORRECT_LTA) < 2 ? "text-green-600" : "text-slate-800"}>
                                            {formatMoney(calcLTA)}
                                        </span>
                                    </td>
                                    <td className="p-3 text-xs text-slate-500 italic pl-6 align-middle">
                                        (Auto-calculated from items marked "Long-Term")
                                    </td>
                                </tr>
                                <tr className="bg-slate-100 border-t border-slate-300 font-extrabold text-blue-900">
                                    <td className="p-3 text-right">Total Assets</td>
                                    <td className="p-3 text-right font-mono text-lg">
                                        {formatMoney(calcSTA + calcLTA)}
                                    </td>
                                    <td className="p-3"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const LiabilityEquityClassifier = ({ inputs, handleInputChange, teacherMode }) => {
            const calcSTL = LIAB_EQ_ITEMS_2022.reduce((acc, item) => {
                return inputs[`class_${item.id}`] === 'current' ? acc + parseMoney(item.value) : acc;
            }, 0);

            const calcLTL = LIAB_EQ_ITEMS_2022.reduce((acc, item) => {
                return inputs[`class_${item.id}`] === 'non-current' ? acc + parseMoney(item.value) : acc;
            }, 0);

            const calcTE = LIAB_EQ_ITEMS_2022.reduce((acc, item) => {
                return inputs[`class_${item.id}`] === 'equity' ? acc + parseMoney(item.value) : acc;
            }, 0);

            const calcTotalLiab = calcSTL + calcLTL;
            const calcTotalLiabEq = calcTotalLiab + calcTE;
            
            const CORRECT_STL = 5859318;
            const CORRECT_LTL = 11224705;
            const CORRECT_TE = 8859920;

            return (
                <div className="bg-white rounded-lg shadow-sm border border-slate-200 mb-8 overflow-hidden">
                    <div className="bg-indigo-50 p-4 border-b border-indigo-100">
                        <h3 className="font-bold text-indigo-900">Liabilities & Equity Classification (2022)</h3>
                        <p className="text-sm text-indigo-700 mt-1">
                            Classify each item as <strong>Current Liability</strong>, <strong>Long-Term Liability</strong>, or <strong>Equity</strong>.
                        </p>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm min-w-[500px]">
                            <thead className="bg-slate-50 text-slate-500 font-medium border-b border-slate-200">
                                <tr>
                                    <th className="p-3 text-left w-1/2">Balance Sheet Item</th>
                                    <th className="p-3 text-right w-1/4">Amount ($)</th>
                                    <th className="p-3 text-left w-1/4 pl-6">Classification</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {LIAB_EQ_ITEMS_2022.map((item) => {
                                    const currentVal = inputs[`class_${item.id}`] || "";
                                    const isCorrect = currentVal === item.correctType;
                                    
                                    return (
                                        <tr key={item.id} className="hover:bg-slate-50 transition group">
                                            <td className="p-3 pl-4 font-medium text-slate-700">{item.label}</td>
                                            <td className="p-3 text-right font-mono text-slate-600">{item.value}</td>
                                            <td className="p-3 pl-6">
                                                <div className="relative">
                                                    <select
                                                        value={currentVal}
                                                        onChange={(e) => handleInputChange(`class_${item.id}`, e.target.value)}
                                                        className={`w-full p-2 pr-8 border rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 cursor-pointer appearance-none ${
                                                            currentVal && isCorrect ? 'bg-green-50 border-green-500 text-green-700' :
                                                            currentVal ? 'bg-red-50 border-red-300 text-red-700' : 'bg-white border-gray-300'
                                                        }`}
                                                    >
                                                        <option value="" disabled>Select Type...</option>
                                                        <option value="current">Current Liability</option>
                                                        <option value="non-current">Long-Term Liability</option>
                                                        <option value="equity">Shareholders' Equity</option>
                                                    </select>
                                                    {teacherMode && !isCorrect && (
                                                        <div className="absolute right-0 top-0 -mt-2 mr-2 bg-yellow-100 text-yellow-800 text-[10px] px-1 rounded shadow pointer-events-none">
                                                            {item.correctType === 'current' ? 'Curr' : item.correctType === 'non-current' ? 'Long' : 'Eq'}
                                                        </div>
                                                    )}
                                                </div>
                                            </td>
                                        </tr>
                                    );
                                })}
                                
                                <tr className="bg-slate-50 border-t-2 border-slate-200 font-bold">
                                    <td className="p-3 text-right text-slate-900">Total Current Liabilities</td>
                                    <td className="p-3 text-right font-mono text-lg">
                                        <span className={Math.abs(calcSTL - CORRECT_STL) < 2 ? "text-green-600" : "text-slate-800"}>
                                            {formatMoney(calcSTL)}
                                        </span>
                                    </td>
                                    <td className="p-3 text-xs text-slate-500 italic pl-6 align-middle">
                                        (Sum of "Current Liability")
                                    </td>
                                </tr>
                                <tr className="bg-slate-50 border-slate-200 font-bold">
                                    <td className="p-3 text-right text-slate-900">Total Long-Term Liabilities</td>
                                    <td className="p-3 text-right font-mono text-lg">
                                        <span className={Math.abs(calcLTL - CORRECT_LTL) < 2 ? "text-green-600" : "text-slate-800"}>
                                            {formatMoney(calcLTL)}
                                        </span>
                                    </td>
                                    <td className="p-3 text-xs text-slate-500 italic pl-6 align-middle">
                                        (Sum of "Long-Term Liability")
                                    </td>
                                </tr>
                                    <tr className="bg-slate-100 font-bold border-t border-slate-200 text-indigo-900">
                                    <td className="p-3 text-right">Total Liabilities</td>
                                    <td className="p-3 text-right font-mono text-lg">
                                        {formatMoney(calcTotalLiab)}
                                    </td>
                                    <td className="p-3"></td>
                                </tr>
                                <tr className="bg-slate-50 border-t border-slate-200 font-bold">
                                    <td className="p-3 text-right text-slate-900">Total Equity</td>
                                    <td className="p-3 text-right font-mono text-lg">
                                        <span className={Math.abs(calcTE - CORRECT_TE) < 2 ? "text-green-600" : "text-slate-800"}>
                                            {formatMoney(calcTE)}
                                        </span>
                                    </td>
                                    <td className="p-3 text-xs text-slate-500 italic pl-6 align-middle">
                                        (Sum of "Equity")
                                    </td>
                                </tr>
                                <tr className="bg-slate-100 border-t border-slate-300 font-extrabold text-blue-900">
                                    <td className="p-3 text-right">Total Liabilities & Equity</td>
                                    <td className="p-3 text-right font-mono text-lg">
                                        {formatMoney(calcTotalLiabEq)}
                                    </td>
                                    <td className="p-3"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const RenderTable = ({ headers, rows, companyPrefix, inputs, handleInputChange, teacherMode, onValueClick, activeInputId, onFocus, readOnlyYears = [] }) => (
            <div className="overflow-x-auto border border-slate-200 rounded-lg shadow-sm mb-8">
                <table className="w-full text-sm text-left min-w-[500px]">
                    <thead className="bg-slate-50 text-slate-500 font-medium border-b border-slate-200">
                        <tr>
                            <th className="p-3 w-1/3">Item</th>
                            {headers.map((h, i) => <th key={i} className="p-3 text-right w-1/4">{h}</th>)}
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100 bg-white">
                        {rows.map((row, idx) => {
                            if (row.type === 'header') return (
                                <tr key={idx} className="bg-slate-50/50 font-semibold text-slate-700">
                                    <td colSpan={headers.length + 1} className="p-3">{row.label}</td>
                                </tr>
                            );
                            
                            const renderCell = (yearSuffix) => {
                                if (companyPrefix) {
                                    const inputId = `${companyPrefix}_${row.id}_${yearSuffix}`;
                                    const isReadOnly = readOnlyYears.includes(yearSuffix);
                                    
                                    // If Read Only, try to fetch the correct value from _DATA_MATRIX (decoded) or CASE_DATA
                                    let readOnlyVal = '';
                                    if (isReadOnly) {
                                        // Try getting value from encoded matrix
                                        if (_DATA_MATRIX[inputId]) {
                                            readOnlyVal = d(_DATA_MATRIX[inputId]);
                                        }
                                    }

                                    return (
                                        <SmartInput 
                                            id={inputId} 
                                            value={isReadOnly ? readOnlyVal : (inputs[inputId] || '')} 
                                            correctValue={d(_DATA_MATRIX[inputId])} 
                                            onChange={handleInputChange} 
                                            teacherMode={teacherMode}
                                            onFocus={onFocus}
                                            isFocused={activeInputId === inputId}
                                            disabled={isReadOnly}
                                        />
                                    );
                                }
                                else {
                                    return null; 
                                }
                            };

                            if (companyPrefix) {
                                if (row.type === 'total') return (
                                    <tr key={idx} className="bg-slate-50 font-bold text-slate-900 border-t-2 border-slate-200">
                                        <td className="p-3">{row.label}</td>
                                        <td className="p-3 text-right">{renderCell('22')}</td>
                                        <td className="p-3 text-right">{renderCell('21')}</td>
                                    </tr>
                                );
                                return (
                                    <tr key={idx} className="hover:bg-slate-50 transition">
                                        <td className="p-3 pl-6">{row.label}</td>
                                        <td className="p-3">{renderCell('22')}</td>
                                        <td className="p-3">{renderCell('21')}</td>
                                    </tr>
                                );
                            } 
                            else {
                                return (
                                    <tr key={idx} className={row.type === 'total' ? "bg-slate-50 font-bold text-slate-900 border-t-2 border-slate-200" : "hover:bg-slate-50 transition"}>
                                        <td className="p-2 font-sans">{row.label}</td>
                                        <td 
                                            className={`p-2 text-right text-slate-600 font-mono ${onValueClick ? 'clickable-cell' : ''}`}
                                            onClick={() => onValueClick && onValueClick(row.val22)}
                                        >
                                            {row.val22}
                                        </td>
                                        <td 
                                            className={`p-2 text-right text-slate-600 font-mono ${onValueClick ? 'clickable-cell' : ''}`}
                                            onClick={() => onValueClick && onValueClick(row.val21)}
                                        >
                                            {row.val21}
                                        </td>
                                    </tr>
                                )
                            }
                        })}
                    </tbody>
                </table>
            </div>
        );

        const ModuleIntro = ({ inputs, handleInputChange, teacherMode, onFocus, activeInputId }) => (
            <div className="max-w-4xl mx-auto pb-20 animate-fade-in">
                <div className="mb-6">
                    <h2 className="text-2xl font-bold text-slate-800">Before Financial Statements: 10-K Research</h2>
                    <p className="text-slate-500 mb-4">Research the Parker Hannifin 2022 10-K to answer the following questions regarding basic annual report information. Note: Figures in the report are originally in $ thousands.</p>
                    
                    <a 
                        href="https://www.sec.gov/ix?doc=/Archives/edgar/data/0000076334/000007633422000034/ph-20220630.htm" 
                        target="_blank" 
                        rel="noopener noreferrer"
                        className="inline-flex items-center gap-2 px-4 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition border border-blue-200 font-medium text-sm"
                    >
                        <Icons.ExternalLink /> Open SEC 10-K Filing
                    </a>
                </div>

                <div className="space-y-6">
                    <div className="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                        <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <span className="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">1.</span>
                            Fiscal Year End
                        </h3>
                        <div className="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                            <span className="text-sm text-slate-600">When does the fiscal year end? (e.g. January 31)</span>
                            <div className="w-full sm:w-48">
                                <SmartInput 
                                    id="intro_fiscal_end" 
                                    value={inputs['intro_fiscal_end'] || ''} 
                                    correctValue={d(_DATA_MATRIX['intro_fiscal_end'])} 
                                    onChange={handleInputChange} 
                                    teacherMode={teacherMode} 
                                    placeholder="Month Day"
                                    onFocus={onFocus}
                                    isFocused={activeInputId === 'intro_fiscal_end'}
                                />
                            </div>
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                        <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <span className="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">2.</span>
                            Main Business Activities
                        </h3>
                        <p className="text-sm text-slate-600 mb-2">Describe the main business activities of Parker Hannifin Corporation.</p>
                        <textarea 
                            className="w-full h-24 p-3 border border-gray-300 rounded focus:ring-2 focus:ring-blue-400 focus:outline-none text-base sm:text-sm"
                            placeholder="Type your summary here..."
                            id="intro_bus_act"
                            onChange={(e) => handleInputChange("intro_bus_act", e.target.value)}
                            value={inputs["intro_bus_act"] || ""}
                        ></textarea>
                        {teacherMode && (
                            <div className="mt-3 bg-yellow-50 p-3 rounded text-sm text-yellow-800 border-l-4 border-yellow-400">
                                <strong>Solution:</strong> Parker-Hannifin Corporation is a leading worldwide diversified manufacturer of motion and control technologies and systems, providing precision engineered solutions for a wide variety of mobile, industrial, and aerospace markets.
                            </div>
                        )}
                    </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                            <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                <span className="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">3.</span>
                                Auditor & Concerns
                            </h3>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm text-slate-600 mb-1">Who is the independent auditor?</label>
                                    <SmartInput 
                                        id="intro_auditor" 
                                        value={inputs['intro_auditor'] || ''} 
                                        correctValue={d(_DATA_MATRIX['intro_auditor'])} 
                                        onChange={handleInputChange} 
                                        teacherMode={teacherMode}
                                        onFocus={onFocus}
                                        isFocused={activeInputId === 'intro_auditor'}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm text-slate-600 mb-1">Were any concerns raised?</label>
                                    <div className="text-sm text-slate-500 italic p-2 bg-slate-50 rounded border border-slate-100">
                                        No concerns raised (Self-check)
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                            <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                <span className="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">4.</span>
                                Audit Opinion
                            </h3>
                            <div>
                                <label className="block text-sm text-slate-600 mb-1">What is the audit opinion?(Qualified,Unqualified,Adverse, Disclaimer of Opnion)</label>
                                <SmartInput 
                                    id="intro_opinion" 
                                    value={inputs['intro_opinion'] || ''} 
                                    correctValue={d(_DATA_MATRIX['intro_opinion'])} 
                                    onChange={handleInputChange} 
                                    teacherMode={teacherMode}
                                    placeholder="e.g. Qualified, Unqualified"
                                    onFocus={onFocus}
                                    isFocused={activeInputId === 'intro_opinion'}
                                />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );

        const Module1 = ({ inputs, handleInputChange, teacherMode, onFocus, activeInputId }) => {
            const [subTab, setSubTab] = useState('bs');

            const calcCC = useMemo(() => {
                const beg = 420142;
                const iss = parseMoney(inputs['m1_eq_oth_cc']);
                return beg + iss;
            }, [inputs['m1_eq_oth_cc']]);

            const calcRE = useMemo(() => {
                const beg = 14915497;
                const ni = parseMoney(inputs['m1_eq_ni_re']);
                const div = parseMoney(inputs['m1_eq_div_re']);
                return beg + ni + div;
            }, [inputs['m1_eq_ni_re'], inputs['m1_eq_div_re']]);

            const calcTS = useMemo(() => {
                const beg = -5370605;
                const rep = parseMoney(inputs['m1_eq_rep_ts']);
                const oth = parseMoney(inputs['m1_eq_oth_ts']);
                return beg + rep + oth;
            }, [inputs['m1_eq_rep_ts'], inputs['m1_eq_oth_ts']]);

            const calcOther = useMemo(() => {
                const beg = -1551364; // AOCI + NCI beginning
                const ni = parseMoney(inputs['m1_eq_ni_other']);
                const div = parseMoney(inputs['m1_eq_div_other']);
                const oth = parseMoney(inputs['m1_eq_oth_other']);
                return beg + ni + div + oth;
            }, [inputs['m1_eq_ni_other'], inputs['m1_eq_div_other'], inputs['m1_eq_oth_other']]);


            return (
                <div className="max-w-4xl mx-auto pb-20">
                    <div className="mb-6">
                        <h2 className="text-2xl font-bold text-slate-800">Module 1: Financial Statements Analysis</h2>
                        <p className="text-slate-500">Analyze the simplified financial statements for Parker Hannifin (PH).</p>
                    </div>

                    {/* Sub-tabs for Statements */}
                    <div className="flex border-b border-slate-200 mb-6 overflow-x-auto">
                        {['bs', 'is', 'eq', 'scf'].map(tab => (
                            <button
                                key={tab}
                                onClick={() => setSubTab(tab)}
                                className={`px-4 sm:px-6 py-3 font-medium text-sm transition-colors border-b-2 whitespace-nowrap ${
                                    subTab === tab ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-500 hover:text-slate-700'
                                }`}
                            >
                                {tab === 'bs' && 'Balance Sheet'}
                                {tab === 'is' && 'Income Statement'}
                                {tab === 'eq' && 'Statement of Equity'}
                                {tab === 'scf' && 'Cash Flows'}
                            </button>
                        ))}
                    </div>

                    {subTab === 'bs' && (
                        <div className="animate-fade-in max-w-4xl mx-auto">
                            <div>
                                <h3 className="font-bold text-lg text-slate-700 mb-4 flex items-center gap-2"><div className="w-2 h-6 bg-orange-400 rounded"></div> Parker Hannifin ($ thousands)</h3>
                                
                                {/* ASSET CLASSIFIER */}
                                <AssetClassifier inputs={inputs} handleInputChange={handleInputChange} teacherMode={teacherMode} />

                                {/* NEW LIABILITY & EQUITY CLASSIFIER */}
                                <LiabilityEquityClassifier inputs={inputs} handleInputChange={handleInputChange} teacherMode={teacherMode} />
                            </div>
                        </div>
                    )}

                    {subTab === 'is' && (
                            <div className="animate-fade-in max-w-3xl mx-auto">
                            <div>
                                <h3 className="font-bold text-lg text-slate-700 mb-4 flex items-center gap-2"><div className="w-2 h-6 bg-orange-400 rounded"></div> Parker Hannifin ($ thousands)</h3>
                                <div className="text-sm font-semibold text-slate-600 mb-2">Consolidated Income Statement June 30</div>
                                {/* PRE-POPULATE: 2021 is read-only */}
                                <RenderTable 
                                    headers={['2022', '2021']} 
                                    rows={isRows} 
                                    companyPrefix="m1_is_ph" 
                                    inputs={inputs} 
                                    handleInputChange={handleInputChange} 
                                    teacherMode={teacherMode} 
                                    onFocus={onFocus} 
                                    activeInputId={activeInputId}
                                    
                                />
                            </div>
                        </div>
                    )}

                    {subTab === 'eq' && (
                            <div className="space-y-8 animate-fade-in max-w-5xl mx-auto">
                            <div className="bg-blue-50 p-4 rounded border border-blue-100">
                                <p className="text-blue-800 text-sm"><strong>Instruction:</strong> Complete the 2022 Consolidated Statement of Equity based on the provided beginning balances and activity. The ending balance row is automatically calculated from your inputs.</p>
                                <p className="text-blue-800 text-xs mt-2"><strong>Note:</strong> The "Other" column represents Accumulated Other Comprehensive (Loss) + Noncontrolling Interests.</p>
                            </div>
                            
                            <div className="bg-white p-6 rounded shadow border border-slate-200 overflow-x-auto">
                                <h4 className="font-bold mb-4 text-slate-700 text-center">Parker Hannifin ($ thousands) Consolidated Statement of Equity For the year ended June 30, 2022</h4>
                                <table className="w-full text-sm min-w-[700px]">
                                    <thead className="bg-slate-50 text-slate-500 font-medium">
                                            <tr>
                                                <th className="p-3 text-left">Item</th>
                                                <th className="p-3 text-right">Contributed Capital</th>
                                                <th className="p-3 text-right">Retained Earnings</th>
                                                <th className="p-3 text-right">Treasury Stock</th>
                                                <th className="p-3 text-right">Other</th>
                                            </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                            <tr>
                                            <td className="p-3 font-medium">Balance at beginning of year</td>
                                            <td className="p-3 text-right font-mono text-slate-600">420,142</td>
                                            <td className="p-3 text-right font-mono text-slate-600">14,915,497</td>
                                            <td className="p-3 text-right font-mono text-slate-600">(5,370,605)</td>
                                            <td className="p-3 text-right font-mono text-slate-600">(1,551,364)</td>
                                            </tr>
                                            <tr>
                                                <td className="p-3">Stock issuances</td>
                                                <td className="p-3 text-right bg-slate-50/50"></td>
                                                <td className="p-3 text-right bg-slate-50/50"></td>
                                                <td className="p-3 text-right bg-slate-50/50"></td>
                                                <td className="p-3 text-right bg-slate-50/50"></td>
                                            </tr>
                                            <tr>
                                                <td className="p-3">Net income</td>
                                                <td className="p-3 text-right bg-slate-50/50"></td>
                                                <td className="p-3 text-right"><SmartInput id="m1_eq_ni_re" value={inputs['m1_eq_ni_re'] || ''} onChange={handleInputChange} correctValue={d(_DATA_MATRIX['m1_eq_ni_re'])} teacherMode={teacherMode} onFocus={onFocus} isFocused={activeInputId === 'm1_eq_ni_re'} /></td>
                                                <td className="p-3 text-right bg-slate-50/50"></td>
                                                <td className="p-3 text-right"><SmartInput id="m1_eq_ni_other" value={inputs['m1_eq_ni_other'] || ''} onChange={handleInputChange} correctValue={d(_DATA_MATRIX['m1_eq_ni_other'])} teacherMode={teacherMode} onFocus={onFocus} isFocused={activeInputId === 'm1_eq_ni_other'} /></td>
                                            </tr>
                                            <tr>
                                                <td className="p-3">Dividends declared</td>
                                                <td className="p-3 text-right bg-slate-50/50"></td>
                                                <td className="p-3 text-right"><SmartInput id="m1_eq_div_re" value={inputs['m1_eq_div_re'] || ''} onChange={handleInputChange} correctValue={d(_DATA_MATRIX['m1_eq_div_re'])} teacherMode={teacherMode} onFocus={onFocus} isFocused={activeInputId === 'm1_eq_div_re'} /></td>
                                                <td className="p-3 text-right bg-slate-50/50"></td>
                                                <td className="p-3 text-right"><SmartInput id="m1_eq_div_other" value={inputs['m1_eq_div_other'] || ''} onChange={handleInputChange} correctValue={d(_DATA_MATRIX['m1_eq_div_other'])} teacherMode={teacherMode} onFocus={onFocus} isFocused={activeInputId === 'm1_eq_div_other'} /></td>
                                            </tr>
                                            <tr>
                                                <td className="p-3">Stock repurchases</td>
                                                <td className="p-3 text-right bg-slate-50/50"></td>
                                                <td className="p-3 text-right bg-slate-50/50"></td>
                                                <td className="p-3 text-right"><SmartInput id="m1_eq_rep_ts" value={inputs['m1_eq_rep_ts'] || ''} onChange={handleInputChange} correctValue={d(_DATA_MATRIX['m1_eq_rep_ts'])} teacherMode={teacherMode} onFocus={onFocus} isFocused={activeInputId === 'm1_eq_rep_ts'} /></td>
                                                <td className="p-3 text-right bg-slate-50/50"></td>
                                            </tr>
                                            <tr>
                                                <td className="p-3">Other</td>
                                                <td className="p-3 text-right"><SmartInput id="m1_eq_oth_cc" value={inputs['m1_eq_oth_cc'] || ''} onChange={handleInputChange} correctValue={d(_DATA_MATRIX['m1_eq_oth_cc'])} teacherMode={teacherMode} onFocus={onFocus} isFocused={activeInputId === 'm1_eq_oth_cc'} /></td>
                                                <td className="p-3 text-right bg-slate-50/50"></td>
                                                <td className="p-3 text-right"><SmartInput id="m1_eq_oth_ts" value={inputs['m1_eq_oth_ts'] || ''} onChange={handleInputChange} correctValue={d(_DATA_MATRIX['m1_eq_oth_ts'])} teacherMode={teacherMode} onFocus={onFocus} isFocused={activeInputId === 'm1_eq_oth_ts'} /></td>
                                                <td className="p-3 text-right"><SmartInput id="m1_eq_oth_other" value={inputs['m1_eq_oth_other'] || ''} onChange={handleInputChange} correctValue={d(_DATA_MATRIX['m1_eq_oth_other'])} teacherMode={teacherMode} onFocus={onFocus} isFocused={activeInputId === 'm1_eq_oth_other'} /></td>
                                            </tr>
                                            <tr className="font-bold bg-slate-50 border-t-2 border-slate-200">
                                                <td className="p-3">Balance at end of year</td>
                                                <td className="p-3 text-right font-mono">{formatMoney(calcCC)}</td>
                                                <td className="p-3 text-right font-mono">{formatMoney(calcRE)}</td>
                                                <td className="p-3 text-right font-mono">{formatMoney(calcTS)}</td>
                                                <td className="p-3 text-right font-mono">{formatMoney(calcOther)}</td>
                                            </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}
                    {subTab === 'scf' && (
                            <div className="space-y-6 animate-fade-in max-w-3xl mx-auto">
                            <div className="flex justify-between items-center">
                                <h3 className="font-bold text-lg text-slate-700">Statement of Cash Flows (Parker Hannifin)</h3>
                            </div>
                            
                            <div className="bg-white p-6 rounded shadow border border-slate-200 overflow-x-auto">
                                <h4 className="font-bold mb-4 text-slate-700 border-b pb-2">Parker Hannifin ($ thousands) Consolidated Statement of Cash Flows June 30</h4>
                                <table className="w-full text-sm min-w-[500px]">
                                    <thead className="bg-slate-50 text-slate-500 font-medium">
                                            <tr>
                                                <th className="p-2 text-left">Item</th>
                                                <th className="p-2 text-right">2022</th>
                                            </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                            <tr>
                                                <td className="py-2 pl-2">Cash from operating activities</td>
                                                <td className="py-2"><SmartInput id="m1_cf_ph_op_22" value={inputs['m1_cf_ph_op_22'] || ''} correctValue={d(_DATA_MATRIX['m1_cf_ph_op_22'])} onChange={handleInputChange} teacherMode={teacherMode} onFocus={onFocus} isFocused={activeInputId === 'm1_cf_ph_op_22'} /></td>
                                            </tr>
                                            <tr>
                                                <td className="py-2 pl-2">Cash from (for) investing activities</td>
                                                <td className="py-2"><SmartInput id="m1_cf_ph_inv_22" value={inputs['m1_cf_ph_inv_22'] || ''} correctValue={d(_DATA_MATRIX['m1_cf_ph_inv_22'])} onChange={handleInputChange} teacherMode={teacherMode} onFocus={onFocus} isFocused={activeInputId === 'm1_cf_ph_inv_22'} /></td>
                                            </tr>
                                            <tr>
                                                <td className="py-2 pl-2">Cash from (for) financing activities</td>
                                                <td className="py-2"><SmartInput id="m1_cf_ph_fin_22" value={inputs['m1_cf_ph_fin_22'] || ''} correctValue={d(_DATA_MATRIX['m1_cf_ph_fin_22'])} onChange={handleInputChange} teacherMode={teacherMode} onFocus={onFocus} isFocused={activeInputId === 'm1_cf_ph_fin_22'} /></td>
                                            </tr>
                                                <tr>
                                                <td className="py-2 pl-2">Effect of exchange rates on cash</td>
                                                <td className="py-2"><SmartInput id="m1_cf_ph_fx_22" value={inputs['m1_cf_ph_fx_22'] || ''} correctValue={d(_DATA_MATRIX['m1_cf_ph_fx_22'])} onChange={handleInputChange} teacherMode={teacherMode} onFocus={onFocus} isFocused={activeInputId === 'm1_cf_ph_fx_22'} /></td>
                                            </tr>
                                            <tr className="border-t-2 border-slate-300 font-bold text-slate-800">
                                                <td className="py-3 pl-2">Net increase (decrease) in cash</td>
                                                <td className="py-3"><SmartInput id="m1_cf_ph_net_22" value={inputs['m1_cf_ph_net_22'] || ''} correctValue={d(_DATA_MATRIX['m1_cf_ph_net_22'])} onChange={handleInputChange} teacherMode={teacherMode} onFocus={onFocus} isFocused={activeInputId === 'm1_cf_ph_net_22'} /></td>
                                            </tr>
                                            <tr>
                                                <td className="py-2 pl-2">Cash at beginning of year</td>
                                                <td className="py-2"><SmartInput id="m1_cf_ph_beg_22" value={inputs['m1_cf_ph_beg_22'] || ''} correctValue={d(_DATA_MATRIX['m1_cf_ph_beg_22'])} onChange={handleInputChange} teacherMode={teacherMode} onFocus={onFocus} isFocused={activeInputId === 'm1_cf_ph_beg_22'} /></td>
                                            </tr>
                                            <tr>
                                                <td className="py-2 pl-2">Cash at end of year</td>
                                                <td className="py-2"><SmartInput id="m1_cf_ph_end_22" value={inputs['m1_cf_ph_end_22'] || ''} correctValue={d(_DATA_MATRIX['m1_cf_ph_end_22'])} onChange={handleInputChange} teacherMode={teacherMode} onFocus={onFocus} isFocused={activeInputId === 'm1_cf_ph_end_22'} /></td>
                                            </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ModuleArticulation = ({ inputs, handleInputChange, teacherMode, onFocus, activeInputId }) => {
             const checkBalance = (calc, actual) => {
                if (!calc || !actual) return null;
                const c = parseFloat(String(calc).replace(/,/g, ''));
                const a = parseFloat(String(actual).replace(/,/g, ''));
                return Math.abs(c - a) < 5; // Tolerance
            };

            const cashEnd = 733117 + parseFloat(inputs['m2_art_cash_op']?.replace(/,/g, '') || 0) +
                            parseFloat(inputs['m2_art_cash_inv']?.replace(/,/g, '') || 0) +
                            parseFloat(inputs['m2_art_cash_fin']?.replace(/,/g, '') || 0); // Financing includes FX in Excel model
            const cashValid = checkBalance(cashEnd, 6647876);

            const reEnd = 14915497 + parseFloat(inputs['m2_art_re_ni']?.replace(/,/g, '') || 0) +
                            parseFloat(inputs['m2_art_re_div']?.replace(/,/g, '') || 0);
            const reValid = checkBalance(reEnd, 15661808);

            const ccEnd = 420142 + parseFloat(inputs['m2_art_cc_iss']?.replace(/,/g, '') || 0);
            const ccValid = checkBalance(ccEnd, 417830);

            const tsEnd = -5370605 + parseFloat(inputs['m2_art_ts_rep']?.replace(/,/g, '') || 0);
            const tsValid = checkBalance(tsEnd, -5688429);

            return (
                <div className="max-w-6xl mx-auto pb-20 animate-fade-in">
                    <div className="mb-6">
                        <h2 className="text-2xl font-bold text-slate-800">Module 2: Financial Statement Articulation</h2>
                        <p className="text-slate-500 mb-2">Reconcile the flows between the 2021 Balance Sheet and 2022 Balance Sheet using the provided data.</p>
                        <div className="bg-yellow-50 border-l-4 border-yellow-400 p-3 text-sm text-yellow-800">
                            <strong>Note:</strong> The Statement of Cash Flows ending cash ($6,647,876) differs from the Balance Sheet "Cash and cash equivalents" ($535,799). The discrepancy (~$6.1B) is due to Restricted Cash held for the Meggitt acquisition, which is classified under "Prepaid expenses and other" on the Balance Sheet but included in the SCF total.
                        </div>
                    </div>

                    {/* Excel-Style Grid Layout - Responsive: Stack on mobile, grid on LG */}
                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-4 text-sm bg-white p-6 rounded shadow border border-slate-200">
                        
                        {/* Headers */}
                        <div className="hidden lg:block lg:col-span-3 font-bold text-slate-600 border-b pb-2">Balance Sheet (June 30, 2021)</div>
                        <div className="hidden lg:block lg:col-span-6 font-bold text-slate-600 border-b pb-2 text-center">Flows (Year Ended June 30, 2022)</div>
                        <div className="hidden lg:block lg:col-span-3 font-bold text-slate-600 border-b pb-2 text-right">Balance Sheet (June 30, 2022)</div>

                        {/* CASH ROW */}
                        <div className="lg:col-span-3 flex justify-between items-center bg-slate-50 p-2 rounded">
                            <span className="font-bold lg:font-normal">Cash (Beg)</span>
                            <span className="font-mono">733,117</span>
                        </div>
                        <div className="lg:col-span-6 space-y-2 p-2 border-l-0 lg:border-l border-r-0 lg:border-r border-slate-100">
                            <div className="flex justify-between items-center">
                                <span className="text-xs text-slate-500">+ Operating Cash Flows</span>
                                <div className="w-28"><SmartInput id="m2_art_cash_op" value={inputs['m2_art_cash_op'] || ''} onChange={handleInputChange} correctValue={d(_DATA_MATRIX['m2_art_cash_op'])} teacherMode={teacherMode} onFocus={onFocus} isFocused={activeInputId === 'm2_art_cash_op'} /></div>
                            </div>
                            <div className="flex justify-between items-center">
                                <span className="text-xs text-slate-500">+ Investing Cash Flows</span>
                                <div className="w-28"><SmartInput id="m2_art_cash_inv" value={inputs['m2_art_cash_inv'] || ''} onChange={handleInputChange} correctValue={d(_DATA_MATRIX['m2_art_cash_inv'])} teacherMode={teacherMode} onFocus={onFocus} isFocused={activeInputId === 'm2_art_cash_inv'} /></div>
                            </div>
                            <div className="flex justify-between items-center">
                                <span className="text-xs text-slate-500 text-right pr-2 leading-tight">+ Financing (inc. FX)</span>
                                <div className="w-28"><SmartInput id="m2_art_cash_fin" value={inputs['m2_art_cash_fin'] || ''} onChange={handleInputChange} correctValue={d(_DATA_MATRIX['m2_art_cash_fin'])} teacherMode={teacherMode} onFocus={onFocus} isFocused={activeInputId === 'm2_art_cash_fin'} /></div>
                            </div>
                        </div>
                        <div className="lg:col-span-3 flex flex-col justify-center items-end bg-slate-50 p-2 rounded relative">
                            <span className="font-bold lg:font-normal">Cash (SCF End)</span>
                            <span className="font-mono font-bold text-lg">6,647,876</span>
                            {cashValid !== null && (
                                <div className={`absolute top-2 left-2 text-[10px] px-1 rounded ${cashValid ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                    {cashValid ? '' : ''}
                                </div>
                            )}
                        </div>

                        {/* SEPARATOR */}
                        <div className="col-span-1 lg:col-span-12 border-t border-slate-200 my-2"></div>

                        {/* EQUITY: Contributed Capital */}
                        <div className="lg:col-span-3 flex justify-between items-center bg-slate-50 p-2 rounded">
                            <span className="font-bold lg:font-normal">Contributed Capital</span>
                            <span className="font-mono">420,142</span>
                        </div>
                        <div className="lg:col-span-6 flex justify-between items-center p-2 border-l-0 lg:border-l border-r-0 lg:border-r border-slate-100">
                            <span className="text-xs text-slate-500">+ Stock Issuance & Other</span>
                            <div className="w-28"><SmartInput id="m2_art_cc_iss" value={inputs['m2_art_cc_iss'] || ''} onChange={handleInputChange} correctValue={d(_DATA_MATRIX['m2_art_cc_iss'])} teacherMode={teacherMode} onFocus={onFocus} isFocused={activeInputId === 'm2_art_cc_iss'} /></div>
                        </div>
                        <div className="lg:col-span-3 flex flex-col justify-center items-end bg-slate-50 p-2 rounded relative">
                            <span className="font-bold lg:font-normal">Contributed Capital</span>
                            <span className="font-mono font-bold">417,830</span>
                            {ccValid !== null && <div className={`absolute top-1 left-1 text-[10px] ${ccValid?'text-green-500':'text-red-500'}`}>{ccValid?'':''}</div>}
                        </div>

                        {/* INCOME CALCULATION BLOCK */}
                        <div className="col-span-1 lg:col-span-12 p-3 bg-blue-50 rounded border border-blue-100 my-2 flex flex-col sm:flex-row justify-center items-center gap-2 sm:gap-4 text-sm text-blue-900 text-center">
                            <strong>Income Calculation:</strong>
                            <div className="flex gap-2 items-center flex-wrap justify-center">
                                <span>Revenue (15,861,608)</span>
                                <span>-</span>
                                <span>Expenses (14,545,422)</span>
                                <span>=</span>
                                <span className="font-bold">Net Income (1,316,186)</span>
                            </div>
                        </div>

                        {/* EQUITY: Retained Earnings */}
                        <div className="lg:col-span-3 flex justify-between items-center bg-slate-50 p-2 rounded">
                            <span className="font-bold lg:font-normal">Retained Earnings</span>
                            <span className="font-mono">14,915,497</span>
                        </div>
                        <div className="lg:col-span-6 space-y-2 p-2 border-l-0 lg:border-l border-r-0 lg:border-r border-slate-100">
                            <div className="flex justify-between items-center">
                                <span className="text-xs text-slate-500">+ Net Income</span>
                                <div className="w-28"><SmartInput id="m2_art_re_ni" value={inputs['m2_art_re_ni'] || ''} onChange={handleInputChange} correctValue={d(_DATA_MATRIX['m2_art_re_ni'])} teacherMode={teacherMode} onFocus={onFocus} isFocused={activeInputId === 'm2_art_re_ni'} /></div>
                            </div>
                            <div className="flex justify-between items-center">
                                <span className="text-xs text-slate-500">- Dividends & Other</span>
                                <div className="w-28"><SmartInput id="m2_art_re_div" value={inputs['m2_art_re_div'] || ''} onChange={handleInputChange} correctValue={d(_DATA_MATRIX['m2_art_re_div'])} teacherMode={teacherMode} onFocus={onFocus} isFocused={activeInputId === 'm2_art_re_div'} /></div>
                            </div>
                        </div>
                        <div className="lg:col-span-3 flex flex-col justify-center items-end bg-slate-50 p-2 rounded relative">
                            <span className="font-bold lg:font-normal">Retained Earnings</span>
                            <span className="font-mono font-bold">15,661,808</span>
                            {reValid !== null && <div className={`absolute top-1 left-1 text-[10px] ${reValid?'text-green-500':'text-red-500'}`}>{reValid?'':''}</div>}
                        </div>

                        {/* EQUITY: Treasury Stock */}
                        <div className="lg:col-span-3 flex justify-between items-center bg-slate-50 p-2 rounded">
                            <span className="font-bold lg:font-normal">Treasury Stock</span>
                            <span className="font-mono">(5,370,605)</span>
                        </div>
                        <div className="lg:col-span-6 flex justify-between items-center p-2 border-l-0 lg:border-l border-r-0 lg:border-r border-slate-100">
                            <span className="text-xs text-slate-500">+ Repurchases/Re-issuance</span>
                            <div className="w-28"><SmartInput id="m2_art_ts_rep" value={inputs['m2_art_ts_rep'] || ''} onChange={handleInputChange} correctValue={d(_DATA_MATRIX['m2_art_ts_rep'])} teacherMode={teacherMode} onFocus={onFocus} isFocused={activeInputId === 'm2_art_ts_rep'} /></div>
                        </div>
                        <div className="lg:col-span-3 flex flex-col justify-center items-end bg-slate-50 p-2 rounded relative">
                            <span className="font-bold lg:font-normal">Treasury Stock</span>
                            <span className="font-mono font-bold">(5,688,429)</span>
                            {tsValid !== null && <div className={`absolute top-1 left-1 text-[10px] ${tsValid?'text-green-500':'text-red-500'}`}>{tsValid?'':''}</div>}
                        </div>

                    </div>
                </div>
            );
        };

        const Module3 = ({ inputs, handleInputChange, teacherMode, onFocus, activeInputId }) => {
            const handleValueClick = (val) => {
                if (activeInputId && val) {
                    const currentVal = inputs[activeInputId] || "";
                    // Remove commas from the inserted value to make math valid
                    const cleanVal = String(val).replace(/,/g, '');
                    const newVal = currentVal + cleanVal;
                    
                    handleInputChange(activeInputId, newVal);
                    
                    // Increased timeout to 50ms to ensure React render cycle completes and cursor is placed at end
                    setTimeout(() => {
                        const el = document.getElementById(activeInputId);
                        if(el) {
                            el.focus();
                            const len = el.value.length;
                            el.setSelectionRange(len, len);
                        }
                    }, 50);
                }
            };

            const referenceRows = isRows.map(row => {
                let val22 = "...", val21 = "...";
                // Get values from _DATA_MATRIX (which are now populated from CASE_DATA)
                if (_DATA_MATRIX[`m1_is_ph_${row.id}_22`]) val22 = d(_DATA_MATRIX[`m1_is_ph_${row.id}_22`]);
                if (_DATA_MATRIX[`m1_is_ph_${row.id}_21`]) val21 = d(_DATA_MATRIX[`m1_is_ph_${row.id}_21`]);
                return { ...row, val22, val21 };
            });

            return (
                <div className="max-w-5xl mx-auto pb-20 animate-fade-in">
                    <div className="mb-6">
                        <h2 className="text-2xl font-bold text-slate-800">Module 3: Common-Size & Advanced Analysis</h2>
                        <p className="text-slate-500">Perform vertical analysis. <span className="text-blue-600 font-semibold bg-blue-50 px-2 py-0.5 rounded">New Feature:</span>  Enter numbers and mathematical operators to automatically calculate each value.Percentages should be shown as % (not decimals)multiply decimal results by 100.</p>
                    </div>

                    {/* Common-Size Balance Sheet Section */}
                    <div className="bg-white p-6 rounded shadow border border-slate-200 mb-8">
                        <h3 className="font-bold text-lg text-slate-700 mb-4 flex items-center gap-2">
                            <Icons.BarChart /> Simplified Balance Sheet Analysis (2022)
                        </h3>
                        <p className="text-xs text-slate-500 mb-4">First, calculate the simplified totals for 2022. Then, express each item as a percentage of Total Assets (25,943,943).</p>
                        
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm min-w-[500px]">
                                <thead className="bg-slate-50 text-slate-500 border-b">
                                    <tr>
                                        <th className="p-2 text-left w-1/3">Item</th>
                                        <th className="p-2 text-right w-1/4 bg-blue-50/50">Amount ($) - 2022</th>
                                        <th className="p-2 text-right w-1/4 text-blue-600">% of Assets</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    <tr>
                                        <td className="p-2 font-medium">Short-term assets</td>
                                        <td className="p-2"><SmartInput id="m3_cs_bs_sta_val" value={inputs['m3_cs_bs_sta_val'] || ''} onChange={handleInputChange} correctValue={d(_DATA_MATRIX['m3_cs_bs_sta_val'])} teacherMode={teacherMode} placeholder="$" onFocus={onFocus} isFocused={activeInputId === 'm3_cs_bs_sta_val'} /></td>
                                        <td className="p-2"><SmartInput id="m3_cs_bs_sta_pct" value={inputs['m3_cs_bs_sta_pct'] || ''} onChange={handleInputChange} correctValue={d(_DATA_MATRIX['m3_cs_bs_sta_pct'])} teacherMode={teacherMode} placeholder="%" onFocus={onFocus} isFocused={activeInputId === 'm3_cs_bs_sta_pct'} /></td>
                                    </tr>
                                    <tr>
                                        <td className="p-2 font-medium">Long-term assets</td>
                                        <td className="p-2"><SmartInput id="m3_cs_bs_lta_val" value={inputs['m3_cs_bs_lta_val'] || ''} onChange={handleInputChange} correctValue={d(_DATA_MATRIX['m3_cs_bs_lta_val'])} teacherMode={teacherMode} placeholder="$" onFocus={onFocus} isFocused={activeInputId === 'm3_cs_bs_lta_val'} /></td>
                                        <td className="p-2"><SmartInput id="m3_cs_bs_lta_pct" value={inputs['m3_cs_bs_lta_pct'] || ''} onChange={handleInputChange} correctValue={d(_DATA_MATRIX['m3_cs_bs_lta_pct'])} teacherMode={teacherMode} placeholder="%" onFocus={onFocus} isFocused={activeInputId === 'm3_cs_bs_lta_pct'} /></td>
                                    </tr>
                                    <tr className="bg-slate-50 font-bold">
                                        <td className="p-2">Total Assets</td>
                                        <td className="p-2"><SmartInput id="m3_cs_bs_ta_val" value={inputs['m3_cs_bs_ta_val'] || ''} onChange={handleInputChange} correctValue={d(_DATA_MATRIX['m3_cs_bs_ta_val'])} teacherMode={teacherMode} placeholder="$" onFocus={onFocus} isFocused={activeInputId === 'm3_cs_bs_ta_val'} /></td>
                                        <td className="p-2"><SmartInput id="m3_cs_bs_ta_pct" value={inputs['m3_cs_bs_ta_pct'] || ''} onChange={handleInputChange} correctValue={d(_DATA_MATRIX['m3_cs_bs_ta_pct'])} teacherMode={teacherMode} placeholder="100.0" onFocus={onFocus} isFocused={activeInputId === 'm3_cs_bs_ta_pct'} /></td>
                                    </tr>
                                    <tr><td colSpan="3" className="h-4"></td></tr>
                                    <tr>
                                        <td className="p-2 font-medium">Short-term liabilities</td>
                                        <td className="p-2"><SmartInput id="m3_cs_bs_stl_val" value={inputs['m3_cs_bs_stl_val'] || ''} onChange={handleInputChange} correctValue={d(_DATA_MATRIX['m3_cs_bs_stl_val'])} teacherMode={teacherMode} placeholder="$" onFocus={onFocus} isFocused={activeInputId === 'm3_cs_bs_stl_val'} /></td>
                                        <td className="p-2"><SmartInput id="m3_cs_bs_stl_pct" value={inputs['m3_cs_bs_stl_pct'] || ''} onChange={handleInputChange} correctValue={d(_DATA_MATRIX['m3_cs_bs_stl_pct'])} teacherMode={teacherMode} placeholder="%" onFocus={onFocus} isFocused={activeInputId === 'm3_cs_bs_stl_pct'} /></td>
                                    </tr>
                                    <tr>
                                        <td className="p-2 font-medium">Long-term liabilities</td>
                                        <td className="p-2"><SmartInput id="m3_cs_bs_ltl_val" value={inputs['m3_cs_bs_ltl_val'] || ''} onChange={handleInputChange} correctValue={d(_DATA_MATRIX['m3_cs_bs_ltl_val'])} teacherMode={teacherMode} placeholder="$" onFocus={onFocus} isFocused={activeInputId === 'm3_cs_bs_ltl_val'} /></td>
                                        <td className="p-2"><SmartInput id="m3_cs_bs_ltl_pct" value={inputs['m3_cs_bs_ltl_pct'] || ''} onChange={handleInputChange} correctValue={d(_DATA_MATRIX['m3_cs_bs_ltl_pct'])} teacherMode={teacherMode} placeholder="%" onFocus={onFocus} isFocused={activeInputId === 'm3_cs_bs_ltl_pct'} /></td>
                                    </tr>
                                    <tr>
                                        <td className="p-2 font-medium">Total Equity</td>
                                        <td className="p-2"><SmartInput id="m3_cs_bs_te_val" value={inputs['m3_cs_bs_te_val'] || ''} onChange={handleInputChange} correctValue={d(_DATA_MATRIX['m3_cs_bs_te_val'])} teacherMode={teacherMode} placeholder="$" onFocus={onFocus} isFocused={activeInputId === 'm3_cs_bs_te_val'} /></td>
                                        <td className="p-2"><SmartInput id="m3_cs_bs_te_pct" value={inputs['m3_cs_bs_te_pct'] || ''} onChange={handleInputChange} correctValue={d(_DATA_MATRIX['m3_cs_bs_te_pct'])} teacherMode={teacherMode} placeholder="%" onFocus={onFocus} isFocused={activeInputId === 'm3_cs_bs_te_pct'} /></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* Balance Sheet Analysis Questions */}
                    <div className="space-y-6 mb-12">
                        <h3 className="font-bold text-slate-700 border-b pb-2 flex items-center gap-2">
                            <Icons.PieChart /> Balance Sheet Analysis
                        </h3>

                        <QuestionBox 
                            title="1. Asset Structure & Largest Components"
                            hint="Refer to the 'Assets' percentages calculated above."
                            solution="Review previous modules for solution details."
                            teacherMode={teacherMode}
                        >
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                <div>
                                    <label className="block text-sm font-semibold text-slate-600 mb-1">Short-term vs Long-term Ratio (%)</label>
                                    <div className="flex gap-2">
                                        <SmartInput id="m3_ph_sta_p_22" value={inputs['m3_ph_sta_p_22'] || ''} correctValue={d(_DATA_MATRIX['m3_ph_sta_p_22'])} onChange={handleInputChange} teacherMode={teacherMode} placeholder="ST %" onFocus={onFocus} isFocused={activeInputId === 'm3_ph_sta_p_22'} />
                                        <SmartInput id="m3_ph_lta_p_22" value={inputs['m3_ph_lta_p_22'] || ''} correctValue={d(_DATA_MATRIX['m3_ph_lta_p_22'])} onChange={handleInputChange} teacherMode={teacherMode} placeholder="LT %" onFocus={onFocus} isFocused={activeInputId === 'm3_ph_lta_p_22'} />
                                    </div>
                                </div>
                            </div>
                        </QuestionBox>

                        <MultipleChoiceQuestion 
                            id="m3_q_largest_assets"
                            title="2. What is the companys largest asset category?"
                            options={[
                                { id: 'a', text: 'Goodwill (~30%)' },
                                { id: 'b', text: 'Inventory (~9%)' },
                                { id: 'c', text: 'Property, Plant, and Equipment (~8%)' }
                            ]}
                            correctOptionId="a"
                            explanation="Goodwill is the largest asset, representing 29.8% of total assets. This indicates significant acquisition activity."
                            teacherMode={teacherMode}
                            selectedOptionId={inputs['m3_q_largest_assets']}
                            onSelect={handleInputChange}
                        />

                        <MultipleChoiceQuestion 
                            id="m3_q_largest_liabs"
                            title="3. What is the companys largest liability?"
                            options={[
                                { id: 'a', text: 'Accounts Payable' },
                                { id: 'b', text: 'Long-term Debt' },
                                { id: 'c', text: 'Pension Obligations' }
                            ]}
                            correctOptionId="b"
                            explanation="The companys largest liability is long-term debt, which represents 37.6% of total assets."
                            teacherMode={teacherMode}
                            selectedOptionId={inputs['m3_q_largest_liabs']}
                            onSelect={handleInputChange}
                        />

                        <MultipleChoiceQuestion 
                            id="m3_q_owner_financing"
                            title="4. What proportion of total assets is financed by owners?"
                            options={[
                                { id: 'a', text: 'Approximately 66%' },
                                { id: 'b', text: 'Approximately 10%' },
                                { id: 'c', text: 'Approximately 34%' }
                            ]}
                            correctOptionId="c"
                            explanation="Approximately 34.1% of total assets are financed by owners (Total Equity / Total Assets)."
                            teacherMode={teacherMode}
                            selectedOptionId={inputs['m3_q_owner_financing']}
                            onSelect={handleInputChange}
                        />

                        <MultipleChoiceQuestion 
                            id="m3_q_nonowner_financing"
                            title="5. What proportion of total assets is financed by nonowners (liabilities)?"
                            options={[
                                { id: 'a', text: 'Approximately 66%' },
                                { id: 'b', text: 'Approximately 34%' },
                                { id: 'c', text: 'Approximately 50%' }
                            ]}
                            correctOptionId="a"
                            explanation="Approximately 65.9% of total assets are financed by liabilities (100% - Equity %)."
                            teacherMode={teacherMode}
                            selectedOptionId={inputs['m3_q_nonowner_financing']}
                            onSelect={handleInputChange}
                        />
                    </div>

                    {/* Simplified Income Statement (Reference) - CLICKABLE */}
                    <div className="bg-white p-6 rounded shadow border border-slate-200 mb-8 ring-4 ring-indigo-50">
                        <h3 className="font-bold text-lg text-indigo-800 mb-2 flex items-center gap-2">
                            <Icons.BookOpen /> Simplified Income Statement (Reference)
                        </h3>
                         <p className="text-xs text-indigo-500 mb-4 font-semibold">
                             TIP: Click any number in this table to insert it into your active input field above or below!
                        </p>
                        <RenderTable 
                            headers={['2022 ($)', '2021 ($)']} 
                            rows={referenceRows} 
                            // No companyPrefix = Reference Mode
                            onValueClick={handleValueClick}
                        />
                    </div>

                    {/* Common-Size Income Statement (Input) */}
                    <div className="bg-white p-6 rounded shadow border border-slate-200 mb-8">
                        <h3 className="font-bold text-lg text-slate-700 mb-4 flex items-center gap-2">
                            <Icons.BarChart /> Common-Size Income Statement (Calculate %)
                        </h3>
                        <p className="text-xs text-slate-500 mb-4">Calculate each item as a percentage of Net Sales. Example: Click "Net Sales" above, type "/", click "Net Sales" again, type "*100".</p>
                        
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left min-w-[500px]">
                                <thead className="bg-slate-50 text-slate-500 border-b">
                                    <tr>
                                        <th className="p-2 w-1/3">Item</th>
                                        <th className="p-2 text-center w-1/4 text-blue-600">2022 (%)</th>
                                        <th className="p-2 text-center w-1/4 text-blue-600">2021 (%)</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {isRows.map((row, idx) => (
                                        <tr key={idx} className={row.type === 'total' ? "bg-blue-50/30 font-bold" : ""}>
                                            <td className="p-2">{row.label}</td>
                                            <td className="p-2 text-center">
                                                <SmartInput 
                                                    id={`m3_cs_is_${row.id}_22`} 
                                                    value={inputs[`m3_cs_is_${row.id}_22`] || ''} 
                                                    onChange={handleInputChange} 
                                                    correctValue={row.id === 'sales' ? "100.0" : d(_DATA_MATRIX[`m3_cs_is_${row.id}_22`])} 
                                                    teacherMode={teacherMode} 
                                                    placeholder="%" 
                                                    onFocus={onFocus}
                                                    isFocused={activeInputId === `m3_cs_is_${row.id}_22`}
                                                />
                                            </td>
                                            <td className="p-2 text-center">
                                                <SmartInput 
                                                    id={`m3_cs_is_${row.id}_21`} 
                                                    value={inputs[`m3_cs_is_${row.id}_21`] || ''} 
                                                    onChange={handleInputChange} 
                                                    correctValue={row.id === 'sales' ? "100.0" : d(_DATA_MATRIX[`m3_cs_is_${row.id}_21`])} 
                                                    teacherMode={teacherMode} 
                                                    placeholder="%" 
                                                    onFocus={onFocus}
                                                    isFocused={activeInputId === `m3_cs_is_${row.id}_21`}
                                                />
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* Income Statement Analysis Questions */}
                    <div className="space-y-6 mb-12">
                        <h3 className="font-bold text-slate-700 border-b pb-2 flex items-center gap-2">
                            <Icons.PieChart /> Income Statement Analysis
                        </h3>

                        <MultipleChoiceQuestion 
                            id="m3_q_major_expenses"
                            title="1. What are the company's major expenses?"
                            options={[
                                { id: 'a', text: 'Interest Expense and Taxes' },
                                { id: 'b', text: 'Cost of Sales (COGS) and SG&A' },
                                { id: 'c', text: 'R&D and Depreciation' }
                            ]}
                            correctOptionId="b"
                            explanation="COGS (71.8%) and SG&A (10.3%) are the largest expense categories relative to sales."
                            teacherMode={teacherMode}
                            selectedOptionId={inputs['m3_q_major_expenses']}
                            onSelect={handleInputChange}
                        />

                        <MultipleChoiceQuestion 
                            id="m3_q_unusual_items"
                            title="2. Which unusual item significantly impacted 2022 results?"
                            options={[
                                { id: 'a', text: 'Loss on forward contracts (6.2% of sales)' },
                                { id: 'b', text: 'Gain on sale of land' },
                                { id: 'c', text: 'Litigation settlement' }
                            ]}
                            correctOptionId="a"
                            explanation="The company recorded a loss on forward contracts equal to ~6.2% of revenue, which is significant."
                            teacherMode={teacherMode}
                            selectedOptionId={inputs['m3_q_unusual_items']}
                            onSelect={handleInputChange}
                        />

                        <MultipleChoiceQuestion 
                            id="m3_q_profitability"
                            title="3. How did 2022 profitability compare to 2021?"
                            options={[
                                { id: 'a', text: 'Profitability improved due to higher sales.' },
                                { id: 'b', text: 'Profitability remained exactly the same.' },
                                { id: 'c', text: 'Profitability declined, largely due to the forward contract loss.' }
                            ]}
                            correctOptionId="c"
                            explanation="Net income declined to 8.3% of revenue in 2022 from 12.2% in 2021, primarily due to the loss on forward contracts."
                            teacherMode={teacherMode}
                            selectedOptionId={inputs['m3_q_profitability']}
                            onSelect={handleInputChange}
                        />

                        <MultipleChoiceQuestion
                            id="m3_q_gross_margin"
                            title="4. Gross Margin Analysis (28.2%)"
                            options={[
                                { id: 'a', text: 'It measures production efficiency and pricing power before operating costs.' },
                                { id: 'b', text: 'It indicates the final profit available to shareholders.' },
                                { id: 'c', text: 'It shows the interest coverage ratio.' }
                            ]}
                            correctOptionId="a"
                            explanation="Gross Margin = (Revenue - COGS) / Revenue. It isolates production costs from overhead."
                            teacherMode={teacherMode}
                            selectedOptionId={inputs['m3_q_gross_margin']}
                            onSelect={handleInputChange}
                        />

                        <MultipleChoiceQuestion
                            id="m3_q_net_margin"
                            title="5. Net Profit Margin Analysis (8.3%)"
                            options={[
                                { id: 'a', text: 'The cash flow from operations.' },
                                { id: 'b', text: 'The bottom-line profit per dollar of revenue after all expenses.' },
                                { id: 'c', text: 'The cost of goods sold percentage.' }
                            ]}
                            correctOptionId="b"
                            explanation="Net Margin reflects overall business health, including SG&A, R&D, interest, and taxes."
                            teacherMode={teacherMode}
                            selectedOptionId={inputs['m3_q_net_margin']}
                            onSelect={handleInputChange}
                        />

                        <MultipleChoiceQuestion
                            id="m3_q_margin_diff"
                            title="6. Why might Gross Margin be high while Net Margin is low?"
                            options={[
                                { id: 'a', text: 'Because COGS is too high.' },
                                { id: 'b', text: 'Because taxes are negative.' },
                                { id: 'c', text: 'High operating expenses (SG&A, R&D) or interest costs consume the gross profit.' }
                            ]}
                            correctOptionId="c"
                            explanation="A company can be efficient at production (High Gross Margin) but have heavy administrative or debt burdens (Low Net Margin)."
                            teacherMode={teacherMode}
                            selectedOptionId={inputs['m3_q_margin_diff']}
                            onSelect={handleInputChange}
                        />
                    </div>

                </div>
            );
        };

        const Module4 = ({ inputs, handleInputChange, teacherMode, onFocus, activeInputId }) => (
            <div className="max-w-4xl mx-auto pb-20 animate-fade-in">
                <div className="mb-6">
                    <h2 className="text-2xl font-bold text-slate-800">Module 4: Cash Flow & Valuation</h2>
                    <p className="text-slate-500">Evaluate cash flow patterns and market value.</p>
                </div>

                <MultipleChoiceQuestion 
                    id="m4_q4_text"
                    title="4. Statement of Cash Flows Analysis: Analyze the cash flow pattern for 2022."
                    options={[
                        { id: 'a', text: 'Operating inflows funded both investing outflows and financing inflows.' },
                        { id: 'b', text: 'Operating inflows and Financing inflows funded Investing outflows and cash buildup.' },
                        { id: 'c', text: 'The company is burning cash from operations.' }
                    ]}
                    correctOptionId="b"
                    explanation="Operating Cash Flow was positive ($2.4B), Financing was positive ($3.9B), and Investing was negative (-$0.4B). The massive cash buildup ($5.9B) came from both Ops and Financing."
                    teacherMode={teacherMode}
                    selectedOptionId={inputs['m4_q4_text']}
                    onSelect={handleInputChange}
                />

                <QuestionBox 
                    title="5. Market Capitalization"
                    hint="Formula: (Common Shares Issued - Treasury Shares)  Year-End Share Price."
                    solution="Market Cap = (181,046,000 - 52,000,000)  $246 = ~$31.7 Billion."
                    teacherMode={teacherMode}
                >
                    <div className="space-y-4">
                        <p className="text-sm text-slate-600">Calculate the market capitalization using the data below:</p>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div className="bg-slate-50 p-3 rounded">
                                <span className="block font-semibold">Common Shares Issued:</span>
                                <span>181,046,000</span>
                            </div>
                            <div className="bg-slate-50 p-3 rounded">
                                <span className="block font-semibold">Treasury Shares:</span>
                                <span>52,000,000</span>
                            </div>
                            <div className="bg-slate-50 p-3 rounded">
                                <span className="block font-semibold">Year-End Share Price:</span>
                                <span>$246.00</span>
                            </div>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">Calculated Market Cap ($ thousands):</label>
                            <SmartInput 
                                id="m4_ph_mkt_cap" 
                                value={inputs['m4_ph_mkt_cap'] || ''} 
                                correctValue={d(_DATA_MATRIX['m4_ph_mkt_cap'])} 
                                onChange={handleInputChange} 
                                teacherMode={teacherMode} 
                                placeholder="e.g. 40,000,000"
                                onFocus={onFocus}
                                isFocused={activeInputId === 'm4_ph_mkt_cap'}
                            />
                        </div>
                    </div>
                </QuestionBox>
            </div>
        );

        // --- MAIN APP COMPONENT ---

        const App = () => {
            const [activeModule, setActiveModule] = useState('intro'); // Default to Intro
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);

            const getInitialInputs = () => {
                const defaults = {};
                // Mapping labels to IDs (must match isRows definitions)
                const idMap = {
                    'Net Sales': 'sales', 'Cost of sales': 'cos', 'Gross profit': 'gp',
                    'Selling, general and administrative expenses': 'sga', 'Gain on disposal of assets': 'gain',
                    'Operating income': 'opinc', 'Interest expense': 'int_exp', 'Other expense (income), net': 'other',
                    'Income before income taxes': 'ibt', 'Income taxes': 'tax', 'Net Income': 'ni',
                    "Less: Noncontrolling interest in subsidiaries' earnings": 'ncin',
                    "Net Income Attributable to Common Shareholders": 'nic'
                };
                
                // Loop through the data source and fill the 2021 keys
                if (CASE_DATA && CASE_DATA.ph_is) {
                    CASE_DATA.ph_is.rows.forEach(row => {
                        const label = row[0];
                        const val21 = row[2]; // Index 2 is the 2021 column
                        if (idMap[label]) {
                            defaults[`m1_is_ph_${idMap[label]}_21`] = val21;
                        }
                    });
                }
                return defaults;
            };
            
            // Initialize state with 2021 data pre-filled
            const [inputs, setInputs] = useState(getInitialInputs);
            
            const [showCalc, setShowCalc] = useState(false);
            const [showDataPanel, setShowDataPanel] = useState(false);
            const [teacherMode, setTeacherMode] = useState(false);
            const [showLogin, setShowLogin] = useState(false);
            const [password, setPassword] = useState("");
            const [studentName, setStudentName] = useState("");
            const [showNamePrompt, setShowNamePrompt] = useState(false);
            const [showResetConfirm, setShowResetConfirm] = useState(false); // New Reset Confirm State
            const [activeInputId, setActiveInputId] = useState(null);

            // Resizable Sidebar State
            const [sidebarWidth, setSidebarWidth] = useState(256);
            const sidebarRef = useRef(null);
            const [isResizing, setIsResizing] = useState(false);

            // Resizing Logic
            const startResizing = useCallback((mouseDownEvent) => {
                setIsResizing(true);
            }, []);

            const stopResizing = useCallback(() => {
                setIsResizing(false);
            }, []);

            const resize = useCallback((mouseMoveEvent) => {
                if (isResizing) {
                    const newWidth = mouseMoveEvent.clientX;
                    if (newWidth > 150 && newWidth < 400) {
                        setSidebarWidth(newWidth);
                    }
                }
            }, [isResizing]);

            useEffect(() => {
                window.addEventListener("mousemove", resize);
                window.addEventListener("mouseup", stopResizing);
                return () => {
                    window.removeEventListener("mousemove", resize);
                    window.removeEventListener("mouseup", stopResizing);
                };
            }, [resize, stopResizing]);

            const handleInputChange = (id, val) => {
                setInputs(prev => ({ ...prev, [id]: val }));
            };

            const handleInputFocus = (id) => {
                setActiveInputId(id);
            };

            const handleDataValueClick = (val) => {
                if (activeInputId && val) {
                    const currentVal = inputs[activeInputId] || "";
                    // Remove commas from the inserted value to make math valid
                    const cleanVal = String(val).replace(/,/g, '');
                    const newVal = currentVal + cleanVal;
                    
                    handleInputChange(activeInputId, newVal);
                    
                    // Force focus back to the input immediately so typing can continue
                    setTimeout(() => {
                        const el = document.getElementById(activeInputId);
                        if(el) {
                            el.focus();
                            // FIX: Ensure cursor is at the end so next operator appends correctly
                            const len = el.value.length;
                            el.setSelectionRange(len, len);
                        }
                    }, 50);
                }
            };

            const toggleTeacher = () => {
                if (teacherMode) {
                    setTeacherMode(false);
                } else {
                    setShowLogin(true);
                }
            };

            
            const attemptLogin = () => {
                const targetHash = "==QU4kXZL1CSQ1SMQF0T"; 
                // Implementation of the hashing check logic
                const inputHash = btoa(password.trim()).split('').reverse().join('');
                
                if (inputHash === targetHash) {
                    setTeacherMode(true);
                    setShowLogin(false);
                    setPassword("");
                } else {
                    alert("Incorrect Password");
                }
            };

            const autoFill = () => {
                const autoClass = {};
                ASSET_ITEMS_2022.forEach(item => { autoClass[`class_${item.id}`] = item.correctType; });
                LIAB_EQ_ITEMS_2022.forEach(item => { autoClass[`class_${item.id}`] = item.correctType; });
                
                // Decode matrix for autofill
                const decodedMatrix = {};
                Object.keys(_DATA_MATRIX).forEach(key => {
                    decodedMatrix[key] = d(_DATA_MATRIX[key]);
                });
                
                setInputs({...decodedMatrix, ...autoClass});
            };

            // New Reset Function
            const handleReset = () => {
                setInputs(getInitialInputs()); // Reset to just the 2021 prefilled data
                setStudentName("");
                setShowResetConfirm(false);
                setActiveModule('intro'); // Optional: Go back to start
            };

            const generateDownloadFile = (nameToUse) => {
                const lines = [];
                lines.push("STUDENT ANSWERS - PARKER HANNIFIN CASE");
                lines.push(`Student Name: ${nameToUse || "Not Provided"}`);
                lines.push("======================================\n");
                
                Object.keys(inputs).forEach(key => {
                    if (key.startsWith('class_')) return; 
                    lines.push(`${key}: ${inputs[key]}`);
                });
                
                const blob = new Blob([lines.join('\n')], { type: "text/plain" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "FinSim_Answers.txt";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const handleDownloadClick = () => {
                if (!studentName || !studentName.trim()) {
                    setShowNamePrompt(true);
                } else {
                    generateDownloadFile(studentName);
                }
            };

            // Sidebar navigation handler (closes menu on mobile)
            const handleNav = (module) => {
                setActiveModule(module);
                setShowDataPanel(false);
                setMobileMenuOpen(false);
            };

            return (
                <div className="flex h-screen bg-slate-50 relative">
                    
                    {/* Mobile Menu Overlay */}
                    {mobileMenuOpen && (
                        <div className="fixed inset-0 bg-black/50 z-30 md:hidden" onClick={() => setMobileMenuOpen(false)}></div>
                    )}

                    {/* SIDEBAR */}
                    <div 
                        ref={sidebarRef}
                        id="sidebar-container"
                        style={{ width: window.innerWidth >= 768 ? sidebarWidth : undefined }}
                        className={`bg-slate-900 text-white flex flex-col shadow-2xl z-40 shrink-0 fixed inset-y-0 left-0 h-full transition-transform duration-300 transform md:translate-x-0 md:relative md:static ${mobileMenuOpen ? "translate-x-0" : "-translate-x-full"}`}
                    >
                        <div className="resizer" onMouseDown={startResizing}></div>
                        <div className="p-6 border-b border-slate-800 flex justify-between items-center">
                            <div>
                                <h1 className="text-xl font-bold tracking-tight text-blue-400">FinSim<span className="text-white">Pro</span></h1>
                                <p className="text-xs text-slate-400 mt-1">Case 1: Parker Hannifin</p>
                            </div>
                            <button className="md:hidden text-slate-400" onClick={() => setMobileMenuOpen(false)}>
                                <Icons.X />
                            </button>
                        </div>
                        <nav className="flex-1 p-4 space-y-2 overflow-y-auto">
                            <button onClick={() => handleNav('intro')} className={`w-full flex items-center p-3 rounded-lg transition-all duration-200 ${activeModule === 'intro' ? 'bg-blue-600 shadow-lg shadow-blue-900/50' : 'hover:bg-slate-800 text-slate-300'}`}>
                                <Icons.FileText /> <span className="ml-3 font-medium">10-K Research</span>
                            </button>
                            <button onClick={() => handleNav('module1')} className={`w-full flex items-center p-3 rounded-lg transition-all duration-200 ${activeModule === 'module1' ? 'bg-blue-600 shadow-lg shadow-blue-900/50' : 'hover:bg-slate-800 text-slate-300'}`}>
                                <Icons.BookOpen /> <span className="ml-3 font-medium">Statements</span>
                            </button>
                            <button onClick={() => handleNav('module2')} className={`w-full flex items-center p-3 rounded-lg transition-all duration-200 ${activeModule === 'module2' ? 'bg-blue-600 shadow-lg shadow-blue-900/50' : 'hover:bg-slate-800 text-slate-300'}`}>
                                <Icons.Link /> <span className="ml-3 font-medium">Articulation</span>
                            </button>
                            <button onClick={() => handleNav('module3')} className={`w-full flex items-center p-3 rounded-lg transition-all duration-200 ${activeModule === 'module3' ? 'bg-blue-600 shadow-lg shadow-blue-900/50' : 'hover:bg-slate-800 text-slate-300'}`}>
                                <Icons.BarChart /> <span className="ml-3 font-medium">Common-Size</span>
                            </button>
                            <button onClick={() => handleNav('module4')} className={`w-full flex items-center p-3 rounded-lg transition-all duration-200 ${activeModule === 'module4' ? 'bg-blue-600 shadow-lg shadow-blue-900/50' : 'hover:bg-slate-800 text-slate-300'}`}>
                                <Icons.PieChart /> <span className="ml-3 font-medium">Cash Flow & Valuation</span>
                            </button>
                            
                            <div className="pt-4 border-t border-slate-800 mt-4">
                                <button onClick={() => { setShowDataPanel(!showDataPanel); setMobileMenuOpen(false); }} className={`w-full flex items-center p-3 rounded-lg transition-all duration-200 ${showDataPanel ? 'bg-indigo-600 text-white shadow-lg' : 'hover:bg-slate-800 text-indigo-300'}`}>
                                    <Icons.Database /> <span className="ml-3 font-medium">Reference Data</span>
                                    <div className="ml-auto opacity-50"><Icons.ChevronRight /></div>
                                </button>
                            </div>
                        </nav>
                        
                        {/* Footer Actions */}
                        <div className="p-4 border-t border-slate-800 space-y-3">
                            <input 
                                type="text" 
                                value={studentName}
                                onChange={(e) => setStudentName(e.target.value)}
                                placeholder="Enter Your Name"
                                className="w-full p-2 rounded bg-slate-800 border border-slate-700 text-white text-sm placeholder-slate-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                            />
                            <button onClick={handleDownloadClick} className="w-full flex items-center justify-center p-2 rounded bg-green-600 hover:bg-green-500 text-white text-sm transition font-bold shadow">
                                <Icons.Download /> <span className="ml-2">Download Answers</span>
                            </button>
                            <button onClick={() => setShowCalc(!showCalc)} className="w-full flex items-center justify-center p-2 rounded bg-slate-800 hover:bg-slate-700 text-sm transition">
                                <Icons.Calculator /> <span className="ml-2">Calculator</span>
                            </button>
                            <button onClick={toggleTeacher} className={`w-full flex items-center justify-center p-2 rounded text-sm transition ${teacherMode ? 'bg-yellow-600 hover:bg-yellow-500 text-white' : 'bg-transparent text-slate-500 hover:text-slate-300'}`}>
                                <Icons.Lock className={teacherMode ? "opacity-100" : "opacity-30"} /> 
                            </button>
                            
                            {/* Auto-Fill Button (Teacher Only) */}
                            {teacherMode && (
                                <button onClick={autoFill} className="w-full text-center text-xs text-yellow-500 hover:text-yellow-400 underline">
                                    Auto-Fill Answers
                                </button>
                            )}

                            {/* NEW: Reset Button */}
                            <button 
                                onClick={() => setShowResetConfirm(true)}
                                className="w-full flex items-center justify-center p-2 rounded text-red-400 hover:bg-red-500/10 hover:text-red-300 text-xs transition mt-2 border border-transparent hover:border-red-900/30"
                            >
                                <Icons.Trash2 /> <span className="ml-2">Reset Simulation</span>
                            </button>

                        </div>
                    </div>

                    {/* REFERENCE DATA PANEL (Slide-out) */}
                    {showDataPanel && (
                        <div className="fixed inset-y-0 right-0 w-full sm:w-96 bg-slate-50 border-l border-slate-200 shadow-xl overflow-y-auto z-50 custom-scrollbar flex flex-col animate-fade-in transition-all">
                             <div className="p-4 bg-white border-b border-slate-200 sticky top-0 z-10 flex justify-between items-center">
                                <h3 className="font-bold text-slate-800 flex items-center gap-2">
                                    <Icons.Database /> Case Exhibits
                                </h3>
                                <button onClick={() => setShowDataPanel(false)} className="text-slate-400 hover:text-red-500">
                                    <Icons.X />
                                </button>
                            </div>
                            <div className="p-4 space-y-4">
                                <div className="space-y-1">
                                    <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Parker Hannifin</h4>
                                    <DataAccordion dataKey="ph_bs" onValueClick={handleDataValueClick} />
                                    <DataAccordion dataKey="ph_is" onValueClick={handleDataValueClick} />
                                    <DataAccordion dataKey="ph_scf" onValueClick={handleDataValueClick} />
                                </div>
                            </div>
                        </div>
                    )}

                    {/* MAIN CONTENT AREA */}
                    <div className="flex-1 overflow-y-auto bg-slate-50 h-full">
                        {/* Top Bar */}
                        <header className="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-4 sm:px-8 sticky top-0 z-10 shadow-sm">
                            <div className="flex items-center text-slate-500 text-sm">
                                <button onClick={() => setMobileMenuOpen(true)} className="md:hidden mr-4 text-slate-700">
                                    <Icons.Menu />
                                </button>
                                <span className="font-semibold text-slate-800 hidden sm:inline">Case Study</span>
                                <span className="hidden sm:inline mx-1"><Icons.ChevronRight /></span>
                                <span className="font-semibold text-slate-800 truncate">
                                    {activeModule === 'intro' ? '10-K Research' : 
                                     activeModule === 'module1' ? 'Financial Statements' : 
                                     activeModule === 'module2' ? 'Articulation' :
                                     activeModule === 'module3' ? 'Common-Size' : 'Cash Flow & Val'}
                                </span>
                            </div>
                            <div className="text-xs text-slate-400 shrink-0 ml-2">
                                {Object.keys(inputs).length} fields filled
                            </div>
                        </header>

                        <main className="p-4 sm:p-8">
                            {activeModule === 'intro' && <ModuleIntro inputs={inputs} handleInputChange={handleInputChange} teacherMode={teacherMode} onFocus={handleInputFocus} activeInputId={activeInputId} />}
                            {activeModule === 'module1' && <Module1 inputs={inputs} handleInputChange={handleInputChange} teacherMode={teacherMode} onFocus={handleInputFocus} activeInputId={activeInputId} />}
                            {activeModule === 'module2' && <ModuleArticulation inputs={inputs} handleInputChange={handleInputChange} teacherMode={teacherMode} onFocus={handleInputFocus} activeInputId={activeInputId} />}
                            {activeModule === 'module3' && <Module3 inputs={inputs} handleInputChange={handleInputChange} teacherMode={teacherMode} onFocus={handleInputFocus} activeInputId={activeInputId} />}
                            {activeModule === 'module4' && <Module4 inputs={inputs} handleInputChange={handleInputChange} teacherMode={teacherMode} onFocus={handleInputFocus} activeInputId={activeInputId} />}
                        </main>
                    </div>

                    {/* OVERLAYS */}
                    {showCalc && <Calculator onClose={() => setShowCalc(false)} />}
                    
                    {/* Teacher Login Modal */}
                    {showLogin && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-xl shadow-2xl w-80">
                                <h3 className="text-lg font-bold mb-4 text-slate-800">Instructor Access</h3>
                                <input 
                                    type="password" 
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    placeholder="Enter password"
                                    className="w-full border border-slate-300 rounded p-2 mb-4 focus:ring-2 focus:ring-blue-500 outline-none"
                                    onKeyDown={(e) => e.key === 'Enter' && attemptLogin()}
                                />
                                <div className="flex justify-end gap-2">
                                    <button onClick={() => setShowLogin(false)} className="px-3 py-1 text-sm text-slate-500 hover:bg-slate-100 rounded">Cancel</button>
                                    <button onClick={attemptLogin} className="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">Login</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Student Name Prompt Modal */}
                    {showNamePrompt && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 animate-fade-in p-4">
                            <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm transform transition-all scale-100">
                                <div className="mb-4 text-center">
                                    <div className="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4">
                                        <Icons.FileText />
                                    </div>
                                    <h3 className="text-xl font-bold text-slate-800">Enter Your Name</h3>
                                    <p className="text-sm text-slate-500 mt-2">Please enter your name to identify your work on the downloaded answer sheet.</p>
                                </div>
                                <input 
                                    type="text" 
                                    value={studentName}
                                    onChange={(e) => setStudentName(e.target.value)}
                                    placeholder="Your Full Name"
                                    className="w-full p-3 border border-slate-300 rounded-lg mb-6 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-center font-medium"
                                    autoFocus
                                />
                                <div className="flex flex-col gap-3">
                                    <button 
                                        onClick={() => {
                                            if (studentName.trim()) {
                                                generateDownloadFile(studentName);
                                                setShowNamePrompt(false);
                                            } else {
                                                alert("Please enter a name.");
                                            }
                                        }} 
                                        className="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition shadow-lg hover:shadow-xl"
                                    >
                                        Save & Download
                                    </button>
                                    <button 
                                        onClick={() => setShowNamePrompt(false)} 
                                        className="w-full py-2 text-slate-500 hover:text-slate-700 text-sm font-medium hover:bg-slate-50 rounded-lg transition"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Reset Confirmation Modal */}
                    {showResetConfirm && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 animate-fade-in p-4">
                            <div className="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                                <div className="flex items-center gap-3 mb-4 text-red-600">
                                    <div className="p-2 bg-red-100 rounded-full">
                                        <Icons.Trash2 />
                                    </div>
                                    <h3 className="text-lg font-bold text-slate-800">Reset Simulation?</h3>
                                </div>
                                <p className="text-sm text-slate-600 mb-6 leading-relaxed">
                                    This will <strong>clear all your answers</strong> and return the simulation to its initial state. This action cannot be undone.
                                </p>
                                <div className="flex justify-end gap-2">
                                    <button 
                                        onClick={() => setShowResetConfirm(false)} 
                                        className="px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded-lg transition font-medium"
                                    >
                                        Cancel
                                    </button>
                                    <button 
                                        onClick={handleReset} 
                                        className="px-4 py-2 text-sm bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-medium shadow-sm"
                                    >
                                        Yes, Reset Everything
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
