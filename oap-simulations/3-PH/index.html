<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DuPont Disaggregation - Parker Hannifin</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        .input-correct { @apply bg-green-50 border-green-500 text-green-700; }
        .input-incorrect { @apply bg-white border-gray-300; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .clickable-cell {
            cursor: pointer;
            transition: all 0.1s ease;
            user-select: none;
        }
        .clickable-cell:hover {
            background-color: #dbeafe;
            color: #1e40af;
            font-weight: 700;
            box-shadow: inset 0 0 0 1px #3b82f6;
        }
        .clickable-cell:active { background-color: #93c5fd; }
        
        .active-input-ring {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
            border-color: #3b82f6;
        }

        .toggle-btn { transition: all 0.2s; }
        .toggle-op { background-color: #dcfce7; color: #166534; border-color: #86efac; }
        .toggle-nonop { background-color: #f3f4f6; color: #4b5563; border-color: #d1d5db; }
        
        /* Modal Animation */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICONS ---
        const Icons = {
            Database: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            ChevronDown: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"/></svg>,
            HelpCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>,
            Info: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>,
            Lock: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            Unlock: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        };

        // --- DATA ---
        
        // 2022 & 2021 Data for Classification (Parker Hannifin)
        const CLASSIFICATION_ITEMS = [
            { id: "cash", label: "Cash and cash equivalents", val22: 535799, val21: 733117, type: "asset", correct: "non-op" },
            { id: "mkt", label: "Marketable securities", val22: 27862, val21: 39116, type: "asset", correct: "non-op" },
            { id: "ar", label: "Trade accounts receivable", val22: 2341504, val21: 2183594, type: "asset", correct: "op" },
            { id: "notes_r", label: "Non-trade and notes receivable", val22: 543757, val21: 326315, type: "asset", correct: "op" },
            { id: "inv", label: "Inventories", val22: 2214553, val21: 2090642, type: "asset", correct: "op" },
            { id: "pre", label: "Prepaid expenses and other", val22: 6383169, val21: 243966, type: "asset", correct: "op" },
            { id: "ppe", label: "Property, plant and equipment, net", val22: 2122758, val21: 2266476, type: "asset", correct: "op" },
            { id: "def_a", label: "Deferred income taxes (Asset)", val22: 110585, val21: 104251, type: "asset", correct: "op" },
            { id: "invest", label: "Investments and other assets", val22: 788057, val21: 774239, type: "asset", correct: "op" },
            { id: "int", label: "Intangible assets, net", val22: 3135817, val21: 3519797, type: "asset", correct: "op" },
            { id: "good", label: "Goodwill", val22: 7740082, val21: 8059687, type: "asset", correct: "op" },

            { id: "notes_pay", label: "Notes payable (Current Debt)", val22: 1724310, val21: 2824, type: "liab", correct: "non-op" },
            { id: "ap", label: "Accounts payable", val22: 1731925, val21: 1667878, type: "liab", correct: "op" },
            { id: "acc_pay", label: "Accrued payrolls", val22: 470132, val21: 507027, type: "liab", correct: "op" },
            { id: "acc_tax", label: "Accrued taxes", val22: 250292, val21: 236384, type: "liab", correct: "op" },
            { id: "lease_cur", label: "Current lease liabilities", val22: 36023, val21: 40193, type: "liab", correct: "non-op" },
            { id: "other_acc", label: "Other accrued liabilities", val22: 1646636, val21: 642197, type: "liab", correct: "op" },
            { id: "lt_debt", label: "Long-term debt", val22: 9755825, val21: 6582053, type: "liab", correct: "non-op" },
            { id: "pension", label: "Pensions", val22: 639939, val21: 1055638, type: "liab", correct: "op" },
            { id: "def_liab", label: "Deferred income taxes", val22: 307044, val21: 553981, type: "liab", correct: "op" },
            { id: "lease_lt", label: "Long-term lease liabilities", val22: 100337, val21: 93904, type: "liab", correct: "non-op" },
            { id: "other_l", label: "Other liabilities", val22: 421560, val21: 545451, type: "liab", correct: "op" },
        ];

        const CASE_DATA = {
            bs: {
                title: "Consolidated Balance Sheet",
                headers: ["Item", "Jun 30, 2022", "Jun 30, 2021"],
                rows: [
                    ["Total Current Assets", "12,046,644", "5,616,750"],
                    ["Property, Plant & Equipment, net", "2,122,758", "2,266,476"],
                    ["Goodwill", "7,740,082", "8,059,687"],
                    ["Intangible Assets, net", "3,135,817", "3,519,797"],
                    ["Other Assets", "898,642", "878,490"], // Combined Def Tax + Invest
                    ["Total Assets", "25,943,943", "20,341,200"],
                    ["", "", ""],
                    ["Total Current Liabilities", "5,859,318", "3,096,503"],
                    ["Long-term Debt", "9,755,825", "6,582,053"],
                    ["Pensions & Postretirement", "639,939", "1,055,638"],
                    ["Deferred Income Taxes", "307,044", "553,981"],
                    ["Other Liabilities", "521,897", "639,355"], // Combined Lease + Other
                    ["Total Liabilities", "17,084,023", "11,927,530"],
                    ["Total Equity", "8,859,920", "8,413,670"]
                ]
            },
            is: {
                title: "Consolidated Income Statement",
                headers: ["Item", "2022", "2021"],
                rows: [
                    ["Net Sales", "15,861,608", "14,347,640"],
                    ["Cost of Sales", "11,387,267", "10,449,680"],
                    ["Gross Profit", "4,474,341", "3,897,960"],
                    ["SG&A Expenses", "1,627,116", "1,527,302"],
                    ["Operating Income", "2,854,346", "2,479,990"],
                    ["Interest Expense", "255,252", "250,036"],
                    ["Other Expense (Income)", "984,868", "(17,003)"], // Combined Loss on fwd + other
                    ["Income Before Taxes", "1,614,226", "2,246,957"],
                    ["Income Taxes", "298,040", "500,096"],
                    ["Net Income", "1,316,186", "1,746,861"]
                ]
            },
            supp: {
                title: "Supplemental Info",
                headers: ["Item", "2022", "2021", "2020"],
                rows: [
                    ["Tax Rate", "22%", "22%", "22%"],
                    ["Non-Operating Items (Pre-tax)", "1,240,120", "233,033", "241,049"],
                    ["Tax Shield (22%)", "272,826", "51,267", "53,031"],
                    ["Average Total Equity", "8,636,795", "7,327,720", "-"],
                    ["Average NOA", "15,920,399", "13,168,717", "-"],
                    ["Average NNO", "7,283,604", "5,840,997", "-"]
                ]
            }
        };

        const ANSWER_KEY = {
            "roe_2022": "15.26", "roe_2021": "23.88",
            "roa_2022": "5.69", "roa_2021": "8.68",
            "fl_2022": "2.68",   "fl_2021": "2.74",
            "ncir_2022": "1.0011", "ncir_2021": "1.0016",
            "pm_2022": "8.30",  "pm_2021": "12.18",
            "at_2022": "0.69",   "at_2021": "0.71",
            
            // 4a
            "avg_noa_2022": "15920399", "avg_noa_2021": "13168717",
            "avg_nno_2022": "7283604", "avg_nno_2021": "5840997",

            // 4b
            "nne_calc": "967294",
            "nopat_m1": "2283480",
            "nopat_m2": "2283480",
            
            // 5
            "rnoa_2022": "14.34", "rnoa_2021": "14.65",
            "nnep_2022": "13.28", "nnep_2021": "3.11", // NNE/Avg NNO
            "spread_2022": "1.06", "spread_2021": "11.53",
            "flev_2022": "0.843", "flev_2021": "0.797",
            "nopm_2022": "14.40", "nopm_2021": "13.44",
            "noat_2022": "0.9963", "noat_2021": "1.0895"
        };

        const HINT_DATA = {
            roe: { title: "Return on Equity", def: "Net Income / Average Stockholders' Equity" },
            dupont: { 
                title: "DuPont Disaggregation", 
                def: (
                    <span>
                        ROE = ROA × FL × NCIR
                        <br/><br/>
                        <span className="block text-slate-600 font-mono text-[11px] mb-1">ROA = Net Income / Average Total Assets</span>
                        <span className="block text-slate-600 font-mono text-[11px]">FL = Average Total Assets / Average Total Equity</span>
                    </span>
                )
            },
            roa: { title: "Return on Assets", def: "Net Income / Average Total Assets" },
            fl: { title: "Financial Leverage", def: "Avg Total Assets / Avg Stockholders' Equity" },
            ncir: { title: "NCIR", def: "Net Income / Net Income Attributable to Parent" },
            roa_decomp: { title: "ROA Decomposition", def: "Profit Margin × Asset Turnover" },
            op_v_nonop: { title: "Operating vs Nonoperating ROE", def: "ROE = [RNOA + (Spread × FLEV)] × NCIR" },
            rnoa: { title: "RNOA", def: "NOPAT / Average Net Operating Assets (NOA)" },
            nnep: { title: "NNEP", def: "Net Nonoperating Expense / Average NNO" },
            flev_op: { title: "Operating FLEV", def: "Average NNO / Average Total Equity" },
            spread: { title: "Spread", def: "RNOA - NNEP" },
            rnoa_decomp: { title: "RNOA Decomposition", def: "NOPM × NOAT" }
        };

        // --- COMPONENTS ---

        const HintBox = ({ id }) => {
            const [isOpen, setIsOpen] = useState(false);
            const data = HINT_DATA[id];
            if(!data) return null;
            return (
                <div className="mt-1 text-xs">
                    <button onClick={() => setIsOpen(!isOpen)} className="flex items-center gap-1 text-blue-600 hover:text-blue-800 font-medium">
                        <Icons.Info /> {isOpen ? "Hide Hint" : "Show Hint"}
                    </button>
                    {isOpen && (
                        <div className="mt-1 p-2 bg-blue-50 border border-blue-200 rounded text-slate-700 animate-fade-in">
                            <p className="font-bold text-blue-900">{data.title}</p>
                            <div className="mt-1">{data.def}</div>
                        </div>
                    )}
                </div>
            );
        };

        const SmartInput = ({ id, value, onChange, correctValue, placeholder, activeInput, setActiveInput, teacherMode, isPercentage, readOnly }) => {
            const isActive = activeInput === id;
            
            const validate = (val) => {
                if(!val || !correctValue) return { isCorrect: false };
                try {
                    const cleanExpr = val.toString().replace(/,/g, '').replace(/[^\d\.\+\-\*\/\(\)]/g, '');
                    // eslint-disable-next-line no-eval
                    const calculated = eval(cleanExpr);
                    if(!isFinite(calculated)) return { isCorrect: false };
                    
                    const correctNum = parseFloat(correctValue.toString().replace(/,/g, ''));
                    const tol = 0.5; // Slightly looser tolerance for thousands inputs
                    
                    if(Math.abs(calculated - correctNum) < tol) return { isCorrect: true, formatted: isPercentage ? correctNum.toFixed(2) : correctNum.toLocaleString('en-US', {maximumFractionDigits: 4}) };
                    if(isPercentage && Math.abs((calculated * 100) - correctNum) < tol) return { isCorrect: true, formatted: correctNum.toFixed(2) };
                    
                    return { isCorrect: false };
                } catch { return { isCorrect: false }; }
            };

            const { isCorrect, formatted } = validate(value);

            const handleBlur = () => { if(isCorrect && formatted && formatted !== value) onChange(id, formatted); };
            const handleKeyDown = (e) => { if(e.key === 'Enter') { handleBlur(); e.target.blur(); } };

            return (
                <div className="relative w-full">
                    <input
                        id={id}
                        type="text"
                        value={readOnly ? correctValue : (value || '')}
                        onChange={readOnly ? undefined : (e) => onChange(id, e.target.value)}
                        onFocus={readOnly ? undefined : () => setActiveInput(id)}
                        onBlur={readOnly ? undefined : handleBlur}
                        onKeyDown={readOnly ? undefined : handleKeyDown}
                        readOnly={readOnly}
                        className={`w-full p-2 text-right border rounded text-sm font-mono transition-all outline-none ${
                            readOnly ? 'bg-gray-100 text-gray-600 border-gray-300' :
                            isActive ? 'active-input-ring z-10 border-blue-500' : 'border-gray-300'
                        } ${!readOnly && isCorrect ? 'bg-green-50 text-green-800 border-green-400 font-bold' : ''}`}
                        placeholder={placeholder}
                    />
                    {!readOnly && isCorrect && <div className="absolute left-2 top-2 text-green-600 pointer-events-none"><Icons.Check /></div>}
                    {teacherMode && !isCorrect && !readOnly && <div className="absolute -top-5 right-0 text-[10px] bg-yellow-100 text-yellow-800 px-1 rounded shadow z-20 whitespace-nowrap">Correct: {correctValue}</div>}
                </div>
            );
        };

        const ReferenceTable = ({ title, data, onValueClick }) => {
            const [isOpen, setIsOpen] = useState(true);
            return (
                <div className="bg-white border border-slate-200 rounded-lg shadow-sm mb-4 overflow-hidden">
                    <button onClick={() => setIsOpen(!isOpen)} className="w-full flex items-center justify-between p-3 bg-slate-50 hover:bg-slate-100 transition text-sm font-bold text-slate-700">
                        <span className="flex items-center gap-2"><Icons.Database /> {title}</span>
                        <div className={`transition-transform ${isOpen ? 'rotate-180' : ''}`}><Icons.ChevronDown /></div>
                    </button>
                    {isOpen && (
                        <div className="overflow-x-auto">
                            <table className="w-full text-xs text-left">
                                <thead className="bg-slate-100 text-slate-500">
                                    <tr>{data.headers.map((h, i) => <th key={i} className={`p-2 border-b ${i>0?'text-right':''}`}>{h}</th>)}</tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {data.rows.map((row, i) => (
                                        <tr key={i} className="hover:bg-blue-50/30">
                                            <td className="p-2 font-medium text-slate-700">{row[0]}</td>
                                            {row.slice(1).map((cell, j) => (
                                                <td key={j} onMouseDown={(e) => { e.preventDefault(); onValueClick(cell); }} className="p-2 text-right font-mono text-slate-600 clickable-cell" title="Click to insert">{cell}</td>
                                            ))}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };

        const ClassificationTable = ({ items, selections, onToggle, inputs, handleInputChange, activeInput, setActiveInput, teacherMode }) => {
            const totals = useMemo(() => {
                let res = { opA22: 0, opA21: 0, noA22: 0, noA21: 0, opL22: 0, opL21: 0, noL22: 0, noL21: 0 };
                items.forEach(item => {
                    const type = selections[item.id] || "op";
                    if(item.type === 'asset') {
                        if(type === 'op') { res.opA22 += item.val22; res.opA21 += item.val21; }
                        else { res.noA22 += item.val22; res.noA21 += item.val21; }
                    } else {
                        if(type === 'op') { res.opL22 += item.val22; res.opL21 += item.val21; }
                        else { res.noL22 += item.val22; res.noL21 += item.val21; }
                    }
                });
                return res;
            }, [items, selections]);

            const noa22 = totals.opA22 - totals.opL22;
            const noa21 = totals.opA21 - totals.opL21;
            const nno22 = totals.noL22 - totals.noA22;
            const nno21 = totals.noL21 - totals.noA21;

            return (
                <div className="bg-white rounded border border-slate-200 overflow-hidden mb-6">
                    <div className="bg-slate-50 p-3 border-b text-sm font-bold text-slate-700 flex justify-between">
                        <span>Classification (2022 & 2021)</span>
                        <span className="text-xs font-normal text-slate-500">Toggle sets classification for both years</span>
                    </div>
                    <div className="grid grid-cols-12 gap-0 text-xs">
                        <div className="col-span-4 p-2 font-bold text-slate-500 border-b">Item</div>
                        <div className="col-span-2 p-2 font-bold text-slate-500 border-b text-right">2022</div>
                        <div className="col-span-2 p-2 font-bold text-slate-500 border-b text-right">2021</div>
                        <div className="col-span-4 p-2 font-bold text-slate-500 border-b text-center">Type</div>
                        
                        {items.map(item => {
                            const isOp = (selections[item.id] || 'op') === 'op';
                            return (
                                <React.Fragment key={item.id}>
                                    <div className="col-span-4 p-2 border-b flex items-center">{item.label}</div>
                                    <div className="col-span-2 p-2 border-b text-right font-mono">{item.val22.toLocaleString()}</div>
                                    <div className="col-span-2 p-2 border-b text-right font-mono text-slate-500">{item.val21.toLocaleString()}</div>
                                    <div className="col-span-4 p-1 border-b flex justify-center">
                                        <button onClick={() => onToggle(item.id)} className={`px-3 py-1 rounded-full text-[10px] font-bold border toggle-btn ${isOp ? 'toggle-op' : 'toggle-nonop'}`}>
                                            {isOp ? 'Operating' : 'Non-Operating'}
                                        </button>
                                        {teacherMode && item.correct !== (selections[item.id] || 'op') && <span className="text-red-500 ml-1">●</span>}
                                    </div>
                                </React.Fragment>
                            );
                        })}
                    </div>
                    <div className="p-4 bg-slate-50 border-t">
                        <div className="grid grid-cols-3 gap-4 text-sm mb-4">
                            <div className="font-bold text-slate-500 text-right">Metric</div>
                            <div className="font-bold text-slate-700 text-right">2022 Total</div>
                            <div className="font-bold text-slate-700 text-right">2021 Total</div>
                            
                            <div className="text-right text-blue-800">Net Operating Assets (NOA)</div>
                            <div className="text-right font-mono font-bold text-blue-900 bg-blue-50 rounded px-2">{noa22.toLocaleString()}</div>
                            <div className="text-right font-mono font-bold text-blue-900 bg-blue-50 rounded px-2">{noa21.toLocaleString()}</div>

                            <div className="text-right text-slate-700">Net Nonoperating Obs (NNO)</div>
                            <div className="text-right font-mono font-bold text-slate-900 bg-gray-100 rounded px-2">{nno22.toLocaleString()}</div>
                            <div className="text-right font-mono font-bold text-slate-900 bg-gray-100 rounded px-2">{nno21.toLocaleString()}</div>
                        </div>
                        <div className="grid grid-cols-2 gap-6 border-t pt-4">
                            <div>
                                <label className="text-xs font-bold text-slate-600 block mb-1">Calculate Average NOA</label>
                                <SmartInput id="avg_noa_2022" value={inputs.avg_noa_2022} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEY.avg_noa_2022} teacherMode={teacherMode} placeholder="(NOA22+NOA21)/2" />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-600 block mb-1">Calculate Average NNO</label>
                                <SmartInput id="avg_nno_2022" value={inputs.avg_nno_2022} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEY.avg_nno_2022} teacherMode={teacherMode} placeholder="(NNO22+NNO21)/2" />
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [inputs, setInputs] = useState({});
            const [selections, setSelections] = useState({});
            const [activeInput, setActiveInput] = useState(null);
            const [teacherMode, setTeacherMode] = useState(false);
            const [showLogin, setShowLogin] = useState(false);
            const [showNamePrompt, setShowNamePrompt] = useState(false);
            const [studentName, setStudentName] = useState("");
            const [password, setPassword] = useState("");

            useEffect(() => {
                const initialSelections = {};
                CLASSIFICATION_ITEMS.forEach(i => initialSelections[i.id] = 'op');
                setSelections(initialSelections);
            }, []);

            const handleInputChange = (id, val) => setInputs(prev => ({ ...prev, [id]: val }));
            const handleToggle = (id) => setSelections(prev => ({ ...prev, [id]: prev[id] === 'op' ? 'non-op' : 'op' }));

            const handleValueClick = (val) => {
                if (!activeInput) return;
                let cleanVal = val.replace(/,/g, '');
                if (cleanVal.includes('(')) cleanVal = '-' + cleanVal.replace(/[()]/g, '');
                setInputs(prev => {
                    const currentVal = prev[activeInput] || "";
                    const operators = ['+', '-', '*', '/', '('];
                    const lastChar = currentVal.trim().slice(-1);
                    return (currentVal === "" || operators.includes(lastChar)) 
                        ? { ...prev, [activeInput]: currentVal + cleanVal }
                        : { ...prev, [activeInput]: cleanVal };
                });
                setTimeout(() => document.getElementById(activeInput)?.focus(), 0);
            };

            const generateDownload = () => {
                const text = `DuPont Analysis - Parker Hannifin\nStudent: ${studentName}\n\nAnswers:\n${JSON.stringify(inputs, null, 2)}`;
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `${studentName.replace(/\s+/g,'_')}_PH_Analysis.txt`;
                a.click();
                setShowNamePrompt(false);
            };

            const toggleTeacher = () => teacherMode ? setTeacherMode(false) : setShowLogin(true);
            
            // PASSWORD CHECK - Obfuscated
            // 'dGVhY2hlcg==' is the Base64 encoding of 'teacher'
            const checkPassword = () => { 
                if(btoa(password.toLowerCase()) === 'dGVhY2hlcg==') { 
                    setTeacherMode(true); 
                    setShowLogin(false); 
                    setPassword(''); 
                } else {
                    alert("Incorrect Code"); 
                }
            };
            
            const autoFill = () => {
                if(teacherMode) {
                    // Toggle Logic: If populated (>5 keys), clear. Else fill.
                    if (Object.keys(inputs).length > 5) {
                        setInputs({});
                        const initialSelections = {};
                        CLASSIFICATION_ITEMS.forEach(i => initialSelections[i.id] = 'op');
                        setSelections(initialSelections);
                    } else {
                        setInputs(ANSWER_KEY);
                        const correctSels = {};
                        CLASSIFICATION_ITEMS.forEach(i => correctSels[i.id] = i.correct);
                        setSelections(correctSels);
                    }
                }
            };

            return (
                <div className="flex h-screen overflow-hidden bg-slate-100">
                    <div className="w-1/3 bg-white border-r border-slate-200 overflow-y-auto custom-scrollbar flex flex-col z-10 shadow-lg">
                        <div className="p-4 bg-slate-900 text-white sticky top-0 z-20 shadow">
                            <h2 className="font-bold text-lg flex items-center gap-2"><span className="text-orange-400">Parker Hannifin</span> Ref. Data</h2>
                            <p className="text-xs text-slate-400 mt-1">Click numbers to calculate. Values in $ Thousands.</p>
                        </div>
                        <div className="p-4 space-y-2">
                            <ReferenceTable title="Balance Sheet" data={CASE_DATA.bs} onValueClick={handleValueClick} />
                            <ReferenceTable title="Income Statement" data={CASE_DATA.is} onValueClick={handleValueClick} />
                            <ReferenceTable title="Supplemental Info" data={CASE_DATA.supp} onValueClick={handleValueClick} />
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto custom-scrollbar bg-slate-50">
                        <div className="p-8 max-w-4xl mx-auto">
                            <div className="flex justify-between items-center mb-8 sticky top-0 bg-slate-50 py-4 z-10 border-b">
                                <div>
                                    <h1 className="text-2xl font-bold text-slate-800">DuPont Disaggregation</h1>
                                    <p className="text-slate-500">Parker Hannifin (PH) - 2022 Analysis</p>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => setShowNamePrompt(true)} className="px-4 py-2 bg-blue-600 text-white rounded text-sm font-bold flex items-center gap-2"><Icons.Download /> Save & Download</button>
                                    {teacherMode && (
                                        <button 
                                            onClick={autoFill} 
                                            className={`px-3 py-1 rounded text-sm font-bold transition ${Object.keys(inputs).length > 5 ? 'bg-red-100 text-red-700 hover:bg-red-200' : 'bg-green-100 text-green-700 hover:bg-green-200'}`}
                                        >
                                            {Object.keys(inputs).length > 5 ? 'Clear All' : 'Auto-Fill'}
                                        </button>
                                    )}
                                    <button onClick={toggleTeacher} className="px-3 py-1 bg-white border rounded text-sm text-slate-600">{teacherMode ? 'Teacher On' : 'Instructor'}</button>
                                </div>
                            </div>

                            {/* 2. ROE */}
                            <div className="bg-white rounded shadow-sm border p-6 mb-6">
                                <div className="flex justify-between"><h3 className="font-bold text-lg text-slate-800">2. Return on Equity (ROE)</h3><HintBox id="roe"/></div>
                                <div className="grid grid-cols-3 gap-4 mt-2">
                                    <div></div><div className="text-center font-bold text-slate-500 text-sm">2022</div><div className="text-center font-bold text-slate-500 text-sm">2021</div>
                                    <div className="font-medium text-sm">ROE (%)</div>
                                    <SmartInput id="roe_2022" value={inputs.roe_2022} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEY.roe_2022} teacherMode={teacherMode} placeholder="%" isPercentage={true} />
                                    <SmartInput id="roe_2021" value={inputs.roe_2021} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEY.roe_2021} teacherMode={teacherMode} placeholder="%" isPercentage={true} />
                                </div>
                            </div>

                            {/* 3. DuPont */}
                            <div className="bg-white rounded shadow-sm border p-6 mb-6">
                                <div className="flex justify-between"><h3 className="font-bold text-lg text-slate-800">3. DuPont Disaggregation</h3><HintBox id="dupont"/></div>
                                <div className="grid grid-cols-3 gap-4 mt-2">
                                    <div className="font-medium text-sm">ROA (%)</div>
                                    <SmartInput id="roa_2022" value={inputs.roa_2022} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEY.roa_2022} teacherMode={teacherMode} placeholder="%" isPercentage={true} />
                                    <SmartInput id="roa_2021" value={inputs.roa_2021} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEY.roa_2021} teacherMode={teacherMode} placeholder="%" isPercentage={true} />
                                    <div className="font-medium text-sm">Fin. Leverage</div>
                                    <SmartInput id="fl_2022" value={inputs.fl_2022} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEY.fl_2022} teacherMode={teacherMode} placeholder="x" />
                                    <SmartInput id="fl_2021" value={inputs.fl_2021} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEY.fl_2021} teacherMode={teacherMode} placeholder="x" />
                                    <div className="font-medium text-sm">NCIR</div>
                                    <SmartInput id="ncir_2022" value={inputs.ncir_2022} correctValue={ANSWER_KEY.ncir_2022} readOnly={true} teacherMode={teacherMode} />
                                    <SmartInput id="ncir_2021" value={inputs.ncir_2021} correctValue={ANSWER_KEY.ncir_2021} readOnly={true} teacherMode={teacherMode} />
                                </div>
                            </div>

                            {/* 4. ROA Decomp */}
                            <div className="bg-white rounded shadow-sm border p-6 mb-6">
                                <div className="flex justify-between"><h3 className="font-bold text-lg text-slate-800">4. ROA Decomposition</h3><HintBox id="roa_decomp"/></div>
                                <div className="grid grid-cols-3 gap-4 mt-2">
                                    <div className="font-medium text-sm">Profit Margin (%)</div>
                                    <SmartInput id="pm_2022" value={inputs.pm_2022} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEY.pm_2022} teacherMode={teacherMode} placeholder="%" isPercentage={true} />
                                    <SmartInput id="pm_2021" value={inputs.pm_2021} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEY.pm_2021} teacherMode={teacherMode} placeholder="%" isPercentage={true} />
                                    <div className="font-medium text-sm">Asset Turnover</div>
                                    <SmartInput id="at_2022" value={inputs.at_2022} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEY.at_2022} teacherMode={teacherMode} placeholder="x" />
                                    <SmartInput id="at_2021" value={inputs.at_2021} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEY.at_2021} teacherMode={teacherMode} placeholder="x" />
                                </div>
                            </div>

                            {/* 4a. Classify */}
                            <div className="bg-white rounded shadow-sm border p-6 mb-6">
                                <h3 className="font-bold text-lg text-slate-800 mb-2">4a. Classify & Calculate NOA/NNO</h3>
                                <p className="text-sm text-slate-500 mb-4">Classify items to calculate NOA and NNO. The classifications will apply to both 2022 and 2021.</p>
                                <ClassificationTable items={CLASSIFICATION_ITEMS} selections={selections} onToggle={handleToggle} inputs={inputs} handleInputChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} teacherMode={teacherMode} />
                            </div>

                            {/* 4b. NOPAT */}
                            <div className="bg-white rounded shadow-sm border p-6 mb-6">
                                <h3 className="font-bold text-lg text-slate-800 mb-4">4b. NNE & NOPAT Derivation (2022)</h3>
                                <div className="space-y-6">
                                    <div className="bg-slate-50 p-4 rounded border">
                                        <h4 className="font-bold text-sm text-slate-700 mb-2">Method 1: Net Income Approach</h4>
                                        <div className="grid grid-cols-2 gap-4 mb-2">
                                            <div className="text-sm">Step 1: NNE (NonOp Items + Tax Shield)</div>
                                            <SmartInput id="nne_calc" value={inputs.nne_calc} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEY.nne_calc} teacherMode={teacherMode} placeholder="$" />
                                        </div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="text-sm">Step 2: NOPAT (Net Income + NNE)</div>
                                            <SmartInput id="nopat_m1" value={inputs.nopat_m1} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEY.nopat_m1} teacherMode={teacherMode} placeholder="$" />
                                        </div>
                                    </div>
                                    <div className="bg-slate-50 p-4 rounded border">
                                        <h4 className="font-bold text-sm text-slate-700 mb-2">Method 2: Operating Income Approach</h4>
                                        <div className="text-xs text-slate-500 mb-2 font-mono">Formula: Operating Income - Tax Provision + Tax Shield on NonOp Items</div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="text-sm">NOPAT Calculation</div>
                                            <SmartInput id="nopat_m2" value={inputs.nopat_m2} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEY.nopat_m2} teacherMode={teacherMode} placeholder="$" />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* 5. Operating ROE */}
                            <div className="bg-white rounded shadow-sm border p-6 mb-6">
                                <div className="flex justify-between"><h3 className="font-bold text-lg text-slate-800">5. Operating vs Nonoperating ROE</h3><HintBox id="op_v_nonop"/></div>
                                <div className="grid grid-cols-3 gap-4 mt-4">
                                    <div className="font-medium text-sm group relative cursor-help">
                                        RNOA (%)
                                        <span className="hidden group-hover:block absolute bottom-full mb-1 bg-gray-800 text-white text-xs p-1 rounded whitespace-nowrap">NOPAT / Average NOA</span>
                                    </div>
                                    <SmartInput id="rnoa_2022" value={inputs.rnoa_2022} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEY.rnoa_2022} teacherMode={teacherMode} placeholder="%" isPercentage={true} />
                                    <SmartInput id="rnoa_2021" value={inputs.rnoa_2021} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEY.rnoa_2021} teacherMode={teacherMode} placeholder="%" isPercentage={true} />
                                    
                                    <div className="font-medium text-sm group relative cursor-help">
                                        NNEP (%)
                                        <span className="hidden group-hover:block absolute bottom-full mb-1 bg-gray-800 text-white text-xs p-1 rounded whitespace-nowrap">NNE / Avg NNO</span>
                                    </div>
                                    <SmartInput id="nnep_2022" value={inputs.nnep_2022} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEY.nnep_2022} teacherMode={teacherMode} placeholder="%" isPercentage={true} />
                                    <SmartInput id="nnep_2021" value={inputs.nnep_2021} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEY.nnep_2021} teacherMode={teacherMode} placeholder="%" isPercentage={true} />

                                    <div className="font-medium text-sm group relative cursor-help">
                                        Spread (%)
                                        <span className="hidden group-hover:block absolute bottom-full mb-1 bg-gray-800 text-white text-xs p-1 rounded whitespace-nowrap">RNOA - NNEP</span>
                                    </div>
                                    <SmartInput id="spread_2022" value={inputs.spread_2022} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEY.spread_2022} teacherMode={teacherMode} placeholder="%" isPercentage={true} />
                                    <SmartInput id="spread_2021" value={inputs.spread_2021} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEY.spread_2021} teacherMode={teacherMode} placeholder="%" isPercentage={true} />

                                    <div className="font-medium text-sm group relative cursor-help">
                                        FLEV
                                        <span className="hidden group-hover:block absolute bottom-full mb-1 bg-gray-800 text-white text-xs p-1 rounded whitespace-nowrap">Avg NNO / Avg Equity</span>
                                    </div>
                                    <SmartInput id="flev_2022" value={inputs.flev_2022} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEY.flev_2022} teacherMode={teacherMode} placeholder="x" />
                                    <SmartInput id="flev_2021" value={inputs.flev_2021} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEY.flev_2021} teacherMode={teacherMode} placeholder="x" />
                                    
                                    <div className="font-medium text-sm">NCIR</div>
                                    <SmartInput id="ncir_2022" value={inputs.ncir_2022} correctValue={ANSWER_KEY.ncir_2022} readOnly={true} teacherMode={teacherMode} />
                                    <SmartInput id="ncir_2021" value={inputs.ncir_2021} correctValue={ANSWER_KEY.ncir_2021} readOnly={true} teacherMode={teacherMode} />
                                </div>
                            </div>

                            {/* 6. RNOA Decomp */}
                            <div className="bg-white rounded shadow-sm border p-6 mb-6">
                                <div className="flex justify-between"><h3 className="font-bold text-lg text-slate-800">6. RNOA Decomposition</h3><HintBox id="rnoa_decomp"/></div>
                                <div className="grid grid-cols-3 gap-4 mt-4">
                                    <div className="font-medium text-sm group relative cursor-help">
                                        NOPM (%)
                                        <span className="hidden group-hover:block absolute bottom-full mb-1 bg-gray-800 text-white text-xs p-1 rounded whitespace-nowrap">NOPAT / Revenue</span>
                                    </div>
                                    <SmartInput id="nopm_2022" value={inputs.nopm_2022} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEY.nopm_2022} teacherMode={teacherMode} placeholder="%" isPercentage={true} />
                                    <SmartInput id="nopm_2021" value={inputs.nopm_2021} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEY.nopm_2021} teacherMode={teacherMode} placeholder="%" isPercentage={true} />
                                    
                                    <div className="font-medium text-sm group relative cursor-help">
                                        NOAT
                                        <span className="hidden group-hover:block absolute bottom-full mb-1 bg-gray-800 text-white text-xs p-1 rounded whitespace-nowrap">Revenue / Average NOA</span>
                                    </div>
                                    <SmartInput id="noat_2022" value={inputs.noat_2022} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEY.noat_2022} teacherMode={teacherMode} placeholder="x" />
                                    <SmartInput id="noat_2021" value={inputs.noat_2021} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEY.noat_2021} teacherMode={teacherMode} placeholder="x" />
                                </div>
                            </div>
                        </div>
                    </div>

                    {showNamePrompt && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 animate-fade-in backdrop-blur-sm">
                            <div className="bg-white p-8 rounded-xl shadow-2xl w-96">
                                <h3 className="text-xl font-bold text-slate-800 mb-4 text-center">Save Your Work</h3>
                                <input type="text" value={studentName} onChange={(e) => setStudentName(e.target.value)} placeholder="Your Full Name" className="w-full p-3 border border-slate-300 rounded-lg mb-4 text-center" autoFocus />
                                <div className="flex flex-col gap-2">
                                    <button onClick={() => studentName.trim() ? generateDownload() : alert("Name required")} className="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">Download Answers</button>
                                    <button onClick={() => setShowNamePrompt(false)} className="w-full py-2 text-slate-500 hover:bg-slate-50 rounded-lg">Cancel</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showLogin && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 backdrop-blur-sm">
                            <div className="bg-white p-6 rounded-lg shadow-xl w-80">
                                <h3 className="font-bold text-lg mb-4">Instructor Code</h3>
                                <input type="password" className="w-full border p-2 rounded mb-4" value={password} onChange={(e) => setPassword(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && checkPassword()} />
                                <div className="flex justify-end gap-2">
                                    <button onClick={() => setShowLogin(false)} className="px-3 py-1 text-slate-500">Cancel</button>
                                    <button onClick={checkPassword} className="px-3 py-1 bg-blue-600 text-white rounded">Access</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
