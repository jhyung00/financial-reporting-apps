<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debt & Note Disclosure Simulation</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a' },
                        blue: { 950: '#172554' },
                        emerald: { 450: '#10b981' }
                    }
                }
            }
        }
    </script>

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .input-correct {
            border-color: #10b981 !important;
            color: #065f46 !important;
            background-color: #ecfdf5 !important;
            font-weight: bold;
        }
        .input-default { border-color: #cbd5e1; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* Calculator Button Styles */
        .calc-btn {
            background-color: #334155;
            color: white;
            font-weight: bold;
            border-radius: 4px;
            padding: 8px 0;
            text-align: center;
            font-size: 0.85rem;
            transition: background-color 0.1s;
        }
        .calc-btn:hover { background-color: #475569; }
        .calc-btn:active { transform: scale(0.98); }
        .calc-btn.op { background-color: #0f172a; color: #60a5fa; }
        .calc-btn.eq { background-color: #059669; }
        .calc-btn.clear { background-color: #991b1b; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }

        /* Anti-Tamper Styles */
        .no-select {
            user-select: none;
            -webkit-user-select: none;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 antialiased h-screen flex flex-col overflow-hidden no-select" oncontextmenu="return false;">

    <div id="root" class="h-full flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- DATA & ANSWER KEYS (OBFUSCATED) ---
        
        const _K_ANS = {
            P: {
                "p_st": "4026", 
                "p_lt": "28295", 
                "p_total": "32321",
                "p_change": "15",
                "p_retired": "1328", 
                "p_loss": "272"
            },
            B: {
                "b_fy3Due": "2248", 
                "b_totalLt": "7051", 
                "b_avgRate": "3.805"
            }
        };

        const _K_MC = {
            P: {
                "mc_p1": "b",
                "mc_p2": "b",
                "mc_p3": "b",
                "mc_p4": "c"
            },
            B: {
                "mc_b1": "b",
                "mc_b2": "c",
                "mc_b3": "b"
            }
        };

        const _M_META = {
            P: {
                "mc_p1": { label: "Q: Carrying Value Increase", text: "Amortization of discount" },
                "mc_p2": { label: "Q: Current Maturities", text: "Due within 1 year" },
                "mc_p3": { label: "Q: Bond Pricing (102.27)", text: "Rates decreased since issuance" },
                "mc_p4": { label: "Q: Credit Rating Factors", text: "Reduced LT debt" }
            },
            B: {
                "mc_b1": { label: "Q: Cash vs Expense", text: "Expense = Effective; Cash = Coupon" },
                "mc_b2": { label: "Q: Premium Bond (109.35)", text: "Premium; rates decreased" },
                "mc_b3": { label: "Q: Yield Curve", text: "Maturity premium (Yield Curve)" }
            }
        };

        const _X_EXPL = {
            P: {
                "p_st": "Other borrowings (73) + Current maturities (3,953)", 
                "p_lt": "Total LT obligations (32,248) - Current maturities (3,953)", 
                "p_total": "Short-term (4,026) + Long-term (28,295)",
                "p_change": "FY2 Balance (3,948) - FY1 Balance (3,933)",
                "p_retired": "Sum: 11 + 4 + 357 + 138 + 410 + 408", 
                "p_loss": "Cash Paid (1,600) - Carrying Value (1,328)"
            },
            B: {
                "b_fy3Due": "Directly from Principal Repayments table (FY3)", 
                "b_totalLt": "Long-term debt (4,803) + Current portion (2,248)", 
                "b_avgRate": "Interest Expense (241) / Average Debt (6,334)"
            }
        };

        const _D_PEP = {
            metadata: { name: "PepsiCo Inc.", code: "P7-44", year: "Debt Schedule" },
            tables: [
                {
                    title: "Short-term Debt ($M)",
                    headers: ["Item", "FY2", "FY1"],
                    rows: [
                        ["Current maturities of LT debt", "3,953", "4,020"],
                        ["Commercial paper (1.3%)", "—", "1,385"],
                        ["Other borrowings", "73", "80"]
                    ]
                },
                {
                    title: "Long-term Debt ($M)",
                    headers: ["Item", "FY2", "FY1"],
                    rows: [
                        ["Notes due FY2 (2.4%)", "—", "4,016"],
                        ["Notes due FY3 (3.1% & 2.1%)", "3,948", "3,933"],
                        ["Notes due FY4 - FY31...", "28,274", "29,836"],
                        ["Total LT Debt Obligations", "32,248", "37,816"],
                        ["Less: Current Maturities", "(3,953)", "(4,020)"]
                    ]
                },
                {
                    title: "Tender Offer Data",
                    headers: ["Bond Retired", "Carrying Value"],
                    rows: [
                        ["7.290% Sep FY9", "$11"],
                        ["7.440% Sep FY9", "$4"],
                        ["7.000% Mar FY12", "$357"],
                        ["5.500% May FY18", "$138"],
                        ["4.875% Nov FY23", "$410"],
                        ["5.500% Jan FY23", "$408"]
                    ]
                },
                {
                    title: "Market Data Excerpt",
                    headers: ["Bond", "Price", "Yield", "Coupon"],
                    rows: [
                        ["Notes due FY6", "102.27", "1.87%", "2.75%"]
                    ]
                }
            ]
        };

        const _D_BOS = {
            metadata: { name: "Boston Scientific", code: "P7-45", year: "Debt Note" },
            tables: [
                {
                    title: "Long-term Debt ($M)",
                    headers: ["Instrument", "Coupon", "FY2", "FY1"],
                    rows: [
                        ["FY4 Notes (Jan)", "6.00%", "850", "850"],
                        ["FY4 Notes (May)", "2.85%", "600", "600"],
                        ["FY6 Notes", "3.375%", "500", "500"],
                        ["FY7 Notes", "4.125%", "450", "450"],
                        ["FY9 Notes", "3.85%", "750", "750"],
                        ["FY12 Notes", "4.00%", "1,000", "1,000"],
                        ["FY19 - FY24 Notes", "Var", "650", "650"],
                        ["Discounts/Hedges", "-", "3", "14"],
                        ["Total LT Debt", "", "4,803", "3,815"]
                    ]
                },
                {
                    title: "Principal Repayments ($M)",
                    headers: ["Year", "Amount"],
                    rows: [
                        ["FY3", "2,248"],
                        ["FY4", "1,540"],
                        ["FY5", "0"],
                        ["FY6", "500"]
                    ]
                },
                {
                    title: "Interest & Market Data",
                    headers: ["Item", "Value"],
                    rows: [
                        ["Interest Expense (FY2)", "$241"],
                        ["Cash Interest Paid (FY2)", "$262"],
                        ["FY12 Note Price", "109.35"],
                        ["FY7 Note Price", "101.57"]
                    ]
                },
                {
                    title: "Balance Sheet Summary",
                    headers: ["Item", "FY2", "FY1"],
                    rows: [
                        ["Short-term Debt", "2,248", "1,801"],
                        ["Long-term Debt", "4,803", "3,815"]
                    ]
                }
            ]
        };

        // --- COMPONENTS ---

        const Icon = ({ name, size = 16, className = "", color = "currentColor" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (iconRef.current && window.lucide) {
                    iconRef.current.innerHTML = '';
                    const iconElement = document.createElement('i');
                    iconElement.setAttribute('data-lucide', name);
                    iconElement.style.width = `${size}px`;
                    iconElement.style.height = `${size}px`;
                    iconElement.style.color = color;
                    if (className) className.split(' ').forEach(cls => iconElement.classList.add(cls));
                    iconRef.current.appendChild(iconElement);
                    window.lucide.createIcons({ root: iconRef.current, attrs: { width: size, height: size } });
                }
            }, [name, size, color, className]);
            return <span ref={iconRef} className="inline-flex items-center justify-center" />;
        };

        const ConfirmationModal = ({ isOpen, title, message, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center backdrop-blur-sm animate-fade-in no-select">
                    <div className="bg-white rounded-lg shadow-2xl max-w-sm w-full p-6 m-4 border-l-4 border-red-500">
                        <div className="flex items-center gap-3 text-red-600 mb-4">
                            <Icon name="alert-triangle" size={24} />
                            <h3 className="text-lg font-bold">{title}</h3>
                        </div>
                        <p className="text-slate-600 mb-6">{message}</p>
                        <div className="flex justify-end gap-3">
                            <button onClick={onCancel} className="px-4 py-2 text-slate-600 font-medium hover:bg-slate-100 rounded-lg">Cancel</button>
                            <button onClick={onConfirm} className="px-4 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700">Confirm & Exit</button>
                        </div>
                    </div>
                </div>
            );
        };

        const StandardCalculator = () => {
            const [display, setDisplay] = useState("0");
            const [prevVal, setPrevVal] = useState(null);
            const [op, setOp] = useState(null);
            const [newNum, setNewNum] = useState(true);

            const handleNum = (num) => {
                if (newNum) { setDisplay(String(num)); setNewNum(false); } 
                else { setDisplay(display === "0" ? String(num) : display + num); }
            };

            const handleOp = (operator) => {
                setOp(operator);
                setPrevVal(parseFloat(display));
                setNewNum(true);
            };

            const handleEq = () => {
                if (!op || prevVal === null) return;
                const curr = parseFloat(display);
                let res = 0;
                switch(op) {
                    case '+': res = prevVal + curr; break;
                    case '-': res = prevVal - curr; break;
                    case '×': res = prevVal * curr; break;
                    case '÷': res = prevVal / curr; break;
                }
                setDisplay(String(parseFloat(res.toFixed(4))));
                setOp(null); setPrevVal(null); setNewNum(true);
            };

            const handleClear = () => {
                setDisplay("0"); setPrevVal(null); setOp(null); setNewNum(true);
            };

            return (
                <div className="mx-4 mt-6 bg-slate-800 rounded-lg p-3 border border-slate-700 shadow-xl">
                    <div className="bg-slate-900 border border-slate-600 rounded mb-3 px-2 py-2 text-right text-lg font-mono text-emerald-400 font-bold overflow-hidden h-10 flex items-center justify-end">
                        {display}
                    </div>
                    <div className="grid grid-cols-4 gap-2">
                        <button onClick={handleClear} className="calc-btn clear col-span-1 text-xs">C</button>
                        <button onClick={() => handleOp('÷')} className="calc-btn op">÷</button>
                        <button onClick={() => handleOp('×')} className="calc-btn op">×</button>
                        <button onClick={() => handleOp('-')} className="calc-btn op">-</button>
                        <button onClick={() => handleNum(7)} className="calc-btn">7</button>
                        <button onClick={() => handleNum(8)} className="calc-btn">8</button>
                        <button onClick={() => handleNum(9)} className="calc-btn">9</button>
                        <button onClick={() => handleOp('+')} className="calc-btn op row-span-2 flex items-center justify-center">+</button>
                        <button onClick={() => handleNum(4)} className="calc-btn">4</button>
                        <button onClick={() => handleNum(5)} className="calc-btn">5</button>
                        <button onClick={() => handleNum(6)} className="calc-btn">6</button>
                        <button onClick={() => handleNum(1)} className="calc-btn">1</button>
                        <button onClick={() => handleNum(2)} className="calc-btn">2</button>
                        <button onClick={() => handleNum(3)} className="calc-btn">3</button>
                        <button onClick={handleEq} className="calc-btn eq row-span-2 flex items-center justify-center">=</button>
                        <button onClick={() => handleNum(0)} className="calc-btn col-span-2">0</button>
                        <button onClick={() => handleNum('.')} className="calc-btn">.</button>
                    </div>
                </div>
            );
        };

        const SmartInput = ({ id, value, onChange, correctValue, label, hint, instructorMode, activeInput, setActiveInput, type = "number" }) => {
            const [localError, setLocalError] = useState(null);
            
            const evaluateMath = (expr) => {
                if (!expr) return { valid: true, val: "" };
                try {
                    const sanitized = expr.toString().replace(/,/g, '').replace(/%/g, '').replace(/[^\d\.\+\-\*\/\(\)]/g, '');
                    if (!/^[\d\.\+\-\*\/\(\)\s]+$/.test(sanitized)) return { valid: false, msg: "Invalid" };
                    const res = eval(sanitized);
                    if (!isFinite(res) || isNaN(res)) return { valid: false, msg: "Error" };
                    return { valid: true, val: res };
                } catch (e) { return { valid: false, msg: "Error" }; }
            };

            const isCorrect = useMemo(() => {
                if (!value || !correctValue) return false;
                const { valid, val } = evaluateMath(value);
                if (!valid) return false;
                
                let numVal = parseFloat(val);
                const target = parseFloat(correctValue.toString().replace(/,/g, ''));
                
                // Special handling for percentages
                if (type === "percent") {
                    // If user enters 0.04 (for 4%) or 4 (for 4%), handle both
                    // We assume if value < 1.0 and target > 1.0, user likely entered decimal
                    if (numVal < 1.0 && target > 1.0 && numVal !== 0) {
                        numVal = numVal * 100;
                    }
                }

                // 2% Relative Tolerance
                if (target === 0) return Math.abs(numVal) < 0.01;
                return Math.abs((numVal - target) / target) <= 0.02;
            }, [value, correctValue, type]);

            const handleBlur = (e) => {
                const { valid, val } = evaluateMath(value);
                if (!valid) { setLocalError("Invalid"); return; }
                setLocalError(null);
                if (valid && value !== "") {
                     const numVal = Number(val);
                     // Format display
                     let displayVal = Number.isInteger(numVal) ? numVal.toString() : numVal.toFixed(3);
                     // Keep decimal precision if it was small
                     if (Math.abs(numVal) < 1 && numVal !== 0) displayVal = numVal.toString();
                     
                     onChange(id, displayVal); 
                }
            };

            const isActive = activeInput === id;

            return (
                <div className="w-full">
                    {label && <label className="block text-xs font-bold text-slate-500 mb-1 uppercase tracking-wider">{label}</label>}
                    <div className="flex gap-2 items-start">
                        <div className="relative flex-grow">
                            <input 
                                type="text" 
                                id={id}
                                value={value || ""}
                                onChange={(e) => { setLocalError(null); onChange(id, e.target.value); }}
                                onFocus={() => setActiveInput(id)}
                                onBlur={handleBlur}
                                onKeyDown={(e) => e.key === 'Enter' && e.target.blur()}
                                className={`w-full p-2 text-right border rounded text-sm font-mono shadow-sm transition-all outline-none focus:ring-2 focus:ring-blue-500 ${
                                    isCorrect ? "input-correct" : (value && !isActive && !isCorrect) ? "bg-white border-slate-300" : "bg-white border-slate-300"
                                }`}
                                placeholder={hint ? "Calc..." : "-"}
                            />
                            <div className="absolute left-2 top-1/2 -translate-y-1/2 pointer-events-none">
                                {isCorrect ? <span className="text-emerald-600"><Icon name="check" size={14} /></span> : 
                                localError ? <span className="text-red-500 font-bold text-xs">!</span> : null}
                            </div>
                        </div>
                        {hint && (
                            <div className="w-1/3 shrink-0 bg-blue-50 border border-blue-100 rounded p-2 flex flex-col justify-center min-h-[38px]">
                                <span className="text-[10px] text-blue-500 font-bold uppercase tracking-wider block mb-0.5">Hint</span>
                                <span className="text-xs text-blue-800 font-medium leading-tight">{hint}</span>
                            </div>
                        )}
                    </div>
                    {/* Per-Input Key Display (Instructor Mode) */}
                    {instructorMode && (
                        <div className="mt-1 text-[10px] text-purple-700 bg-purple-50 px-2 py-1 rounded inline-block font-bold border border-purple-200 shadow-sm animate-fade-in">
                            Key: {correctValue}
                        </div>
                    )}
                </div>
            );
        };

        const MultipleChoiceQuestion = ({ id, question, options, selected, onSelect, correctId, feedback }) => {
            const isAnswered = selected !== undefined;
            const isCorrect = selected === correctId;

            return (
                <div className="bg-white border border-slate-200 rounded-lg p-5 shadow-sm mb-4">
                    <h4 className="font-bold text-slate-800 mb-3 text-sm">{question}</h4>
                    <div className="space-y-2 mb-3">
                        {options.map((opt) => {
                            let btnClass = "border-slate-200 hover:bg-slate-50 text-slate-700";
                            if (isAnswered) {
                                if (opt.id === correctId) btnClass = "bg-emerald-50 border-emerald-500 text-emerald-800 font-bold";
                                else if (selected === opt.id) btnClass = "bg-red-50 border-red-500 text-red-800";
                                else btnClass = "opacity-50 border-slate-200";
                            }
                            return (
                                <button 
                                    key={opt.id}
                                    onClick={() => !isAnswered && onSelect(id, opt.id)}
                                    disabled={isAnswered}
                                    className={`w-full text-left p-3 rounded border text-sm transition-all flex items-center justify-between ${btnClass}`}
                                >
                                    <span>{opt.text}</span>
                                    {isAnswered && opt.id === correctId && <Icon name="check-circle" size={16} />}
                                    {isAnswered && selected === opt.id && selected !== correctId && <Icon name="x-circle" size={16} />}
                                </button>
                            );
                        })}
                    </div>
                    {isAnswered && (
                        <div className={`text-xs p-3 rounded border ${isCorrect ? "bg-emerald-50 border-emerald-100 text-emerald-800" : "bg-blue-50 border-blue-100 text-blue-800"}`}>
                            <span className="font-bold uppercase tracking-wider block mb-1">{isCorrect ? "Correct" : "Analysis"}</span>
                            {feedback}
                        </div>
                    )}
                </div>
            );
        };

        const ReferenceTable = ({ title, headers, rows, onValueClick }) => {
            const [isOpen, setIsOpen] = useState(true);
            return (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-4">
                    <button onClick={() => setIsOpen(!isOpen)} className="w-full flex items-center justify-between p-3 bg-slate-50 border-b border-slate-100 hover:bg-slate-100 transition">
                        <h4 className="font-bold text-slate-700 text-sm flex items-center gap-2">
                            <Icon name="table" size={16} /> {title}
                        </h4>
                        <Icon name={isOpen ? "chevron-up" : "chevron-down"} size={16} />
                    </button>
                    {isOpen && (
                        <div className="overflow-x-auto max-h-64">
                            <table className="w-full text-xs text-left">
                                <thead className="bg-slate-50 text-slate-500 uppercase tracking-wider sticky top-0">
                                    <tr>{headers.map((h, i) => <th key={i} className={`p-2 border-b font-medium ${i > 0 ? "text-right" : ""}`}>{h}</th>)}</tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {rows.map((row, rI) => (
                                        <tr key={rI} className="hover:bg-blue-50 transition-colors group">
                                            <td className="p-2 font-medium text-slate-700">{row[0]}</td>
                                            {row.slice(1).map((cell, cI) => (
                                                <td key={cI} onClick={() => onValueClick(cell)} className="p-2 text-right font-mono text-slate-600 cursor-pointer hover:text-blue-700 hover:font-bold decoration-dotted" title="Insert">{cell}</td>
                                            ))}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('P'); // P, B
            const [inputs, setInputs] = useState({ P: {}, B: {} });
            const [mcAnswers, setMcAnswers] = useState({});
            const [activeInput, setActiveInput] = useState(null);
            
            // Instructor State
            const [instructorMode, setInstructorMode] = useState(false);
            const [showLogin, setShowLogin] = useState(false);
            const [password, setPassword] = useState("");
            const [clearModalOpen, setClearModalOpen] = useState(false);
            const [showAnswerKey, setShowAnswerKey] = useState(false);
            
            // Hash/Download
            const [studentName, setStudentName] = useState("");
            const [showDownload, setShowDownload] = useState(false);

            const activeData = activeTab === 'P' ? _D_PEP : _D_BOS;
            const activeKey = activeTab === 'P' ? _K_ANS.P : _K_ANS.B;
            const activeMcKey = activeTab === 'P' ? _K_MC.P : _K_MC.B;

            const handleInputChange = (id, val) => setInputs(prev => ({ ...prev, [activeTab]: { ...prev[activeTab], [id]: val } }));
            
            const handleMcSelect = (id, optId) => {
                setMcAnswers(prev => ({ ...prev, [id]: optId }));
            };

            const handleValueClick = (val) => {
                if (!activeInput) return;
                const cleanVal = val.replace(/,/g, '').replace(/[()]/g, (m) => m === '(' ? '-' : '');
                setInputs(prev => {
                    const cur = prev[activeTab][activeInput] || "";
                    const isOperator = /[+\-*/(]$/.test(cur.trim());
                    const newVal = (cur === "" || isOperator) ? cur + cleanVal : cleanVal;
                    return { ...prev, [activeTab]: { ...prev[activeTab], [activeInput]: newVal } };
                });
                setTimeout(() => document.getElementById(activeInput)?.focus(), 50);
            };

            const unlockInstructor = () => {
                if (password.toLowerCase() === "teacher") { setInstructorMode(true); setShowLogin(false); setPassword(""); } else { alert("Incorrect"); }
            };

            const handleAutoFill = () => {
                setInputs(prev => ({ ...prev, [activeTab]: { ...activeKey } }));
                setMcAnswers(prev => ({ ...prev, ...activeMcKey }));
            };

            // Clear All Functionality
            const performClear = () => {
                setInputs({ P: {}, B: {} });
                setMcAnswers({});
                setInstructorMode(false);
                setClearModalOpen(false);
            };

            const handleDownload = () => {
                const text = `Debt Analysis - ${activeTab}\nStudent: ${studentName}\nAnswers:\n${JSON.stringify({inputs: inputs[activeTab], mc: mcAnswers})}`;
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `${studentName}_DebtSim.txt`; a.click();
                setShowDownload(false);
            };

            return (
                <div className="flex h-screen bg-slate-100 overflow-hidden font-sans">
                    {/* SIDEBAR */}
                    <div className="w-72 bg-slate-900 text-slate-300 flex flex-col border-r border-slate-700 shadow-2xl z-10 shrink-0">
                        <div className="p-6 border-b border-slate-700 bg-slate-950">
                            <h1 className="font-bold text-lg text-white tracking-tight flex items-center gap-2">
                                <Icon name="activity" className="text-emerald-400" /> Debt<span className="text-emerald-400">Analyst</span>
                            </h1>
                            <p className="text-xs text-slate-500 uppercase tracking-wider font-semibold mt-1">10-K Interpretation</p>
                        </div>
                        <div className="flex-1 p-4 space-y-2 overflow-y-auto">
                            <h3 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Modules</h3>
                            <button onClick={() => setActiveTab('P')} className={`w-full text-left px-4 py-3 rounded-lg text-sm transition-all flex items-center gap-3 ${activeTab === 'P' ? 'bg-blue-600 text-white shadow-lg' : 'hover:bg-slate-800 text-slate-400'}`}>
                                <div className="bg-white/10 p-1.5 rounded"><Icon name="droplet" size={16} /></div>
                                <div><div className="font-bold">PepsiCo Inc.</div><div className="text-[10px] opacity-75">P7-44 | Debt & Tender</div></div>
                            </button>
                            <button onClick={() => setActiveTab('B')} className={`w-full text-left px-4 py-3 rounded-lg text-sm transition-all flex items-center gap-3 ${activeTab === 'B' ? 'bg-emerald-600 text-white shadow-lg' : 'hover:bg-slate-800 text-slate-400'}`}>
                                <div className="bg-white/10 p-1.5 rounded"><Icon name="heart-pulse" size={16} /></div>
                                <div><div className="font-bold">Boston Scientific</div><div className="text-[10px] opacity-75">P7-45 | Rates & Yields</div></div>
                            </button>
                            
                            <StandardCalculator />
                        </div>
                        <div className="p-4 border-t border-slate-800">
                             {/* STEALTH INSTRUCTOR ACCESS REMOVED FROM HERE */}
                             {instructorMode && (
                                <div className="text-center">
                                    <p className="text-xs text-purple-400 font-bold mb-2 flex items-center justify-center gap-1"><Icon name="unlock" size={12}/> Mode Active</p>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* MAIN */}
                    <div className="flex-1 flex flex-col bg-slate-100 overflow-hidden relative">
                        {/* INSTRUCTOR STICKY TOOLBAR */}
                        {instructorMode && (
                            <div className="bg-purple-700 text-white p-2 shadow-md flex items-center justify-between z-20 animate-fade-in shrink-0 border-b border-purple-800">
                                <div className="flex items-center gap-3 px-4">
                                    <span className="bg-white/20 p-1.5 rounded"><Icon name="graduation-cap" size={18}/></span>
                                    <span className="font-bold tracking-wide text-sm">INSTRUCTOR TOOLBAR</span>
                                </div>
                                <div className="flex gap-2 px-4">
                                    <button onClick={() => setShowAnswerKey(true)} className="flex items-center gap-2 px-3 py-1 bg-purple-600 hover:bg-purple-500 rounded text-xs font-bold transition border border-purple-400">
                                        <Icon name="list" size={14} /> View Answer Key
                                    </button>
                                    <button onClick={handleAutoFill} className="flex items-center gap-2 px-3 py-1 bg-emerald-500 hover:bg-emerald-400 rounded text-xs font-bold transition shadow-sm text-emerald-950">
                                        <Icon name="zap" size={14} /> Auto-Fill Inputs
                                    </button>
                                    <button onClick={() => setClearModalOpen(true)} className="flex items-center gap-2 px-3 py-1 bg-red-500 hover:bg-red-400 rounded text-xs font-bold transition shadow-sm">
                                        <Icon name="log-out" size={14} /> Clear & Exit
                                    </button>
                                </div>
                            </div>
                        )}

                        <header className="bg-white border-b border-slate-200 px-8 py-5 flex justify-between items-center shadow-sm z-10 relative">
                            <div>
                                <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                                    {activeData.metadata.name} <span className="text-xs font-normal text-white bg-slate-400 px-2 py-0.5 rounded-full">{activeData.metadata.code}</span>
                                </h2>
                                <p className="text-xs text-slate-500 font-medium ml-0.5">{activeData.metadata.year}</p>
                            </div>
                            
                            {/* STEALTH BUTTON CONTAINER - Fixed position to top right corner */}
                            <div className="absolute top-0 right-0"> 
                                 <button 
                                    onClick={() => setShowLogin(true)} 
                                    className="p-2 opacity-5 hover:opacity-100 text-slate-400 hover:text-purple-600 transition-all"
                                    title="Instructor Access"
                                >
                                    <Icon name="lock" size={14} />
                                </button>
                            </div>

                            <button onClick={() => setShowDownload(true)} className="px-4 py-2 bg-blue-600 text-white rounded text-sm font-bold flex items-center gap-2 hover:bg-blue-700 transition"><Icon name="download" size={16}/> Save Work</button>
                        </header>

                        <main className="flex-1 overflow-y-auto p-8 custom-scrollbar">
                            <div className="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8">
                                {/* LEFT: Reference */}
                                <div className="space-y-4">
                                    <div className="bg-blue-900 text-white px-4 py-3 rounded-t-lg font-bold text-sm flex items-center justify-between shadow-sm no-select">
                                        <span>Financial Data</span>
                                        <span className="text-xs opacity-75 flex items-center gap-1"><Icon name="mouse-pointer-click" size={12}/> Click to insert</span>
                                    </div>
                                    {activeData.tables.map((tbl, i) => (
                                        <ReferenceTable key={i} title={tbl.title} headers={tbl.headers} rows={tbl.rows} onValueClick={handleValueClick} />
                                    ))}
                                </div>

                                {/* RIGHT: Work */}
                                <div className="space-y-6">
                                    {activeTab === 'P' && (
                                        <div className="space-y-6 animate-fade-in">
                                            {/* a. Debt Obligations */}
                                            <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                                                <h4 className="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2 no-select"><Icon name="file-text" className="text-blue-600"/> a. Debt Reporting on FY2 Balance Sheet ($M)</h4>
                                                <div className="space-y-3">
                                                    <SmartInput id="p_st" label="Short-term Debt" value={inputs.P.p_st} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={_K_ANS.P.p_st} instructorMode={instructorMode} />
                                                    <SmartInput id="p_lt" label="Long-term Debt" value={inputs.P.p_lt} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={_K_ANS.P.p_lt} instructorMode={instructorMode} />
                                                    <div className="pt-2 border-t"><SmartInput id="p_total" label="Total Debt Reported" value={inputs.P.p_total} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={_K_ANS.P.p_total} instructorMode={instructorMode} /></div>
                                                </div>
                                            </div>

                                            {/* b. Notes Due Analysis */}
                                            <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                                                <h4 className="text-sm font-bold text-slate-700 mb-4 no-select">b. Analysis of Notes Due in FY3</h4>
                                                <div className="flex gap-4 items-end mb-4">
                                                    <SmartInput id="p_change" label="Change in Balance ($M)" value={inputs.P.p_change} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={_K_ANS.P.p_change} instructorMode={instructorMode} hint="FY2 - FY1" />
                                                </div>
                                                <MultipleChoiceQuestion 
                                                    id="mc_p1" 
                                                    selected={mcAnswers['mc_p1']} 
                                                    onSelect={handleMcSelect}
                                                    correctId="b"
                                                    question="Does this increase mean PepsiCo issued more of these notes?"
                                                    options={[
                                                        {id: 'a', text: 'Yes, because the carrying value increased.'},
                                                        {id: 'b', text: 'No, it represents amortization of discount.'},
                                                        {id: 'c', text: 'No, it represents capitalized interest.'}
                                                    ]}
                                                    feedback="Correct. As notes move toward maturity, the carrying value moves toward the face value (amortizing the discount)."
                                                />
                                            </div>

                                            {/* c. Current Maturities */}
                                            <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                                                <h4 className="text-sm font-bold text-slate-700 mb-4 no-select">c. Debt Classification</h4>
                                                <MultipleChoiceQuestion 
                                                    id="mc_p2" 
                                                    selected={mcAnswers['mc_p2']} 
                                                    onSelect={handleMcSelect}
                                                    correctId="b"
                                                    question="Why are current maturities ($3,953M) reported as short-term debt?"
                                                    options={[
                                                        {id: 'a', text: 'To improve the current ratio.'},
                                                        {id: 'b', text: 'They are obligations due within 1 year.'},
                                                        {id: 'c', text: 'Because they are variable rate notes.'}
                                                    ]}
                                                    feedback="Correct. Debt payments due within the next fiscal year are classified as current liabilities, which is critical for assessing liquidity."
                                                />
                                            </div>

                                            {/* d. Bond Premium/Yield */}
                                            <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                                                <h4 className="text-sm font-bold text-slate-700 mb-4 no-select">d. Bond Pricing & Yields</h4>
                                                <MultipleChoiceQuestion 
                                                    id="mc_p3" 
                                                    selected={mcAnswers['mc_p3']} 
                                                    onSelect={handleMcSelect}
                                                    correctId="b"
                                                    question="Notes due FY6 are priced at 102.27 (Yield 1.87%). What does this imply?"
                                                    options={[
                                                        {id: 'a', text: 'Interest rates have increased since issuance.'},
                                                        {id: 'b', text: 'Interest rates have decreased since issuance.'},
                                                        {id: 'c', text: 'PepsiCo credit rating has worsened.'}
                                                    ]}
                                                    feedback="Correct. The bond sells at a premium (Yield < Coupon), implying market rates have fallen since the coupon was set."
                                                />
                                            </div>

                                            {/* e. Early Retirement */}
                                            <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                                                <h4 className="text-sm font-bold text-slate-700 mb-4 no-select">e. Early Retirement Analysis</h4>
                                                <div className="space-y-3">
                                                    <SmartInput id="p_retired" label="Total Carrying Value Retired ($M)" value={inputs.P.p_retired} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={_K_ANS.P.p_retired} instructorMode={instructorMode} hint="Sum of notes" />
                                                    <SmartInput id="p_loss" label="Loss on Retirement ($M)" value={inputs.P.p_loss} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={_K_ANS.P.p_loss} instructorMode={instructorMode} hint="Cash Paid - CV" />
                                                </div>
                                            </div>

                                            {/* f. Credit Ratings */}
                                            <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                                                <h4 className="text-sm font-bold text-slate-700 mb-4 no-select">f. Credit Rating Factors</h4>
                                                <MultipleChoiceQuestion 
                                                    id="mc_p4" 
                                                    selected={mcAnswers['mc_p4']} 
                                                    onSelect={handleMcSelect}
                                                    correctId="c"
                                                    question="Which of these factors would likely IMPROVE credit ratings?"
                                                    options={[
                                                        {id: 'a', text: 'Weaker cash-generating capability'},
                                                        {id: 'b', text: 'Increase in dividends to shareholders'},
                                                        {id: 'c', text: 'Reduced level of long-term debt'}
                                                    ]}
                                                    feedback="Correct. Reducing debt improves the solvency ratio. Increasing dividends or weaker cash flow reduces the cushion available for debt service."
                                                />
                                            </div>
                                        </div>
                                    )}

                                    {activeTab === 'B' && (
                                        <div className="space-y-6 animate-fade-in">
                                            <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                                                <h4 className="text-sm font-bold text-slate-700 mb-4 no-select">Debt Analysis</h4>
                                                <div className="space-y-4">
                                                    <SmartInput id="b_fy3Due" label="a. LT Debt due in FY3 ($M)" value={inputs.B.b_fy3Due} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={_K_ANS.B.b_fy3Due} instructorMode={instructorMode} />
                                                    <SmartInput id="b_totalLt" label="b. Total LT Debt (incl. current) at FY2 ($M)" value={inputs.B.b_totalLt} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={_K_ANS.B.b_totalLt} instructorMode={instructorMode} hint="Reported LT + Current Mat." />
                                                    <SmartInput id="b_avgRate" label="c. Effective Interest Rate (%)" value={inputs.B.b_avgRate} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={_K_ANS.B.b_avgRate} instructorMode={instructorMode} hint="Int Exp / Avg Debt" type="percent" />
                                                </div>
                                                {instructorMode && (
                                                    <div className="mt-3 p-3 bg-blue-50 text-xs text-blue-800 rounded border border-blue-100">
                                                        <strong>Explanation (c):</strong> Interest expense ($241) divided by Average Debt ($6,334) = 3.805%. Interest paid ($262) differs due to amortization and accrual timing.
                                                    </div>
                                                )}
                                            </div>
                                            
                                            <MultipleChoiceQuestion 
                                                id="mc_b1" 
                                                selected={mcAnswers['mc_b1']} 
                                                onSelect={handleMcSelect}
                                                correctId="b"
                                                question="d. Why does cash interest paid ($262M) differ from interest expense ($241M)?"
                                                options={[
                                                    {id: 'a', text: 'Accounting error in the cash flow statement.'},
                                                    {id: 'b', text: 'Interest expense uses effective rate; cash is coupon.'},
                                                    {id: 'c', text: 'The company defaulted on some payments.'}
                                                ]}
                                                feedback="Correct. Interest expense reflects the effective yield (including amortization of premiums/discounts), while cash paid is strictly based on the coupon rate."
                                            />

                                            <MultipleChoiceQuestion 
                                                id="mc_b2" 
                                                selected={mcAnswers['mc_b2']} 
                                                onSelect={handleMcSelect}
                                                correctId="c"
                                                question="e. The FY12 note is priced at 109.35 (Yield 2.80% vs Coupon 4.0%). Interpretation?"
                                                options={[
                                                    {id: 'a', text: 'The bond is selling at a discount.'},
                                                    {id: 'b', text: 'Market interest rates have increased since issuance.'},
                                                    {id: 'c', text: 'Bond is premium; market rates decreased since issuance.'}
                                                ]}
                                                feedback="Correct. A price > 100 (Premium) means Coupon > Yield. This implies market interest rates have fallen since the bond was originally issued."
                                            />

                                            <MultipleChoiceQuestion 
                                                id="mc_b3" 
                                                selected={mcAnswers['mc_b3']} 
                                                onSelect={handleMcSelect}
                                                correctId="b"
                                                question="f. Why does the FY12 bond (4.0%) have a higher yield (2.80%) than the FY7 bond (2.41%)?"
                                                options={[
                                                    {id: 'a', text: 'The FY12 bond has a higher coupon rate.'},
                                                    {id: 'b', text: 'Yields typically increase with maturity (Time/Risk).'},
                                                    {id: 'c', text: 'The FY7 bond is more risky.'}
                                                ]}
                                                feedback="Correct. Investors demand higher yields for longer maturities to compensate for increased credit, liquidity, and inflation risk over time (Normal Yield Curve)."
                                            />
                                        </div>
                                    )}
                                </div>
                            </div>
                        </main>
                    </div>

                    {/* MODALS */}
                    {showLogin && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm animate-fade-in no-select">
                            <div className="bg-white p-6 rounded-lg shadow-xl w-80">
                                <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Icon name="shield" className="text-blue-600"/> Instructor Login</h3>
                                <input type="password" className="w-full border p-2 rounded mb-4" value={password} onChange={(e) => setPassword(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && unlockInstructor()} autoFocus placeholder="Enter Password" />
                                <div className="flex justify-end gap-2">
                                    <button onClick={() => setShowLogin(false)} className="px-3 py-1 text-slate-500 hover:bg-slate-100 rounded">Cancel</button>
                                    <button onClick={unlockInstructor} className="px-3 py-1 bg-blue-600 text-white rounded font-bold hover:bg-blue-700">Access</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {showDownload && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm animate-fade-in no-select">
                            <div className="bg-white p-6 rounded-lg shadow-xl w-80">
                                <h3 className="font-bold text-lg mb-4 text-center">Save Work</h3>
                                <input type="text" className="w-full border p-2 rounded mb-4 text-center" placeholder="Your Name" value={studentName} onChange={(e) => setStudentName(e.target.value)} autoFocus />
                                <button onClick={() => studentName ? handleDownload() : alert("Name required")} className="w-full py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700">Download</button>
                                <button onClick={() => setShowDownload(false)} className="w-full mt-2 py-2 text-slate-500 text-sm hover:text-slate-800">Cancel</button>
                            </div>
                        </div>
                    )}

                    {/* Answer Key Table Modal */}
                    {showAnswerKey && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm animate-fade-in no-select">
                            <div className="bg-white p-6 rounded-xl shadow-2xl w-full max-w-2xl h-3/4 flex flex-col">
                                <div className="flex justify-between items-center mb-4 border-b pb-2">
                                    <h3 className="font-bold text-xl text-purple-800 flex items-center gap-2"><Icon name="key" /> Full Answer Key</h3>
                                    <button onClick={() => setShowAnswerKey(false)} className="text-slate-400 hover:text-slate-600"><Icon name="x" /></button>
                                </div>
                                <div className="flex-1 overflow-y-auto custom-scrollbar">
                                    <div className="grid grid-cols-1 gap-6">
                                        <div>
                                            <h4 className="font-bold text-slate-700 mb-2 bg-slate-100 p-2 rounded">PepsiCo (P7-44)</h4>
                                            <div className="grid grid-cols-2 gap-4 text-sm">
                                                {/* Numerical Answers */}
                                                <div className="col-span-2 md:col-span-1">
                                                    <h5 className="font-bold text-slate-600 border-b mb-2 pb-1 text-xs uppercase tracking-wider">Calculations</h5>
                                                    {Object.entries(_K_ANS.P).map(([k, v]) => (
                                                        <div key={k} className="flex flex-col border-b border-slate-100 py-2">
                                                            <div className="flex justify-between">
                                                                <span className="text-slate-500 font-medium">{k}:</span>
                                                                <span className="font-mono font-bold text-purple-700">{v}</span>
                                                            </div>
                                                            <span className="text-xs text-slate-400 mt-1 italic">{_X_EXPL.P[k]}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                                {/* MC Answers */}
                                                <div className="col-span-2 md:col-span-1">
                                                    <h5 className="font-bold text-slate-600 border-b mb-2 pb-1 text-xs uppercase tracking-wider">Multiple Choice</h5>
                                                    {Object.entries(_K_MC.P).map(([k, v]) => (
                                                        <div key={k} className="flex flex-col border-b border-slate-100 py-2">
                                                            <div className="flex justify-between items-center">
                                                                <span className="text-slate-500 font-medium text-xs truncate mr-2" title={_M_META.P[k].label}>{_M_META.P[k].label}</span>
                                                                <span className="font-bold text-purple-700 bg-purple-50 px-1.5 rounded">{v.toUpperCase()}</span>
                                                            </div>
                                                            <span className="text-xs text-slate-500 mt-1 leading-tight">{_M_META.P[k].text}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <h4 className="font-bold text-slate-700 mb-2 bg-slate-100 p-2 rounded">Boston Scientific (P7-45)</h4>
                                            <div className="grid grid-cols-2 gap-4 text-sm">
                                                {/* Numerical Answers */}
                                                <div className="col-span-2 md:col-span-1">
                                                    <h5 className="font-bold text-slate-600 border-b mb-2 pb-1 text-xs uppercase tracking-wider">Calculations</h5>
                                                    {Object.entries(_K_ANS.B).map(([k, v]) => (
                                                        <div key={k} className="flex flex-col border-b border-slate-100 py-2">
                                                            <div className="flex justify-between">
                                                                <span className="text-slate-500 font-medium">{k}:</span>
                                                                <span className="font-mono font-bold text-purple-700">{v}</span>
                                                            </div>
                                                            <span className="text-xs text-slate-400 mt-1 italic">{_X_EXPL.B[k]}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                                {/* MC Answers */}
                                                <div className="col-span-2 md:col-span-1">
                                                    <h5 className="font-bold text-slate-600 border-b mb-2 pb-1 text-xs uppercase tracking-wider">Multiple Choice</h5>
                                                    {Object.entries(_K_MC.B).map(([k, v]) => (
                                                        <div key={k} className="flex flex-col border-b border-slate-100 py-2">
                                                            <div className="flex justify-between items-center">
                                                                <span className="text-slate-500 font-medium text-xs truncate mr-2" title={_M_META.B[k].label}>{_M_META.B[k].label}</span>
                                                                <span className="font-bold text-purple-700 bg-purple-50 px-1.5 rounded">{v.toUpperCase()}</span>
                                                            </div>
                                                            <span className="text-xs text-slate-500 mt-1 leading-tight">{_M_META.B[k].text}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div className="mt-4 pt-2 border-t text-right">
                                    <button onClick={() => setShowAnswerKey(false)} className="px-4 py-2 bg-slate-200 text-slate-700 rounded font-bold hover:bg-slate-300">Close</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <ConfirmationModal 
                        isOpen={clearModalOpen}
                        title="Clear All & Exit Instructor Mode?"
                        message="This will remove all answers, reset the board, and lock instructor privileges. Are you sure?"
                        onConfirm={performClear}
                        onCancel={() => setClearModalOpen(false)}
                    />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
