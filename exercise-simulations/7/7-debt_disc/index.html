<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corporate Debt & Valuation Analysis Suite</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a' },
                        blue: { 950: '#172554' },
                        emerald: { 450: '#10b981' },
                        excel: { green: '#217346', header: '#e6f2ea' }
                    },
                    cursor: {
                        'col-resize': 'col-resize',
                    }
                }
            }
        }
    </script>

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .input-correct {
            border-color: #10b981 !important;
            color: #065f46 !important;
            background-color: #ecfdf5 !important;
            font-weight: bold;
        }
        .input-default { border-color: #cbd5e1; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* Drag Handle */
        .resizer {
            width: 5px;
            cursor: col-resize;
            background-color: #cbd5e1;
            transition: background-color 0.2s;
            z-index: 50;
        }
        .resizer:hover, .resizer.active {
            background-color: #3b82f6;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }

        /* Anti-Tamper Styles */
        .no-select {
            user-select: none;
            -webkit-user-select: none;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 antialiased h-screen flex flex-col overflow-hidden no-select" oncontextmenu="return false;">

    <div id="root" class="h-full flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- SECURITY & OBFUSCATION ---
        
        // Helper to decode Base64
        const d = (str) => {
            try { return atob(str); } catch (e) { return str; }
        };

        // Obfuscated Data Matrix (Answers & Keys)
        const _DATA_MATRIX = {
            A: {
                "a_cv1": "MTI4NDQ=", "a_cv2": "MTI4NTc=",
                "a_fv1": "MTI0MDA=", "a_fv2": "OTkwMA==",
                "a_trend": "aW5jcmVhc2U="
            },
            B: {
                "b_step1": "NQ==",
                "b_n": "OA==", "b_pmt": "LTU=", "b_pv": "NDk3LjY3", "b_fv": "LTUwMA==",
                "b_rate": "MS4wNjE=", "b_intexp": "My41Mg==",
                "b_c_proceeds": "NDk3LjY3", "b_c_rate": "MS4wNjEwNw==", "b_c_months": "OA==", "b_c_calc": "My41Mg=="
            },
            Q: {
                "q1": "YQ==", "q2": "Yw==", "q3": "YQ==", "q4": "Yg==", "q5": "Yw==", "q6": "Yg=="
            }
        };

        const _D_ALPHA = {
            metadata: { name: "Alphabet Inc. (E7-34)", year: "Debt Disclosures" },
            tables: [
                {
                    title: "Debt Disclosure ($ Millions)",
                    headers: ["Debt Item", "Maturity", "FY1", "FY2"],
                    rows: [
                        ["Notes issuances", "FY4-FY40", "13,000", "13,000"],
                        ["Lease payments & other", "-", "2,086", "2,142"],
                        ["Total Debt", "", "15,086", "15,142"],
                        ["Unamortized discount", "-", "(156)", "(143)"],
                        ["Less: Current portion", "-", "(113)", "(298)"],
                        ["Total Long-Term Debt", "", "14,817", "14,701"]
                    ]
                },
                {
                    title: "Fair Value Note",
                    headers: ["Metric", "FY1", "FY2"],
                    rows: [
                        ["Est. Fair Value", "$12.4B", "$9.9B"]
                    ]
                }
            ]
        };

        const _D_CARR = {
            metadata: { name: "Carrefour SA (E7-37)", year: "Bond Valuation" },
            tables: [
                {
                    title: "Bond Details",
                    headers: ["Item", "Value"],
                    rows: [
                        ["Face Value", "€500 Million"],
                        ["Coupon Rate", "1.0% (Annual)"],
                        ["Issue Date", "May 1, FY1"],
                        ["Maturity", "May 1, FY9 (8 Years)"],
                        ["Proceeds", "€497.67 Million (Discount)"],
                        ["Effective Rate", "1.06107%"]
                    ]
                }
            ]
        };

        // --- COMPONENTS ---

        const Icon = ({ name, size = 16, className = "", color = "currentColor" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (iconRef.current && window.lucide) {
                    iconRef.current.innerHTML = '';
                    const iconElement = document.createElement('i');
                    iconElement.setAttribute('data-lucide', name);
                    iconElement.style.width = `${size}px`;
                    iconElement.style.height = `${size}px`;
                    iconElement.style.color = color;
                    if (className) className.split(' ').forEach(cls => iconElement.classList.add(cls));
                    iconRef.current.appendChild(iconElement);
                    window.lucide.createIcons({ root: iconRef.current, attrs: { width: size, height: size } });
                }
            }, [name, size, color, className]);
            return <span ref={iconRef} className="inline-flex items-center justify-center" />;
        };

        const ConfirmationModal = ({ isOpen, title, message, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center backdrop-blur-sm animate-fade-in no-select">
                    <div className="bg-white rounded-lg shadow-2xl max-w-sm w-full p-6 m-4 border-l-4 border-red-500">
                        <div className="flex items-center gap-3 text-red-600 mb-4">
                            <Icon name="alert-triangle" size={24} />
                            <h3 className="text-lg font-bold">{title}</h3>
                        </div>
                        <p className="text-slate-600 mb-6">{message}</p>
                        <div className="flex justify-end gap-3">
                            <button onClick={onCancel} className="px-4 py-2 text-slate-600 font-medium hover:bg-slate-100 rounded-lg">Cancel</button>
                            <button onClick={onConfirm} className="px-4 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700">Confirm & Exit</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- SMART INPUT SYSTEM ---

        const SmartInput = ({ id, value, onChange, correctValue, label, hint, instructorMode, activeInput, setActiveInput, tolerance = 0.5, className="", allowPercent = false }) => {
            const [localError, setLocalError] = useState(null);
            
            const evaluateMath = (expr) => {
                if (!expr) return { valid: true, val: "" };
                try {
                    // Pre-process: handle '1.06%' as '0.0106'
                    let sanitized = expr.toString().replace(/,/g, '');
                    
                    // Handle percentages explicitly
                    sanitized = sanitized.replace(/(\d+(?:\.\d+)?)%/g, '($1/100)'); 

                    // Remove unsafe chars
                    sanitized = sanitized.replace(/[^\d\.\+\-\*\/\(\)]/g, '');
                    
                    if (!/^[\d\.\+\-\*\/\(\)\s]+$/.test(sanitized)) return { valid: false, msg: "Invalid" };
                    
                    // eslint-disable-next-line no-eval
                    const res = eval(sanitized);
                    
                    if (!isFinite(res) || isNaN(res)) return { valid: false, msg: "Error" };
                    return { valid: true, val: res };
                } catch (e) { return { valid: false, msg: "Error" }; }
            };

            const isCorrect = useMemo(() => {
                if (!value || !correctValue) return false;
                const { valid, val } = evaluateMath(value);
                if (!valid) return false;
                
                const target = parseFloat(correctValue.toString().replace(/,/g, ''));
                
                // Enhanced Tolerance: 2% margin or strict tolerance
                const margin = Math.abs(target * 0.02); // 2% of target
                const appliedTolerance = Math.max(tolerance, margin);

                // Standard Check
                if (Math.abs(val - target) <= appliedTolerance) return true;

                // Smart Percent Check: if target is small (<1) and user entered e.g. 5.1 (meaning 5.1%), check val/100
                if (Math.abs(target) < 1.0) {
                     if (Math.abs((val / 100) - target) <= appliedTolerance) return true;
                }

                return false;
            }, [value, correctValue, tolerance]);

            const handleBlur = (e) => {
                const { valid, val } = evaluateMath(value);
                if (!valid) { setLocalError("Invalid"); return; }
                setLocalError(null);
                
                if (valid && value !== "") {
                     const numVal = Number(val);
                     const displayVal = Number.isInteger(numVal) ? numVal.toString() : numVal.toFixed(4).replace(/\.?0+$/, '');
                     onChange(id, displayVal.toString()); 
                }
            };

            const isActive = activeInput === id;

            return (
                <div className="w-full relative">
                    {label && <label className="block text-xs font-bold text-slate-500 mb-1 uppercase tracking-wider">{label}</label>}
                    <input 
                        type="text" 
                        id={id}
                        value={value || ""}
                        onChange={(e) => { setLocalError(null); onChange(id, e.target.value); }}
                        onFocus={() => setActiveInput(id)}
                        onBlur={handleBlur}
                        onKeyDown={(e) => e.key === 'Enter' && e.target.blur()}
                        className={`w-full p-2 text-right border rounded text-sm font-mono shadow-sm transition-all outline-none focus:ring-2 focus:ring-blue-500 ${
                            isCorrect ? "input-correct" : (value && !isActive && !isCorrect) ? "bg-white border-slate-300" : "bg-white border-slate-300"
                        } ${className}`}
                        placeholder={hint ? "Calc..." : "-"}
                    />
                    <div className="absolute left-2 top-1/2 -translate-y-1/2 pointer-events-none transform mt-0.5">
                        {isCorrect ? <span className="text-emerald-600"><Icon name="check" size={14} /></span> : 
                        localError ? <span className="text-red-500 font-bold text-xs">!</span> : null}
                    </div>
                    {instructorMode && (
                        <div className="mt-1 text-[10px] text-purple-700 bg-purple-50 px-2 py-1 rounded inline-block font-bold border border-purple-200 shadow-sm animate-fade-in w-full text-center">
                            Key: {correctValue}
                        </div>
                    )}
                </div>
            );
        };

        // --- SPECIAL: TVM Helper ---
        const solveRate = (nper, pmt, pv, fv) => {
            const maxIter = 50;
            let r = 0.1; 
            for (let i = 0; i < maxIter; i++) {
                if (Math.abs(r) < 1e-8) r = 1e-8;
                let t1 = Math.pow(1 + r, nper);
                let f_r = pv + (pmt * (1 - 1/t1) / r) + (fv / t1);
                let r_plus = r + 1e-5;
                let t1_plus = Math.pow(1 + r_plus, nper);
                let f_r_plus = pv + (pmt * (1 - 1/t1_plus) / r_plus) + (fv / t1_plus);
                let df_r = (f_r_plus - f_r) / 1e-5;
                let r_new = r - f_r / df_r;
                if (Math.abs(r_new - r) < 1e-6) return r_new;
                r = r_new;
            }
            return r;
        };

        const TVMTool = () => {
            const [inputs, setInputs] = useState({ n: '', pmt: '', pv: '', fv: '' });
            const [rate, setRate] = useState(null);

            const calculate = () => {
                const n = parseFloat(inputs.n);
                const pmt = parseFloat(inputs.pmt);
                const pv = parseFloat(inputs.pv);
                const fv = parseFloat(inputs.fv);
                if (!isNaN(n) && !isNaN(pmt) && !isNaN(pv) && !isNaN(fv)) {
                    const r = solveRate(n, pmt, pv, fv);
                    setRate((r * 100).toFixed(4));
                }
            };

            return (
                <div className="bg-slate-800 text-white rounded-xl p-4 shadow-lg mb-6">
                    <div className="flex justify-between items-center mb-4">
                        <h4 className="font-bold text-sm flex items-center gap-2"><Icon name="calculator" size={14}/> TVM Solver</h4>
                        <span className="text-[10px] bg-slate-700 px-2 py-1 rounded text-emerald-400">Target: RATE</span>
                    </div>
                    <div className="grid grid-cols-4 gap-2 mb-4">
                        {['n','pmt','pv','fv'].map(k => (
                            <div key={k}>
                                <label className="block text-[10px] uppercase text-slate-400 mb-1">{k}</label>
                                <input className="w-full bg-slate-900 border border-slate-600 rounded p-1 text-xs text-right text-white focus:border-blue-500 outline-none" 
                                    value={inputs[k]} onChange={(e)=>setInputs({...inputs, [k]:e.target.value})} />
                            </div>
                        ))}
                    </div>
                    <div className="flex justify-between items-center">
                        <button onClick={calculate} className="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-1 rounded text-xs font-bold transition">Calculate Rate</button>
                        <div className="text-right">
                            <span className="text-[10px] text-slate-400 mr-2">Rate per period:</span>
                            <span className="font-mono text-lg font-bold text-emerald-400">{rate !== null ? rate + '%' : '---'}</span>
                        </div>
                    </div>
                </div>
            );
        };

        const ReferenceTable = ({ title, headers, rows, onValueClick }) => {
            const [isOpen, setIsOpen] = useState(true);
            return (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-4 select-none">
                    <button onClick={() => setIsOpen(!isOpen)} className="w-full flex items-center justify-between p-3 bg-slate-50 border-b border-slate-100 hover:bg-slate-100 transition">
                        <h4 className="font-bold text-slate-700 text-sm flex items-center gap-2">
                            <Icon name="table" size={16} /> {title}
                        </h4>
                        <Icon name={isOpen ? "chevron-up" : "chevron-down"} size={16} />
                    </button>
                    {isOpen && (
                        <div className="overflow-x-auto max-h-64">
                            <table className="w-full text-xs text-left">
                                <thead className="bg-slate-50 text-slate-500 uppercase tracking-wider sticky top-0">
                                    <tr>{headers.map((h, i) => <th key={i} className={`p-2 border-b font-medium ${i > 0 ? "text-right" : ""}`}>{h}</th>)}</tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {rows.map((row, rI) => (
                                        <tr key={rI} className="hover:bg-blue-50 transition-colors group">
                                            <td className="p-2 font-medium text-slate-700">{row[0]}</td>
                                            {row.slice(1).map((cell, cI) => (
                                                <td key={cI} 
                                                    onClick={(e) => { e.preventDefault(); onValueClick(cell); }} 
                                                    className="p-2 text-right font-mono text-slate-600 cursor-pointer hover:bg-blue-100 hover:text-blue-700 hover:font-bold border-l border-transparent hover:border-blue-200" 
                                                    title="Click to insert value">
                                                    {cell}
                                                </td>
                                            ))}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };

        // --- MODULES ---

        const ModuleA = ({ teacherMode, isAutoFilled, handleInputChange, inputs, activeInput, setActiveInput }) => {
            const [trend, setTrend] = useState("");
            
            useEffect(() => {
                if(isAutoFilled) setTrend("increase");
                else if(!isAutoFilled && teacherMode) setTrend("");
            }, [isAutoFilled, teacherMode]);

            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                        <h4 className="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2">
                            <Icon name="file-text" className="text-blue-600"/> Analysis: Notes Carrying Value vs. Fair Value
                        </h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="space-y-3">
                                <h5 className="text-xs font-bold text-slate-500 uppercase">FY1 Calculations ($M)</h5>
                                <div className="flex justify-between items-center text-sm">
                                    <span>Net Carrying Value</span>
                                    <div className="w-24"><SmartInput id="a_cv1" value={inputs.A.a_cv1} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={d(_DATA_MATRIX.A.a_cv1)} instructorMode={teacherMode} hint="Face - Unamortized Discount" /></div>
                                </div>
                                <div className="flex justify-between items-center text-sm">
                                    <span>Fair Value</span>
                                    <div className="w-24"><SmartInput id="a_fv1" value={inputs.A.a_fv1} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={d(_DATA_MATRIX.A.a_fv1)} instructorMode={teacherMode} hint="Given" /></div>
                                </div>
                            </div>
                            <div className="space-y-3">
                                <h5 className="text-xs font-bold text-slate-500 uppercase">FY2 Calculations ($M)</h5>
                                <div className="flex justify-between items-center text-sm">
                                    <span>Net Carrying Value</span>
                                    <div className="w-24"><SmartInput id="a_cv2" value={inputs.A.a_cv2} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={d(_DATA_MATRIX.A.a_cv2)} instructorMode={teacherMode} hint="Face - Unamortized Discount" /></div>
                                </div>
                                <div className="flex justify-between items-center text-sm">
                                    <span>Fair Value</span>
                                    <div className="w-24"><SmartInput id="a_fv2" value={inputs.A.a_fv2} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={d(_DATA_MATRIX.A.a_fv2)} instructorMode={teacherMode} hint="Given" /></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="bg-blue-50 p-6 rounded-lg border border-blue-100 shadow-sm">
                        <h3 className="font-bold text-blue-900 mb-3 text-sm flex items-center gap-2">
                            <Icon name="trending-up" size={16} /> Market Interest Rate Analysis
                        </h3>
                        <p className="text-sm text-slate-700 mb-4">
                            Fair Value dropped significantly from FY1 ($12.4B) to FY2 ($9.9B), while Carrying Value remained stable. What does this imply about interest rates?
                        </p>
                        <div className="flex gap-4">
                            <label className={`flex items-center gap-2 p-3 bg-white border rounded cursor-pointer transition-all ${trend==='increase' ? 'border-emerald-500 bg-emerald-50 ring-1 ring-emerald-500' : 'border-slate-200 hover:border-blue-400'}`}>
                                <input type="radio" name="trend" value="increase" checked={trend === 'increase'} onChange={()=>setTrend('increase')} className="accent-emerald-600" />
                                <span className="text-sm font-medium text-slate-700">Interest Rates Increased</span>
                            </label>
                            <label className={`flex items-center gap-2 p-3 bg-white border rounded cursor-pointer transition-all ${trend==='decrease' ? 'border-red-500 bg-red-50' : 'border-slate-200 hover:border-blue-400'}`}>
                                <input type="radio" name="trend" value="decrease" checked={trend === 'decrease'} onChange={()=>setTrend('decrease')} className="accent-blue-600" />
                                <span className="text-sm font-medium text-slate-700">Interest Rates Decreased</span>
                            </label>
                        </div>
                        {trend === 'increase' && (
                            <div className="text-xs text-emerald-700 font-bold mt-3 flex items-center gap-1 animate-fade-in">
                                <Icon name="check-circle" size={12}/> Correct! Bond prices fall when market interest rates rise.
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const ModuleB = ({ teacherMode, isAutoFilled, handleInputChange, inputs, activeInput, setActiveInput }) => {
            return (
                <div className="space-y-6 animate-fade-in">
                    {/* Embedded TVM Tool */}
                    <TVMTool />

                    {/* Step 1 */}
                    <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                        <h3 className="font-bold text-slate-700 mb-3 text-sm flex items-center gap-2">
                            <span className="bg-blue-100 text-blue-700 w-6 h-6 rounded-full flex items-center justify-center text-xs">1</span>
                            Determine Annual Interest Payments
                        </h3>
                        <div className="flex items-center gap-4 text-sm text-slate-600 bg-slate-50 p-4 rounded-lg border border-slate-100">
                            <p>Face Value (€500M) × Coupon Rate (1%) = </p>
                            <div className="w-24">
                                <SmartInput id="b_step1" value={inputs.B.b_step1} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={d(_DATA_MATRIX.B.b_step1)} instructorMode={teacherMode} placeholder="Amount" />
                            </div>
                            <span className="font-medium">€ Million</span>
                        </div>
                    </div>

                    {/* Step 2 */}
                    <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                        <h3 className="font-bold text-slate-700 mb-3 text-sm flex items-center gap-2">
                            <span className="bg-blue-100 text-blue-700 w-6 h-6 rounded-full flex items-center justify-center text-xs">2</span>
                            Identify Inputs for RATE Calculation
                        </h3>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <label className="text-[10px] uppercase font-bold text-slate-400">NPER</label>
                                <SmartInput id="b_n" value={inputs.B.b_n} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={d(_DATA_MATRIX.B.b_n)} instructorMode={teacherMode} hint="Years" />
                            </div>
                            <div>
                                <label className="text-[10px] uppercase font-bold text-slate-400">PMT</label>
                                <SmartInput id="b_pmt" value={inputs.B.b_pmt} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={d(_DATA_MATRIX.B.b_pmt)} instructorMode={teacherMode} hint="Cash Out" />
                            </div>
                            <div>
                                <label className="text-[10px] uppercase font-bold text-slate-400">PV</label>
                                <SmartInput id="b_pv" value={inputs.B.b_pv} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={d(_DATA_MATRIX.B.b_pv)} instructorMode={teacherMode} hint="Inflow" tolerance={0.1} />
                            </div>
                            <div>
                                <label className="text-[10px] uppercase font-bold text-slate-400">FV</label>
                                <SmartInput id="b_fv" value={inputs.B.b_fv} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={d(_DATA_MATRIX.B.b_fv)} instructorMode={teacherMode} hint="Face Out" />
                            </div>
                        </div>
                    </div>

                    {/* Step 3 (New Detailed Part C) */}
                    <div className="bg-emerald-50 p-6 rounded-xl border border-emerald-100 shadow-md">
                        <h3 className="font-bold text-emerald-900 mb-4 text-base flex items-center gap-2">
                            <Icon name="book-open" size={20}/> Part C: Interest in the First Year (Step-by-Step)
                        </h3>
                        
                        <div className="space-y-6">
                            {/* Sub-step 1 */}
                            <div className="bg-white p-4 rounded-lg border border-emerald-100">
                                <h4 className="font-bold text-slate-700 text-sm mb-3">Step 1) Enter the inputs</h4>
                                <div className="grid grid-cols-1 gap-4">
                                    <div className="flex items-center justify-between">
                                        <label className="text-xs text-slate-600 w-1/2">Issue Proceeds (Beginning CV)</label>
                                        <div className="w-32">
                                            <SmartInput id="b_c_proceeds" value={inputs.B.b_c_proceeds} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={d(_DATA_MATRIX.B.b_c_proceeds)} instructorMode={teacherMode} hint="€497.67" />
                                        </div>
                                    </div>
                                    <div className="flex items-center justify-between">
                                        <label className="text-xs text-slate-600 w-1/2">Effective Interest Rate (Annual)</label>
                                        <div className="w-32">
                                            <SmartInput id="b_c_rate" value={inputs.B.b_c_rate} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={d(_DATA_MATRIX.B.b_c_rate)} instructorMode={teacherMode} hint="1.06107%" allowPercent={true} />
                                        </div>
                                    </div>
                                    <div className="flex items-center justify-between">
                                        <label className="text-xs text-slate-600 w-1/2">Months elapsed in FY1 (May–Dec)</label>
                                        <div className="w-32">
                                            <SmartInput id="b_c_months" value={inputs.B.b_c_months} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={d(_DATA_MATRIX.B.b_c_months)} instructorMode={teacherMode} hint="8" />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Sub-step 2 & 3 */}
                            <div className="bg-white p-4 rounded-lg border border-emerald-100">
                                <div className="flex items-start gap-3 mb-4">
                                    <div className="bg-emerald-100 text-emerald-800 p-2 rounded-lg mt-1">
                                        <Icon name="function-square" size={20} />
                                    </div>
                                    <div>
                                        <h4 className="font-bold text-slate-700 text-sm">Step 2 & 3) Calculate Interest</h4>
                                        <p className="text-xs text-slate-500 mt-1">Formula: <code className="bg-slate-100 px-1 rounded border border-slate-200">= Proceeds * Rate * (Months/12)</code></p>
                                        <p className="text-xs text-slate-500 italic mt-1">Logic: Annual Interest Amount × Fraction of Year</p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-4">
                                    <span className="text-sm font-bold text-slate-700">Interest Expense:</span>
                                    <div className="w-40">
                                        <SmartInput id="b_c_calc" value={inputs.B.b_c_calc} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={d(_DATA_MATRIX.B.b_c_calc)} instructorMode={teacherMode} hint="Result" tolerance={0.05} />
                                    </div>
                                    <span className="text-sm text-slate-500">€ Million</span>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            );
        };

        const QuizModule = ({ teacherMode, isAutoFilled, handleInputChange, inputs, activeInput, setActiveInput }) => {
            const [answers, setAnswers] = useState({});
            
            useEffect(() => {
                if (isAutoFilled) {
                    const decodedAnswers = {};
                    Object.keys(_DATA_MATRIX.Q).forEach(k => decodedAnswers[k] = d(_DATA_MATRIX.Q[k]));
                    setAnswers(decodedAnswers);
                } else if (!isAutoFilled && teacherMode) {
                    setAnswers({});
                }
            }, [isAutoFilled, teacherMode]);

            const questions = [
                { id: 'q1', text: "1. Generally, if the Fair Value of a company's fixed-rate debt falls significantly below its Carrying Value, what does this imply about the market interest rate environment since issuance?", options: [{id:'a', text:"Market interest rates have increased."}, {id:'b', text:"Market interest rates have decreased."}, {id:'c', text:"The company's credit rating has improved significantly."}] },
                { id: 'q2', text: "2. Carrefour's bond was issued at €497.67M with a face value of €500M. This is a:", options: [{id:'a', text:"Premium Bond"}, {id:'b', text:"Par Bond"}, {id:'c', text:"Discount Bond"}] },
                { id: 'q3', text: "3. For a discount bond like Carrefour's, interest expense reported on the income statement is:", options: [{id:'a', text:"Greater than cash interest paid"}, {id:'b', text:"Less than cash interest paid"}, {id:'c', text:"Equal to cash interest paid"}] },
                { id: 'q4', text: "4. What is the typical relationship between the Coupon Rate and the Effective Interest Rate (Yield at Issuance) for a Premium Bond?", options: [{id:'a', text:"Coupon Rate < Effective Rate"}, {id:'b', text:"Coupon Rate > Effective Rate"}, {id:'c', text:"Coupon Rate = Effective Rate"}] },
                { id: 'q5', text: "5. When a bond is issued at a discount, how does the amortization of that discount affect the Carrying Value of the bond over time?", options: [{id:'a', text:"Carrying Value decreases towards Face Value."}, {id:'b', text:"Carrying Value remains constant."}, {id:'c', text:"Carrying Value increases towards Face Value."}] },
                { id: 'q6', text: "6. Which value represents the actual legal obligation to be repaid at maturity?", options: [{id:'a', text:"Carrying Value"}, {id:'b', text:"Face Value (Principal)"}, {id:'c', text:"Fair Value"}] }
            ];

            return (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 animate-fade-in">
                    <h2 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2"><Icon name="check-square" className="text-emerald-600"/> Concept Check: Debt Analysis</h2>
                    <div className="space-y-6">
                        {questions.map(q => {
                            const correctId = d(_DATA_MATRIX.Q[q.id]);
                            return (
                                <div key={q.id} className="border-b border-slate-100 pb-4 last:border-0">
                                    <p className="text-sm font-medium text-slate-800 mb-3">{q.text}</p>
                                    <div className="space-y-2">
                                        {q.options.map(opt => (
                                            <button key={opt.id} onClick={() => setAnswers({...answers, [q.id]: opt.id})} 
                                                className={`w-full text-left p-3 rounded border text-xs flex items-center gap-3 transition-all ${
                                                    answers[q.id]===opt.id ? (opt.id === correctId ? "bg-emerald-50 border-emerald-500 text-emerald-800 ring-1 ring-emerald-500" : "bg-red-50 border-red-500 text-red-800 ring-1 ring-red-500") : "hover:bg-slate-50 border-slate-200 bg-white"
                                                }`}>
                                                <div className={`w-4 h-4 rounded-full border flex items-center justify-center shrink-0 ${
                                                    answers[q.id]===opt.id ? (opt.id === correctId ? "bg-emerald-600 border-emerald-600" : "bg-red-600 border-red-600") : "border-slate-300"
                                                }`}>
                                                    {answers[q.id]===opt.id && <div className="w-1.5 h-1.5 bg-white rounded-full"></div>}
                                                </div>
                                                <span>{opt.text}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---

        const App = () => {
            const [activeTab, setActiveTab] = useState('A'); 
            const [inputs, setInputs] = useState({ A: {}, B: {}, Q: {} });
            const [activeInput, setActiveInput] = useState(null);
            
            // Sidebar State
            const [sidebarWidth, setSidebarWidth] = useState(350);
            const [isDragging, setIsDragging] = useState(false);

            // Instructor State
            const [instructorMode, setInstructorMode] = useState(false);
            const [showLogin, setShowLogin] = useState(false);
            const [password, setPassword] = useState("");
            const [clearModalOpen, setClearModalOpen] = useState(false);
            const [isAutoFilled, setIsAutoFilled] = useState(false);
            const [studentName, setStudentName] = useState("");
            const [showDownload, setShowDownload] = useState(false);

            const activeData = activeTab === 'A' ? _D_ALPHA : _D_CARR;

            // --- Sidebar Resize Logic ---
            const startResizing = useCallback(() => setIsDragging(true), []);
            const stopResizing = useCallback(() => setIsDragging(false), []);
            const resize = useCallback((mouseMoveEvent) => {
                if (isDragging) {
                    const newWidth = mouseMoveEvent.clientX;
                    if (newWidth > 200 && newWidth < 600) setSidebarWidth(newWidth);
                }
            }, [isDragging]);

            useEffect(() => {
                window.addEventListener("mousemove", resize);
                window.addEventListener("mouseup", stopResizing);
                return () => {
                    window.removeEventListener("mousemove", resize);
                    window.removeEventListener("mouseup", stopResizing);
                };
            }, [resize, stopResizing]);

            const handleInputChange = (id, val) => setInputs(prev => ({ ...prev, [activeTab]: { ...prev[activeTab], [id]: val } }));

            // --- Smart Number Replacement Logic ---
            const handleValueClick = (val) => {
                if (!activeInput) return;
                
                // Clean input from reference table
                const cleanVal = val.replace(/,/g, '').replace(/[()]/g, (m) => m === '(' ? '-' : '').replace(/[^0-9\.\-]/g, ''); // Keep numbers and decimals

                setInputs(prev => {
                    const cur = prev[activeTab][activeInput] || "";
                    
                    // Check if current input ends with an operator (ignoring whitespace)
                    // If "100 +", append. If "100", replace.
                    const isOperatorOrEmpty = /[+\-*/(]\s*$/.test(cur) || cur.trim() === "";

                    let newVal;
                    if (isOperatorOrEmpty) {
                        newVal = cur + cleanVal;
                    } else {
                        // Replace the last number segment
                        // Matches a number at the end of the string
                        newVal = cur.replace(/(\d*\.?\d+)$/, cleanVal);
                        
                        // Fallback: if regex didn't match (maybe complex expression), just append (safety)
                        if (newVal === cur) newVal = cur + cleanVal; 
                    }

                    return { ...prev, [activeTab]: { ...prev[activeTab], [activeInput]: newVal } };
                });

                // Focus Retention
                setTimeout(() => {
                    const el = document.getElementById(activeInput);
                    if (el) {
                        el.focus();
                        // Optional: move cursor to end
                        const len = el.value.length;
                        el.setSelectionRange(len, len);
                    }
                }, 50);
            };

            const unlockInstructor = () => {
                // Base64 for "teacher"
                if (btoa(password.toLowerCase()) === 'dGVhY2hlcg==') { setInstructorMode(true); setShowLogin(false); setPassword(""); } else { alert("Incorrect"); }
            };

            const handleAutoFill = () => {
                if (activeTab === 'Q') {
                    setIsAutoFilled(true);
                } else {
                    const activeKey = activeTab === 'A' ? _DATA_MATRIX.A : _DATA_MATRIX.B;
                    const decodedInputs = {};
                    Object.keys(activeKey).forEach(k => decodedInputs[k] = d(activeKey[k]));
                    setInputs(prev => ({ ...prev, [activeTab]: decodedInputs }));
                    setIsAutoFilled(true);
                }
            };

            const performClear = () => {
                setInputs({ A: {}, B: {}, Q: {} });
                setIsAutoFilled(false);
                setInstructorMode(false);
                setClearModalOpen(false);
            };

            const handleDownload = () => {
                const text = `Bond Analysis - ${activeTab}\nStudent: ${studentName}\nAnswers:\n${JSON.stringify(inputs[activeTab] || {})}`;
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `${studentName}_BondSim.txt`; a.click();
                setShowDownload(false);
            };

            return (
                <div className="flex h-screen bg-slate-100 overflow-hidden font-sans">
                    
                    {/* LEFT SIDEBAR: REFERENCE */}
                    <div 
                        className="bg-slate-50 border-r border-slate-200 overflow-y-auto custom-scrollbar flex flex-col relative shrink-0"
                        style={{ width: sidebarWidth }}
                    >
                        <div className="sticky top-0 bg-white p-4 border-b border-slate-200 shadow-sm z-10">
                            <div className="flex items-center gap-2 text-blue-800 font-bold text-lg mb-1">
                                <Icon name="library" /> Reference Data
                            </div>
                            <p className="text-xs text-slate-500 font-bold uppercase tracking-wider">{activeData.metadata.name}</p>
                            <p className="text-xs text-blue-600 mt-1 flex items-center gap-1">
                                <Icon name="mouse-pointer-click" size={12} /> Click values to insert
                            </p>
                        </div>
                        <div className="p-4 space-y-2">
                            {activeData.tables.map((tbl, i) => (
                                <ReferenceTable 
                                    key={i}
                                    title={tbl.title} 
                                    headers={tbl.headers} 
                                    rows={tbl.rows} 
                                    onValueClick={handleValueClick} 
                                />
                            ))}
                        </div>
                    </div>

                    {/* DRAG HANDLE */}
                    <div 
                        className={`resizer ${isDragging ? 'active' : ''}`}
                        onMouseDown={startResizing}
                    ></div>

                    {/* MAIN CONTENT */}
                    <div className="flex-1 flex flex-col h-screen overflow-hidden relative">
                        
                        {/* TOP NAV TABS */}
                        <div className="bg-slate-800 text-white flex shrink-0">
                            <button onClick={() => { setActiveTab('A'); setIsAutoFilled(false); }} className={`flex-1 py-3 text-sm font-bold flex items-center justify-center gap-2 transition-colors ${activeTab === 'A' ? 'bg-blue-600 text-white' : 'hover:bg-slate-700 text-slate-400'}`}>
                                <Icon name="file-text" size={16} /> E7-34: Alphabet
                            </button>
                            <button onClick={() => { setActiveTab('B'); setIsAutoFilled(false); }} className={`flex-1 py-3 text-sm font-bold flex items-center justify-center gap-2 transition-colors ${activeTab === 'B' ? 'bg-emerald-600 text-white' : 'hover:bg-slate-700 text-slate-400'}`}>
                                <Icon name="euro" size={16} /> E7-37: Carrefour
                            </button>
                            <button onClick={() => { setActiveTab('Q'); setIsAutoFilled(false); }} className={`flex-1 py-3 text-sm font-bold flex items-center justify-center gap-2 transition-colors ${activeTab === 'Q' ? 'bg-purple-600 text-white' : 'hover:bg-slate-700 text-slate-400'}`}>
                                <Icon name="help-circle" size={16} /> Quiz
                            </button>
                        </div>

                        {/* INSTRUCTOR TOOLBAR */}
                        {instructorMode && (
                            <div className="bg-purple-700 text-white p-2 shadow-md flex items-center justify-between z-20 animate-fade-in shrink-0">
                                <div className="flex items-center gap-3 px-4">
                                    <span className="bg-white/20 p-1.5 rounded"><Icon name="graduation-cap" /></span>
                                    <span className="font-bold tracking-wide">INSTRUCTOR MODE</span>
                                </div>
                                <div className="flex gap-2 px-4">
                                    <button onClick={handleAutoFill} className="flex items-center gap-2 px-3 py-1 bg-green-500 hover:bg-green-600 rounded text-sm font-bold transition">
                                        <Icon name="wand-2" size={14} /> Auto-Fill Tab
                                    </button>
                                    <button onClick={() => setClearModalOpen(true)} className="flex items-center gap-2 px-3 py-1 bg-red-500 hover:bg-red-600 rounded text-sm font-bold transition">
                                        <Icon name="log-out" size={14} /> Clear & Exit
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* HEADER */}
                        <header className="bg-white border-b border-slate-200 p-6 flex justify-between items-center shrink-0 relative">
                            <div>
                                <h1 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
                                    <Icon name="file-spreadsheet" className="text-blue-600" /> {activeData.metadata.name}
                                </h1>
                                <p className="text-slate-500 text-sm mt-1">{activeData.metadata.year} Simulation</p>
                            </div>
                            
                            {/* STEALTH BUTTON CONTAINER - Fixed position to top right corner */}
                            <div className="absolute top-0 right-0"> 
                                 <button 
                                    onClick={() => setShowLogin(true)} 
                                    className="p-2 opacity-5 hover:opacity-100 text-slate-400 hover:text-purple-600 transition-all"
                                    title="Instructor Access"
                                >
                                    <Icon name="lock" size={14} />
                                </button>
                            </div>

                            <div className="flex gap-3">
                                <button onClick={() => setShowDownload(true)} className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-sm transition">
                                    <Icon name="save" size={18} /> Save Work
                                </button>
                            </div>
                        </header>

                        {/* SCROLLABLE FORM AREA */}
                        <main className="flex-1 overflow-y-auto custom-scrollbar bg-slate-50/50 p-8 pb-20">
                            <div className="max-w-4xl mx-auto space-y-8">
                                <div className={activeTab === 'Q' ? "col-span-2" : "space-y-6 col-span-2 lg:col-span-1"}>
                                    {activeTab === 'A' && (
                                        <ModuleA teacherMode={instructorMode} isAutoFilled={isAutoFilled} handleInputChange={handleInputChange} inputs={inputs} activeInput={activeInput} setActiveInput={setActiveInput} />
                                    )}
                                    {activeTab === 'B' && (
                                        <ModuleB teacherMode={instructorMode} isAutoFilled={isAutoFilled} handleInputChange={handleInputChange} inputs={inputs} activeInput={activeInput} setActiveInput={setActiveInput} />
                                    )}
                                    {activeTab === 'Q' && (
                                        <QuizModule teacherMode={instructorMode} isAutoFilled={isAutoFilled} handleInputChange={handleInputChange} inputs={inputs} activeInput={activeInput} setActiveInput={setActiveInput} />
                                    )}
                                </div>
                            </div>
                        </main>
                    </div>

                    {/* MODALS */}
                    
                    {/* Login Modal */}
                    {showLogin && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center animate-fade-in">
                            <div className="bg-white p-6 rounded-xl shadow-2xl w-80 transform transition-all">
                                <h3 className="font-bold text-lg mb-4 text-slate-800 flex items-center gap-2">
                                    <Icon name="lock" size={20} className="text-blue-600" /> Instructor Access
                                </h3>
                                <input type="password" className="w-full border p-3 rounded-lg mb-4 outline-none focus:border-blue-500" placeholder="Enter password" value={password} onChange={(e) => setPassword(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && unlockInstructor()} autoFocus />
                                <div className="flex justify-end gap-2">
                                    <button onClick={() => setShowLogin(false)} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg text-sm font-medium">Cancel</button>
                                    <button onClick={unlockInstructor} className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-bold">Unlock</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Download Modal */}
                    {showDownload && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center animate-fade-in">
                            <div className="bg-white p-8 rounded-xl shadow-2xl w-96">
                                <div className="text-center mb-6">
                                    <div className="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3 text-blue-600">
                                        <Icon name="download-cloud" size={24} />
                                    </div>
                                    <h3 className="text-xl font-bold text-slate-800">Submit Assignment</h3>
                                    <p className="text-slate-500 text-sm mt-1">Enter your name to generate your submission file.</p>
                                </div>
                                <input type="text" value={studentName} onChange={(e) => setStudentName(e.target.value)} placeholder="Your Full Name" className="w-full p-3 border border-slate-300 rounded-lg mb-4 text-center focus:border-blue-500 outline-none font-bold text-slate-700" autoFocus />
                                <div className="flex flex-col gap-2">
                                    <button onClick={() => studentName.trim() ? handleDownload() : alert("Name required")} className="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition flex items-center justify-center gap-2">
                                        Download Submission
                                    </button>
                                    <button onClick={() => setShowDownload(false)} className="w-full py-2 text-slate-500 hover:bg-slate-50 rounded-lg text-sm">Cancel</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Clear Confirmation Modal */}
                    <ConfirmationModal isOpen={clearModalOpen} title="Clear All & Exit?" message="This will remove all student answers and lock Instructor Mode. This action cannot be undone." onConfirm={performClear} onCancel={() => setClearModalOpen(false)} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
