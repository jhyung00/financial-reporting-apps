<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Analysis Simulation: Spirit AeroSystems (P4-34)</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Input Styles */
        .input-base { transition: all 0.2s; outline: none; }
        .input-correct { background-color: #f0fdf4; border-color: #22c55e; color: #15803d; font-weight: 600; }
        .input-incorrect { background-color: #fef2f2; border-color: #ef4444; }
        .input-neutral { background-color: #fff; border-color: #cbd5e1; }
        .input-neutral:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }

        /* Resize Handle */
        .resize-handle {
            width: 4px;
            cursor: col-resize;
            transition: background 0.2s;
        }
        .resize-handle:hover, .resize-handle.active {
            background-color: #3b82f6;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- SECURITY UTILS ---
        
        // Helper to decode Base64 strings
        const d = (str) => {
            try {
                return atob(str);
            } catch (e) {
                console.error("Decoding error", e);
                return str;
            }
        };

        // --- DATA: AMAZON ---
        const AMAZON_DATA = {
            // Obfuscated Name: Amazon
            metadata: { name: d("QW1hem9u"), year: "Current Year" },
            tables: [
                {
                    title: "Selected Financial Data ($ millions)",
                    headers: ["Item", "Current Year", "Prior Year"],
                    rows: [
                        ["Net operating profit after tax (NOPAT)", "13,174", "3,705"],
                        ["Net income", "11,584", "3,640"],
                        ["Operating profit", "14,905", "4,722"],
                        ["Interest expense", "1,630", "1,018"],
                        ["Cash from operating activities", "36,868", "21,120"],
                        ["Current assets", "300,404", "72,236"],
                        ["Current liabilities", "82,069", "66,565"],
                        ["Cash and cash equivalents", "36,513", "24,626"],
                        ["Marketable securities", "11,400", "12,034"],
                        ["Accounts receivable", "19,179", "15,797"],
                        ["Total debt", "28,194", "28,454"],
                        ["Total assets", "187,045", "157,572"],
                        ["Average assets", "176,375", "123,459"],
                        ["Total liabilities", "136,964", "124,321"],
                        ["Equity", "52,259", "31,865"],
                        ["Average equity", "40,973", "28,196"],
                        ["Net operating assets (NOA)", "30,953", "24,686"],
                        ["Average NOA", "27,175", "13,478"]
                    ]
                }
            ]
        };

        const AMAZON_ANSWER_KEY = {
            "rnoa_curr": "48.5", "rnoa_prior": "27.5",
            "roe_curr": "28.3", "roe_prior": "12.9",
            "prof_stronger": "Current year", "prof_improved": "ROE",
            "tie_curr": "9.14", "tie_prior": "4.64",
            "cfo_debt_curr": "1.31", "cfo_debt_prior": "0.74",
            "cov_interp": "Both coverage ratios approximately doubled over the two years.",
            "curr_ratio_curr": "3.66", "curr_ratio_prior": "1.09",
            "quick_ratio_curr": "0.82", "quick_ratio_prior": "0.79",
            "liq_info": "Liquidity ratios of other online retail companies",
            "liab_eq_curr": "2.62", "liab_eq_prior": "3.90",
            "debt_eq_curr": "0.54", "debt_eq_prior": "0.89",
            "cap_interp": "Both liabilities-to-equity and debt-to-equity ratios decreased, indicating an improvement in Amazonâ€™s solvency."
        };

        const AMAZON_QUESTIONS = [
            {
                id: "qA", title: "A. Profitability Measures", desc: "Compute RNOA and ROE.",
                sections: [
                    { subtitle: "RNOA", fields: [{ id: "rnoa_curr", label: "Current RNOA %", type: "percent", hint: "NOPAT / Avg NOA" }, { id: "rnoa_prior", label: "Prior RNOA %", type: "percent", hint: "NOPAT / Avg NOA" }] },
                    { subtitle: "ROE", fields: [{ id: "roe_curr", label: "Current ROE %", type: "percent", hint: "Net Income / Avg Equity" }, { id: "roe_prior", label: "Prior ROE %", type: "percent", hint: "Net Income / Avg Equity" }] },
                    { subtitle: "Interpretation", fields: [{ id: "prof_stronger", label: "Stronger year?", type: "text" }, { id: "prof_improved", label: "Most improved ratio?", type: "text" }] }
                ]
            },
            {
                id: "qB", title: "B. Coverage Metrics", desc: "Compute Times Interest Earned & CFO to Debt.",
                sections: [
                    { subtitle: "Times Interest Earned", fields: [{ id: "tie_curr", label: "Current Times", type: "decimal", hint: "Op Profit / Interest" }, { id: "tie_prior", label: "Prior Times", type: "decimal", hint: "Op Profit / Interest" }] },
                    { subtitle: "CFO to Total Debt", fields: [{ id: "cfo_debt_curr", label: "Current Ratio", type: "decimal", hint: "CFO / Total Debt" }, { id: "cfo_debt_prior", label: "Prior Ratio", type: "decimal", hint: "CFO / Total Debt" }] },
                    { subtitle: "Interpretation", fields: [{ id: "cov_interp", label: "Interpret change", type: "text", fullWidth: true }] }
                ]
            },
            {
                id: "qC", title: "C. Liquidity Ratios", desc: "Compute Current & Quick Ratios.",
                sections: [
                    { subtitle: "Current Ratio", fields: [{ id: "curr_ratio_curr", label: "Current Ratio", type: "decimal", hint: "Curr Assets / Curr Liab" }, { id: "curr_ratio_prior", label: "Prior Ratio", type: "decimal", hint: "Curr Assets / Curr Liab" }] },
                    { subtitle: "Quick Ratio", fields: [{ id: "quick_ratio_curr", label: "Current Ratio", type: "decimal", hint: "(Cash+MktSec+AR)/CL" }, { id: "quick_ratio_prior", label: "Prior Ratio", type: "decimal", hint: "(Cash+MktSec+AR)/CL" }] },
                    { subtitle: "Analysis", fields: [{ id: "liq_info", label: "Helpful Info?", type: "text", fullWidth: true }] }
                ]
            },
            {
                id: "qD", title: "D. Capital Structure", desc: "Compute Liabilities-to-Equity & Debt-to-Equity.",
                sections: [
                    { subtitle: "Liabilities-to-Equity", fields: [{ id: "liab_eq_curr", label: "Current Ratio", type: "decimal", hint: "Total Liab / Equity" }, { id: "liab_eq_prior", label: "Prior Ratio", type: "decimal", hint: "Total Liab / Equity" }] },
                    { subtitle: "Debt-to-Equity", fields: [{ id: "debt_eq_curr", label: "Current Ratio", type: "decimal", hint: "Total Debt / Equity" }, { id: "debt_eq_prior", label: "Prior Ratio", type: "decimal", hint: "Total Debt / Equity" }] },
                    { subtitle: "Interpretation", fields: [{ id: "cap_interp", label: "Interpret solvency", type: "text", fullWidth: true }] }
                ]
            }
        ];

        // --- DATA: SPIRIT AEROSYSTEMS ---
        const SPIRIT_DATA = {
            // Obfuscated Name: Spirit AeroSystems (P4-34)
            metadata: { name: d("U3Bpcml0IEFlcm9TeXN0ZW1zIChQNC0zNCk="), year: "Current Year" },
            tables: [
                {
                    title: "Balance Sheet: Assets ($M)",
                    headers: ["Item", "Current", "Prior"],
                    rows: [
                        ["Cash & equivalents", "658.6", "1,478.6"],
                        ["Restricted cash", "0.2", "0.3"],
                        ["Accounts receivable, net", "489.5", "461.6"],
                        ["Inventory, net", "1,470.7", "1,382.6"],
                        ["Other current assets", "539.3", "482.9"],
                        ["Total current assets", "3,158.3", "3,806.0"],
                        ["PPE, net", "2,205.9", "2,385.5"],
                        ["Operating lease ROU", "94.3", "85.3"],
                        ["Goodwill", "630.5", "623.7"],
                        ["Intangible assets", "211.4", "212.3"],
                        ["Other assets", "365.8", "624.5"],
                        ["Total assets", "6,666.2", "7,737.3"]
                    ]
                },
                {
                    title: "Balance Sheet: Liab & Eq ($M)",
                    headers: ["Item", "Current", "Prior"],
                    rows: [
                        ["Accounts payable", "919.8", "720.3"],
                        ["Accrued expenses", "411.7", "376.1"],
                        ["Curr portion LT debt", "53.7", "49.5"],
                        ["Operating leases (curr)", "8.3", "8.2"],
                        ["Other current liab", "559.0", "721.9"],
                        ["Total current liab", "1,952.5", "1,876.0"],
                        ["Long-term debt", "3,814.9", "3,742.7"],
                        ["Op leases (noncurr)", "85.4", "78.8"],
                        ["Other noncurr liab", "1,057.2", "1,591.0"],
                        ["Total stock. equity", "(247.5)", "448.3"],
                        ["Noncontrolling int", "3.7", "0.5"],
                        ["Total equity", "(243.8)", "448.8"],
                        ["Total Liab & Eq", "6,666.2", "7,737.3"]
                    ]
                },
                {
                    title: "Income Statement ($M)",
                    headers: ["Item", "Current", "Prior"],
                    rows: [
                        ["Net revenues", "5,029.6", "3,953.0"],
                        ["Cost of sales", "4,981.0", "4,070.8"],
                        ["SG&A", "279.2", "279.9"],
                        ["Restructuring", "0.2", "8.2"],
                        ["R&D", "50.4", "53.3"],
                        ["Operating loss (EBIT)", "(281.2)", "(459.2)"],
                        ["Interest expense", "(244.1)", "(242.6)"],
                        ["Other (exp) income", "(14.1)", "146.6"],
                        ["Income tax (prov) ben", "(5.2)", "17.2"],
                        ["Net loss", "(545.7)", "(540.8)"]
                    ]
                },
                {
                    title: "Additional Info ($M)",
                    headers: ["Item", "Current", "Prior"],
                    rows: [
                        ["Cash from Ops (CFO)", "(394.6)", "(63.2)"],
                        ["Depreciation", "322.7", "313.6"],
                        ["Amortization", "14.4", "14.0"],
                        ["CAPEX", "121.6", "150.6"]
                    ]
                }
            ]
        };

        const SPIRIT_ANSWER_KEY = {
            "s_liab_eq_curr": "Negative", "s_liab_eq_prior": "16.258",
            "s_debt_eq_curr": "Negative", "s_debt_eq_prior": "8.653",
            "s_cap_interp": "Because the company has negative equity in the current fiscal year and very low equity in the prior year, we cannot interpret these two capital structure ratios. We can observe that the level of debt is very significant and the capital structure is weak.",
            
            "s_tie_curr": "-1.152", "s_tie_prior": "-1.893",
            "s_ebitda_calc_curr": "55.9", "s_ebitda_calc_prior": "-131.6",
            "s_ebitda_curr": "0.229", "s_ebitda_prior": "-0.542",
            "s_cfo_debt_curr": "-0.100", "s_cfo_debt_prior": "-0.016",
            "s_focf_debt_curr": "-0.130", "s_focf_debt_prior": "-0.055",
            "s_cov_drivers": "Improvement in TIE/EBITDA driven by GAAP earnings. Worsening cash coverage driven by decrease in CFO.",
            
            "s_curr_ratio_curr": "1.618", "s_curr_ratio_prior": "2.029",
            "s_quick_ratio_curr": "0.588", "s_quick_ratio_prior": "1.034",
            "s_liq_concl": "Spirit AeroSystems has high levels of credit risk. All of the metrics are weak and most have weakened during the recent fiscal year."
        };

        const SPIRIT_QUESTIONS = [
            {
                id: "sq1", title: "1. Capital Structure Ratios", desc: "Compute structure ratios. Note any negative equity issues by entering 'Negative' (do not calculate).",
                sections: [
                    { subtitle: "Liabilities-to-Equity", fields: [{ id: "s_liab_eq_curr", label: "Current", type: "text", hint: "Total Liab / Stockholders' Equity" }, { id: "s_liab_eq_prior", label: "Prior", type: "decimal", hint: "Total Liab / Stockholders' Equity" }] },
                    { subtitle: "Total Debt-to-Equity", fields: [{ id: "s_debt_eq_curr", label: "Current", type: "text", hint: "Total Debt / Stockholders' Equity" }, { id: "s_debt_eq_prior", label: "Prior", type: "decimal", hint: "Total Debt / Stockholders' Equity" }] },
                    { subtitle: "Interpretation", fields: [{ id: "s_cap_interp", label: "Analysis", type: "text", fullWidth: true }] }
                ]
            },
            {
                id: "sq2", title: "2. Coverage Ratios", desc: "Assess ability to service debt. (Total Debt = ST Debt + Curr Lease + LT Debt + Noncurr Lease)",
                sections: [
                    { subtitle: "Times Interest Earned", fields: [{ id: "s_tie_curr", label: "Current", type: "decimal", hint: "EBIT / Interest" }, { id: "s_tie_prior", label: "Prior", type: "decimal", hint: "EBIT / Interest" }] },
                    { subtitle: "EBITDA Build", fields: [{ id: "s_ebitda_calc_curr", label: "Current EBITDA", type: "decimal", hint: "EBIT + Depr + Amort" }, { id: "s_ebitda_calc_prior", label: "Prior EBITDA", type: "decimal", hint: "EBIT + Depr + Amort" }] },
                    { subtitle: "EBITDA Coverage", fields: [{ id: "s_ebitda_curr", label: "Current", type: "decimal", hint: "(EBIT+Dep+Amort)/Int" }, { id: "s_ebitda_prior", label: "Prior", type: "decimal", hint: "(EBIT+Dep+Amort)/Int" }] },
                    { subtitle: "CFO to Total Debt", fields: [{ id: "s_cfo_debt_curr", label: "Current", type: "decimal", hint: "CFO / Total Debt" }, { id: "s_cfo_debt_prior", label: "Prior", type: "decimal", hint: "CFO / Total Debt" }] },
                    { subtitle: "FOCF to Total Debt", fields: [{ id: "s_focf_debt_curr", label: "Current", type: "decimal", hint: "(CFO-CAPEX)/Total Debt" }, { id: "s_focf_debt_prior", label: "Prior", type: "decimal", hint: "(CFO-CAPEX)/Total Debt" }] },
                    { subtitle: "Key Drivers", fields: [{ id: "s_cov_drivers", label: "Explain changes", type: "text", fullWidth: true }] }
                ]
            },
            {
                id: "sq3", title: "3. Liquidity Ratios", desc: "Assess short-term solvency.",
                sections: [
                    { subtitle: "Current Ratio", fields: [{ id: "s_curr_ratio_curr", label: "Current", type: "decimal", hint: "CA / CL" }, { id: "s_curr_ratio_prior", label: "Prior", type: "decimal", hint: "CA / CL" }] },
                    { subtitle: "Quick Ratio", fields: [{ id: "s_quick_ratio_curr", label: "Current", type: "decimal", hint: "(Cash+Restr+AR)/CL" }, { id: "s_quick_ratio_prior", label: "Prior", type: "decimal", hint: "(Cash+Restr+AR)/CL" }] },
                    { subtitle: "Conclusion", fields: [{ id: "s_liq_concl", label: "Takeaway", type: "text", fullWidth: true }] }
                ]
            }
        ];

        // --- COMPONENTS ---

        const Icon = ({ name, size = 16, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (window.lucide && ref.current) {
                    ref.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    ref.current.appendChild(i);
                    window.lucide.createIcons({
                        root: ref.current,
                        nameAttr: 'data-lucide',
                        attrs: { width: size, height: size, "stroke-width": 2 }
                    });
                }
            }, [name, size]);
            return <span ref={ref} className={`inline-flex items-center justify-center ${className}`} style={{ width: size, height: size }}></span>;
        };

        const ConfirmationModal = ({ isOpen, title, message, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center backdrop-blur-sm animate-fade-in">
                    <div className="bg-white rounded-lg shadow-2xl max-w-sm w-full p-6 m-4">
                        <div className="flex items-center gap-3 text-red-600 mb-4">
                            <Icon name="alert-triangle" size={24} />
                            <h3 className="text-lg font-bold">{title}</h3>
                        </div>
                        <p className="text-slate-600 mb-6">{message}</p>
                        <div className="flex justify-end gap-3">
                            <button onClick={onCancel} className="px-4 py-2 text-slate-600 font-medium hover:bg-slate-100 rounded-lg">Cancel</button>
                            <button onClick={onConfirm} className="px-4 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700">Confirm</button>
                        </div>
                    </div>
                </div>
            );
        };

        const SmartInput = ({ id, value, onChange, correctValue, label, type, hint, instructorMode, activeInput, setActiveInput }) => {
            const [localError, setLocalError] = useState(null);
            
            const evaluateMath = (expr) => {
                if (!expr) return { valid: true, val: "" };
                try {
                    let sanitized = expr.toString().replace(/,/g, '').replace(/%/g, '/100');
                    // Handle accounting parens: (123) -> -123
                    sanitized = sanitized.replace(/\(([\d\.]+)\)/g, '-$1');
                    
                    if (!/^[\d\.\+\-\*\/\(\)\s]+$/.test(sanitized)) return { valid: false, msg: "Invalid characters" };
                    const res = eval(sanitized);
                    if (!isFinite(res) || isNaN(res)) return { valid: false, msg: "Math Error" };
                    return { valid: true, val: res };
                } catch (e) {
                    return { valid: false, msg: "Syntax Error" };
                }
            };

            const isCorrect = useMemo(() => {
                if (!value || !correctValue) return false;
                if (type === 'text') {
                    const cleanVal = value.toString().trim().toLowerCase().replace(/[.,]$/, ""); 
                    const cleanKey = correctValue.toString().trim().toLowerCase().replace(/[.,]$/, "");
                    return cleanVal === cleanKey || cleanVal.includes(cleanKey) || cleanKey.includes(cleanVal);
                }
                const { valid, val } = evaluateMath(value);
                if (!valid) return false;
                
                const target = parseFloat(correctValue.replace(/,/g, ''));
                let inputNum = parseFloat(val);
                const tolerance = Math.max(Math.abs(target * 0.02), 0.05); 

                if (type === 'percent') {
                    if (Math.abs(inputNum - target) <= tolerance) return true;
                    if (Math.abs((inputNum * 100) - target) <= tolerance) return true;
                    return false;
                } else {
                    return Math.abs(inputNum - target) <= tolerance;
                }
            }, [value, correctValue, type]);

            const handleBlur = (e) => {
                const { valid, val } = evaluateMath(value);
                setLocalError(null);
                
                if (valid && value !== "") {
                     const numVal = Number(val);
                     let displayVal = numVal;
                     if (type === 'percent') {
                        if (Math.abs(numVal) < 1 && parseFloat(correctValue) > 1) { displayVal = (numVal * 100).toFixed(2); } 
                        else { displayVal = numVal.toFixed(2); }
                     } else {
                        displayVal = Number.isInteger(numVal) ? numVal.toString() : numVal.toFixed(3);
                     }
                     onChange(id, displayVal.toString()); 
                } else if (!valid && type !== 'text') {
                     // Only show invalid math error if we were expecting a number
                     setLocalError("Invalid Math");
                }
            };

            const isActive = activeInput === id;

            return (
                <div className="mb-4 w-full">
                    <label className="block text-xs font-bold text-slate-500 mb-1 uppercase tracking-wider">{label}</label>
                    <div className="flex gap-2 items-start">
                        <div className="relative flex-grow">
                            {type === 'text' && correctValue.length > 50 ? (
                                <textarea 
                                    id={id}
                                    value={value || ""}
                                    onChange={(e) => { setLocalError(null); onChange(id, e.target.value); }}
                                    onFocus={() => setActiveInput(id)}
                                    className={`w-full p-3 border rounded-lg font-sans text-sm shadow-sm transition-all h-24 ${
                                        isCorrect ? "input-correct" : (value && !isActive && !isCorrect) ? "input-incorrect" : "input-neutral"
                                    }`}
                                    placeholder="Enter interpretation..."
                                />
                            ) : (
                                <input 
                                    type="text" 
                                    id={id}
                                    value={value || ""}
                                    onChange={(e) => { setLocalError(null); onChange(id, e.target.value); }}
                                    onFocus={() => setActiveInput(id)}
                                    onBlur={handleBlur}
                                    onKeyDown={(e) => e.key === 'Enter' && e.target.blur()}
                                    className={`w-full p-3 pr-10 border rounded-lg font-mono text-sm shadow-sm transition-all ${
                                        isCorrect ? "input-correct" : (value && !isActive && !isCorrect) ? "input-incorrect" : "input-neutral"
                                    }`}
                                    placeholder={type === 'text' ? (correctValue === "Negative" ? "Enter answer..." : "Type answer...") : "Calculate..."}
                                />
                            )}
                            <div className="absolute right-3 top-3 text-slate-400 pointer-events-none">
                                {isCorrect ? <span className="text-green-600"><Icon name="check-circle" size={18} /></span> : 
                                localError ? <span className="text-red-500 font-bold">!</span> :
                                type !== 'text' && <Icon name="calculator" size={16} />}
                            </div>
                        </div>
                        {hint && (
                            <div className="w-2/5 shrink-0 bg-blue-50 border border-blue-100 rounded p-2 flex flex-col justify-center min-h-[46px]">
                                <span className="text-[10px] text-blue-500 font-bold uppercase tracking-wider block mb-0.5">Formula</span>
                                <span className="text-[10px] sm:text-xs text-blue-800 font-medium leading-tight break-words">{hint}</span>
                            </div>
                        )}
                    </div>
                    {localError && <p className="text-xs text-red-500 mt-1">{localError}</p>}
                    {instructorMode && (
                        <div className="mt-1 bg-purple-100 border border-purple-200 text-purple-800 text-xs p-1 rounded font-mono animate-fade-in flex items-start gap-2">
                            <span className="mt-0.5"><Icon name="key" size={12} /></span> 
                            <span className="break-words w-full">Key: {correctValue}</span>
                        </div>
                    )}
                </div>
            );
        };

        const ReferenceTable = ({ title, headers, rows, onValueClick }) => {
            const [isOpen, setIsOpen] = useState(false);
            return (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-4">
                    <button onClick={() => setIsOpen(!isOpen)} className="w-full flex items-center justify-between p-3 bg-slate-50 border-b border-slate-100 hover:bg-slate-100 transition">
                        <h4 className="font-bold text-slate-700 text-sm flex items-center gap-2">
                            <Icon name="table" size={16} /> {title}
                        </h4>
                        <Icon name={isOpen ? "chevron-up" : "chevron-down"} size={16} />
                    </button>
                    {isOpen && (
                        <div className="overflow-x-auto max-h-64">
                            <table className="w-full text-xs text-left">
                                <thead className="bg-slate-50 text-slate-500 uppercase tracking-wider sticky top-0">
                                    <tr>{headers.map((h, i) => <th key={i} className={`p-2 border-b font-medium ${i > 0 ? "text-right" : ""}`}>{h}</th>)}</tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {rows.map((row, rI) => (
                                        <tr key={rI} className="hover:bg-blue-50 transition-colors group">
                                            <td className="p-2 font-medium text-slate-700">{row[0]}</td>
                                            {row.slice(1).map((cell, cI) => (
                                                <td key={cI} onClick={() => onValueClick(cell)} className="p-2 text-right font-mono text-slate-600 cursor-pointer hover:text-blue-700 hover:font-bold decoration-dotted" title="Insert">{cell}</td>
                                            ))}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('amazon'); // 'amazon' or 'spirit'
            const [inputs, setInputs] = useState({});
            const [activeInput, setActiveInput] = useState(null);
            
            // Layout State
            const [sidebarWidth, setSidebarWidth] = useState(350);
            const [isResizing, setIsResizing] = useState(false);
            const sidebarRef = useRef(null);

            // Instructor State
            const [instructorMode, setInstructorMode] = useState(false);
            const [showLogin, setShowLogin] = useState(false);
            const [password, setPassword] = useState("");
            const [clearModalOpen, setClearModalOpen] = useState(false);
            
            // Hash Tool
            const [hashInput, setHashInput] = useState("");
            const [verifiedResult, setVerifiedResult] = useState(null);
            const [studentName, setStudentName] = useState("");
            const [showDownload, setShowDownload] = useState(false);

            const activeData = activeTab === 'amazon' ? AMAZON_DATA : SPIRIT_DATA;
            const activeQuestions = activeTab === 'amazon' ? AMAZON_QUESTIONS : SPIRIT_QUESTIONS;
            const activeKey = activeTab === 'amazon' ? AMAZON_ANSWER_KEY : SPIRIT_ANSWER_KEY;

            // --- LAYOUT HANDLERS ---
            const startResizing = useCallback((mouseDownEvent) => {
                mouseDownEvent.preventDefault();
                setIsResizing(true);
            }, []);

            const stopResizing = useCallback(() => {
                setIsResizing(false);
            }, []);

            const resize = useCallback((mouseMoveEvent) => {
                if (isResizing) {
                    const newWidth = mouseMoveEvent.clientX;
                    if (newWidth > 250 && newWidth < 600) {
                        setSidebarWidth(newWidth);
                    }
                }
            }, [isResizing]);

            useEffect(() => {
                window.addEventListener("mousemove", resize);
                window.addEventListener("mouseup", stopResizing);
                return () => {
                    window.removeEventListener("mousemove", resize);
                    window.removeEventListener("mouseup", stopResizing);
                };
            }, [resize, stopResizing]);

            const handleInputChange = (id, val) => setInputs(prev => ({ ...prev, [id]: val }));

            const handleValueClick = (val) => {
                if (!activeInput) return;
                const cleanVal = val.replace(/,/g, '').replace(/[()]/g, (m) => m === '(' ? '-' : '');
                setInputs(prev => {
                    const cur = prev[activeInput] || "";
                    const isOperator = /[+\-*/(]$/.test(cur.trim());
                    const newVal = (cur === "" || isOperator) ? cur + cleanVal : cleanVal;
                    return { ...prev, [activeInput]: newVal };
                });
                setTimeout(() => document.getElementById(activeInput)?.focus(), 50);
            };

            const unlockInstructor = () => {
                // Security: Password Hashing (Base64)
                // "teacher" -> dGVhY2hlcg==
                if (btoa(password) === 'dGVhY2hlcg==') {
                    setInstructorMode(true);
                    setShowLogin(false);
                    setPassword("");
                } else {
                    alert("Incorrect Password");
                }
            };

            const handleAutoFill = () => {
                setInputs(prev => ({ ...prev, ...activeKey }));
            };

            const handleClearConfirm = () => {
                setInputs({});
                setClearModalOpen(false);
                setInstructorMode(false); 
            };

            const verifyHash = () => {
                try {
                    const decoded = atob(hashInput);
                    const data = JSON.parse(decoded);
                    setVerifiedResult(data);
                } catch (e) {
                    setVerifiedResult({ error: "Invalid Hash" });
                }
            };

            const handleDownload = () => {
                const timestamp = new Date().toLocaleString();
                let correctCount = 0;
                let totalCount = 0;
                
                Object.keys(activeKey).forEach(key => {
                    totalCount++;
                    const userVal = (inputs[key] || "").toString().trim().toLowerCase();
                    const keyVal = (activeKey[key] || "").toString().trim().toLowerCase();
                    let isCorrect = false;
                    
                    if(!isNaN(parseFloat(keyVal)) && !isNaN(parseFloat(userVal.replace(/,/g,'')))) {
                         const u = parseFloat(userVal.replace(/,/g,''));
                         const k = parseFloat(keyVal);
                         if (Math.abs(u-k) < Math.max(k*0.02, 0.05)) isCorrect = true;
                    } else {
                        if (userVal === keyVal || userVal.includes(keyVal)) isCorrect = true;
                    }
                    if (isCorrect) correctCount++;
                });
                
                // Security: Hashed verification object
                const verificationHash = btoa(JSON.stringify({ name: studentName, score: `${correctCount}/${totalCount}`, date: new Date().toISOString(), module: activeTab }));

                const content = `
FINANCIAL SIMULATION REPORT: ${activeTab.toUpperCase()}
-------------------------------------
Student: ${studentName}
Date: ${timestamp}
Score: ${correctCount} / ${totalCount}
Verification Hash: ${verificationHash}

ANSWERS SUBMITTED (${activeTab}):
-------------------------------------
${Object.keys(activeKey).map(k => `${k}: ${inputs[k] || "[Empty]"}`).join('\n')}
                `.trim();

                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${studentName.replace(/\s+/g, '_')}_${activeTab}_Submission.txt`;
                a.click();
                setShowDownload(false);
            };

            return (
                <div className="flex h-screen bg-slate-100 overflow-hidden font-sans">
                    
                    {/* LEFT SIDEBAR: REFERENCE (RESIZABLE) */}
                    <div 
                        ref={sidebarRef}
                        className="bg-slate-50 border-r border-slate-200 overflow-y-auto custom-scrollbar flex flex-col relative z-0 shrink-0"
                        style={{ width: sidebarWidth }}
                    >
                        <div className="sticky top-0 bg-white p-4 border-b border-slate-200 shadow-sm z-10">
                            <div className="flex items-center gap-2 text-blue-800 font-bold text-lg mb-1">
                                <Icon name="library" /> Reference Data
                            </div>
                            <p className="text-xs text-slate-500 font-bold uppercase tracking-wider">{activeData.metadata.name}</p>
                            <p className="text-xs text-blue-600 mt-1 flex items-center gap-1">
                                <Icon name="mouse-pointer-click" size={12} /> Click values to insert
                            </p>
                        </div>
                        <div className="p-4 space-y-2">
                            {activeData.tables.map((tbl, i) => (
                                <ReferenceTable 
                                    key={i}
                                    title={tbl.title} 
                                    headers={tbl.headers} 
                                    rows={tbl.rows} 
                                    onValueClick={handleValueClick} 
                                />
                            ))}
                        </div>
                    </div>

                    {/* DRAGGABLE HANDLE */}
                    <div 
                        className={`resize-handle hover:bg-blue-400 w-1 cursor-col-resize z-20 flex items-center justify-center relative ${isResizing ? 'bg-blue-600' : 'bg-slate-200'}`}
                        onMouseDown={startResizing}
                    >
                        <div className="absolute top-1/2 -translate-y-1/2 bg-white border border-slate-300 rounded shadow-sm p-1 cursor-col-resize">
                            <Icon name="grip-vertical" size={12} className="text-slate-400" />
                        </div>
                    </div>

                    {/* MAIN CONTENT */}
                    <div className="flex-1 flex flex-col h-screen overflow-hidden relative min-w-[400px]">
                        
                        {/* TOP NAV TABS */}
                        <div className="bg-slate-800 text-white flex shrink-0">
                            <button 
                                onClick={() => setActiveTab('amazon')}
                                className={`flex-1 py-3 text-sm font-bold flex items-center justify-center gap-2 transition-colors ${activeTab === 'amazon' ? 'bg-blue-600 text-white' : 'hover:bg-slate-700 text-slate-400'}`}
                            >
                                <Icon name="shopping-cart" size={16} /> Amazon (E4.24)
                            </button>
                            <button 
                                onClick={() => setActiveTab('spirit')}
                                className={`flex-1 py-3 text-sm font-bold flex items-center justify-center gap-2 transition-colors ${activeTab === 'spirit' ? 'bg-blue-600 text-white' : 'hover:bg-slate-700 text-slate-400'}`}
                            >
                                <Icon name="plane" size={16} /> Spirit AeroSystems (P4-34)
                            </button>
                        </div>

                        {/* INSTRUCTOR TOOLBAR (STICKY) */}
                        {instructorMode && (
                            <div className="bg-purple-700 text-white p-2 shadow-md flex items-center justify-between z-20 animate-fade-in shrink-0">
                                <div className="flex items-center gap-3 px-4">
                                    <span className="bg-white/20 p-1.5 rounded"><Icon name="graduation-cap" /></span>
                                    <span className="font-bold tracking-wide">INSTRUCTOR MODE</span>
                                </div>
                                <div className="flex gap-2 px-4">
                                    <button onClick={handleAutoFill} className="flex items-center gap-2 px-3 py-1 bg-green-500 hover:bg-green-600 rounded text-sm font-bold transition">
                                        <Icon name="wand-2" size={14} /> Auto-Fill Tab
                                    </button>
                                    <button onClick={() => setClearModalOpen(true)} className="flex items-center gap-2 px-3 py-1 bg-red-500 hover:bg-red-600 rounded text-sm font-bold transition">
                                        <Icon name="log-out" size={14} /> Clear & Exit
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* HEADER */}
                        <header className="bg-white border-b border-slate-200 p-6 flex justify-between items-center shrink-0">
                            <div>
                                <h1 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
                                    <Icon name="bar-chart-3" className="text-blue-600" /> {activeData.metadata.name}
                                </h1>
                                <p className="text-slate-500 text-sm mt-1">Financial Statement Analysis & Ratio Calculation</p>
                            </div>
                            <div className="flex gap-3">
                                <button onClick={() => setShowDownload(true)} className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-sm transition">
                                    <Icon name="save" size={18} /> Save Work
                                </button>
                                {!instructorMode && (
                                    <button onClick={() => setShowLogin(true)} className="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-medium transition border border-slate-300">
                                        <Icon name="lock" size={16} /> Instructor
                                    </button>
                                )}
                            </div>
                        </header>

                        {/* SCROLLABLE FORM AREA */}
                        <main className="flex-1 overflow-y-auto custom-scrollbar bg-slate-50/50 p-8 pb-20">
                            <div className="max-w-4xl mx-auto space-y-8">
                                {activeQuestions.map((q) => (
                                    <div key={q.id} className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 animate-fade-in">
                                        <h2 className="text-lg font-bold text-slate-800 mb-2 border-b pb-2 flex items-center gap-2">
                                            <span className="bg-blue-100 text-blue-700 w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold">{q.id.replace(/^q|sq/,'')}</span>
                                            {q.title}
                                        </h2>
                                        <p className="text-sm text-slate-500 mb-6 italic">{q.desc}</p>
                                        
                                        {q.sections && q.sections.map((sec, idx) => (
                                            <div key={idx} className="mb-6 last:mb-0 bg-slate-50 p-4 rounded-lg border border-slate-100">
                                                <h3 className="font-bold text-slate-700 mb-4 text-sm uppercase">{sec.subtitle}</h3>
                                                <div className={`grid gap-4 ${sec.fields.some(f => f.fullWidth) ? 'grid-cols-1' : 'grid-cols-1 md:grid-cols-2'}`}>
                                                    {sec.fields.map(f => (
                                                        <SmartInput 
                                                            key={f.id}
                                                            id={f.id}
                                                            label={f.label}
                                                            type={f.type}
                                                            hint={f.hint}
                                                            value={inputs[f.id]}
                                                            onChange={handleInputChange}
                                                            correctValue={activeKey[f.id]}
                                                            instructorMode={instructorMode}
                                                            activeInput={activeInput}
                                                            setActiveInput={setActiveInput}
                                                        />
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                ))}

                                {/* Instructor Only: Hash Verification Tool */}
                                {instructorMode && (
                                    <div className="bg-slate-800 rounded-xl shadow-lg border border-slate-700 p-6 text-slate-200 mt-12">
                                        <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                                            <Icon name="shield-check" className="text-green-400" /> Verification Tool
                                        </h3>
                                        <div className="flex gap-4 items-start">
                                            <div className="flex-1">
                                                <label className="text-xs font-bold text-slate-400 mb-1 block">PASTE STUDENT HASH</label>
                                                <textarea 
                                                    className="w-full bg-slate-900 border-slate-700 rounded p-2 text-xs font-mono text-green-400 focus:ring-1 focus:ring-green-500 outline-none"
                                                    rows="3"
                                                    placeholder="Paste base64 hash string here..."
                                                    value={hashInput}
                                                    onChange={(e) => setHashInput(e.target.value)}
                                                ></textarea>
                                            </div>
                                            <button 
                                                onClick={verifyHash}
                                                className="mt-6 px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded font-bold text-sm"
                                            >
                                                Verify
                                            </button>
                                        </div>
                                        {verifiedResult && (
                                            <div className="mt-4 p-4 bg-slate-900 rounded border border-slate-700">
                                                {verifiedResult.error ? (
                                                    <p className="text-red-400 font-bold flex items-center gap-2"><Icon name="x-circle" /> {verifiedResult.error}</p>
                                                ) : (
                                                    <div className="grid grid-cols-2 gap-4 text-sm">
                                                        <div><span className="text-slate-500">Student:</span> <span className="text-white font-bold">{verifiedResult.name}</span></div>
                                                        <div><span className="text-slate-500">Score:</span> <span className="text-green-400 font-bold">{verifiedResult.score}</span></div>
                                                        <div><span className="text-slate-500">Date:</span> <span className="text-slate-300">{new Date(verifiedResult.date).toLocaleString()}</span></div>
                                                        <div><span className="text-slate-500">Module:</span> <span className="text-blue-400 font-bold uppercase">{verifiedResult.module}</span></div>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </main>
                    </div>

                    {/* MODALS */}
                    
                    {/* Login Modal */}
                    {showLogin && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center animate-fade-in">
                            <div className="bg-white p-6 rounded-xl shadow-2xl w-80 transform transition-all">
                                <h3 className="font-bold text-lg mb-4 text-slate-800 flex items-center gap-2">
                                    <Icon name="lock" size={20} className="text-blue-600" /> Instructor Access
                                </h3>
                                <input 
                                    type="password" 
                                    className="w-full border p-3 rounded-lg mb-4 outline-none focus:border-blue-500" 
                                    placeholder="Enter password"
                                    value={password} 
                                    onChange={(e) => setPassword(e.target.value)}
                                    onKeyDown={(e) => e.key === 'Enter' && unlockInstructor()}
                                    autoFocus
                                />
                                <div className="flex justify-end gap-2">
                                    <button onClick={() => setShowLogin(false)} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg text-sm font-medium">Cancel</button>
                                    <button onClick={unlockInstructor} className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-bold">Unlock</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Download Modal */}
                    {showDownload && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center animate-fade-in">
                            <div className="bg-white p-8 rounded-xl shadow-2xl w-96">
                                <div className="text-center mb-6">
                                    <div className="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3 text-blue-600">
                                        <Icon name="download-cloud" size={24} />
                                    </div>
                                    <h3 className="text-xl font-bold text-slate-800">Submit Assignment</h3>
                                    <p className="text-slate-500 text-sm mt-1">Enter your name to generate your submission file.</p>
                                </div>
                                <input 
                                    type="text" 
                                    value={studentName} 
                                    onChange={(e) => setStudentName(e.target.value)} 
                                    placeholder="Your Full Name" 
                                    className="w-full p-3 border border-slate-300 rounded-lg mb-4 text-center focus:border-blue-500 outline-none font-bold text-slate-700"
                                    autoFocus 
                                />
                                <div className="flex flex-col gap-2">
                                    <button 
                                        onClick={() => studentName.trim() ? handleDownload() : alert("Name required")} 
                                        className="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition flex items-center justify-center gap-2"
                                    >
                                        Download Submission
                                    </button>
                                    <button onClick={() => setShowDownload(false)} className="w-full py-2 text-slate-500 hover:bg-slate-50 rounded-lg text-sm">Cancel</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Clear Confirmation Modal */}
                    <ConfirmationModal 
                        isOpen={clearModalOpen}
                        title="Clear All & Exit?"
                        message="This will remove all student answers and lock Instructor Mode. This action cannot be undone."
                        onConfirm={handleClearConfirm}
                        onCancel={() => setClearModalOpen(false)}
                    />

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
