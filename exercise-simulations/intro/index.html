<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Analyst & Fraud Simulator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        :root {
            --blue-income: #2980b9;
            --green-cash: #27ae60;
            --red-alert: #c0392b;
            --dark-bg: #2c3e50;
            --light-bg: #ecf0f1;
            --gold-highlight: #f1c40f;
            --purple-analyst: #8e44ad;
            --orange-sec: #e67e22;
            --teal-trap: #16a085;
            --navy-chain: #34495e;
            --indigo-market: #3f51b5;
            --pink-users: #d63384;
            --audit-blue: #2196f3;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 20px; }
        h1 { color: var(--dark-bg); margin: 0; font-size: 2.2em; }
        .subtitle { color: #7f8c8d; font-size: 1.1em; margin-top: 5px; }

        /* Main Navigation */
        .main-nav { display: flex; justify-content: center; gap: 8px; margin-bottom: 30px; flex-wrap: wrap; }
        .nav-btn {
            padding: 8px 16px; border: 2px solid transparent; background: #e0e0e0; color: #555; 
            font-size: 0.85em; font-weight: bold; border-radius: 8px; cursor: pointer; transition: all 0.3s;
        }
        .nav-btn:hover { background: #d0d0d0; }
        .nav-btn.active-nav { background: var(--dark-bg); color: white; border-color: var(--dark-bg); box-shadow: 0 4px 10px rgba(44, 62, 80, 0.3); }

        .view-section { display: none; animation: fadeIn 0.5s ease; }
        .view-section.active-view { display: block; }

        /* Shared Components */
        .chart-wrapper { position: relative; height: 350px; width: 100%; margin-bottom: 30px; }
        .controls { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; }
        
        /* Module A (User Landscape) */
        .users-desk { background: #fdfefe; padding: 20px; border-radius: 10px; border: 1px solid #eee; }
        .columns-container { display: flex; justify-content: space-between; gap: 20px; margin-bottom: 30px; }
        .col-group { flex: 1; background: #fafafa; padding: 15px; border-radius: 10px; border: 1px solid #eee; }
        .col-header { text-align: center; font-weight: bold; margin-bottom: 15px; color: var(--pink-users); border-bottom: 2px solid var(--pink-users); padding-bottom: 5px;}
        .user-item { background: white; border: 1px solid #ddd; padding: 12px; margin-bottom: 10px; border-radius: 5px; cursor: pointer; transition: all 0.2s; font-size: 0.9em; text-align: center; }
        .user-item:hover { background: #fce4ec; border-color: var(--pink-users); }
        .user-item.selected { background: var(--pink-users); color: white; border-color: var(--pink-users); }
        .user-item.correct { background: #27ae60; color: white; border-color: #27ae60; cursor: default; }
        
        .bonus-section { margin-top: 40px; border-top: 2px dashed #ccc; padding-top: 20px; }
        .bonus-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .bonus-interactive { background: #fff; border: 2px solid #eee; border-radius: 10px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .bonus-title { font-weight: bold; color: #e65100; margin-bottom: 10px; border-bottom: 2px solid #ffcc80; display: inline-block; padding-bottom: 3px;}
        .lemon-switch-container { display: flex; justify-content: center; margin: 15px 0; background: #eee; border-radius: 20px; padding: 5px; width: fit-content; margin-left: auto; margin-right: auto;}
        .lemon-btn { padding: 8px 15px; border-radius: 15px; border: none; background: transparent; cursor: pointer; font-weight: bold; color: #777; transition: all 0.3s; }
        .lemon-btn.active-lemon { background: #e65100; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .market-scene { display: flex; justify-content: space-around; align-items: flex-end; height: 120px; margin-top: 15px; background: #fff8e1; border-radius: 8px; padding: 10px; position: relative; overflow: hidden; }
        .company-icon { text-align: center; font-size: 2em; transition: all 0.5s; width: 60px; }
        .company-label { font-size: 0.3em; display: block; line-height: 1.2; font-weight: bold; color: #555; }
        .company-out { opacity: 0.2; transform: translateX(100px) scale(0.8); filter: grayscale(100%); }
        .price-tag { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 5px 10px; border-radius: 5px; font-weight: bold; font-size: 0.9em; transition: all 0.3s; }
        .esg-slider-box { margin: 15px 0; }
        .esg-visual { height: 100px; display: flex; align-items: center; justify-content: space-between; background: #e8f5e9; border-radius: 8px; padding: 0 20px; margin-top: 10px; border: 1px solid #c8e6c9;}
        .stock-ticker { font-family: monospace; font-size: 1.5em; font-weight: bold; color: #2e7d32; transition: color 0.3s; }
        .risk-badge { font-size: 0.8em; padding: 5px 10px; border-radius: 4px; font-weight: bold; color: white; transition: background 0.3s; }
        .explanation-box { background: #e8f8f5; border: 1px solid #b2dbd5; padding: 15px; border-radius: 5px; margin-top: 20px; font-size: 0.95em; color: #2c3e50; display:none; }
        .reveal-btn { background: var(--teal-trap); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; margin-top: 10px; display: block; margin-left: auto; margin-right: auto;}

        /* Module B (Earnings Game) */
        .earnings-panel { display: flex; flex-direction: column; align-items: center; text-align: center; }
        .earnings-btn-group { display: flex; gap: 20px; margin-bottom: 20px; }
        .earnings-btn { padding: 15px 30px; font-size: 1.2em; border: none; border-radius: 50px; cursor: pointer; color: white; font-weight: bold; transition: transform 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .earnings-btn:hover { transform: scale(1.05); }
        .btn-miss { background: #c0392b; }
        .btn-meet { background: #f39c12; }
        .btn-beat { background: #27ae60; }
        .market-reaction-box { padding: 20px; border-radius: 10px; background: #f8f9fa; border: 2px solid #eee; width: 80%; margin-top: 20px; min-height: 100px;}

        /* Module C (Fraud) */
        .case-selector { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; background: #eee; padding: 10px; border-radius: 50px; width: fit-content; margin-left: auto; margin-right: auto; }
        .case-btn { padding: 10px 25px; border: none; background: transparent; cursor: pointer; font-weight: bold; color: #7f8c8d; border-radius: 40px; transition: all 0.3s; }
        .case-btn.active-case { background: white; color: var(--dark-bg); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .scenario-box { background: #fff8e1; border-left: 5px solid #f1c40f; padding: 20px; margin-bottom: 30px; border-radius: 4px; }
        .btn-fraud-ctrl { padding: 15px 30px; font-size: 16px; font-weight: bold; border: none; border-radius: 50px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-income { background-color: var(--blue-income); color: white; }
        .btn-cash { background-color: var(--green-cash); color: white; opacity: 0.5; }
        .active-mode { opacity: 1 !important; ring: 3px solid white; }
        .analysis-panel { display: none; background: var(--dark-bg); color: white; padding: 25px; border-radius: 10px; margin-top: 20px; }
        .analysis-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 15px; }

        /* Module D (SEC) */
        .sec-board { background: #fdfefe; padding: 20px; border-radius: 10px; border: 1px solid #eee; }
        .card-bank { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; padding: 20px; background: #f4f6f7; border-radius: 8px; margin-bottom: 30px; min-height: 60px; }
        .term-card { background: white; border: 2px solid var(--orange-sec); color: var(--orange-sec); padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; transition: all 0.2s; user-select: none; }
        .term-card.selected { background: var(--orange-sec); color: white; }
        .term-card.matched { background: #27ae60; border-color: #27ae60; color: white; cursor: default; }
        .match-row { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }
        .drop-zone { height: 70px; border: 2px dashed #ccc; border-radius: 8px; background: #fafafa; display: flex; align-items: center; justify-content: center; color: #555; font-size: 0.95em; transition: background 0.3s; padding: 10px; text-align: center; }
        .drop-zone.active-zone { border-color: var(--orange-sec); background: #fef5e7; }
        .instructor-bar { margin-top: 40px; padding: 20px; background: #2c3e50; border-radius: 8px; color: white; display: flex; align-items: center; justify-content: space-between; }
        .pwd-input { padding: 8px 15px; border-radius: 4px; border: none; font-size: 1em; width: 120px; }
        .ctrl-btn { padding: 8px 20px; border-radius: 4px; border: none; font-weight: bold; cursor: pointer; margin-left: 10px; }
        .btn-unlock { background: var(--orange-sec); color: white; }
        .btn-clear { background: #e74c3c; color: white; }
        
        /* Audit & MCQ Styles */
        .audit-section { margin-top: 40px; padding: 20px; background: #e3f2fd; border-radius: 10px; border-left: 5px solid var(--audit-blue); }
        .audit-mcq-container { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 20px; }
        .audit-btn { padding: 15px; border: 2px solid #90caf9; background: white; border-radius: 8px; cursor: pointer; font-size: 1em; color: #1565c0; transition: all 0.2s; }
        .audit-btn:hover { background: #e3f2fd; }
        .audit-btn.selected-wrong { background: #ffebee; border-color: #ef5350; color: #c62828; }
        .audit-btn.selected-correct { background: #e8f5e9; border-color: #66bb6a; color: #2e7d32; }
        .audit-feedback-text { text-align: center; margin-top: 15px; font-weight: bold; height: 20px; }

        /* Module E (Equity) */
        .equity-stepper { display: flex; justify-content: space-between; margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .step-btn { background: none; border: none; font-weight: bold; color: #ccc; cursor: pointer; font-size: 1.1em; }
        .step-btn.active-step { color: var(--purple-analyst); border-bottom: 3px solid var(--purple-analyst); margin-bottom: -12px; }
        .equity-card { background: #fdfefe; border: 1px solid #eee; border-radius: 10px; padding: 30px; text-align: center; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .equity-btn { background: var(--purple-analyst); color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; margin-top: 15px; }
        .result-box { margin-top: 20px; padding: 15px; border-radius: 5px; font-weight: bold; display: none; }
        .result-correct { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .result-wrong { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .phase-content { display: none; }
        .phase-content.active-phase { display: block; animation: fadeIn 0.5s; }

        /* Module F (Mistakes) */
        .mistake-container { background: #fdfefe; padding: 30px; border-radius: 10px; border: 1px solid #eee; }
        .slider-group { margin: 20px 0; background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 5px solid var(--teal-trap); display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .slider-box label { font-size: 0.9em; font-weight: bold; display: block; margin-bottom: 5px; color: #555; }
        .slider-box input { width: 100%; }
        .val-display { color: var(--teal-trap); font-weight: bold; }
        .comparison-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .comp-card { background: white; padding: 20px; border-radius: 8px; border: 2px solid #eee; text-align: center; }
        .comp-card.highlight { border-color: var(--teal-trap); box-shadow: 0 4px 12px rgba(22, 160, 133, 0.2); }
        .metric-big { font-size: 1.8em; font-weight: bold; margin: 10px 0; }

        /* Module G (Chain) */
        .chain-container { background: white; padding: 20px; border-radius: 10px; border: 1px solid #eee; }
        .chain-selector { display: flex; justify-content: center; margin-bottom: 20px; gap: 10px; }
        .domino-area { display: flex; flex-direction: column; align-items: center; gap: 15px; margin-top: 30px; position: relative; min-height: 400px;}
        .domino-slot { 
            width: 400px; height: 60px; border: 2px dashed #bdc3c7; border-radius: 8px; 
            display: flex; align-items: center; justify-content: center; background: #f9f9f9;
            font-weight: bold; color: #95a5a6;
        }
        .domino-block {
            width: 400px; padding: 15px; background: var(--navy-chain); color: white; border-radius: 8px;
            font-weight: bold; cursor: grab; text-align: left; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            user-select: none; z-index: 10; display: flex;
        }
        .domino-label { 
            background: rgba(255,255,255,0.2); padding: 0 10px; border-radius: 4px; margin-right: 15px; 
            font-family: monospace; font-size: 1.1em;
        }
        .domino-block:active { cursor: grabbing; }
        .arrow-down { font-size: 24px; color: #bdc3c7; }
        .start-event { 
            background: #c0392b; color: white; padding: 15px 30px; border-radius: 50px; font-weight: bold; 
            margin-bottom: 20px; box-shadow: 0 4px 10px rgba(192, 57, 43, 0.3); text-align: center; width: 400px;
        }
        .success-msg { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: rgba(39, 174, 96, 0.95); color: white; padding: 30px; border-radius: 15px;
            font-size: 1.5em; font-weight: bold; display: none; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 100;
        }

        /* Module H (Market vs Book) */
        .valuation-desk { background: #fdfefe; padding: 20px; border-radius: 10px; border: 1px solid #eee; }
        .val-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 30px; align-items: start; }
        .val-controls { background: #f5f5f5; padding: 20px; border-radius: 10px; }
        .val-visual { 
            height: 400px; position: relative; border-bottom: 5px solid #333; /* The Floor */
            display: flex; align-items: flex-end; gap: 60px; padding-bottom: 0px; 
        }
        .bar-container { 
            width: 140px; background: transparent; position: relative; 
            display: flex; flex-direction: column; justify-content: flex-end;
        }
        .bar-book { 
            background: #7f8c8d; width: 100%; transition: height 0.5s; 
            color: white; text-align: center; font-weight: bold; display: flex; align-items: center; justify-content: center;
            border-top-left-radius: 5px; border-top-right-radius: 5px; border: 2px solid #555;
        }
        .bar-market { 
            background: var(--indigo-market); width: 100%; transition: height 0.5s; opacity: 0.95; 
            color: white; text-align: center; font-weight: bold; display: flex; align-items: start; justify-content: center; padding-top: 10px;
            border-top-left-radius: 5px; border-top-right-radius: 5px;
        }
        .val-slider-box { margin-bottom: 20px; }
        .val-slider-box label { font-weight: bold; display: block; margin-bottom: 5px; color: var(--indigo-market); }
        .pb-ratio-box { margin-top: 20px; background: var(--indigo-market); color: white; padding: 15px; border-radius: 8px; text-align: center; }
        .market-scenario-btns { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:20px; }
        .mkt-btn { flex:1; padding:8px; font-size:0.85em; background:#e0e0e0; border:none; border-radius:5px; cursor:pointer; min-width: 150px; }
        .mkt-btn:hover { background:#d0d0d0; }
        .mkt-btn.active-mkt { background:var(--indigo-market); color:white; }
        .market-definition {
            background: #fff3e0; border-left: 5px solid #ff9800; padding: 15px; margin-bottom: 20px; font-size: 0.95em; color: #e65100;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Financial Simulation Lab</h1>
        <div class="subtitle">Interactive Tools for Finance Majors</div>
    </header>

    <!-- TOP LEVEL NAVIGATION (The Hero's Journey Order) -->
    <nav class="main-nav">
        <button class="nav-btn active-nav" onclick="switchView('users')">A: User Landscape</button>
        <button class="nav-btn" onclick="switchView('earnings')">B: Earnings Game</button>
        <button class="nav-btn" onclick="switchView('fraud')">C: Fraud Detective</button>
        <button class="nav-btn" onclick="switchView('filings')">D: SEC & Audit</button>
        <button class="nav-btn" onclick="switchView('equity')">E: Equity Research</button>
        <button class="nav-btn" onclick="switchView('mistakes')">F: Rookie Mistakes</button>
        <button class="nav-btn" onclick="switchView('chain')">G: Chain Reactions</button>
        <button class="nav-btn" onclick="switchView('market')">H: Market vs Book</button>
    </nav>

    <!-- ================= MODULE A: USER LANDSCAPE (First View) ================= -->
    <div id="view-users" class="view-section active-view">
        <div class="users-desk">
            <h2>The Information Ecosystem: Who Needs What?</h2>
            <p style="margin-bottom:20px;">Connect the dots: Select a <strong>User</strong>, then their primary <strong>Need</strong>, then the <strong>Key Metric</strong> they use.</p>
            <div class="columns-container">
                <div class="col-group" id="col-users"><div class="col-header">1. The User</div></div>
                <div class="col-group" id="col-needs"><div class="col-header">2. The Question (Need)</div></div>
                <div class="col-group" id="col-tools"><div class="col-header">3. The Tool (Metric)</div></div>
            </div>
            <div id="user-feedback" style="text-align:center; font-weight:bold; height:30px; color:#d63384;"></div>
            <div class="bonus-section">
                <h3 style="color:#e65100;">üöÄ Bonus Level: Market Mechanics & Modern Risks</h3>
                <div class="bonus-grid">
                    <div class="bonus-interactive">
                        <div class="bonus-title">1. The Lemon Problem</div>
                        <p style="font-size:0.9em;">Without rules, "Lemons" (frauds) drive out good companies.</p>
                        <div class="lemon-switch-container"><button class="lemon-btn" id="btn-lemon-off" onclick="updateLemonMarket(false)">Wild West</button><button class="lemon-btn active-lemon" id="btn-lemon-on" onclick="updateLemonMarket(true)">GAAP Standards</button></div>
                        <div class="market-scene"><div class="price-tag" id="market-price-tag">Market Price: $100</div><div class="company-icon" id="good-co">üè¢<br><span class="company-label">Good Co.<br>(Value $100)</span></div><div class="company-icon" id="bad-co">üèöÔ∏è<br><span class="company-label">Bad Co.<br>(Value $10)</span></div></div>
                        <div id="lemon-result" style="margin-top:10px; font-weight:bold; color:#27ae60; font-size:0.9em;">Result: Efficient Market.</div>
                    </div>
                    <div class="bonus-interactive" style="border-color:#c8e6c9;">
                        <div class="bonus-title" style="color:#2e7d32; border-color:#a5d6a7;">2. ESG Valuation</div>
                        <button class="reveal-btn" style="background:#2e7d32; margin-bottom:10px;" onclick="toggleESGInfo()">‚ÑπÔ∏è Background: What is ESG?</button>
                        <div id="esg-info-box" class="explanation-box" style="border-color:#a5d6a7; background:#e8f5e9; color:#1b5e20;">
                            <p><strong>The Link:</strong> High ESG = Low Risk.</p>
                            <ol style="padding-left: 20px; font-size: 0.9em;"><li>Lower Risk = Lower Cost of Capital (r).</li><li>Value = Cash Flow / r. If r drops, Value rises.</li><li>Higher Price + Same Earnings = <strong>Higher P/E</strong>.</li></ol>
                        </div>
                        <div class="esg-slider-box"><label style="font-weight:bold; color:#2e7d32; display:flex; justify-content:space-between;"><span>ESG Rating:</span><span id="esg-score-display">50/100</span></label><input type="range" id="esg-slider" min="0" max="100" value="50" style="width:100%; accent-color:#2e7d32;" oninput="updateESG()"></div>
                        <div class="esg-visual"><div><div style="font-size:0.8em; color:#555;">EPS</div><div style="font-weight:bold;">$5.00</div></div><div style="font-size:1.5em; color:#ccc;">√ó</div><div style="text-align:center;"><div style="font-size:0.8em; color:#555;">P/E</div><div id="pe-display" style="font-weight:bold;">15x</div></div><div style="font-size:1.5em; color:#ccc;">=</div><div style="text-align:right;"><div class="stock-ticker" id="esg-stock-price">$75.00</div><div class="risk-badge" id="esg-badge" style="background:#7f8c8d;">Neutral Risk</div></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= MODULE B: THE EARNINGS GAME ================= -->
    <div id="view-earnings" class="view-section">
        <div class="earnings-panel">
            <h2>The Earnings Game: "Beat the Street"</h2>
            <p style="max-width:700px; margin-bottom:30px;">
                You are the CEO of Guidance Corp. Wall Street Consensus is <strong>$1.00 EPS</strong>.<br>
                Investors are watching. 1 cent makes a difference. Choose your reported Earnings:
            </p>
            <div class="earnings-btn-group">
                <button class="earnings-btn btn-miss" onclick="playEarningsGame('miss')">$0.99<br>(Miss)</button>
                <button class="earnings-btn btn-meet" onclick="playEarningsGame('meet')">$1.00<br>(Meet)</button>
                <button class="earnings-btn btn-beat" onclick="playEarningsGame('beat')">$1.01<br>(Beat)</button>
            </div>
            <div class="chart-wrapper"><canvas id="earningsChart"></canvas></div>
            <div id="earnings-feedback" class="market-reaction-box"><em>Select an option above to see the market reaction.</em></div>
        </div>
    </div>

    <!-- ================= MODULE C: FRAUD DETECTIVE ================= -->
    <div id="view-fraud" class="view-section">
        <div class="case-selector">
            <button class="case-btn active-case" onclick="switchFraudCase('grill')">Case 1: The Channel Stuffer</button>
            <button class="case-btn" onclick="switchFraudCase('enron')">Case 2: The Energy Giant</button>
        </div>
        <div id="scenario-content" class="scenario-box"></div>
        <div class="controls">
            <button class="btn-fraud-ctrl btn-income active-mode" id="btn-income" onclick="showFraudLayer('income')">1. View Net Income (The Lie)</button>
            <button class="btn-fraud-ctrl btn-cash" id="btn-cash" onclick="showFraudLayer('combined')">2. Overlay Cash Flow (The Truth)</button>
        </div>
        <div class="chart-wrapper"><canvas id="fraudChart"></canvas></div>
        <div id="analysis" class="analysis-panel">
            <h2 style="margin-top:0; text-align:center;">The "Aha!" Moment</h2>
            <div class="analysis-grid">
                <div class="analysis-col"><h3 style="color:#3498db; border-bottom:1px solid #555;">üìà The Blue Line (Accounting)</h3><div id="analysis-income-text"></div></div>
                <div class="analysis-col cash-col"><h3 style="color:#2ecc71; border-bottom:1px solid #555;">üìâ The Green Line (Economics)</h3><div id="analysis-cash-text"></div></div>
            </div>
        </div>
    </div>

    <!-- ================= MODULE D: SEC & AUDIT ================= -->
    <div id="view-filings" class="view-section">
        <div class="sec-board">
            <h2>The Filing Cabinet: SEC Data Scavenger Hunt</h2>
            <p><strong>Instructions:</strong> Drag the correct SEC Form (e.g., 10-K) to the box that describes its contents.</p>
            <div class="card-bank" id="card-bank"></div>
            <div id="match-container"></div>
            <div class="instructor-bar">
                <span><strong>üë®‚Äçüè´ Instructor Control:</strong></span>
                <div><input type="password" id="teacher-pwd" class="pwd-input" placeholder="Password"><button class="ctrl-btn btn-unlock" onclick="revealInstructorKey()">Reveal Key</button><button class="ctrl-btn btn-clear" onclick="resetSECGame()">Reset</button></div>
            </div>
            <div id="instructor-msg" style="color:#e74c3c; text-align:right; margin-top:5px; font-size:0.9em;"></div>

            <!-- NEW AUDIT REFLECTION SECTION (MCQ) -->
            <div class="audit-section">
                <h3 style="color:#1565c0; margin-top:0;">The Multi-Million Dollar Question: Who Watches the Watchmen?</h3>
                <p><strong>Reflective Question:</strong> Managers get paid bonuses based on profit. Managers also prepare the financial reports that calculate profit. <br><em>What is the fundamental flaw in this system?</em></p>
                
                <div style="display:flex; gap:20px; align-items:center; margin-top:20px;">
                    <div style="flex:1; text-align:center; background:white; padding:15px; border-radius:10px; border:2px solid #90caf9;">
                        <div style="font-size:3em;">üëî</div>
                        <strong style="color:#1565c0;">The Manager (Agent)</strong><br>
                        <em>"I prepared these financials. Trust me, we made a huge profit (and I deserve my bonus)."</em>
                    </div>
                    <div style="font-size:2em; font-weight:bold; color:#777;">vs</div>
                    <div style="flex:1; text-align:center; background:white; padding:15px; border-radius:10px; border:2px solid #a5d6a7;">
                        <div style="font-size:3em;">üïµÔ∏è</div>
                        <strong style="color:#2e7d32;">The Investor (Principal)</strong><br>
                        <em>"I'm investing my life savings. How do I know you didn't just make these numbers up?"</em>
                    </div>
                </div>

                <div style="margin-top:20px;">
                    <p style="text-align:center; font-weight:bold;">How do we solve this conflict?</p>
                    <div class="audit-mcq-container">
                        <button class="audit-btn" onclick="checkAuditAnswer('A')">A. Trust the Manager implicitly</button>
                        <button class="audit-btn" onclick="checkAuditAnswer('B')">B. Eliminate all manager bonuses</button>
                        <button class="audit-btn" onclick="checkAuditAnswer('C')">C. Hire an Independent Auditor</button>
                    </div>
                    <div id="audit-feedback" class="audit-feedback-text"></div>
                </div>

                <div id="audit-solution" style="display:none; margin-top:20px; position:relative;">
                    <button style="position:absolute; top:5px; right:5px; background:#ddd; border:none; padding:5px 10px; cursor:pointer; border-radius:5px;" onclick="hideAuditSolution()">Hide</button>
                    <div style="text-align:center; font-size:3em; margin: 10px 0; animation: fadeIn 0.5s;">üõ°Ô∏è ‚öñÔ∏è üîç</div>
                    <div style="background:white; padding:20px; border-radius:5px; border:2px solid var(--audit-blue); animation: fadeIn 1s;">
                        <h4 style="color:var(--audit-blue); margin-top:0;">The Answer: Independent Audit</h4>
                        <p>We hire a neutral third party (The Auditor) to verify the numbers match reality <strong>before</strong> the Investor sees them.</p>
                        <p><strong>The Impact:</strong> This bridges the "Trust Gap." Because investors trust the numbers are verified, they are willing to provide capital at a lower cost.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= MODULE E: EQUITY RESEARCH ================= -->
    <div id="view-equity" class="view-section">
        <div class="equity-stepper">
            <button class="step-btn active-step" onclick="switchEquityPhase(1)">Phase 1: The Pitch</button>
            <button class="step-btn" onclick="switchEquityPhase(2)">Phase 2: The Investigation</button>
            <button class="step-btn" onclick="switchEquityPhase(3)">Phase 3: The Decision</button>
        </div>
        <div id="phase-1" class="phase-content active-phase">
            <div class="equity-card">
                <h2>Strategy on the Balance Sheet</h2>
                <p>Identify the <strong>Luxury Jeweler</strong> vs. <strong>Discount Grocer</strong>.</p>
                <div class="chart-wrapper" style="height: 300px;"><canvas id="balanceSheetChart"></canvas></div>
                <div style="margin-top: 20px;">
                    <p>Which is the <strong>Luxury Jeweler</strong>?</p>
                    <button class="equity-btn" onclick="checkAnswer(1, 'A')">Company A</button>
                    <button class="equity-btn" onclick="checkAnswer(1, 'B')">Company B</button>
                </div>
                <div id="p1-result" class="result-box"></div>
            </div>
        </div>
        <div id="phase-2" class="phase-content">
            <div class="equity-card">
                <h2>The Detective: Hunting Hidden Value</h2>
                <p><strong>The Question:</strong> Consolidated Net Income is $100M. NCI is $35M. What income do you use for valuation?</p>
                <div style="background:#eee; padding:15px; margin:20px 0; font-family:monospace; text-align:left; display:inline-block;">
                    Consolidated Net Income: .................................. $100 M<br>
                    Less: Net Income Attributable to Noncontrolling Interest .. $(35) M<br>
                    <strong>Net Income to Shareholders: ............................... ???</strong>
                </div>
                <br>
                <button class="equity-btn" onclick="checkAnswer(2, '100')">Use $100 Million</button>
                <button class="equity-btn" onclick="checkAnswer(2, '65')">Use $65 Million</button>
                <div id="p2-result" class="result-box"></div>
            </div>
        </div>
        <div id="phase-3" class="phase-content">
            <div class="equity-card">
                <h2>Phase 3: The Recommendation</h2>
                <div style="text-align:left; background:#fff; padding:20px; border-left:5px solid var(--purple-analyst); border-radius:5px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                    <h3>üìù Final Analyst Checklist</h3>
                    <div style="margin-bottom:15px;">
                        <div style="font-weight:bold; color:#555;">Step 1: Strategic Alignment</div>
                        <div><em>"Does the Balance Sheet match the Strategy?"</em></div>
                        <div style="color:#27ae60; font-weight:bold;">‚úÖ YES (Passed in Phase 1)</div>
                        <div style="font-size:0.9em; color:#666; margin-top:5px; background:#f0f0f0; padding:8px; border-radius:4px;"><strong>Note:</strong> Recall Phase 1. If a Jeweler lacked Inventory, the numbers would be lying. Here, they match.</div>
                    </div>
                    <div style="margin-bottom:15px;">
                        <div style="font-weight:bold; color:#555;">Step 2: Earnings Quality</div>
                        <div><em>"Are the Earnings Real (Cash-backed)?"</em></div>
                        <div style="color:#27ae60; font-weight:bold;">‚úÖ YES (Passed in Phase 2)</div>
                    </div>
                    <div style="margin-bottom:15px;">
                        <div style="font-weight:bold; color:#555;">Step 3: Valuation Gap</div>
                        <div><em>"Does the Stock Price reflect the True Value?"</em></div>
                        <div style="color:#c0392b; font-weight:bold;">‚ùå NO (Opportunity Found!)</div>
                        <ul style="margin:5px 0; padding-left:20px; font-size:0.95em;"><li><strong>Market Price:</strong> $50.00</li><li><strong>Your Value:</strong> $72.00</li></ul>
                    </div>
                    <hr>
                    <div style="text-align:center;"><div style="font-size:1.5em; font-weight:bold; color:#2c3e50;">FINAL DECISION: <span style="color:#27ae60; background:#e8f8f5; padding:5px 15px; border-radius:20px; border:2px solid #27ae60;">BUY</span></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= MODULE F: ROOKIE MISTAKES ================= -->
    <div id="view-mistakes" class="view-section">
        <div class="mistake-container">
            <h2>Concept 1: The Growth Trap (Cash Burn)</h2>
            <p>High growth can bankrupt a profitable company if collection is slow.</p>
            <button class="reveal-btn" onclick="toggleExplanation()">üí° Why do I run out of cash?</button>
            <div id="growth-explanation" class="explanation-box"><p>Because "On Time" means "Later." You pay for inventory today, but collect cash in 60 days. Growth widens this gap.</p></div>
            <div class="slider-group">
                <div class="slider-box"><label>1. Sales Growth: <span id="growth-val" class="val-display">10%</span></label><input type="range" id="growth-slider" min="5" max="80" value="10" step="5" oninput="updateGrowthSimulation()"></div>
                <div class="slider-box"><label>2. Collection Time (Days): <span id="dso-val" class="val-display">60</span></label><input type="range" id="dso-slider" min="0" max="120" value="60" step="15" oninput="updateGrowthSimulation()"></div>
                <div class="slider-box"><label>3. Inventory Prep (Days): <span id="inv-val" class="val-display">30</span></label><input type="range" id="inv-slider" min="0" max="120" value="30" step="15" oninput="updateGrowthSimulation()"></div>
            </div>
            <div class="chart-wrapper" style="height: 350px;"><canvas id="growthChart"></canvas></div>
            <hr style="margin: 40px 0; border:0; border-top:2px solid #eee;">
            <h2>Concept 2: The EBITDA Illusion</h2>
            <div class="comparison-grid">
                <div class="comp-card"><h3>üèãÔ∏è Gym Chain</h3><div class="metric-big">$10M</div><div>EBITDA</div><div style="color:#c0392b; font-weight:bold; margin-top:10px;">-$9.5M CapEx</div><div class="metric-big" style="color:#c0392b;">$0.5M</div><div>Free Cash Flow</div></div>
                <div class="comp-card highlight"><h3>üíª SaaS Company</h3><div class="metric-big">$10M</div><div>EBITDA</div><div style="color:#27ae60; font-weight:bold; margin-top:10px;">-$0.5M CapEx</div><div class="metric-big" style="color:#27ae60;">$9.5M</div><div>Free Cash Flow</div></div>
            </div>
        </div>
    </div>

    <!-- ================= MODULE G: CHAIN REACTIONS ================= -->
    <div id="view-chain" class="view-section">
        <div class="chain-container">
            <h2>Financial Dominoes</h2>
            <p>Drag the blocks (A-E) into the correct chronological order.</p>
            <div class="chain-selector">
                <button class="nav-btn" onclick="initChainGame('debt')">Scenario 1: Debt</button>
                <button class="nav-btn" onclick="initChainGame('inventory')">Scenario 2: Inventory</button>
                <button class="nav-btn" onclick="initChainGame('sales')">Scenario 3: Sales</button>
            </div>
            <div class="bank-area" id="domino-bank"></div>
            <div class="domino-area" id="domino-board">
                <div id="start-event" class="start-event">Trigger</div>
                <div class="arrow-down">‚Üì</div><div class="domino-slot" data-order="0"></div>
                <div class="arrow-down">‚Üì</div><div class="domino-slot" data-order="1"></div>
                <div class="arrow-down">‚Üì</div><div class="domino-slot" data-order="2"></div>
                <div class="arrow-down">‚Üì</div><div class="domino-slot" data-order="3"></div>
                <div class="arrow-down">‚Üì</div><div class="domino-slot" data-order="4"></div>
                <div id="success-msg" class="success-msg">üéâ CHAIN COMPLETE!</div>
            </div>
            <div class="instructor-bar">
                <span><strong>üë®‚Äçüè´ Instructor:</strong></span>
                <div><input type="password" id="chain-pwd" class="pwd-input" placeholder="Password"><button class="ctrl-btn btn-unlock" onclick="revealChainKey()">Auto-Solve</button><button class="ctrl-btn btn-clear" onclick="initChainGame(currentChainKey)">Reset</button></div>
            </div>
            <div id="chain-msg" style="color:#e74c3c; text-align:right; margin-top:5px; font-size:0.9em;"></div>
        </div>
    </div>

    <!-- ================= MODULE H: MARKET VS BOOK ================= -->
    <div id="view-market" class="view-section">
        <div class="valuation-desk">
            <h2>The Trillion Dollar Gap</h2>
            <div class="market-definition">
                <strong>üí° Definition:</strong> <em>Market Equity</em> (or Market Cap) = <strong>Stock Price √ó Shares Outstanding</strong>. <br>It represents what investors <em>believe</em> the company is worth today, which often differs from Book Value (Cost).
            </div>
            <div class="market-scenario-btns">
                <button class="mkt-btn active-mkt" onclick="loadMarketScenario('custom')">Custom Sandbox</button>
                <button class="mkt-btn" onclick="loadMarketScenario('manufacturer')">Rust Belt (e.g., U.S. Steel)</button>
                <button class="mkt-btn" onclick="loadMarketScenario('tech')">AI Startup (e.g., OpenAI)</button>
                <button class="mkt-btn" onclick="loadMarketScenario('coke')">Consumer (e.g., Coca-Cola)</button>
            </div>
            <div class="val-grid">
                <div class="val-controls">
                    <h3 style="color:#7f8c8d;">Step 1: The Foundation</h3>
                    <div style="background:#eee; padding:15px; border-radius:5px; margin-bottom:20px;"><strong>Book Equity:</strong> $100 M</div>
                    <h3 style="color:var(--indigo-market);">Step 2: Intangibles</h3>
                    <div class="val-slider-box"><label>Brand Value (Loyalty):</label><input type="range" id="brand-slider" min="0" max="600" value="50" oninput="updateValuation()"></div>
                    <div class="val-slider-box"><label>Growth Potential (Future Cash):</label><input type="range" id="growth-cap-slider" min="-200" max="800" value="100" oninput="updateValuation()"></div>
                    <div class="val-slider-box"><label>Market Sentiment (The Hype):</label><input type="range" id="sentiment-slider" min="-200" max="400" value="0" oninput="updateValuation()"></div>
                    <div class="pb-ratio-box"><div style="font-size:0.9em;">P/B Ratio</div><div id="pb-ratio-display" style="font-size:2em; font-weight:bold;">1.0x</div></div>
                </div>
                <div class="val-visual">
                    <div class="bar-container">
                        <div id="book-bar-visual" class="bar-book">$100M<br>Book</div>
                        <div style="margin-top:10px; font-weight:bold; text-align:center;">Accountant's View</div>
                    </div>
                    
                    <div style="font-size:2em; color:#ccc; align-self:center; margin-bottom:50px;">VS</div>
                    
                    <div class="bar-container">
                        <div id="market-bar" class="bar-market">Market</div>
                        <div style="margin-top:10px; font-weight:bold; color:var(--indigo-market); text-align:center;">Investor's View</div>
                        <div id="market-val-text" style="font-size:1.2em; font-weight:bold; margin-top:5px; text-align:center;">$250M</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    Chart.register(window['chartjs-plugin-annotation']);

    // --- GLOBAL STATE ---
    let currentView = 'users'; // Changed default to Users
    let fraudChartInstance = null;
    let balanceSheetChartInstance = null;
    let alphaChartInstance = null;
    let growthChartInstance = null;
    let earningsChartInstance = null;
    let currentFraudCase = 'grill';
    let currentChainKey = 'debt';
    
    // ================= MAIN NAVIGATION =================
    function switchView(view) {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active-nav'));
        event.target.classList.add('active-nav');
        document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active-view'));
        document.getElementById(`view-${view}`).classList.add('active-view');

        if (view === 'earnings') { if(!earningsChartInstance) initEarningsGame(); }
        if (view === 'users') { initUserGame(); }
        if (view === 'fraud') { if(!fraudChartInstance) initFraudChart(); }
        if (view === 'equity') { 
            const ctx = document.getElementById('balanceSheetChart').getContext('2d');
            if (balanceSheetChartInstance) { balanceSheetChartInstance.destroy(); }
            balanceSheetChartInstance = new Chart(ctx, { type: 'bar', data: { labels: ['A','B'], datasets: [{label:'Inventory',data:[65,20],backgroundColor:'#e67e22'},{label:'PP&E',data:[10,60],backgroundColor:'#34495e'},{label:'Cash',data:[25,20],backgroundColor:'#95a5a6'}] }, options: { scales: {x:{stacked:true},y:{stacked:true,max:100}} } }); 
        }
        if (view === 'filings') { if (document.getElementById('card-bank').children.length === 0) initSECGame(); }
        if (view === 'mistakes') { if (!growthChartInstance) initGrowthChart(); }
        if (view === 'chain') { initChainGame('debt'); } 
        if (view === 'market') { loadMarketScenario('custom'); }
    }

    // ================= MODULE A: USER GAME (Moved from B) =================
    let userSelection = { user: null, need: null, tool: null };
    const userGameData = [ { id: 'equity', user: "Equity Investor", need: "Is the stock undervalued?", tool: "P/E Ratio, EPS" }, { id: 'creditor', user: "Creditor (Banker)", need: "Can they pay back debt?", tool: "Interest Coverage" }, { id: 'manager', user: "Manager (CEO)", need: "Are we meeting targets?", tool: "Variance Analysis" }, { id: 'employee', user: "Employee", need: "Is my job safe?", tool: "Revenue Stability" }, { id: 'regulator', user: "Regulator (SEC)", need: "Are they following rules?", tool: "Compliance/10-K" } ];
    function initUserGame() {
        const colUsers = document.getElementById('col-users'); if(colUsers.children.length > 1) return; 
        renderUserCol('col-users', userGameData, 'user');
        renderUserCol('col-needs', [...userGameData].sort(()=>Math.random()-0.5), 'need');
        renderUserCol('col-tools', [...userGameData].sort(()=>Math.random()-0.5), 'tool');
        updateLemonMarket(true); updateESG();
    }
    function renderUserCol(id, data, type) { const c = document.getElementById(id); const h = c.querySelector('.col-header'); c.innerHTML=''; c.appendChild(h); data.forEach(item => { let d = document.createElement('div'); d.className='user-item'; d.innerText=item[type]; d.dataset.id=item.id; d.onclick=()=>handleUserClick(d, item.id, type); c.appendChild(d); }); }
    function handleUserClick(el, id, type) { if(el.classList.contains('correct')) return; el.parentElement.querySelectorAll('.user-item').forEach(e=>e.classList.remove('selected')); el.classList.add('selected'); userSelection[type] = {id, el}; if(userSelection.user && userSelection.need && userSelection.tool) checkUserMatch(); }
    function checkUserMatch() { const s = userSelection; const f = document.getElementById('user-feedback'); if(s.user.id===s.need.id && s.need.id===s.tool.id) { f.innerText="‚úÖ Correct!"; f.style.color="#27ae60"; [s.user.el, s.need.el, s.tool.el].forEach(e=>{e.classList.remove('selected'); e.classList.add('correct');}); userSelection={user:null,need:null,tool:null}; } else { f.innerText="‚ùå Try Again"; f.style.color="#c0392b"; [s.user.el, s.need.el, s.tool.el].forEach(e=>{e.style.background='#fadbd8'; setTimeout(()=>e.style.background='',500); e.classList.remove('selected');}); userSelection={user:null,need:null,tool:null}; } }
    
    function updateLemonMarket(reg) {
        document.getElementById('btn-lemon-off').className = reg ? 'lemon-btn' : 'lemon-btn active-lemon';
        document.getElementById('btn-lemon-on').className = reg ? 'lemon-btn active-lemon' : 'lemon-btn';
        document.getElementById('good-co').className = reg ? 'company-icon' : 'company-icon company-out';
        document.getElementById('market-price-tag').innerText = reg ? "Price: $100" : "Price: $55";
        document.getElementById('lemon-result').innerText = reg ? "Efficient Market." : "Market Collapse (Lemons Only).";
    }
    function updateESG() {
        const s = document.getElementById('esg-slider').value;
        document.getElementById('esg-score-display').innerText = s+"/100";
        let pe = 15; if(s<40) pe=10+(s/8); else if(s>60) pe=15+((s-60)/4);
        document.getElementById('pe-display').innerText = pe.toFixed(1)+"x";
        document.getElementById('esg-stock-price').innerText = "$"+(5*pe).toFixed(2);
    }
    function toggleESGInfo() { const b = document.getElementById('esg-info-box'); b.style.display = b.style.display==='block'?'none':'block'; }

    // ================= MODULE B: EARNINGS GAME (Moved from A) =================
    function initEarningsGame() {
        const ctx = document.getElementById('earningsChart').getContext('2d');
        earningsChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['10:00 AM', '12:00 PM', '3:59 PM', '4:00 PM (Earnings)', '4:01 PM'],
                datasets: [{ label: 'Stock Price ($)', data: [50, 50.2, 50.1, 50.0, null], borderColor: '#34495e', borderWidth: 3, tension: 0.1 }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 40, max: 60 } } }
        });
    }
    function playEarningsGame(result) {
        const feedback = document.getElementById('earnings-feedback');
        let newData = [50, 50.2, 50.1, 50.0]; let color = '#34495e';
        if (result === 'miss') { newData.push(42.5); color = '#c0392b'; feedback.innerHTML = `<h3 style="color:#c0392b; margin-top:0;">üí• The Miss ($0.99)</h3><p><strong>Result:</strong> Stock crashes 15%.</p><p><strong>Why?</strong> "If they missed by a penny, what else is wrong?" Wall Street hates uncertainty.</p>`; }
        else if (result === 'meet') { newData.push(49.8); color = '#f39c12'; feedback.innerHTML = `<h3 style="color:#f39c12; margin-top:0;">üòê The Meet ($1.00)</h3><p><strong>Result:</strong> Flat.</p><p><strong>Why?</strong> "Priced in." Good news that is expected is neutral.</p>`; }
        else if (result === 'beat') { newData.push(55.0); color = '#27ae60'; feedback.innerHTML = `<h3 style="color:#27ae60; margin-top:0;">üöÄ The Beat ($1.01)</h3><p><strong>Result:</strong> +10%.</p><p><strong>Why?</strong> "Beat and Raise." That penny implies stronger growth ahead.</p>`; }
        earningsChartInstance.data.datasets[0].data = newData; earningsChartInstance.data.datasets[0].borderColor = color; earningsChartInstance.update();
    }

    // ================= MODULE C: FRAUD =================
    const fraudData = {
        grill: {
            scenario: `<span class="scenario-title">Case 1: The "Channel Stuffing" Scheme</span><div style="font-size:0.95em; line-height:1.6; color:#333;"><p><strong>The Situation:</strong> It is December 20th. You are the CEO of GrillMaster. Your bonus depends on hitting a specific earnings target, but sales are down because it is winter.</p><p><strong>The Scheme:</strong> You call your largest distributor and pressure them to accept a shipment of 50,000 grills they do not need. To get them to agree, you provide a secret side letter: <em>"You do not have to pay for six months, and you can return any unsold grills for a full refund."</em></p><p><strong>The Result:</strong> The trucks leave your warehouse on December 31st. Because the goods shipped, you record $50 million in revenue immediately. Your Income Statement shows massive growth, but your bank account shows zero cash collected.</p></div>`,
            income: [10, 12, 11, 45], cash: [9, 13, 10, -25], narrative: { income: "<strong>Why UP?</strong> GAAP rules allow you to recognize revenue when goods are shipped. By stuffing the channel with unwanted inventory, you manufactured a paper profit.", cash: "<strong>Why DOWN?</strong> You collected no money (Net 180 terms). Furthermore, you spent actual cash on labor and materials to build the grills. Profit is up, but cash is gone." }
        },
        enron: {
            scenario: `<span class="scenario-title">Case 2: The "Mark-to-Market" Illusion</span><div style="font-size:0.95em; line-height:1.6; color:#333;"><p><strong>The Situation:</strong> You are the CEO of VaporEnergy. Wall Street demands constant growth. You just signed a 20-year contract to supply natural gas to a power plant, but you have not delivered any gas yet.</p><p><strong>The Scheme:</strong> Instead of booking profit year-by-year as you get paid, you use "Mark-to-Market" accounting. You build a spreadsheet model that assumes gas prices will stay high for 20 years. The model predicts $100 million in total future profit.</p><p><strong>The Result:</strong> You record the entire $100 million of <em>estimated future profit</em> as revenue today. You report a record-breaking quarter to investors, even though you have not collected a single cent of cash from the customer.</p></div>`,
            income: [15, 16, 15, 95], cash: [14, 15, 14, 12], narrative: { income: "<strong>Why UP?</strong> Mark-to-Market accounting allowed you to book the Present Value of a 20-year contract immediately. The profit exists only on your spreadsheet.", cash: "<strong>Why FLAT?</strong> Signing a contract generates no immediate cash. You are reporting billions in profit while struggling to pay your daily electric bill." }
        }
    };
    function initFraudChart() { const ctx = document.getElementById('fraudChart').getContext('2d'); fraudChartInstance = new Chart(ctx, { type: 'line', data: { labels: ['Q1','Q2','Q3','Q4'], datasets: [{label:'Net Income',data:fraudData.grill.income,borderColor:'#2980b9',fill:true},{label:'Cash Flow',data:[],borderColor:'#27ae60',borderDash:[10,5]}] }, options: { responsive: true, maintainAspectRatio: false } }); document.getElementById('scenario-content').innerHTML = fraudData.grill.scenario; document.getElementById('analysis-income-text').innerHTML = fraudData.grill.narrative.income; document.getElementById('analysis-cash-text').innerHTML = fraudData.grill.narrative.cash; }
    function switchFraudCase(c) { currentFraudCase = c; const d = fraudData[c]; document.getElementById('scenario-content').innerHTML = d.scenario; document.getElementById('analysis-income-text').innerHTML = d.narrative.income; document.getElementById('analysis-cash-text').innerHTML = d.narrative.cash; showFraudLayer('income'); }
    function showFraudLayer(m) { const d = fraudData[currentFraudCase]; document.getElementById('analysis').style.display='none'; if(m==='income') { fraudChartInstance.data.datasets[0].data=d.income; fraudChartInstance.data.datasets[1].data=[]; } else { fraudChartInstance.data.datasets[1].data=d.cash; document.getElementById('analysis').style.display='block'; } fraudChartInstance.update(); }

    // ================= MODULE D: SEC & AUDIT (MCQ Logic) =================
    // Initial setup handled in switchView()
    let secMatches = { 
        '10-K': 'Annual Report. Audited financials, comprehensive business overview, Risk Factors.', 
        '10-Q': 'Quarterly Report. Unaudited, updates on financial position, filed 3x a year.', 
        '8-K': 'Current Report. "Breaking News" (e.g., CEO fired, Bankruptcy) filed within 4 days.', 
        'Proxy (Def 14A)': 'The "Voter Guide". Executive Pay (Comp), Board Elections, Shareholder Proposals.', 
        'S-1 (IPO Prospectus)': 'The "Birth Certificate". Filed before going public. Lists risks & use of funds.' 
    }; 
    let selCard=null;
    function initSECGame() { const b = document.getElementById('card-bank'); const m = document.getElementById('match-container'); b.innerHTML=''; m.innerHTML=''; Object.keys(secMatches).forEach(k => { let c=document.createElement('div'); c.className='term-card'; c.innerText=k; c.onclick=()=>selSEC(c,k); b.appendChild(c); let r=document.createElement('div'); r.className='match-row'; r.innerHTML=`<div class="drop-zone" onclick="dropSEC(this,'${k}')">${secMatches[k]}</div>`; m.appendChild(r); }); }
    function selSEC(el,k) { if(selCard) selCard.el.classList.remove('selected'); el.classList.add('selected'); selCard={el,k}; }
    function dropSEC(zone,k) { if(selCard && selCard.k===k) { zone.innerHTML=''; zone.appendChild(selCard.el); selCard.el.classList.add('matched'); selCard=null; } }
    function revealInstructorKey() { if(document.getElementById('teacher-pwd').value==='teacher') initSECGame(); } 
    function resetSECGame() { initSECGame(); }
    
    // MCQ Handler
    function checkAuditAnswer(choice) {
        const feedback = document.getElementById('audit-feedback');
        const solution = document.getElementById('audit-solution');
        const buttons = document.querySelectorAll('.audit-btn');
        
        // Reset styles
        buttons.forEach(btn => {
            btn.classList.remove('selected-correct', 'selected-wrong');
        });

        if (choice === 'C') {
            // Correct
            feedback.innerText = "‚úÖ Correct! Auditors are the independent referees.";
            feedback.style.color = "#2e7d32";
            buttons[2].classList.add('selected-correct');
            
            // Toggle Logic: If visible, hide. If hidden, show.
            if(solution.style.display === 'block') {
               solution.style.display = 'none';
            } else {
               solution.style.display = 'block';
            }
        } else {
            // Wrong
            feedback.style.color = "#c62828";
            solution.style.display = 'none'; // Hide solution on wrong answer
            if (choice === 'A') {
                feedback.innerText = "‚ùå Incorrect. Blind trust leads to fraud (see Enron).";
                buttons[0].classList.add('selected-wrong');
            } else if (choice === 'B') {
                feedback.innerText = "‚ùå Incorrect. Removing bonuses destroys motivation.";
                buttons[1].classList.add('selected-wrong');
            }
        }
    }
    
    function hideAuditSolution() {
        document.getElementById('audit-solution').style.display = 'none';
    }

    // ================= MODULE E: EQUITY =================
    // Removed initBalanceSheetChart here because it is now inline in switchView
    function switchEquityPhase(n) { document.querySelectorAll('.phase-content').forEach(c=>c.classList.remove('active-phase')); document.getElementById(`phase-${n}`).classList.add('active-phase'); document.querySelectorAll('.step-btn').forEach(b=>b.classList.remove('active-step')); document.querySelectorAll('.step-btn')[n-1].classList.add('active-step'); }
    function checkAnswer(phase, ans) { const r = document.getElementById(`p${phase}-result`); r.style.display='block'; r.className='result-box'; if(phase===1 && ans==='A') { r.innerHTML="‚úÖ CORRECT! Jewelers have high Inventory."; r.classList.add('result-correct'); } else if(phase===1) { r.innerHTML="‚ùå WRONG. High PP&E = Manufacturer."; r.classList.add('result-wrong'); } if(phase===2 && ans==='65') { r.innerHTML="‚úÖ CORRECT! Subtract NCI."; r.classList.add('result-correct'); } else if(phase===2) { r.innerHTML="‚ùå WRONG. Don't include minority money."; r.classList.add('result-wrong'); } }

    // ================= MODULE F: MISTAKES =================
    function initGrowthChart() { growthChartInstance = new Chart(document.getElementById('growthChart').getContext('2d'), { type: 'line', data: { labels: ['Y1','Y2','Y3','Y4','Y5'], datasets: [{label:'Net Income',data:[10,12,14,16,18],borderColor:'#2980b9'},{label:'Cash',data:[20,20,20,20,20],borderColor:'#27ae60'}] }, options: {maintainAspectRatio:false} }); updateGrowthSimulation(); }
    function updateGrowthSimulation() { const g=document.getElementById('growth-slider').value; const d=document.getElementById('dso-slider').value; const i=document.getElementById('inv-slider').value; let inc=[10], cash=[20], rev=[100], ar=[100/365*d], inv=[60/365*i]; for(let x=1;x<5;x++){ let nr=rev[x-1]*(1+g/100); rev.push(nr); let ni=nr*0.1; inc.push(ni); let nar=nr/365*d; let niv=nr*0.6/365*i; let c=cash[x-1]+ni-(nar-ar[x-1])-(niv-inv[x-1]); cash.push(c); ar.push(nar); inv.push(niv); } growthChartInstance.data.datasets[0].data=inc; growthChartInstance.data.datasets[1].data=cash; growthChartInstance.update(); }
    function toggleExplanation() { const b=document.getElementById('growth-explanation'); b.style.display = b.style.display==='block'?'none':'block'; }

    // ================= MODULE G: CHAIN =================
    const chainScenarios = {
        debt: {
            start: "Trigger: Company Issues Massive Debt",
            steps: [
                { label: "B", text: "Debt-to-Equity Ratio Spikes" },
                { label: "D", text: "Credit Rating Downgraded (AAA ‚Üí BBB)" },
                { label: "E", text: "Lenders Demand Higher Interest Rates" },
                { label: "A", text: "Interest Expense Increases Significantly" },
                { label: "C", text: "Net Income (Profit) Falls" }
            ]
        },
        inventory: {
            start: "Trigger: Forecast is Too Optimistic",
            steps: [
                { label: "C", text: "Inventory Turnover Ratio Slows" },
                { label: "A", text: "Cash Conversion Cycle Lengthens" },
                { label: "D", text: "Liquidity Crunch (Cash Trapped in Warehouse)" },
                { label: "B", text: "Inventory Becomes Obsolete / Expires" },
                { label: "E", text: "Massive Write-Down (Loss) Recorded" }
            ]
        },
        sales: {
            start: "Trigger: Aggressive Credit Terms (Net 90)",
            steps: [
                { label: "D", text: "Sales Growth Looks Artificially High" },
                { label: "A", text: "Accounts Receivable Balance Balloons" },
                { label: "E", text: "Days Sales Outstanding (DSO) Increases" },
                { label: "B", text: "Operating Cash Flow Drops vs Net Income" },
                { label: "C", text: "Customers Default (Bad Debt Expense)" }
            ]
        }
    };
    function initChainGame(s) { 
        currentChainKey=s; 
        const c=chainScenarios[s]; 
        document.getElementById('start-event').innerText=c.start; 
        const b=document.getElementById('domino-bank'); 
        b.innerHTML=''; 
        c.steps.slice().sort(()=>Math.random()-0.5).forEach((st)=>{ 
            let d=document.createElement('div'); 
            d.className='domino-block'; 
            d.innerHTML=`<span class="domino-label">${st.label}.</span> <span>${st.text}</span>`; 
            d.dataset.correctIndex=c.steps.findIndex(x=>x.label===st.label); 
            d.dataset.itemLabel = st.label;
            b.appendChild(d); 
        }); 
        new Sortable(b,{group:'chain'}); 
        document.querySelectorAll('.domino-slot').forEach(sl=>{ 
            sl.innerHTML=''; 
            sl.style.borderColor = '#bdc3c7';
            new Sortable(sl,{group:'chain',onAdd:checkChain}); 
        }); 
        document.getElementById('success-msg').style.display='none';
        document.getElementById('chain-msg').innerText='';
    }
    function checkChain() { let correct=0; document.querySelectorAll('.domino-slot').forEach((sl,i)=>{ if(sl.children[0] && parseInt(sl.children[0].dataset.correctIndex)===i) { sl.style.borderColor='#27ae60'; correct++; } else sl.style.borderColor='#c0392b'; }); if(correct===5) document.getElementById('success-msg').style.display='block'; else document.getElementById('success-msg').style.display='none'; }
    function revealChainKey() { 
        if (document.getElementById('chain-pwd').value === 'teacher') { 
            document.getElementById('chain-msg').innerText = ''; 
            const currentChain = chainScenarios[currentChainKey]; 
            for(let i=0; i<5; i++) { 
                const correctItem = currentChain.steps[i]; 
                const allBlocks = document.querySelectorAll('.domino-block'); 
                let targetBlock = null; 
                allBlocks.forEach(b => { 
                    if(b.dataset.itemLabel === correctItem.label) targetBlock = b; 
                }); 
                if(targetBlock) { 
                    const slot = document.querySelector(`.domino-slot[data-order="${i}"]`); 
                    if(slot.children[0] !== targetBlock) { 
                        slot.innerHTML = ''; 
                        slot.appendChild(targetBlock); 
                    } 
                } 
            } 
            checkChain(); 
        } else { 
            document.getElementById('chain-msg').innerText = '‚ö†Ô∏è Incorrect Password'; 
        } 
    }

    // ================= MODULE H: MARKET =================
    const mktScenes = { custom: { b:50, g:100, s:0 }, manufacturer: { b:10, g:0, s:0 }, tech: { b:100, g:800, s:300 }, coke: { b:600, g:200, s:50 } };
    function loadMarketScenario(t) { const s=mktScenes[t]; document.getElementById('brand-slider').value=s.b; document.getElementById('growth-cap-slider').value=s.g; document.getElementById('sentiment-slider').value=s.s; updateValuation(); }
    const MAX_VALUATION = 1000; const VISUAL_HEIGHT = 400;
    function updateValuation() { const b=parseInt(document.getElementById('brand-slider').value); const g=parseInt(document.getElementById('growth-cap-slider').value); const s=parseInt(document.getElementById('sentiment-slider').value); const mc=Math.max(0, 100+b+g+s); const pb=(mc/100).toFixed(2); const pxPerMillion = VISUAL_HEIGHT / MAX_VALUATION; const mktHeight = Math.min(mc * pxPerMillion, VISUAL_HEIGHT); const marketBar = document.getElementById('market-bar'); marketBar.style.height = Math.max(mktHeight, 5) + 'px'; const bookHeight = 100 * pxPerMillion; document.getElementById('book-bar-visual').style.height = Math.max(bookHeight, 5) + 'px'; document.getElementById('market-val-text').innerText = "$" + mc + "M"; document.getElementById('pb-ratio-display').innerText = pb+"x"; if(pb > 8) { marketBar.style.background = "#e74c3c"; document.getElementById('market-val-text').style.color = "#e74c3c"; } else if (pb < 1) { marketBar.style.background = "#7f8c8d"; document.getElementById('market-val-text').style.color = "#7f8c8d"; } else { marketBar.style.background = "#3f51b5"; document.getElementById('market-val-text').style.color = "#3f51b5"; } }

    // Init
    initUserGame(); // Default View is Users
</script>
</body>
</html>