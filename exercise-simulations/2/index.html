<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operating Characteristics & Adjustments Simulation</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a' },
                        blue: { 950: '#172554' },
                        emerald: { 450: '#10b981' },
                        excel: { green: '#217346', header: '#e6f2ea' }
                    }
                }
            }
        }
    </script>

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .input-correct {
            border-color: #10b981 !important;
            color: #065f46 !important;
            background-color: #ecfdf5 !important;
            font-weight: bold;
        }
        .input-default { border-color: #cbd5e1; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* Calculator Button Styles */
        .calc-btn {
            background-color: #334155;
            color: white;
            font-weight: bold;
            border-radius: 4px;
            padding: 8px 0;
            text-align: center;
            font-size: 0.85rem;
            transition: background-color 0.1s;
        }
        .calc-btn:hover { background-color: #475569; }
        .calc-btn:active { transform: scale(0.98); }
        .calc-btn.op { background-color: #0f172a; color: #60a5fa; }
        .calc-btn.eq { background-color: #059669; }
        .calc-btn.clear { background-color: #991b1b; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 antialiased h-screen flex flex-col overflow-hidden">

    <div id="root" class="h-full flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- DATA & KEYS ---
        const ANSWER_KEYS = {
            P1: {
                // Target
                "t_gp": "25", "t_pm": "3", "t_roe": "25", "t_lev": "3.75",
                // Nike
                "n_gp": "46", "n_pm": "13", "n_roe": "40", "n_lev": "1.64",
                // Harley
                "h_gp": "37", "h_pm": "13", "h_roe": "25", "h_lev": "2.96",
                // Abbott
                "a_gp": "56", "a_pm": "16", "a_roe": "19", "a_lev": "1.02"
            },
            P2: {
                "adj1_a": "-2310", "adj1_l": "0", "adj1_e": "-2310", "adj1_r": "0", "adj1_x": "2310",
                "adj2_a": "-7920", "adj2_l": "0", "adj2_e": "-7920", "adj2_r": "0", "adj2_x": "7920",
                "adj3_a": "0", "adj3_l": "488", "adj3_e": "-488", "adj3_r": "0", "adj3_x": "488",
                "adj4_a": "0", "adj4_l": "3600", "adj4_e": "-3600", "adj4_r": "0", "adj4_x": "3600",
                "adj5_a": "-7125", "adj5_l": "0", "adj5_e": "-7125", "adj5_r": "0", "adj5_x": "7125",
                "adj6_a": "0", "adj6_l": "675", "adj6_e": "-675", "adj6_r": "0", "adj6_x": "675",
                "adj7_a": "0", "adj7_l": "1032", "adj7_e": "-1032", "adj7_r": "0", "adj7_x": "1032"
            }
        };

        const DATA_P1 = {
            metadata: { name: "Industry Comparison", year: "Financial Data ($ Millions)" },
            tables: [
                {
                    title: "Selected Financial Data",
                    headers: ["Company", "Sales", "COGS", "Net Income", "Assets", "Liabs", "Equity"],
                    rows: [
                        ["Target", "218,240", "164,458", "5,560", "106,670", "84,206", "22,464"],
                        ["Nike", "93,420", "50,462", "12,092", "80,642", "50,080", "30,562"],
                        ["Harley-Davidson", "11,510", "7,242", "1,478", "22,984", "17,172", "5,806"],
                        ["Abbott Labs", "87,306", "38,284", "13,866", "148,876", "75,066", "73,372"]
                    ]
                }
            ]
        };

        const DATA_P2 = {
            metadata: { name: "BensEx", year: "Adjusting Information" },
            tables: [
                {
                    title: "Trial Balance (Unadjusted)",
                    headers: ["Account", "Amount"],
                    rows: [
                        ["Prepaid advertising", "2,520"],
                        ["Supplies", "9,405"],
                        ["Equipment", "63,360"],
                        ["Wages expense", "58,200"],
                        ["Rent expense", "10,350"],
                        ["Utilities expense", "4,530"]
                    ]
                },
                {
                    title: "Adjustment Data",
                    headers: ["Item", "Details"],
                    rows: [
                        ["Adv.", "Covers Feb 1–Jan 31 (12 mos); no ads in Jan."],
                        ["Equip.", "8 yr life, straight-line, no salvage."],
                        ["Util.", "Dec accrued: $488."],
                        ["Wages", "Accrued: $3,600."],
                        ["Supplies", "On hand: $2,280."],
                        ["Interest", "Accrued: $675."],
                        ["Rent", "Accrued calculated as $1,032."]
                    ]
                }
            ]
        };

        const ACCOUNT_OPTIONS = [
            "", "Cash", "Accounts Receivable", "Prepaid Advertising", "Supplies", 
            "Equipment", "Accumulated Depreciation",
            "Accounts Payable", "Utilities Payable", "Wages Payable", "Interest Payable", "Rent Payable",
            "Common Stock", "Retained Earnings",
            "Service Revenue", "Mailing Fees Earned",
            "Advertising Expense", "Depreciation Expense", "Utilities Expense", "Wages Expense", "Supplies Expense", "Interest Expense", "Rent Expense"
        ];

        // --- COMPONENTS ---

        const Icon = ({ name, size = 16, className = "", color = "currentColor" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (iconRef.current && window.lucide) {
                    iconRef.current.innerHTML = '';
                    const iconElement = document.createElement('i');
                    iconElement.setAttribute('data-lucide', name);
                    iconElement.style.width = `${size}px`;
                    iconElement.style.height = `${size}px`;
                    iconElement.style.color = color;
                    if (className) className.split(' ').forEach(cls => iconElement.classList.add(cls));
                    iconRef.current.appendChild(iconElement);
                    window.lucide.createIcons({ root: iconRef.current, attrs: { width: size, height: size } });
                }
            }, [name, size, color, className]);
            return <span ref={iconRef} className="inline-flex items-center justify-center" />;
        };

        const ConfirmationModal = ({ isOpen, title, message, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center backdrop-blur-sm animate-fade-in">
                    <div className="bg-white rounded-lg shadow-2xl max-w-sm w-full p-6 m-4 border-l-4 border-red-500">
                        <div className="flex items-center gap-3 text-red-600 mb-4">
                            <Icon name="alert-triangle" size={24} />
                            <h3 className="text-lg font-bold">{title}</h3>
                        </div>
                        <p className="text-slate-600 mb-6">{message}</p>
                        <div className="flex justify-end gap-3">
                            <button onClick={onCancel} className="px-4 py-2 text-slate-600 font-medium hover:bg-slate-100 rounded-lg">Cancel</button>
                            <button onClick={onConfirm} className="px-4 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700">Confirm & Exit</button>
                        </div>
                    </div>
                </div>
            );
        };

        const StandardCalculator = () => {
            const [display, setDisplay] = useState("0");
            const [prevVal, setPrevVal] = useState(null);
            const [op, setOp] = useState(null);
            const [newNum, setNewNum] = useState(true);

            const handleNum = (num) => {
                if (newNum) { setDisplay(String(num)); setNewNum(false); } 
                else { setDisplay(display === "0" ? String(num) : display + num); }
            };

            const handleOp = (operator) => {
                setOp(operator);
                setPrevVal(parseFloat(display));
                setNewNum(true);
            };

            const handleEq = () => {
                if (!op || prevVal === null) return;
                const curr = parseFloat(display);
                let res = 0;
                switch(op) {
                    case '+': res = prevVal + curr; break;
                    case '-': res = prevVal - curr; break;
                    case '×': res = prevVal * curr; break;
                    case '÷': res = prevVal / curr; break;
                }
                setDisplay(String(parseFloat(res.toFixed(4))));
                setOp(null); setPrevVal(null); setNewNum(true);
            };

            const handleClear = () => {
                setDisplay("0"); setPrevVal(null); setOp(null); setNewNum(true);
            };

            return (
                <div className="mx-4 mt-6 bg-slate-800 rounded-lg p-3 border border-slate-700 shadow-xl">
                    <div className="bg-slate-900 border border-slate-600 rounded mb-3 px-2 py-2 text-right text-lg font-mono text-emerald-400 font-bold overflow-hidden h-10 flex items-center justify-end">
                        {display}
                    </div>
                    <div className="grid grid-cols-4 gap-2">
                        <button onClick={handleClear} className="calc-btn clear col-span-1 text-xs">C</button>
                        <button onClick={() => handleOp('÷')} className="calc-btn op">÷</button>
                        <button onClick={() => handleOp('×')} className="calc-btn op">×</button>
                        <button onClick={() => handleOp('-')} className="calc-btn op">-</button>
                        <button onClick={() => handleNum(7)} className="calc-btn">7</button>
                        <button onClick={() => handleNum(8)} className="calc-btn">8</button>
                        <button onClick={() => handleNum(9)} className="calc-btn">9</button>
                        <button onClick={() => handleOp('+')} className="calc-btn op row-span-2 flex items-center justify-center">+</button>
                        <button onClick={() => handleNum(4)} className="calc-btn">4</button>
                        <button onClick={() => handleNum(5)} className="calc-btn">5</button>
                        <button onClick={() => handleNum(6)} className="calc-btn">6</button>
                        <button onClick={() => handleNum(1)} className="calc-btn">1</button>
                        <button onClick={() => handleNum(2)} className="calc-btn">2</button>
                        <button onClick={() => handleNum(3)} className="calc-btn">3</button>
                        <button onClick={handleEq} className="calc-btn eq row-span-2 flex items-center justify-center">=</button>
                        <button onClick={() => handleNum(0)} className="calc-btn col-span-2">0</button>
                        <button onClick={() => handleNum('.')} className="calc-btn">.</button>
                    </div>
                </div>
            );
        };

        const SmartInput = ({ id, value, onChange, correctValue, label, hint, instructorMode, activeInput, setActiveInput, tolerance = 0.5, className="", isPercentage=false }) => {
            const [localError, setLocalError] = useState(null);
            
            const evaluateMath = (expr) => {
                if (!expr) return { valid: true, val: "" };
                try {
                    // Remove commas and handle percentages
                    let sanitized = expr.toString().replace(/,/g, '');
                    // Replace % with /100 if it's part of a number, but be careful with operators
                    // Simple replacement: numbers followed by % -> number/100
                    sanitized = sanitized.replace(/(\d+(\.\d+)?)%/g, '($1/100)');
                    
                    // Safety check: only allow numbers, operators, parens, decimal points
                    if (!/^[\d\.\+\-\*\/\(\)\s]+$/.test(sanitized)) return { valid: false, msg: "Invalid characters" };
                    
                    // eslint-disable-next-line no-eval
                    const res = eval(sanitized);
                    
                    if (!isFinite(res) || isNaN(res)) return { valid: false, msg: "Math Error" };
                    return { valid: true, val: res };
                } catch (e) {
                    return { valid: false, msg: "Syntax Error" };
                }
            };

            const isCorrect = useMemo(() => {
                if (!value || !correctValue) return false;
                if (typeof value === 'string' && value.trim() === '') return false;

                const { valid, val } = evaluateMath(value);
                if (!valid) return false;
                
                const target = parseFloat(correctValue.toString().replace(/,/g, ''));
                let inputNum = parseFloat(val);
                
                // Flexible percentage logic:
                // If correct answer is 25 (meaning 25%), accept 25 or 0.25
                // If correct answer is 0.25, accept 0.25 or 25 (if they meant %)
                
                const effectiveTolerance = Math.max(Math.abs(target * 0.02), 0.15);

                if (isPercentage) {
                    // Scenario A: Input matches target directly (e.g. 25 vs 25)
                    if (Math.abs(inputNum - target) <= effectiveTolerance) return true;
                    // Scenario B: Input is decimal, target is whole (e.g. 0.25 vs 25)
                    if (Math.abs((inputNum * 100) - target) <= effectiveTolerance) return true;
                     // Scenario C: Input is whole, target is decimal (e.g. 25 vs 0.25) -- less common if key is '25'
                     if (Math.abs(inputNum - (target * 100)) <= effectiveTolerance) return true;
                    return false;
                } else {
                    return Math.abs(inputNum - target) <= effectiveTolerance;
                }
            }, [value, correctValue, isPercentage, tolerance]);

            const handleBlur = (e) => {
                // Don't format if empty
                if (!value || value.trim() === '') {
                     setLocalError(null);
                     return;
                }

                const { valid, val } = evaluateMath(value);
                if (!valid) { 
                    // Do NOT clear value on error, just show indicator
                    setLocalError("Invalid Math"); 
                    return; 
                }
                setLocalError(null);
                
                // Only auto-format if it's a "clean" number outcome, otherwise leave expression
                // Actually, standard behavior for these sims is usually to replace with result
                if (valid) {
                     const numVal = Number(val);
                     let displayVal = numVal;
                     if (isPercentage) {
                        // Heuristic: if calculated val < 1 (e.g. 0.25) and target > 1 (25), display as 25.0
                        // This helps if they typed (A-B)/A resulting in 0.25
                        if (Math.abs(numVal) < 1 && parseFloat(correctValue) > 1) { 
                            displayVal = (numVal * 100).toFixed(1); 
                        } else { 
                            displayVal = numVal.toFixed(1); 
                        }
                     } else {
                        // Integer for non-decimals unless it has a decimal part
                        displayVal = Number.isInteger(numVal) ? numVal.toString() : numVal.toFixed(1);
                     }
                     onChange(id, displayVal.toString()); 
                }
            };

            const isActive = activeInput === id;

            return (
                <div className="w-full relative">
                    {label && <label className="block text-xs font-bold text-slate-500 mb-1 uppercase tracking-wider">{label}</label>}
                    <input 
                        type="text" 
                        id={id}
                        value={value || ""}
                        onChange={(e) => { setLocalError(null); onChange(id, e.target.value); }}
                        onFocus={() => setActiveInput(id)}
                        onBlur={handleBlur}
                        onKeyDown={(e) => e.key === 'Enter' && e.target.blur()}
                        className={`w-full p-2 text-right border rounded text-sm font-mono shadow-sm transition-all outline-none focus:ring-2 focus:ring-blue-500 ${
                            isCorrect ? "input-correct" : (value && !isActive && !isCorrect) ? "bg-white border-slate-300" : "bg-white border-slate-300"
                        } ${className}`}
                        placeholder={hint ? "Calc..." : "-"}
                    />
                    <div className="absolute left-2 top-1/2 -translate-y-1/2 pointer-events-none transform mt-0.5">
                        {isCorrect ? <span className="text-emerald-600"><Icon name="check" size={14} /></span> : 
                        localError ? <span className="text-red-500 font-bold text-xs">!</span> : null}
                    </div>
                    {instructorMode && (
                        <div className="mt-1 text-[10px] text-purple-700 bg-purple-50 px-2 py-1 rounded inline-block font-bold border border-purple-200 shadow-sm animate-fade-in w-full text-center">
                            Key: {correctValue}
                        </div>
                    )}
                </div>
            );
        };

        const ReferenceTable = ({ title, headers, rows, onValueClick }) => {
            const [isOpen, setIsOpen] = useState(true);
            return (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-4">
                    <button onClick={() => setIsOpen(!isOpen)} className="w-full flex items-center justify-between p-3 bg-slate-50 border-b border-slate-100 hover:bg-slate-100 transition">
                        <h4 className="font-bold text-slate-700 text-sm flex items-center gap-2">
                            <Icon name="table" size={16} /> {title}
                        </h4>
                        <Icon name={isOpen ? "chevron-up" : "chevron-down"} size={16} />
                    </button>
                    {isOpen && (
                        <div className="overflow-x-auto max-h-64">
                            <table className="w-full text-xs text-left">
                                <thead className="bg-slate-50 text-slate-500 uppercase tracking-wider sticky top-0">
                                    <tr>{headers.map((h, i) => <th key={i} className={`p-2 border-b font-medium ${i > 0 ? "text-right" : ""}`}>{h}</th>)}</tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {rows.map((row, rI) => (
                                        <tr key={rI} className="hover:bg-blue-50 transition-colors group">
                                            <td className="p-2 font-medium text-slate-700">{row[0]}</td>
                                            {row.slice(1).map((cell, cI) => (
                                                <td key={cI} onClick={() => onValueClick(cell)} className="p-2 text-right font-mono text-slate-600 cursor-pointer hover:text-blue-700 hover:font-bold decoration-dotted" title="Insert">{cell}</td>
                                            ))}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };

        const QuestionBox = ({ q, hint, teacherAns, teacherMode }) => {
            const [showHint, setShowHint] = useState(false);
            return (
                <div className="bg-white border border-slate-200 rounded-lg p-5 shadow-sm mb-4">
                    <p className="font-bold text-slate-800 mb-3 text-sm">{q}</p>
                    <textarea className="w-full border border-slate-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-200 outline-none mb-2 bg-slate-50 min-h-[80px]" placeholder="Type analysis..."></textarea>
                    <div className="flex justify-between items-center">
                        <button onClick={() => setShowHint(!showHint)} className="text-xs text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1">
                            <Icon name="help-circle" size={12} /> {showHint ? "Hide Hint" : "Show Hint"}
                        </button>
                    </div>
                    {showHint && <p className="mt-2 text-xs text-blue-700 bg-blue-50 p-2 rounded border border-blue-100">{hint}</p>}
                    {teacherMode && (
                        <div className="mt-3 pt-3 border-t border-slate-100 bg-purple-50 p-3 rounded">
                            <span className="text-[10px] font-bold text-purple-700 uppercase tracking-wider block mb-1">Instructor Note</span>
                            <p className="text-xs text-slate-700">{teacherAns}</p>
                        </div>
                    )}
                </div>
            );
        };

        // --- MODULES ---

        const ModuleP1 = ({ teacherMode, isAutoFilled, handleInputChange, inputs, activeInput, setActiveInput }) => {
            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h4 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
                            <Icon name="bar-chart-2" className="text-blue-600"/> Operating Ratios
                        </h4>
                        
                        {/* Headers */}
                        <div className="grid grid-cols-5 gap-4 text-xs font-bold text-slate-500 uppercase tracking-wider border-b border-slate-100 pb-2 mb-4 text-center">
                            <div className="text-left">Company</div>
                            <div>Gross Profit %</div>
                            <div>Profit Margin %</div>
                            <div>ROE %</div>
                            <div>Leverage</div>
                        </div>

                        {/* Target */}
                        <div className="grid grid-cols-5 gap-4 items-center mb-4 text-sm">
                            <div className="font-bold text-slate-700">Target</div>
                            <SmartInput id="t_gp" value={inputs.t_gp} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEYS.P1.t_gp} instructorMode={teacherMode} isPercentage={true} hint="(Sales-COGS)/Sales" />
                            <SmartInput id="t_pm" value={inputs.t_pm} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEYS.P1.t_pm} instructorMode={teacherMode} isPercentage={true} hint="NI / Sales" />
                            <SmartInput id="t_roe" value={inputs.t_roe} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEYS.P1.t_roe} instructorMode={teacherMode} isPercentage={true} hint="NI / Equity" />
                            <SmartInput id="t_lev" value={inputs.t_lev} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEYS.P1.t_lev} instructorMode={teacherMode} hint="Liab / Equity" />
                        </div>

                        {/* Nike */}
                        <div className="grid grid-cols-5 gap-4 items-center mb-4 text-sm">
                            <div className="font-bold text-slate-700">Nike</div>
                            <SmartInput id="n_gp" value={inputs.n_gp} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEYS.P1.n_gp} instructorMode={teacherMode} isPercentage={true} hint="(Sales-COGS)/Sales" />
                            <SmartInput id="n_pm" value={inputs.n_pm} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEYS.P1.n_pm} instructorMode={teacherMode} isPercentage={true} hint="NI / Sales" />
                            <SmartInput id="n_roe" value={inputs.n_roe} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEYS.P1.n_roe} instructorMode={teacherMode} isPercentage={true} hint="NI / Equity" />
                            <SmartInput id="n_lev" value={inputs.n_lev} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEYS.P1.n_lev} instructorMode={teacherMode} hint="Liab / Equity" />
                        </div>

                        {/* Harley */}
                        <div className="grid grid-cols-5 gap-4 items-center mb-4 text-sm">
                            <div className="font-bold text-slate-700">Harley-Davidson</div>
                            <SmartInput id="h_gp" value={inputs.h_gp} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEYS.P1.h_gp} instructorMode={teacherMode} isPercentage={true} hint="(Sales-COGS)/Sales" />
                            <SmartInput id="h_pm" value={inputs.h_pm} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEYS.P1.h_pm} instructorMode={teacherMode} isPercentage={true} hint="NI / Sales" />
                            <SmartInput id="h_roe" value={inputs.h_roe} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEYS.P1.h_roe} instructorMode={teacherMode} isPercentage={true} hint="NI / Equity" />
                            <SmartInput id="h_lev" value={inputs.h_lev} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEYS.P1.h_lev} instructorMode={teacherMode} hint="Liab / Equity" />
                        </div>

                        {/* Abbott */}
                        <div className="grid grid-cols-5 gap-4 items-center mb-4 text-sm">
                            <div className="font-bold text-slate-700">Abbott Labs</div>
                            <SmartInput id="a_gp" value={inputs.a_gp} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEYS.P1.a_gp} instructorMode={teacherMode} isPercentage={true} hint="(Sales-COGS)/Sales" />
                            <SmartInput id="a_pm" value={inputs.a_pm} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEYS.P1.a_pm} instructorMode={teacherMode} isPercentage={true} hint="NI / Sales" />
                            <SmartInput id="a_roe" value={inputs.a_roe} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEYS.P1.a_roe} instructorMode={teacherMode} isPercentage={true} hint="NI / Equity" />
                            <SmartInput id="a_lev" value={inputs.a_lev} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEYS.P1.a_lev} instructorMode={teacherMode} hint="Liab / Equity" />
                        </div>
                    </div>

                    <div className="space-y-4">
                        <QuestionBox q="Interpretation: Highest Profit Margin?" hint="Look at Net Income / Sales." teacherAns="Abbott Labs (16%) due to high gross profit." teacherMode={teacherMode} />
                        <QuestionBox q="Highest Return on Equity?" hint="Look at ROE column." teacherAns="Nike (40%)." teacherMode={teacherMode} />
                        <QuestionBox q="Highest Leverage?" hint="Look at Liab/Equity." teacherAns="Target (3.75), likely due to stock buybacks." teacherMode={teacherMode} />
                    </div>
                </div>
            );
        };

        const ModuleP2 = ({ teacherMode, isAutoFilled, handleInputChange, inputs, activeInput, setActiveInput, handleAccountChange }) => {
            const rows = [
                { id: "adj1", label: "Advertising Adj." },
                { id: "adj2", label: "Depreciation Adj." },
                { id: "adj3", label: "Utilities Accrual" },
                { id: "adj4", label: "Wages Accrual" },
                { id: "adj5", label: "Supplies Used" },
                { id: "adj6", label: "Interest Accrual" },
                { id: "adj7", label: "Rent Accrual" }
            ];

            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                        <h4 className="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2">
                            <Icon name="file-spreadsheet" className="text-blue-600"/> Financial Statement Effects Template
                        </h4>
                        <div className="overflow-x-auto">
                            <table className="w-full text-xs text-center border-collapse">
                                <thead className="bg-slate-50 text-slate-500 font-semibold border-b border-slate-200">
                                    <tr>
                                        <th className="p-2 text-left w-32">Transaction</th>
                                        <th className="p-2 w-24">Assets</th>
                                        <th className="p-2">=</th>
                                        <th className="p-2 w-24">Liabilities</th>
                                        <th className="p-2">+</th>
                                        <th className="p-2 w-24">Equity</th>
                                        <th className="p-2 text-slate-300">|</th>
                                        <th className="p-2 w-24">Revenue</th>
                                        <th className="p-2">-</th>
                                        <th className="p-2 w-24">Expense</th>
                                        <th className="p-2">=</th>
                                        <th className="p-2 w-24">Net Inc.</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {rows.map((row) => (
                                        <tr key={row.id}>
                                            <td className="p-2 text-left font-medium text-slate-700">
                                                {row.label}
                                                <select 
                                                    className="w-full mt-1 bg-slate-50 text-xs text-slate-600 rounded border border-slate-200 p-1 outline-none focus:border-blue-500"
                                                    value={inputs[`${row.id}_acct`] || ""}
                                                    onChange={(e) => handleAccountChange(`${row.id}_acct`, e.target.value)}
                                                >
                                                    {ACCOUNT_OPTIONS.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                                </select>
                                            </td>
                                            <td className="p-2"><SmartInput id={`${row.id}_a`} value={inputs[`${row.id}_a`]} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEYS.P2[`${row.id}_a`]} instructorMode={teacherMode} /></td>
                                            <td>=</td>
                                            <td className="p-2"><SmartInput id={`${row.id}_l`} value={inputs[`${row.id}_l`]} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEYS.P2[`${row.id}_l`]} instructorMode={teacherMode} /></td>
                                            <td>+</td>
                                            <td className="p-2"><SmartInput id={`${row.id}_e`} value={inputs[`${row.id}_e`]} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEYS.P2[`${row.id}_e`]} instructorMode={teacherMode} /></td>
                                            <td className="text-slate-300">|</td>
                                            <td className="p-2"><SmartInput id={`${row.id}_r`} value={inputs[`${row.id}_r`]} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEYS.P2[`${row.id}_r`]} instructorMode={teacherMode} /></td>
                                            <td>-</td>
                                            <td className="p-2"><SmartInput id={`${row.id}_x`} value={inputs[`${row.id}_x`]} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={ANSWER_KEYS.P2[`${row.id}_x`]} instructorMode={teacherMode} /></td>
                                            <td>=</td>
                                            <td className="p-2">
                                                <div className={`py-1 px-2 rounded font-bold text-center text-xs ${
                                                    (parseFloat(inputs[`${row.id}_r`]) || 0) - (parseFloat(inputs[`${row.id}_x`]) || 0) !== 0 ? 'bg-slate-100 text-slate-800' : 'text-slate-400'
                                                }`}>
                                                    {((parseFloat(inputs[`${row.id}_r`]) || 0) - (parseFloat(inputs[`${row.id}_x`]) || 0)) || '-'}
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---

        const App = () => {
            const [activeTab, setActiveTab] = useState('P1'); 
            const [inputs, setInputs] = useState({ P1: {}, P2: {} });
            const [activeInput, setActiveInput] = useState(null);
            
            // Instructor State
            const [instructorMode, setInstructorMode] = useState(false);
            const [showLogin, setShowLogin] = useState(false);
            const [password, setPassword] = useState("");
            const [clearModalOpen, setClearModalOpen] = useState(false);
            const [isAutoFilled, setIsAutoFilled] = useState(false);
            const [showAnswerKey, setShowAnswerKey] = useState(false);
            
            const [studentName, setStudentName] = useState("");
            const [showDownload, setShowDownload] = useState(false);
            const [resetKey, setResetKey] = useState(0);

            const activeData = activeTab === 'P1' ? DATA_P1 : DATA_P2;
            const activeKey = ANSWER_KEYS[activeTab];

            const handleInputChange = (id, val) => setInputs(prev => ({ ...prev, [activeTab]: { ...prev[activeTab], [id]: val } }));
            
            // New handler specifically for P2 Account dropdowns which are stored in the same inputs object but handled differently
            const handleAccountChange = (id, val) => setInputs(prev => ({ ...prev, [activeTab]: { ...prev[activeTab], [id]: val } }));

            const handleValueClick = (val) => {
                if (!activeInput) return;
                const cleanVal = val.replace(/,/g, '').replace(/[()]/g, (m) => m === '(' ? '-' : '');
                setInputs(prev => {
                    const cur = prev[activeTab][activeInput] || "";
                    const isOperator = /[+\-*/(]$/.test(cur.trim());
                    const newVal = (cur === "" || isOperator) ? cur + cleanVal : cleanVal;
                    return { ...prev, [activeTab]: { ...prev[activeTab], [activeInput]: newVal } };
                });
                setTimeout(() => document.getElementById(activeInput)?.focus(), 50);
            };

            const unlockInstructor = () => {
                if (password.toLowerCase() === "teacher") { setInstructorMode(true); setShowLogin(false); setPassword(""); } else { alert("Incorrect"); }
            };

            const toggleTeacherMode = () => {
                if(instructorMode) setInstructorMode(false);
                else setShowLogin(true);
            };

            const handleAutoFill = () => {
                setInputs(prev => ({ ...prev, [activeTab]: { ...activeKey } }));
                setIsAutoFilled(true);
            };

            const performClear = () => {
                setInputs({ P1: {}, P2: {} });
                setIsAutoFilled(false);
                setInstructorMode(false);
                setClearModalOpen(false);
                setResetKey(prev => prev + 1);
            };

            const handleDownload = () => {
                const text = `Sim - ${activeTab}\nStudent: ${studentName}\nAnswers:\n${JSON.stringify(inputs[activeTab] || {})}`;
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `${studentName}_Sim.txt`; a.click();
                setShowDownload(false);
            };

            const handleClearConfirm = () => {
                performClear();
            };

            return (
                <div className="flex h-screen bg-slate-100 overflow-hidden font-sans">
                    
                    {/* LEFT SIDEBAR: REFERENCE */}
                    <div className="w-1/3 min-w-[350px] bg-slate-50 border-r border-slate-200 overflow-y-auto custom-scrollbar flex flex-col relative z-0">
                        <div className="sticky top-0 bg-white p-4 border-b border-slate-200 shadow-sm z-10">
                            <div className="flex items-center gap-2 text-blue-800 font-bold text-lg mb-1">
                                <Icon name="library" /> Reference Data
                            </div>
                            <p className="text-xs text-slate-500 font-bold uppercase tracking-wider">{activeData.metadata.name}</p>
                            <p className="text-xs text-blue-600 mt-1 flex items-center gap-1">
                                <Icon name="mouse-pointer-click" size={12} /> Click values to insert
                            </p>
                        </div>
                        <div className="p-4 space-y-2">
                             {activeData.tables.map((tbl, i) => (
                                <ReferenceTable 
                                    key={i}
                                    title={tbl.title} 
                                    headers={tbl.headers} 
                                    rows={tbl.rows} 
                                    onValueClick={handleValueClick} 
                                />
                            ))}
                            <StandardCalculator />
                        </div>
                    </div>

                    {/* MAIN CONTENT */}
                    <div className="flex-1 flex flex-col h-screen overflow-hidden relative">
                        
                        {/* TOP NAV TABS */}
                        <div className="bg-slate-800 text-white flex shrink-0">
                            <button 
                                onClick={() => { setActiveTab('P1'); setIsAutoFilled(false); }}
                                className={`flex-1 py-3 text-sm font-bold flex items-center justify-center gap-2 transition-colors ${activeTab === 'P1' ? 'bg-blue-600 text-white' : 'hover:bg-slate-700 text-slate-400'}`}
                            >
                                <Icon name="file-text" size={16} /> Industry Analysis
                            </button>
                            <button 
                                onClick={() => { setActiveTab('P2'); setIsAutoFilled(false); }}
                                className={`flex-1 py-3 text-sm font-bold flex items-center justify-center gap-2 transition-colors ${activeTab === 'P2' ? 'bg-emerald-600 text-white' : 'hover:bg-slate-700 text-slate-400'}`}
                            >
                                <Icon name="list" size={16} /> Adjusting Entries
                            </button>
                        </div>

                        {/* INSTRUCTOR TOOLBAR (STICKY) */}
                        {instructorMode && (
                            <div className="bg-purple-700 text-white p-2 shadow-md flex items-center justify-between z-20 animate-fade-in shrink-0">
                                <div className="flex items-center gap-3 px-4">
                                    <span className="bg-white/20 p-1.5 rounded"><Icon name="graduation-cap" /></span>
                                    <span className="font-bold tracking-wide">INSTRUCTOR MODE</span>
                                </div>
                                <div className="flex gap-2 px-4">
                                    <button onClick={() => setShowAnswerKey(true)} className="flex items-center gap-2 px-3 py-1 bg-purple-600 hover:bg-purple-500 rounded text-xs font-bold transition border border-purple-400"><Icon name="list" size={14} /> View Key</button>
                                    <button onClick={handleAutoFill} className="flex items-center gap-2 px-3 py-1 bg-green-500 hover:bg-green-600 rounded text-sm font-bold transition">
                                        <Icon name="wand-2" size={14} /> Auto-Fill Tab
                                    </button>
                                    <button onClick={() => setClearModalOpen(true)} className="flex items-center gap-2 px-3 py-1 bg-red-500 hover:bg-red-600 rounded text-sm font-bold transition">
                                        <Icon name="log-out" size={14} /> Clear & Exit
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* HEADER */}
                        <header className="bg-white border-b border-slate-200 p-6 flex justify-between items-center shrink-0">
                            <div>
                                <h1 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
                                    <Icon name="file-spreadsheet" className="text-blue-600" /> {activeData.metadata.name}
                                </h1>
                                <p className="text-slate-500 text-sm mt-1">{activeData.metadata.year}</p>
                            </div>
                            <div className="flex gap-3">
                                <button onClick={() => setShowDownload(true)} className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-sm transition">
                                    <Icon name="save" size={18} /> Save Work
                                </button>
                                {!instructorMode && (
                                    <button onClick={() => setShowLogin(true)} className="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-medium transition border border-slate-300">
                                        <Icon name="lock" size={16} /> Instructor
                                    </button>
                                )}
                            </div>
                        </header>

                        {/* SCROLLABLE FORM AREA */}
                        <main className="flex-1 overflow-y-auto custom-scrollbar bg-slate-50/50 p-8 pb-20">
                            <div className="max-w-4xl mx-auto space-y-8">
                                <div className="space-y-6">
                                    {activeTab === 'P1' && (
                                        <ModuleP1 
                                            key={`p1-${resetKey}`}
                                            teacherMode={instructorMode} 
                                            isAutoFilled={isAutoFilled} 
                                            handleInputChange={handleInputChange} 
                                            inputs={inputs.P1} 
                                            activeInput={activeInput} 
                                            setActiveInput={setActiveInput} 
                                        />
                                    )}
                                    {activeTab === 'P2' && (
                                        <ModuleP2 
                                            key={`p2-${resetKey}`}
                                            teacherMode={instructorMode} 
                                            isAutoFilled={isAutoFilled} 
                                            handleInputChange={handleInputChange} 
                                            inputs={inputs.P2} 
                                            activeInput={activeInput} 
                                            setActiveInput={setActiveInput} 
                                            handleAccountChange={handleAccountChange}
                                        />
                                    )}
                                </div>
                            </div>
                        </main>
                    </div>

                    {/* MODALS */}
                    
                    {/* Login Modal */}
                    {showLogin && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center animate-fade-in">
                            <div className="bg-white p-6 rounded-xl shadow-2xl w-80 transform transition-all">
                                <h3 className="font-bold text-lg mb-4 text-slate-800 flex items-center gap-2">
                                    <Icon name="lock" size={20} className="text-blue-600" /> Instructor Access
                                </h3>
                                <input 
                                    type="password" 
                                    className="w-full border p-3 rounded-lg mb-4 outline-none focus:border-blue-500" 
                                    placeholder="Enter password"
                                    value={password} 
                                    onChange={(e) => setPassword(e.target.value)}
                                    onKeyDown={(e) => e.key === 'Enter' && unlockInstructor()}
                                    autoFocus
                                />
                                <div className="flex justify-end gap-2">
                                    <button onClick={() => setShowLogin(false)} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg text-sm font-medium">Cancel</button>
                                    <button onClick={unlockInstructor} className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-bold">Unlock</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Answer Key Modal */}
                     {showAnswerKey && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm animate-fade-in">
                            <div className="bg-white p-6 rounded-xl shadow-2xl w-full max-w-2xl h-3/4 flex flex-col">
                                <div className="flex justify-between items-center mb-4 border-b pb-2">
                                    <h3 className="font-bold text-xl text-purple-800 flex items-center gap-2"><Icon name="key" /> Answer Key ({activeTab})</h3>
                                    <button onClick={() => setShowAnswerKey(false)} className="text-slate-400 hover:text-slate-600"><Icon name="x" /></button>
                                </div>
                                <div className="flex-1 overflow-y-auto custom-scrollbar p-2">
                                    <div className="grid grid-cols-2 gap-2 text-sm">
                                        {Object.entries(activeKey || {}).map(([k, v]) => (
                                            <div key={k} className="flex justify-between border-b border-slate-100 py-1">
                                                <span className="text-slate-500">{k}:</span>
                                                <span className="font-mono font-bold text-purple-700">{v}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="mt-4 pt-2 border-t text-right">
                                    <button onClick={() => setShowAnswerKey(false)} className="px-4 py-2 bg-slate-200 text-slate-700 rounded font-bold hover:bg-slate-300">Close</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Download Modal */}
                    {showDownload && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center animate-fade-in">
                            <div className="bg-white p-8 rounded-xl shadow-2xl w-96">
                                <div className="text-center mb-6">
                                    <div className="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3 text-blue-600">
                                        <Icon name="download-cloud" size={24} />
                                    </div>
                                    <h3 className="text-xl font-bold text-slate-800">Submit Assignment</h3>
                                    <p className="text-slate-500 text-sm mt-1">Enter your name to generate your submission file.</p>
                                </div>
                                <input 
                                    type="text" 
                                    value={studentName} 
                                    onChange={(e) => setStudentName(e.target.value)} 
                                    placeholder="Your Full Name" 
                                    className="w-full p-3 border border-slate-300 rounded-lg mb-4 text-center focus:border-blue-500 outline-none font-bold text-slate-700"
                                    autoFocus 
                                />
                                <div className="flex flex-col gap-2">
                                    <button 
                                        onClick={() => studentName.trim() ? handleDownload() : alert("Name required")} 
                                        className="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition flex items-center justify-center gap-2"
                                    >
                                        Download Submission
                                    </button>
                                    <button onClick={() => setShowDownload(false)} className="w-full py-2 text-slate-500 hover:bg-slate-50 rounded-lg text-sm">Cancel</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Clear Confirmation Modal */}
                    <ConfirmationModal 
                        isOpen={clearModalOpen}
                        title="Clear All & Exit?"
                        message="This will remove all student answers and lock Instructor Mode. This action cannot be undone."
                        onConfirm={handleClearConfirm}
                        onCancel={() => setClearModalOpen(false)}
                    />

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>