<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receivables Simulation: E5.49 & P5.53</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { 
            font-family: 'Inter', system-ui, -apple-system, sans-serif; 
            user-select: none; /* Prevent text selection */
            -webkit-user-select: none;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Input Styles */
        .input-base { transition: all 0.2s; outline: none; }
        .input-correct { background-color: #f0fdf4; color: #15803d; font-weight: 600; }
        .input-incorrect { background-color: #fef2f2; color: #b91c1c; }
        .input-neutral { background-color: #fff; }
        .input-neutral:focus { background-color: #f8fafc; box-shadow: inset 0 0 0 2px #3b82f6; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }

        /* Table Input Specifics */
        .table-input {
            width: 100%;
            height: 100%;
            padding: 8px;
            border: none;
            outline: none;
            font-family: 'Consolas', monospace;
            text-align: right;
            background: transparent;
        }

        /* Resize Handle */
        .resize-handle {
            width: 4px;
            cursor: col-resize;
            background-color: #e2e8f0;
            transition: background 0.2s;
            position: relative;
            z-index: 50;
        }
        .resize-handle:hover, .resize-handle.active {
            background-color: #3b82f6;
        }

        /* Clickable Numbers */
        .clickable-number {
            cursor: pointer;
            border-bottom: 1px dotted #94a3b8;
            transition: all 0.2s;
        }
        .clickable-number:hover {
            color: #2563eb;
            background-color: #eff6ff;
            border-bottom: 1px solid #2563eb;
            font-weight: 600;
        }

        /* STEALTH INSTRUCTOR BUTTON */
        .stealth-lock {
            position: absolute;
            top: 4px;
            right: 4px;
            background: none;
            border: none;
            color: #94a3b8; /* subtle slate */
            opacity: 0.1; /* Almost invisible */
            cursor: pointer;
            padding: 8px;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .stealth-lock:hover {
            opacity: 1;
            transform: scale(1.1);
            color: #334155;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen overflow-hidden" oncontextmenu="return false;">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- SECURITY UTILS ---
        
        // Helper to decode Base64 strings
        const d = (str) => {
            try {
                if (!str) return "";
                return atob(str);
            } catch (e) {
                console.error("Decoding error", e);
                return str;
            }
        };

        // --- MATH EVALUATION LOGIC ---
        const evaluateMath = (expr) => {
            if (!expr) return { valid: true, val: "" };
            try {
                // Sanitize: allow numbers, operators, parens, spaces, and %
                const sanitized = expr.toString().replace(/,/g, '').replace(/%/g, '/100');
                if (!/^[\d\.\+\-\*\/\(\)\s]+$/.test(sanitized)) return { valid: false, msg: "Invalid chars" };
                const res = eval(sanitized);
                if (!isFinite(res) || isNaN(res)) return { valid: false, msg: "Math Error" };
                return { valid: true, val: res };
            } catch (e) {
                return { valid: false, msg: "Syntax Error" };
            }
        };

        // --- DATA MATRIX (OBFUSCATED) ---
        // Originally WEISS_DATA
        const _DM_W = {
            metadata: { name: "Weiss Company", year: "Years 1-3" },
            tables: [
                {
                    title: "Credit Sales Activity",
                    headers: ["Year", "Credit Sales", "Collections", "Written Off"],
                    rows: [
                        ["Year 1", "733,000", "716,000", "5,300"],
                        ["Year 2", "857,000", "842,000", "5,800"],
                        ["Year 3", "945,000", "928,000", "6,500"]
                    ]
                },
                {
                    title: "Policy Information",
                    headers: ["Policy", "Rate"],
                    rows: [
                        ["Bad Debt Estimation", "1% of Credit Sales"],
                        ["Prior Allowance", "Zero at start of Year 1"]
                    ]
                }
            ]
        };

        // Originally WEISS_ANSWER_KEY
        const _KM_W = {
            // Req (a)
            "w_bd_exp_y1": "NzMzMA==", // 7330
            "w_bd_exp_y2": "ODU3MA==", // 8570
            "w_bd_exp_y3": "OTQ1MA==", // 9450
            // Req (b) - Gross AR
            "w_gross_y1": "MTE3MDA=", // 11700
            "w_gross_y2": "MjA5MDA=", // 20900
            "w_gross_y3": "MzE0MDA=", // 31400
            // Req (b) - Allowance
            "w_allow_y1": "MjAzMA==", // 2030
            "w_allow_y2": "NDgwMA==", // 4800
            "w_allow_y3": "Nzc1MA==", // 7750
            // Req (b) - Net AR
            "w_net_y1": "OTY3MA==", // 9670
            "w_net_y2": "MTYxMDA=", // 16100
            "w_net_y3": "MjM2NTA=", // 23650
            // Req (c)
            "w_concl": "aGlnaA==" // high
        };

        // Originally WEISS_QUESTIONS
        const _QM_W = [
            {
                id: "wq1", title: "Requirement (a): Bad Debt Expense", desc: "Calculate expense recognized each year (1% of sales).",
                sections: [
                    { 
                        type: "table",
                        subtitle: "Bad Debt Expense Schedule", 
                        headers: ["Year", "Sales", "Bad Debt Expense (1%)"],
                        rows: [
                            [{t:"text", v:"Year 1"}, {t:"text", v:"733,000"}, {t:"input", id:"w_bd_exp_y1"}],
                            [{t:"text", v:"Year 2"}, {t:"text", v:"857,000"}, {t:"input", id:"w_bd_exp_y2"}],
                            [{t:"text", v:"Year 3"}, {t:"text", v:"945,000"}, {t:"input", id:"w_bd_exp_y3"}]
                        ]
                    }
                ]
            },
            {
                id: "wq2", title: "Requirement (b): Balance Sheet Accounts", desc: "Compute ending balances. (Beg + Additions - Deductions)",
                sections: [
                    { 
                        type: "table",
                        subtitle: "Accounts Receivable, Gross", 
                        headers: ["Item", "Year 1", "Year 2", "Year 3"],
                        rows: [
                            [{t:"text", v:"Beginning Balance"}, {t:"text", v:"-"}, {t:"text", v:"11,700"}, {t:"text", v:"20,900"}],
                            [{t:"text", v:"Credit Sales"}, {t:"text", v:"733,000"}, {t:"text", v:"857,000"}, {t:"text", v:"945,000"}],
                            [{t:"text", v:"Collections"}, {t:"text", v:"(716,000)"}, {t:"text", v:"(842,000)"}, {t:"text", v:"(928,000)"}],
                            [{t:"text", v:"Write-offs"}, {t:"text", v:"(5,300)"}, {t:"text", v:"(5,800)"}, {t:"text", v:"(6,500)"}],
                            [{t:"text", v:"Ending Balance", bold:true}, {t:"input", id:"w_gross_y1"}, {t:"input", id:"w_gross_y2"}, {t:"input", id:"w_gross_y3"}],
                        ]
                    },
                    { 
                        type: "table",
                        subtitle: "Allowance for Doubtful Accounts", 
                        headers: ["Item", "Year 1", "Year 2", "Year 3"],
                        rows: [
                            [{t:"text", v:"Beginning Balance"}, {t:"text", v:"-"}, {t:"text", v:"2,030"}, {t:"text", v:"4,800"}],
                            [{t:"text", v:"Bad Debt Exp (from a)"}, {t:"input", id:"w_bd_exp_y1", readOnly: true}, {t:"input", id:"w_bd_exp_y2", readOnly: true}, {t:"input", id:"w_bd_exp_y3", readOnly: true}],
                            [{t:"text", v:"Write-offs"}, {t:"text", v:"(5,300)"}, {t:"text", v:"(5,800)"}, {t:"text", v:"(6,500)"}],
                            [{t:"text", v:"Ending Balance", bold:true}, {t:"input", id:"w_allow_y1"}, {t:"input", id:"w_allow_y2"}, {t:"input", id:"w_allow_y3"}],
                        ]
                    },
                    { 
                        type: "table",
                        subtitle: "Net Accounts Receivable", 
                        headers: ["Item", "Year 1", "Year 2", "Year 3"],
                        rows: [
                            [{t:"text", v:"A/R Gross"}, {t:"input", id:"w_gross_y1", readOnly:true}, {t:"input", id:"w_gross_y2", readOnly:true}, {t:"input", id:"w_gross_y3", readOnly:true}],
                            [{t:"text", v:"Less: Allowance"}, {t:"input", id:"w_allow_y1", readOnly:true}, {t:"input", id:"w_allow_y2", readOnly:true}, {t:"input", id:"w_allow_y3", readOnly:true}],
                            [{t:"text", v:"A/R Net", bold:true}, {t:"input", id:"w_net_y1"}, {t:"input", id:"w_net_y2"}, {t:"input", id:"w_net_y3"}],
                        ]
                    }
                ]
            },
            {
                id: "wq3", title: "Requirement (c): Evaluation", desc: "Analyze the trend.",
                sections: [
                    { 
                        type: "mcq",
                        subtitle: "Conclusion", 
                        fields: [{ 
                            id: "w_concl", 
                            label: "Based on the allowance accumulation, how does the 1% rate appear?",
                            options: [
                                { val: "low", text: "The 1% rate appears to be too low; write-offs exceed expense." },
                                { val: "high", text: "The 1% rate appears to be too high; allowance is growing significantly." },
                                { val: "correct", text: "The 1% rate appears appropriate; allowance is stable." }
                            ]
                        }] 
                    }
                ]
            }
        ];

        // --- DATA MATRIX (OBFUSCATED) ---
        // Originally LOLLAR_DATA
        const _DM_L = {
            metadata: { name: "Lollar Inc.", year: "FY1 - FY3" },
            tables: [
                {
                    title: "Financial Data ($ millions)",
                    headers: ["Item", "FY3", "FY2", "FY1"],
                    rows: [
                        ["Accounts receivable, net", "280", "288", "252"],
                        ["Allowance for uncollectible accts", "70", "32", "28"],
                        ["Sales, net", "2,500", "2,300", "2,000"]
                    ]
                }
            ]
        };

        // Originally LOLLAR_ANSWER_KEY
        const _KM_L = {
            // Req (a)
            "l_gross_fy3": "MzUw", // 350
            "l_gross_fy2": "MzIw", // 320
            "l_gross_fy1": "Mjgw", // 280
            // Req (b)
            "l_allow_pct_fy3": "MjA=", // 20
            "l_allow_pct_fy2": "MTA=", // 10
            "l_allow_pct_fy1": "MTA=", // 10
            "l_obs": "aW5jcmVhc2Vk", // increased
            // Req (c)
            "l_dso_fy3": "NDE=", // 41
            "l_dso_fy2": "NDM=", // 43
            "l_concl": "aW1wcm92ZWQ=", // improved
            // Req (d)
            "l_restated_net": "MzE1", // 315
            "l_restated_dso": "NDQ=", // 44
            "l_effect": "aW1wcm92ZWRfZHNv" // improved_dso
        };

        // Originally LOLLAR_QUESTIONS
        const _QM_L = [
            {
                id: "lq1", title: "Req (a): Compute AR Gross", desc: "AR (gross) = AR (net) + Allowance",
                sections: [
                    { 
                        type: "table",
                        subtitle: "Accounts Receivable, Gross",
                        headers: ["Item", "FY3", "FY2", "FY1"],
                        rows: [
                            [{t:"text", v:"A/R Net"}, {t:"text", v:"280"}, {t:"text", v:"288"}, {t:"text", v:"252"}],
                            [{t:"text", v:"Allowance"}, {t:"text", v:"70"}, {t:"text", v:"32"}, {t:"text", v:"28"}],
                            [{t:"text", v:"A/R Gross", bold:true}, {t:"input", id:"l_gross_fy3"}, {t:"input", id:"l_gross_fy2"}, {t:"input", id:"l_gross_fy1"}],
                        ]
                    }
                ]
            },
            {
                id: "lq2", title: "Req (b): Allowance %", desc: "Allowance % = Allowance / AR Gross",
                sections: [
                    { 
                        type: "table",
                        subtitle: "Allowance % Calculation",
                        headers: ["Item", "FY3", "FY2", "FY1"],
                        rows: [
                            [{t:"text", v:"Allowance / Gross"}, {t:"input", id:"l_allow_pct_fy3", type:"percent"}, {t:"input", id:"l_allow_pct_fy2", type:"percent"}, {t:"input", id:"l_allow_pct_fy1", type:"percent"}],
                        ]
                    },
                    { 
                        type: "mcq",
                        subtitle: "Observation", 
                        fields: [{ 
                            id: "l_obs", 
                            label: "Trend Analysis",
                            options: [
                                { val: "stable", text: "The allowance percentage remained stable across all years." },
                                { val: "increased", text: "The allowance percentage doubled in FY3, suggesting higher expected write-offs." },
                                { val: "decreased", text: "The allowance percentage decreased significantly in FY3." }
                            ]
                        }] 
                    }
                ]
            },
            {
                id: "lq3", title: "Req (c): Days Sales Outstanding (DSO)", desc: "Use Average Net AR. Round to nearest day.",
                sections: [
                    { 
                        type: "table",
                        subtitle: "DSO Calculation",
                        headers: ["Item", "FY3", "FY2"],
                        rows: [
                            [{t:"text", v:"Sales"}, {t:"text", v:"2,500"}, {t:"text", v:"2,300"}],
                            [{t:"text", v:"Avg Net AR"}, {t:"text", v:"284"}, {t:"text", v:"270"}],
                            [{t:"text", v:"DSO (Days)", bold:true}, {t:"input", id:"l_dso_fy3"}, {t:"input", id:"l_dso_fy2"}],
                        ]
                    },
                    { 
                        type: "mcq",
                        subtitle: "Conclusion", 
                        fields: [{ 
                            id: "l_concl", 
                            label: "Collection Performance",
                            options: [
                                { val: "worsened", text: "Collections slowed down in FY3 compared to FY2." },
                                { val: "improved", text: "Collections improved (faster) in FY3 compared to FY2." },
                                { val: "unchanged", text: "There was no material change in collection speed." }
                            ]
                        }] 
                    }
                ]
            },
            {
                id: "lq4", title: "Req (d): Restate FY3", desc: "Assume FY3 allowance % equals FY2 allowance % (10%). Recalculate Net AR and DSO.",
                sections: [
                     { 
                        type: "table",
                        subtitle: "Recalculation (FY3)",
                        headers: ["Item", "Value"],
                        rows: [
                            [{t:"text", v:"Restated Net AR"}, {t:"input", id:"l_restated_net"}],
                            [{t:"text", v:"Restated DSO"}, {t:"input", id:"l_restated_dso"}],
                        ]
                    },
                    { 
                        type: "mcq",
                        subtitle: "Effect Analysis", 
                        fields: [{ 
                            id: "l_effect", 
                            label: "Effect of increased allowance",
                            options: [
                                { val: "worsened_dso", text: "The increased allowance made the DSO appear worse (higher days)." },
                                { val: "improved_dso", text: "The increased allowance improved the reported DSO (lower days)." },
                                { val: "no_effect", text: "The allowance has no impact on DSO calculation." }
                            ]
                        }] 
                    }
                ]
            }
        ];

        // --- COMPONENTS ---

        const Icon = ({ name, size = 16, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (window.lucide && ref.current) {
                    ref.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    ref.current.appendChild(i);
                    window.lucide.createIcons({
                        root: ref.current,
                        nameAttr: 'data-lucide',
                        attrs: { width: size, height: size, "stroke-width": 2 }
                    });
                }
            }, [name, size]);
            return <span ref={ref} className={`inline-flex items-center justify-center ${className}`} style={{ width: size, height: size }}></span>;
        };

        const ConfirmationModal = ({ isOpen, title, message, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center backdrop-blur-sm animate-fade-in">
                    <div className="bg-white rounded-lg shadow-2xl max-w-sm w-full p-6 m-4">
                        <div className="flex items-center gap-3 text-red-600 mb-4">
                            <Icon name="alert-triangle" size={24} />
                            <h3 className="text-lg font-bold">{title}</h3>
                        </div>
                        <p className="text-slate-600 mb-6">{message}</p>
                        <div className="flex justify-end gap-3">
                            <button onClick={onCancel} className="px-4 py-2 text-slate-600 font-medium hover:bg-slate-100 rounded-lg">Cancel</button>
                            <button onClick={onConfirm} className="px-4 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700">Confirm</button>
                        </div>
                    </div>
                </div>
            );
        };

        const MultipleChoice = ({ id, value, onChange, options, correctValue, readOnly }) => {
            // Decode correctness check
            const decodedKey = d(correctValue);
            const isCorrect = value === decodedKey;
            
            return (
                <div className="space-y-2">
                    {options.map((opt) => (
                        <label key={opt.val} className={`flex items-start gap-3 p-3 rounded-lg border cursor-pointer transition-all ${
                            value === opt.val 
                                ? (isCorrect ? "bg-green-50 border-green-500 ring-1 ring-green-500" : "bg-red-50 border-red-300 ring-1 ring-red-300")
                                : "bg-white border-slate-200 hover:bg-slate-50"
                        }`}>
                            <input 
                                type="radio" 
                                name={id} 
                                value={opt.val} 
                                checked={value === opt.val} 
                                onChange={() => !readOnly && onChange(id, opt.val)}
                                disabled={readOnly}
                                className="mt-1"
                            />
                            <span className={`text-sm ${value === opt.val ? "font-semibold text-slate-800" : "text-slate-600"}`}>
                                {opt.text}
                            </span>
                            {value === opt.val && (
                                <span className="ml-auto">
                                    {isCorrect ? <span className="text-green-600"><Icon name="check-circle" size={18} /></span> : <span className="text-red-500"><Icon name="x-circle" size={18} /></span>}
                                </span>
                            )}
                        </label>
                    ))}
                </div>
            );
        };

        const CalculatorInput = ({ id, value, onChange, correctValue, type, readOnly, activeInput, setActiveInput }) => {
            const isCorrect = useMemo(() => {
                // Decode logic here
                const decodedKey = d(correctValue);
                if (!value || !decodedKey) return false;
                
                const { valid, val } = evaluateMath(value);
                if (!valid) return false;
                
                const target = parseFloat(decodedKey.replace(/,/g, ''));
                let inputNum = parseFloat(val);
                const tolerance = type === 'percent' ? 0.1 : Math.max(Math.abs(target * 0.02), 0.5); 

                if (type === 'percent') {
                    if (Math.abs(inputNum - target) <= tolerance) return true;
                    if (Math.abs((inputNum * 100) - target) <= tolerance) return true;
                    return false;
                } else {
                    return Math.abs(inputNum - target) <= tolerance;
                }
            }, [value, correctValue, type]);

            const handleBlur = () => {
                if (readOnly) return;
                const { valid, val } = evaluateMath(value);
                // Decode for formatting check
                const decodedKey = d(correctValue);
                
                if (valid && value !== "") {
                     const numVal = Number(val);
                     let displayVal = numVal;
                     if (type === 'percent') {
                        if (Math.abs(numVal) < 1 && parseFloat(decodedKey) > 1) { displayVal = (numVal * 100).toFixed(2); } 
                        else { displayVal = numVal.toFixed(2); }
                     } else {
                        displayVal = Number.isInteger(numVal) ? numVal.toString() : numVal.toFixed(2);
                     }
                     onChange(id, displayVal.toString()); 
                }
            };

            const statusClass = isCorrect ? "input-correct" : (value ? "input-incorrect" : "input-neutral");
            const activeClass = activeInput === id ? "ring-2 ring-blue-500 z-10" : "";

            return (
                <div className={`relative h-full w-full ${readOnly ? "bg-gray-50 text-gray-500" : statusClass} ${activeClass}`}>
                    <input 
                        type="text" 
                        id={id} 
                        value={value || ""}
                        onChange={(e) => !readOnly && onChange(id, e.target.value)}
                        onFocus={() => setActiveInput(id)}
                        onBlur={handleBlur}
                        readOnly={readOnly}
                        onKeyDown={(e) => e.key === 'Enter' && e.target.blur()}
                        className={`table-input ${readOnly ? "cursor-default" : ""}`}
                        placeholder={readOnly ? "" : "..."}
                    />
                    {!readOnly && isCorrect && <div className="absolute top-1 left-1 text-green-600 pointer-events-none opacity-50"><Icon name="check" size={12} /></div>}
                </div>
            );
        };

        const TableSection = ({ subtitle, headers, rows, inputs, onInputChange, keyData, activeInput, setActiveInput, onValueClick }) => {
            // Helper to determine if a cell text is a clickable number
            const isClickableNumber = (text) => {
                if (typeof text !== 'string') return false;
                const clean = text.replace(/[()]/g,'').replace(/,/g,'').trim();
                return /^-?\d+(\.\d+)?$/.test(clean);
            };

            return (
                <div className="mb-6 last:mb-0">
                    <h3 className="font-bold text-slate-700 mb-2 text-sm uppercase flex items-center gap-2">
                        <Icon name="grid" size={14} /> {subtitle}
                    </h3>
                    <div className="overflow-hidden rounded-lg border border-slate-200 shadow-sm">
                        <table className="w-full text-sm border-collapse bg-white">
                            <thead>
                                <tr className="bg-slate-50 border-b border-slate-200 text-slate-500">
                                    {headers.map((h, i) => (
                                        <th key={i} className={`p-3 font-semibold ${i===0 ? "text-left" : "text-right w-32"}`}>{h}</th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {rows.map((row, rI) => (
                                    <tr key={rI} className="hover:bg-slate-50/50">
                                        {row.map((cell, cI) => {
                                            if (cell.t === "text") {
                                                const clickable = isClickableNumber(cell.v);
                                                return (
                                                    <td 
                                                        key={cI} 
                                                        className={`p-3 text-slate-700 ${cI>0 ? "text-right" : ""} ${cell.bold ? "font-bold" : ""} ${clickable ? "clickable-number" : ""}`}
                                                        onClick={() => clickable && onValueClick(cell.v)}
                                                        title={clickable ? "Click to use value" : ""}
                                                    >
                                                        {cell.v}
                                                    </td>
                                                );
                                            } else if (cell.t === "input") {
                                                const val = inputs[cell.id] || "";
                                                return (
                                                    <td key={cI} className="p-0 border-l border-slate-100 h-10">
                                                        <CalculatorInput 
                                                            id={cell.id}
                                                            value={val}
                                                            onChange={onInputChange}
                                                            correctValue={keyData[cell.id]}
                                                            type={cell.type}
                                                            readOnly={cell.readOnly}
                                                            activeInput={activeInput}
                                                            setActiveInput={setActiveInput}
                                                        />
                                                    </td>
                                                );
                                            }
                                            return <td key={cI}></td>;
                                        })}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const ReferenceTable = ({ title, headers, rows, onValueClick }) => {
            const [isOpen, setIsOpen] = useState(false);
            return (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-4">
                    <button onClick={() => setIsOpen(!isOpen)} className="w-full flex items-center justify-between p-3 bg-slate-50 border-b border-slate-100 hover:bg-slate-100 transition">
                        <h4 className="font-bold text-slate-700 text-sm flex items-center gap-2">
                            <Icon name="table" size={16} /> {title}
                        </h4>
                        <Icon name={isOpen ? "chevron-up" : "chevron-down"} size={16} />
                    </button>
                    {isOpen && (
                        <div className="overflow-x-auto max-h-64">
                            <table className="w-full text-xs text-left">
                                <thead className="bg-slate-50 text-slate-500 uppercase tracking-wider sticky top-0">
                                    <tr>{headers.map((h, i) => <th key={i} className={`p-2 border-b font-medium ${i > 0 ? "text-right" : ""}`}>{h}</th>)}</tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {rows.map((row, rI) => (
                                        <tr key={rI} className="hover:bg-blue-50 transition-colors group">
                                            <td className="p-2 font-medium text-slate-700">{row[0]}</td>
                                            {row.slice(1).map((cell, cI) => (
                                                <td key={cI} onClick={() => onValueClick(cell)} className="p-2 text-right font-mono text-slate-600 cursor-pointer hover:text-blue-700 hover:font-bold decoration-dotted" title="Insert">{cell}</td>
                                            ))}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('weiss');
            const [inputs, setInputs] = useState({});
            const [activeInput, setActiveInput] = useState(null);
            
            // Layout State
            const [sidebarWidth, setSidebarWidth] = useState(350);
            const [isResizing, setIsResizing] = useState(false);
            
            // Instructor State
            const [instructorMode, setInstructorMode] = useState(false);
            const [showLogin, setShowLogin] = useState(false);
            const [password, setPassword] = useState("");
            const [clearModalOpen, setClearModalOpen] = useState(false);
            
            // Hash Tool
            const [hashInput, setHashInput] = useState("");
            const [verifiedResult, setVerifiedResult] = useState(null);
            const [studentName, setStudentName] = useState("");
            const [showDownload, setShowDownload] = useState(false);

            // UPDATED: Obfuscated References
            const activeData = activeTab === 'weiss' ? _DM_W : _DM_L;
            const activeQuestions = activeTab === 'weiss' ? _QM_W : _QM_L;
            const activeKey = activeTab === 'weiss' ? _KM_W : _KM_L;

            // Resize Logic
            const startResizing = useCallback(() => setIsResizing(true), []);
            const stopResizing = useCallback(() => setIsResizing(false), []);
            const resize = useCallback((e) => {
                if (isResizing) {
                    setSidebarWidth(prev => Math.max(250, Math.min(e.clientX, 600)));
                }
            }, [isResizing]);

            useEffect(() => {
                window.addEventListener("mousemove", resize);
                window.addEventListener("mouseup", stopResizing);
                return () => {
                    window.removeEventListener("mousemove", resize);
                    window.removeEventListener("mouseup", stopResizing);
                };
            }, [resize, stopResizing]);

            const handleInputChange = (id, val) => setInputs(prev => ({ ...prev, [id]: val }));

            const handleValueClick = (val) => {
                if (!activeInput) return;
                // Clean the value from the table (remove commas/parens)
                const cleanVal = val.toString().replace(/,/g, '').replace(/[()]/g, (m) => m === '(' ? '-' : '');
                
                setInputs(prev => {
                    let cur = (prev[activeInput] || "").toString();
                    
                    // Logic: 
                    // 1. If empty, just set.
                    // 2. If ends in operator, append.
                    // 3. If ends in number, replace that number.
                    
                    // Regex to find trailing number: allows optional negative, digits, optional decimal, digits. 
                    // Anchored to end of string ($).
                    // Does NOT match if there's an operator after the number (e.g. "10 +").
                    const trailingNumberRegex = /(-?(\d{1,3}(,\d{3})*|\d+)(\.\d+)?)$/;
                    
                    // Check if it ends in an operator (ignoring spaces)
                    const endsWithOperator = /[\+\-\*\/]\s*$/.test(cur);
                    
                    let newVal = cur;
                    
                    if (cur.trim() === "") {
                        newVal = cleanVal;
                    } else if (endsWithOperator) {
                        // Just append
                        newVal = cur + cleanVal;
                    } else if (trailingNumberRegex.test(cur)) {
                        // Replace the trailing number
                        newVal = cur.replace(trailingNumberRegex, cleanVal);
                    } else {
                        // Fallback (e.g. cursor in weird spot or unknown format), just append? 
                        // Or maybe replace whole thing? Let's assume append for safety if regex fails,
                        // but practically the regex covers numbers.
                        // Actually, if it's "100", regex matches "100". Replace with new.
                        newVal = cur + cleanVal; // Fallback
                    }
                    
                    return { ...prev, [activeInput]: newVal };
                });

                // Restore focus to the input
                setTimeout(() => {
                    const el = document.getElementById(activeInput);
                    if (el) {
                        el.focus();
                        // Optional: set cursor to end
                        // el.setSelectionRange(el.value.length, el.value.length);
                    }
                }, 0);
            };

            const unlockInstructor = () => {
                // Security: Password Hashing (Base64)
                // "teacher" -> dGVhY2hlcg==
                if (btoa(password) === 'dGVhY2hlcg==') {
                    setInstructorMode(true);
                    setShowLogin(false);
                    setPassword("");
                } else {
                    alert("Incorrect Password");
                }
            };

            const handleAutoFill = () => {
                // Decode keys before filling
                const decodedKey = {};
                Object.keys(activeKey).forEach(k => {
                    decodedKey[k] = d(activeKey[k]);
                });
                setInputs(prev => ({ ...prev, ...decodedKey }));
            };

            const handleClearConfirm = () => {
                setInputs({});
                setClearModalOpen(false);
                setInstructorMode(false); 
            };

            const verifyHash = () => {
                try {
                    const decoded = atob(hashInput);
                    const data = JSON.parse(decoded);
                    setVerifiedResult(data);
                } catch (e) {
                    setVerifiedResult({ error: "Invalid Hash" });
                }
            };

            const handleDownload = () => {
                const timestamp = new Date().toLocaleString();
                let correctCount = 0;
                let totalCount = 0;
                
                Object.keys(activeKey).forEach(key => {
                    totalCount++;
                    const userVal = (inputs[key] || "").toString().trim().toLowerCase();
                    // Decode key for comparison
                    const keyVal = d(activeKey[key] || "").toString().trim().toLowerCase();
                    let isCorrect = false;
                    
                    if(!isNaN(parseFloat(keyVal)) && !isNaN(parseFloat(userVal.replace(/,/g,'')))) {
                         const u = parseFloat(userVal.replace(/,/g,''));
                         const k = parseFloat(keyVal);
                         if (Math.abs(u-k) < Math.max(k*0.02, 0.5)) isCorrect = true;
                    } else {
                        if (userVal === keyVal || userVal.includes(keyVal)) isCorrect = true;
                    }
                    if (isCorrect) correctCount++;
                });
                
                const verificationHash = btoa(JSON.stringify({ name: studentName, score: `${correctCount}/${totalCount}`, date: new Date().toISOString(), module: activeTab }));

                const content = `
FINANCIAL SIMULATION REPORT: ${activeTab.toUpperCase()}
-------------------------------------
Student: ${studentName}
Date: ${timestamp}
Score: ${correctCount} / ${totalCount}
Verification Hash: ${verificationHash}

ANSWERS SUBMITTED (${activeTab}):
-------------------------------------
${Object.keys(activeKey).map(k => `${k}: ${inputs[k] || "[Empty]"}`).join('\n')}
                `.trim();

                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${studentName.replace(/\s+/g, '_')}_${activeTab}_Submission.txt`;
                a.click();
                setShowDownload(false);
            };

            return (
                <div className="flex h-screen bg-slate-100 overflow-hidden font-sans">
                    
                    {/* LEFT SIDEBAR: REFERENCE */}
                    <div 
                        className="bg-slate-50 border-r border-slate-200 overflow-y-auto custom-scrollbar flex flex-col relative shrink-0"
                        style={{ width: sidebarWidth }}
                    >
                        <div className="sticky top-0 bg-white p-4 border-b border-slate-200 shadow-sm z-10">
                            <div className="flex items-center gap-2 text-blue-800 font-bold text-lg mb-1">
                                <Icon name="library" /> Reference Data
                            </div>
                            <p className="text-xs text-slate-500 font-bold uppercase tracking-wider">{activeData.metadata.name}</p>
                            <p className="text-xs text-blue-600 mt-1 flex items-center gap-1">
                                <Icon name="mouse-pointer-click" size={12} /> Click values to insert into calculator cells
                            </p>
                        </div>
                        <div className="p-4 space-y-2">
                            {activeData.tables.map((tbl, i) => (
                                <ReferenceTable 
                                    key={i}
                                    title={tbl.title} 
                                    headers={tbl.headers} 
                                    rows={tbl.rows} 
                                    onValueClick={handleValueClick} 
                                />
                            ))}
                        </div>
                    </div>

                    {/* RESIZE HANDLE */}
                    <div 
                        className={`resize-handle ${isResizing ? 'active' : ''}`}
                        onMouseDown={startResizing}
                    ></div>

                    {/* MAIN CONTENT */}
                    <div className="flex-1 flex flex-col h-screen overflow-hidden relative">
                        
                        {/* TOP NAV TABS */}
                        <div className="bg-slate-800 text-white flex shrink-0">
                            <button 
                                onClick={() => setActiveTab('weiss')}
                                className={`flex-1 py-3 text-sm font-bold flex items-center justify-center gap-2 transition-colors ${activeTab === 'weiss' ? 'bg-blue-600 text-white' : 'hover:bg-slate-700 text-slate-400'}`}
                            >
                                <Icon name="calculator" size={16} /> Weiss Company (E5.49)
                            </button>
                            <button 
                                onClick={() => setActiveTab('lollar')}
                                className={`flex-1 py-3 text-sm font-bold flex items-center justify-center gap-2 transition-colors ${activeTab === 'lollar' ? 'bg-blue-600 text-white' : 'hover:bg-slate-700 text-slate-400'}`}
                            >
                                <Icon name="bar-chart-big" size={16} /> Lollar Inc. (P5.53)
                            </button>
                        </div>

                        {/* INSTRUCTOR TOOLBAR (STICKY) */}
                        {instructorMode && (
                            <div className="bg-purple-700 text-white p-2 shadow-md flex items-center justify-between z-20 animate-fade-in shrink-0">
                                <div className="flex items-center gap-3 px-4">
                                    <span className="bg-white/20 p-1.5 rounded"><Icon name="graduation-cap" /></span>
                                    <span className="font-bold tracking-wide">INSTRUCTOR MODE</span>
                                </div>
                                <div className="flex gap-2 px-4">
                                    <button onClick={handleAutoFill} className="flex items-center gap-2 px-3 py-1 bg-green-500 hover:bg-green-600 rounded text-sm font-bold transition">
                                        <Icon name="wand-2" size={14} /> Auto-Fill Tab
                                    </button>
                                    <button onClick={() => setClearModalOpen(true)} className="flex items-center gap-2 px-3 py-1 bg-red-500 hover:bg-red-600 rounded text-sm font-bold transition">
                                        <Icon name="log-out" size={14} /> Clear & Exit
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* HEADER */}
                        <header className="bg-white border-b border-slate-200 p-6 flex justify-between items-center shrink-0 relative">
                            <div>
                                <h1 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
                                    <Icon name="file-spreadsheet" className="text-blue-600" /> {activeData.metadata.name}
                                </h1>
                                <p className="text-slate-500 text-sm mt-1">Estimating Uncollectible Accounts & Receivables Analysis</p>
                            </div>
                            <div className="flex gap-3">
                                <button onClick={() => setShowDownload(true)} className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-sm transition">
                                    <Icon name="save" size={18} /> Save Work
                                </button>
                                {/* STEALTH BUTTON HERE */}
                                <button 
                                    className="stealth-lock" 
                                    onClick={() => setShowLogin(true)} 
                                    title="System"
                                >
                                    <Icon name="lock" size={14} />
                                </button>
                            </div>
                        </header>

                        {/* SCROLLABLE FORM AREA */}
                        <main className="flex-1 overflow-y-auto custom-scrollbar bg-slate-50/50 p-8 pb-20">
                            <div className="max-w-4xl mx-auto space-y-8">
                                {activeQuestions.map((q) => (
                                    <div key={q.id} className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 animate-fade-in">
                                        <h2 className="text-lg font-bold text-slate-800 mb-2 border-b pb-2 flex items-center gap-2">
                                            <span className="bg-blue-100 text-blue-700 w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold">{q.id.replace(/^(wq|lq)/,'')}</span>
                                            {q.title}
                                        </h2>
                                        <p className="text-sm text-slate-500 mb-6 italic">{q.desc}</p>
                                        
                                        {q.sections && q.sections.map((sec, idx) => (
                                            <div key={idx}>
                                                {sec.type === "table" ? (
                                                    <TableSection 
                                                        subtitle={sec.subtitle}
                                                        headers={sec.headers}
                                                        rows={sec.rows}
                                                        inputs={inputs}
                                                        onInputChange={handleInputChange}
                                                        keyData={activeKey}
                                                        activeInput={activeInput}
                                                        setActiveInput={setActiveInput}
                                                        onValueClick={handleValueClick}
                                                    />
                                                ) : sec.type === "mcq" ? (
                                                    <div className="mb-6 last:mb-0">
                                                        <h3 className="font-bold text-slate-700 mb-2 text-sm uppercase">{sec.subtitle}</h3>
                                                        <div className="bg-slate-50 p-4 rounded-lg border border-slate-200">
                                                            <label className="block text-xs font-bold text-slate-500 mb-3 uppercase tracking-wider">{sec.fields[0].label}</label>
                                                            <MultipleChoice 
                                                                id={sec.fields[0].id}
                                                                value={inputs[sec.fields[0].id]}
                                                                onChange={handleInputChange}
                                                                options={sec.fields[0].options}
                                                                correctValue={activeKey[sec.fields[0].id]}
                                                                readOnly={instructorMode && activeKey[sec.fields[0].id]} // Just allowing normal interaction unless purely readonly
                                                            />
                                                        </div>
                                                    </div>
                                                ) : null}
                                            </div>
                                        ))}
                                    </div>
                                ))}

                                {/* Instructor Only: Hash Verification Tool */}
                                {instructorMode && (
                                    <div className="bg-slate-800 rounded-xl shadow-lg border border-slate-700 p-6 text-slate-200 mt-12">
                                        <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                                            <Icon name="shield-check" className="text-green-400" /> Verification Tool
                                        </h3>
                                        <div className="flex gap-4 items-start">
                                            <div className="flex-1">
                                                <label className="text-xs font-bold text-slate-400 mb-1 block">PASTE STUDENT HASH</label>
                                                <textarea 
                                                    className="w-full bg-slate-900 border-slate-700 rounded p-2 text-xs font-mono text-green-400 focus:ring-1 focus:ring-green-500 outline-none"
                                                    rows="3"
                                                    placeholder="Paste base64 hash string here..."
                                                    value={hashInput}
                                                    onChange={(e) => setHashInput(e.target.value)}
                                                ></textarea>
                                            </div>
                                            <button 
                                                onClick={verifyHash}
                                                className="mt-6 px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded font-bold text-sm"
                                            >
                                                Verify
                                            </button>
                                        </div>
                                        {verifiedResult && (
                                            <div className="mt-4 p-4 bg-slate-900 rounded border border-slate-700">
                                                {verifiedResult.error ? (
                                                    <p className="text-red-400 font-bold flex items-center gap-2"><Icon name="x-circle" /> {verifiedResult.error}</p>
                                                ) : (
                                                    <div className="grid grid-cols-2 gap-4 text-sm">
                                                        <div><span className="text-slate-500">Student:</span> <span className="text-white font-bold">{verifiedResult.name}</span></div>
                                                        <div><span className="text-slate-500">Score:</span> <span className="text-green-400 font-bold">{verifiedResult.score}</span></div>
                                                        <div><span className="text-slate-500">Date:</span> <span className="text-slate-300">{new Date(verifiedResult.date).toLocaleString()}</span></div>
                                                        <div><span className="text-slate-500">Module:</span> <span className="text-blue-400 font-bold uppercase">{verifiedResult.module}</span></div>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </main>
                    </div>

                    {/* MODALS */}
                    
                    {/* Login Modal */}
                    {showLogin && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center animate-fade-in">
                            <div className="bg-white p-6 rounded-xl shadow-2xl w-80 transform transition-all">
                                <h3 className="font-bold text-lg mb-4 text-slate-800 flex items-center gap-2">
                                    <Icon name="lock" size={20} className="text-blue-600" /> Instructor Access
                                </h3>
                                <input 
                                    type="password" 
                                    className="w-full border p-3 rounded-lg mb-4 outline-none focus:border-blue-500" 
                                    placeholder="Enter password"
                                    value={password} 
                                    onChange={(e) => setPassword(e.target.value)}
                                    onKeyDown={(e) => e.key === 'Enter' && unlockInstructor()}
                                    autoFocus
                                />
                                <div className="flex justify-end gap-2">
                                    <button onClick={() => setShowLogin(false)} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg text-sm font-medium">Cancel</button>
                                    <button onClick={unlockInstructor} className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-bold">Unlock</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Download Modal */}
                    {showDownload && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center animate-fade-in">
                            <div className="bg-white p-8 rounded-xl shadow-2xl w-96">
                                <div className="text-center mb-6">
                                    <div className="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3 text-blue-600">
                                        <Icon name="download-cloud" size={24} />
                                    </div>
                                    <h3 className="text-xl font-bold text-slate-800">Submit Assignment</h3>
                                    <p className="text-slate-500 text-sm mt-1">Enter your name to generate your submission file.</p>
                                </div>
                                <input 
                                    type="text" 
                                    value={studentName} 
                                    onChange={(e) => setStudentName(e.target.value)} 
                                    placeholder="Your Full Name" 
                                    className="w-full p-3 border border-slate-300 rounded-lg mb-4 text-center focus:border-blue-500 outline-none font-bold text-slate-700"
                                    autoFocus 
                                />
                                <div className="flex flex-col gap-2">
                                    <button 
                                        onClick={() => studentName.trim() ? handleDownload() : alert("Name required")} 
                                        className="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition flex items-center justify-center gap-2"
                                    >
                                        Download Submission
                                    </button>
                                    <button onClick={() => setShowDownload(false)} className="w-full py-2 text-slate-500 hover:bg-slate-50 rounded-lg text-sm">Cancel</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Clear Confirmation Modal */}
                    <ConfirmationModal 
                        isOpen={clearModalOpen}
                        title="Clear All & Exit?"
                        message="This will remove all student answers and lock Instructor Mode. This action cannot be undone."
                        onConfirm={handleClearConfirm}
                        onCancel={() => setClearModalOpen(false)}
                    />

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
