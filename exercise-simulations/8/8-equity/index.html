<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equity & Comprehensive Income Analysis: Case 8-37, 8-44 & 8-45</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Input Styles */
        .input-base { transition: all 0.2s; outline: none; }
        .input-correct { background-color: #f0fdf4; border-color: #22c55e; color: #15803d; font-weight: 600; }
        .input-incorrect { background-color: #fef2f2; border-color: #ef4444; }
        .input-neutral { background-color: #fff; border-color: #cbd5e1; }
        .input-neutral:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

        /* Resizer */
        .resizer {
            width: 5px;
            cursor: col-resize;
            background-color: transparent;
            transition: background-color 0.2s;
            z-index: 50;
        }
        .resizer:hover, .resizer.resizing {
            background-color: #3b82f6;
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- DATA: CAMPBELL SOUP ---
        const CAMPBELL_DATA = {
            metadata: { name: "Campbell Soup Co. (E8-37)", year: "Current Year" },
            tables: [
                {
                    title: "Statement of Shareholders' Equity ($ millions, except per share)",
                    headers: [
                        "Account / Transaction", 
                        "Cap. Stock Issued (Shares)", "Cap. Stock Issued ($)", 
                        "In Treasury (Shares)", "In Treasury ($)", 
                        "APIC", "Retained Earnings", "Acc. OCI", "Non-controlling Interests", "Total Equity"
                    ],
                    rows: [
                        ["Balance at start of current year", "323", "$12", "(22)", "$(1,066)", "$359", "$2,385", "$(53)", "$8", "$1,645"],
                        ["Net earnings", "", "", "", "", "", "261", "", "", "261"],
                        ["Other comprehensive income (loss)", "", "", "", "", "", "", "(65)", "1", "(64)"],
                        ["Dividends ($1.40 per share)", "", "", "", "", "", "(422)", "", "", "(422)"],
                        ["Treasury stock purchased", "", "", "(2)", "$(86)", "", "", "", "", "(86)"],
                        ["Treasury stock issued (options)", "", "", "2", "49", "(10)", "", "", "", "39"],
                        ["Balance at end of current year", "323", "$12", "(22)", "$(1,103)", "$349", "$2,224", "$(118)", "$9", "$1,373"]
                    ],
                    hint: "Use these values for calculations"
                },
                {
                    title: "Additional Information",
                    headers: ["Item", "Value"],
                    rows: [
                        ["Authorized Shares", "560 million"],
                        ["Par Value", "$0.0375"],
                        ["Stock Price (End of Year)", "$32.99"]
                    ],
                    hint: "Market Data"
                }
            ]
        };

        const CAMPBELL_ANSWER_KEY = {
            "c_cap_bal": "12.1125",
            "c_avg_issue": "1.12",
            "c_re_beg": "2385", "c_re_net": "261", "c_re_div": "422", "c_re_end": "2224",
            "c_opt_cash": "39", "c_opt_ts": "49", "c_opt_apic": "10",
            "c_ts_cost": "43", "c_ts_total": "86",
            "c_mkt_cap": "9929.99",
            "c_mb_ratio": "7.23"
        };

        const CAMPBELL_EXPLANATIONS = {
            "c_cap_bal": `Shares issued: 323\nPar value per share: 0.0375\nPar value ($ millions): 12.1125`,
            "c_avg_issue": `Capital stock: 12\nAdditional paid-in capital: 349\nTotal: 361\nShares issued: 323\nAverage price per share: 1.12`,
            "c_re_end": `Retained earnings (Beg): 2,385\nNet earnings: 261\nDividends: (422)\nRetained earnings (End): 2,224`,
            "c_opt_apic": `The exercise of employee stock options resulted in the issuance of 2 million shares of stock for a total of $39 million. Because the treasury stock shares were sold, the treasury stock account is reduced (an addition reduces the negative amount for treasury stock) by the original purchase cost of the shares ($49 million) and additional paid-in capital is decreased for the difference ($10 million).`,
            "c_ts_cost": `Campbell Soup repurchased 2 million shares of common stock for a total of $86 million, or at a cost of $43 per share. The effect of the repurchase of stock is to reduce cash and shareowners’ equity, thereby shrinking the company.`,
            "c_mkt_cap": `Shares issued: 323\nTreasury shares: 22\nShares outstanding: 301\nStock price at year end: 32.99\nMarket capitalization ($ millions): 301 × 32.99 = 9,929.99`,
            "c_mb_ratio": `Market capitalization: 9,929.99\nBook value of equity: 1,373\nMarket-to-book ratio: 7.23\n\nInterpretation: The market-to-book ratio is significantly above 1. This means that the market values the company's net assets at more than dollar for dollar. This is a sign that the market expects the company to grow and deliver higher net income and/or dividends.`
        };

        const CAMPBELL_QUESTIONS = [
            {
                id: "cq1", title: "1. Capital Stock Computation", desc: "Show the computation, using par value and share numbers, to arrive at the $12 million in the capital (common) stock account.",
                sections: [
                    { subtitle: "Calculation", fields: [
                        { id: "c_cap_bal", label: "Computed Capital Stock ($m)", type: "decimal", hint: "Issued Shares * Par Value" }
                    ]}
                ]
            },
            {
                id: "cq2", title: "2. Average Issue Price", desc: "At what average price were the Campbell Soup shares issued?",
                sections: [
                    { subtitle: "Calculation", fields: [
                        { id: "c_avg_issue", label: "Avg Issue Price ($/share)", type: "currency", hint: "(Capital Stock + APIC) / Issued Shares" }
                    ]}
                ]
            },
            {
                id: "cq3", title: "3. Retained Earnings Reconciliation", desc: "Reconcile the beginning and ending balances of retained earnings.",
                sections: [
                    { subtitle: "Reconciliation", fields: [
                        { id: "c_re_beg", label: "Beginning Balance ($m)", type: "currency" },
                        { id: "c_re_net", label: "Add: Net Earnings ($m)", type: "currency" },
                        { id: "c_re_div", label: "Less: Dividends ($m)", type: "currency" },
                        { id: "c_re_end", label: "Ending Balance ($m)", type: "currency" }
                    ]}
                ]
            },
            {
                id: "cq4", title: "4. Stock Options Analysis", desc: "Campbell Soup reports an increase in shareowners' equity relating to the exercise of stock options (titled 'Treasury stock issued under management incentive and stock option plans'). This transaction involves the purchase of common stock by employees at a preset price. Quantify the components.",
                sections: [
                    { subtitle: "Impact Analysis", fields: [
                        { id: "c_opt_cash", label: "Cash Received / Total Issuance Value ($m)", type: "currency", hint: "Total increase in equity from options" },
                        { id: "c_opt_ts", label: "Treasury Stock Reduction (Cost Basis) ($m)", type: "currency", hint: "Original cost of shares issued" },
                        { id: "c_opt_apic", label: "APIC Reduction ($m)", type: "currency", hint: "Difference absorbed by APIC" }
                    ]}
                ]
            },
            {
                id: "cq5", title: "5. Treasury Stock Purchase", desc: "Describe the transaction relating to the 'Treasury stock purchased' line in the statement of shareowners' equity by determining the cost per share.",
                sections: [
                    { subtitle: "Cost Analysis", fields: [
                        { id: "c_ts_total", label: "Total Cost of Repurchase ($m)", type: "currency" },
                        { id: "c_ts_cost", label: "Cost Per Share ($)", type: "currency", hint: "Total Cost / Shares Repurchased" }
                    ]}
                ]
            },
            {
                id: "cq6", title: "6. Market Capitalization", desc: "Campbell Soup's stock price was $32.99 at the end of the current fiscal year. Determine the company's market capitalization that day.",
                sections: [
                    { subtitle: "Market Capitalization", fields: [
                        { id: "c_mkt_cap", label: "Market Cap ($m)", type: "currency", hint: "(Issued - Treasury Shares) * Share Price" }
                    ]}
                ]
            },
            {
                id: "cq7", title: "7. Market-to-Book Ratio", desc: "Calculate and interpret the company's market-to-book ratio at the end of the current fiscal year.",
                sections: [
                    { subtitle: "Ratio Analysis", fields: [
                        { id: "c_mb_ratio", label: "M/B Ratio", type: "decimal", hint: "Market Cap / Total Equity" }
                    ]}
                ]
            }
        ];

        // --- DATA: SYSCO (CASE 8-44) ---
        const SYSCO_DATA = {
            metadata: { name: "Sysco Corp.", year: "Case 8-44" },
            tables: [
                {
                    title: "Consolidated Stmts of Comp. Income ($000s)",
                    headers: ["Item", "Current", "Prior", "2 Yrs Prior"],
                    rows: [
                        ["Net earnings", "1,358,768", "524,209", "215,475"],
                        ["Foreign currency translation adj.", "(461,425)", "362,292", "(112,215)"],
                        ["Amortization of cash flow hedges", "8,624", "8,812", "8,620"],
                        ["Change in net investment hedges", "53,930", "(24,155)", "43,529"],
                        ["Change in cash flow hedges", "24,312", "14,125", "(7,257)"],
                        ["Amortization of prior service cost", "296", "548", "5,712"],
                        ["Amortization of actuarial loss", "59,118", "46,695", "38,934"],
                        ["Actuarial gain (loss)", "(8,758)", "156,480", "(92,743)"],
                        ["Change in marketable securities", "(9,387)", "(2,680)", "4,268"],
                        ["Total other comprehensive (loss) income", "(333,290)", "562,117", "(111,152)"],
                        ["Comprehensive income", "1,025,478", "1,086,326", "104,323"]
                    ],
                    hint: "Income Data"
                },
                {
                    title: "Balance Sheet Averages ($000s)",
                    headers: ["Measure", "Current", "Prior", "2 Yrs Prior"],
                    rows: [
                        ["Average assets", "21,749,614", "22,020,903", "20,297,394"],
                        ["Average equity", "1,467,578", "1,355,755", "1,830,608"]
                    ],
                    hint: "Balance Sheet Data"
                }
            ]
        };

        const SYSCO_ANSWER_KEY = {
            "s_formula_oci": "Other Comprehensive Income|OCI",
            "s_oci_driver": "foreign",
            "s_roa_ni_cur": "6.2", "s_roa_ni_pri": "2.4", "s_roa_ni_2p": "1.1",
            "s_roe_ni_cur": "92.6", "s_roe_ni_pri": "38.7", "s_roe_ni_2p": "11.8",
            "s_roa_ci_cur": "4.7", "s_roa_ci_pri": "4.9", "s_roa_ci_2p": "0.5",
            "s_roe_ci_cur": "69.9", "s_roe_ci_pri": "80.1", "s_roe_ci_2p": "5.7",
            "s_interp_mag": "large", "s_interp_impact": "are"
        };

        const SYSCO_EXPLANATIONS = {
            "s_formula_oci": "During the year, market values change the unrealized gains and losses in AOCI. These changes do not flow to the income statement as they are not part of net income. Instead, those changes are aggregated and labeled other comprehensive income (OCI). The total change in AOCI for the year (on the balance sheet) is labeled other comprehensive income. Another definition is: CI = Net income + OCI.",
            "s_oci_driver": "The chief difference is the large gains/losses from the foreign currency translation. This arises because the company has net assets (likely subsidiaries) in other countries. The exchange rates for those foreign currencies changed each year causing there to be an unrealized gain or loss.",
            // ROA NET INCOME (Streamlined)
            "s_roa_ni_2p": "215,475 / 20,297,394 = 1.1%",
            "s_roa_ni_pri": "524,209 / 22,020,903 = 2.4%",
            "s_roa_ni_cur": "1,358,768 / 21,749,614 = 6.2%",
            // ROE NET INCOME (Streamlined)
            "s_roe_ni_2p": "215,475 / 1,830,608 = 11.8%",
            "s_roe_ni_pri": "524,209 / 1,355,755 = 38.7%",
            "s_roe_ni_cur": "1,358,768 / 1,467,578 = 92.6%",
            // ROA COMP INCOME (Streamlined)
            "s_roa_ci_2p": "104,323 / 20,297,394 = 0.5%",
            "s_roa_ci_pri": "1,086,326 / 22,020,903 = 4.9%",
            "s_roa_ci_cur": "1,025,478 / 21,749,614 = 4.7%",
            // ROE COMP INCOME (Streamlined)
            "s_roe_ci_2p": "104,323 / 1,830,608 = 5.7%",
            "s_roe_ci_pri": "1,086,326 / 1,355,755 = 80.1%",
            "s_roe_ci_cur": "1,025,478 / 1,467,578 = 69.9%",
            // Interpretation
            "s_interp_mag": "The ratios are significantly different. The company reports large other comprehensive losses in the current year and two years prior, and a gain in the prior year. This causes the comprehensive income to swing dramatically. The chief reason is the translation of foreign currency denominated net assets, which is hard to predict and fluctuates for reasons beyond the company's control."
        };

        const SYSCO_QUESTIONS = [
            {
                id: "sqa", title: "Part (a): Net vs Comprehensive Income", desc: "Explain the relationship.",
                sections: [{ subtitle: "Formula", fields: [{ id: "s_formula_oci", label: "Complete the formula: Net Income + ____________ = Comprehensive Income", type: "text", fullWidth: true }] }]
            },
            {
                id: "sq1", title: "Part (b): OCI Drivers", desc: "Identify the line item that causes the largest difference between Net Income and Comprehensive Income.",
                sections: [{ subtitle: "Analysis", fields: [{ id: "s_oci_driver", label: "Largest OCI Component (All Years)", type: "text", fullWidth: true }] }]
            },
            {
                id: "sq2", title: "Part (c): Returns using Net Income", desc: "Calculate ROA and ROE using Net Income.",
                type: "ratio_table",
                tables: [
                    {
                        title: "Return on Assets (ROA)", headers: ["Year", "ROA %"], hint: "Net Income / Avg Assets", chartKey: "roa_ni",
                        rows: [
                            { label: "Two Years Prior", id: "s_roa_ni_2p" },
                            { label: "Prior Year", id: "s_roa_ni_pri" },
                            { label: "Current Year", id: "s_roa_ni_cur" }
                        ]
                    },
                    {
                        title: "Return on Equity (ROE)", headers: ["Year", "ROE %"], hint: "Net Income / Avg Equity", chartKey: "roe_ni",
                        rows: [
                            { label: "Two Years Prior", id: "s_roe_ni_2p" },
                            { label: "Prior Year", id: "s_roe_ni_pri" },
                            { label: "Current Year", id: "s_roe_ni_cur" }
                        ]
                    }
                ]
            },
            {
                id: "sq3", title: "Part (d): Returns using Comprehensive Income", desc: "Recalculate using Comprehensive Income.",
                type: "ratio_table",
                tables: [
                    {
                        title: "Adjusted ROA (Comp. Income)", headers: ["Year", "Adj ROA %"], hint: "Comp. Income / Avg Assets", chartKey: "roa_ci",
                        rows: [
                            { label: "Two Years Prior", id: "s_roa_ci_2p" },
                            { label: "Prior Year", id: "s_roa_ci_pri" },
                            { label: "Current Year", id: "s_roa_ci_cur" }
                        ]
                    },
                    {
                        title: "Adjusted ROE (Comp. Income)", headers: ["Year", "Adj ROE %"], hint: "Comp. Income / Avg Equity", chartKey: "roe_ci",
                        rows: [
                            { label: "Two Years Prior", id: "s_roe_ci_2p" },
                            { label: "Prior Year", id: "s_roe_ci_pri" },
                            { label: "Current Year", id: "s_roe_ci_cur" }
                        ]
                    }
                ]
            },
            {
                id: "sq4", title: "Interpretation", desc: "Select the correct conclusions based on the data.",
                type: "interpretation_text"
            }
        ];

        const CHART_DATA = {
            "roa_ni": [1.1, 2.4, 6.2], "roe_ni": [11.8, 38.7, 92.6],
            "roa_ci": [0.5, 4.9, 4.7], "roe_ci": [5.7, 80.1, 69.9]
        };

        // --- DATA: XPRESS (CASE 8-45) ---
        const XPRESS_DATA = {
            metadata: { name: "XPress Media Co.", year: "Case 8-45" },
            tables: [
                {
                    title: "1. Beginning Stockholders' Equity",
                    headers: ["Account", "Amount"],
                    rows: [
                        ["8% Preferred stock ($25 par, 8,400 shares)", "$210,000"],
                        ["Common stock ($10 par, 50,000 shares)", "$500,000"],
                        ["Paid-in capital - preferred", "$85,000"],
                        ["Paid-in capital - common", "$300,000"],
                        ["Retained earnings", "$370,000"]
                    ],
                    hint: "Start Balances"
                },
                {
                    title: "2. Stock Transactions",
                    headers: ["Date", "Transaction"],
                    rows: [
                        ["Jan. 10", "Issued 28,000 shares of common stock at $18/share"],
                        ["Jan. 23", "Repurchased 8,000 shares of common stock at $20/share"],
                        ["Mar. 14", "Sold 4,000 treasury shares at $22/share"],
                        ["July 15", "Issued 2,600 shares of preferred stock for $128,000"],
                        ["Nov. 15", "Sold 1,000 treasury shares at $26/share"]
                    ],
                    hint: "Journal Entries"
                }
            ]
        };

        const XPRESS_FSE_CONFIG = {
            columns: [
                { key: "cash", label: "Cash", type: "asset" },
                { key: "noncashAssets", label: "Noncash Assets", type: "asset" },
                { key: "liabilities", label: "Liabilities", type: "liability" },
                { 
                    key: "stock", label: "Contributed Capital (Stock)", type: "equity",
                    options: ["Common Stock", "Preferred Stock", "Treasury Stock"]
                },
                { 
                    key: "apic", label: "Additional Paid-in Capital", type: "equity",
                    options: ["Paid-in Capital - Common", "Paid-in Capital - Preferred", "Paid-in Capital - Treasury"]
                },
                { 
                    key: "earnedCapital", label: "Earned Capital", type: "equity",
                    options: ["Retained Earnings", "Dividends"]
                },
                { key: "revenue", label: "Revenue", type: "income" },
                { key: "expenses", label: "Expenses", type: "income" },
                { key: "netIncome", label: "Net Income", type: "income" }
            ],
            transactions: [
                { id: "x_jan10", label: "Jan. 10 – Issue Common Stock" },
                { id: "x_jan23", label: "Jan. 23 – Treasury Stock Purchase" },
                { id: "x_mar14", label: "Mar. 14 – Sell Treasury Stock" },
                { id: "x_jul15", label: "July 15 – Issue Preferred Stock" },
                { id: "x_nov15", label: "Nov. 15 – Sell Treasury Stock" }
            ]
        };

        const XPRESS_ANSWER_KEY = {
            "x_jan10_cash": "504000", "x_jan10_stock": "280000", "x_jan10_stock_acct": "Common Stock", "x_jan10_apic": "224000", "x_jan10_apic_acct": "Paid-in Capital - Common",
            "x_jan23_cash": "-160000", "x_jan23_stock": "-160000", "x_jan23_stock_acct": "Treasury Stock", 
            "x_mar14_cash": "88000", "x_mar14_stock": "80000", "x_mar14_stock_acct": "Treasury Stock", "x_mar14_apic": "8000", "x_mar14_apic_acct": "Paid-in Capital - Treasury",
            "x_jul15_cash": "128000", "x_jul15_stock": "65000", "x_jul15_stock_acct": "Preferred Stock", "x_jul15_apic": "63000", "x_jul15_apic_acct": "Paid-in Capital - Preferred",
            "x_nov15_cash": "26000", "x_nov15_stock": "20000", "x_nov15_stock_acct": "Treasury Stock", "x_nov15_apic": "6000", "x_nov15_apic_acct": "Paid-in Capital - Treasury",
            "x_sc_pref": "11000", "x_sc_common_issued": "78000", "x_sc_treasury": "3000", "x_sc_common_out": "75000",
            "x_bs_pref": "275000", "x_bs_common": "780000", "x_bs_total_paid_in": "1055000",
            "x_bs_apic_pref": "148000", "x_bs_apic_common": "524000", "x_bs_apic_treasury": "14000", "x_bs_total_apic": "686000",
            "x_bs_re": "491000", "x_bs_treasury": "-60000", "x_bs_total_se": "2172000"
        };

        const XPRESS_EXPLANATIONS = {
            // Balance Sheet Explanations (Part C)
            "x_bs_pref": "8% preferred stock, $25 par value, 50,000 shares authorized; 11,000 shares issued and outstanding — $275,000",
            "x_bs_common": "Common stock, $10 par value, 200,000 shares authorized; 78,000 shares issued, (3,000 shares in treasury) — $780,000",
            "x_bs_apic_pref": "Paid-in capital in excess of par value—preferred stock — $148,000",
            "x_bs_apic_common": "Paid-in capital in excess of par value—common stock — $524,000",
            "x_bs_apic_treasury": "Paid-in capital from treasury stock — $14,000",
            "x_bs_re": "Retained earnings — $491,000",
            "x_bs_treasury": "Less: Treasury stock (3,000 common shares) at cost — ($60,000)",
            "x_bs_total_se": "Total stockholders’ equity — $2,172,000"
        };

        const XPRESS_QUESTIONS = [
            {
                id: "xq1", title: "Part (a): Financial Statement Effects", desc: "Analyze each transaction. Select the affected accounts and enter the amounts. (Use negative for decreases)",
                type: "fse_table"
            },
            {
                id: "xq2", title: "Part (b): Ending Share Counts", desc: "Calculate the ending number of shares for each category.",
                sections: [
                    { subtitle: "Share Statistics", fields: [
                        { id: "x_sc_pref", label: "Preferred shares outstanding", type: "decimal" },
                        { id: "x_sc_common_issued", label: "Common shares issued", type: "decimal" },
                        { id: "x_sc_treasury", label: "Treasury shares", type: "decimal" },
                        { id: "x_sc_common_out", label: "Common shares outstanding", type: "decimal" }
                    ]}
                ]
            },
            {
                id: "xq3", title: "Part (c): Stockholders’ Equity Section", desc: "Prepare the Stockholders' Equity section of the Balance Sheet. (Net Income = $121,000)",
                sections: [
                    { subtitle: "Paid-in Capital", fields: [
                        { id: "x_bs_pref", label: "8% preferred stock, $25 par value; 50,000 shares authorized; 11,000 shares issued and outstanding", type: "currency", fullWidth: true },
                        { id: "x_bs_common", label: "Common stock, $10 par value, 200,000 shares authorized; 78,000 shares issued, ( 3,000 shares in treasury)", type: "currency", fullWidth: true },
                        { id: "x_bs_total_paid_in", label: "Total paid-in capital", type: "currency", fullWidth: true }
                    ]},
                    { subtitle: "Additional Paid-in Capital", fields: [
                        { id: "x_bs_apic_pref", label: "Paid-in capital in excess of par value—preferred stock", type: "currency", fullWidth: true },
                        { id: "x_bs_apic_common", label: "Paid-in capital in excess of par value—common stock", type: "currency", fullWidth: true },
                        { id: "x_bs_apic_treasury", label: "Paid-in capital from treasury stock", type: "currency", fullWidth: true },
                        { id: "x_bs_total_apic", label: "Total additional paid-in capital", type: "currency", fullWidth: true }
                    ]},
                    { subtitle: "Retained Earnings", fields: [
                        { id: "x_bs_re", label: "Retained earnings", type: "currency", fullWidth: true }
                    ]},
                    { subtitle: "Treasury Stock", fields: [
                        { id: "x_bs_treasury", label: "Treasury stock (3,000 common shares) at cost", type: "currency", fullWidth: true, hint: "Enter as negative number" }
                    ]},
                    { subtitle: "Total", fields: [
                        { id: "x_bs_total_se", label: "Total stockholders’ equity", type: "currency", fullWidth: true }
                    ]}
                ]
            }
        ];

        // --- COMPONENTS ---

        const Icon = ({ name, size = 16, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (window.lucide && ref.current) {
                    ref.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    ref.current.appendChild(i);
                    window.lucide.createIcons({
                        root: ref.current,
                        nameAttr: 'data-lucide',
                        attrs: { width: size, height: size, "stroke-width": 2 }
                    });
                }
            }, [name, size]);
            return <span ref={ref} className={`inline-flex items-center justify-center ${className}`} style={{ width: size, height: size }}></span>;
        };

        const ConfirmationModal = ({ isOpen, title, message, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center backdrop-blur-sm animate-fade-in">
                    <div className="bg-white rounded-lg shadow-2xl max-w-sm w-full p-6 m-4">
                        <div className="flex items-center gap-3 text-red-600 mb-4">
                            <Icon name="alert-triangle" size={24} />
                            <h3 className="text-lg font-bold">{title}</h3>
                        </div>
                        <p className="text-slate-600 mb-6">{message}</p>
                        <div className="flex justify-end gap-3">
                            <button onClick={onCancel} className="px-4 py-2 text-slate-600 font-medium hover:bg-slate-100 rounded-lg">Cancel</button>
                            <button onClick={onConfirm} className="px-4 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700">Confirm</button>
                        </div>
                    </div>
                </div>
            );
        };

        const Sparkline = ({ data, color = "#3b82f6" }) => {
            const height = 40;
            const width = 100;
            const padding = 5;
            const min = Math.min(...data, 0);
            const max = Math.max(...data);
            const range = max - min || 1;
            const points = data.map((d, i) => {
                const x = (i / (data.length - 1)) * (width - 2 * padding) + padding;
                const y = height - ((d - min) / range) * (height - 2 * padding) - padding;
                return `${x},${y}`;
            }).join(" ");

            return (
                <div className="flex flex-col items-center">
                    <svg width={width} height={height} className="overflow-visible">
                        <polyline points={points} fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                        {data.map((d, i) => {
                            const x = (i / (data.length - 1)) * (width - 2 * padding) + padding;
                            const y = height - ((d - min) / range) * (height - 2 * padding) - padding;
                            return <circle key={i} cx={x} cy={y} r="2" fill={color} />;
                        })}
                    </svg>
                    <div className="flex justify-between w-full text-[9px] text-slate-400 mt-1 px-1">
                        <span>2yr</span><span>Prior</span><span>Cur</span>
                    </div>
                </div>
            );
        };

        const SmartInput = ({ id, value, onChange, correctValue, label, type, hint, instructorMode, activeInput, setActiveInput, isTable, options, acctValue, onAcctChange, correctAcct, fullWidth, explanation }) => {
            const [localError, setLocalError] = useState(null);
            
            const evaluateMath = (expr) => {
                if (!expr) return { valid: true, val: "" };
                try {
                    const sanitized = expr.toString().replace(/,/g, '').replace(/(\d+(\.\d+)?)%/g, '($1/100)');
                    if (!/^[\d\.\+\-\*\/\(\)\s]+$/.test(sanitized)) return { valid: false, msg: "Invalid chars" };
                    const res = new Function('return ' + sanitized)();
                    if (!isFinite(res) || isNaN(res)) return { valid: false, msg: "Math Error" };
                    return { valid: true, val: res };
                } catch (e) {
                    return { valid: false, msg: "Syntax Error" };
                }
            };

            const isAmountCorrect = useMemo(() => {
                if (!value || !correctValue) return false;
                if (type === 'text') {
                    const cleanVal = value.toString().trim().toLowerCase().replace(/[.,]$/, ""); 
                    // Support multiple correct answers separated by pipe
                    const keys = correctValue.toString().toLowerCase().split('|').map(k => k.trim().replace(/[.,]$/, ""));
                    
                    // Check if any key matches (contains logic allowed)
                    return keys.some(cleanKey => cleanVal.includes(cleanKey) || cleanKey.includes(cleanVal));
                }
                const { valid, val } = evaluateMath(value);
                if (!valid) return false;
                
                const target = parseFloat(correctValue.replace(/,/g, ''));
                let inputNum = parseFloat(val);
                
                // Smart Percent Logic: Accept 3.8 as 3.8% if target is 3.8 or 0.038
                if (type === 'percent' || type === 'decimal') {
                   const diffExact = Math.abs(inputNum - target);
                   const diffPercent = Math.abs((inputNum / 100) - target);
                   const diffPercentReverse = Math.abs((inputNum * 100) - target);

                   return (diffExact <= Math.max(Math.abs(target * 0.02), 0.01)) || 
                          (diffPercent <= Math.max(Math.abs(target * 0.02), 0.001)) ||
                          (diffPercentReverse <= Math.max(Math.abs(target * 0.02), 0.1));
                } else {
                    const tolerance = Math.max(Math.abs(target * 0.02), 0.1); 
                    return Math.abs(inputNum - target) <= tolerance;
                }
            }, [value, correctValue, type]);

            const isAcctCorrect = useMemo(() => {
                if (!options) return true;
                if (!acctValue || !correctAcct) return false;
                return acctValue === correctAcct;
            }, [acctValue, correctAcct, options]);

            const isFullyCorrect = options ? (isAmountCorrect && isAcctCorrect) : isAmountCorrect;

            const handleBlurOrEnter = (e) => {
                if (type === 'text') return;
                if (!value) return;

                const { valid, val } = evaluateMath(value);
                if (!valid) { setLocalError("Invalid Math"); return; }
                setLocalError(null);
                
                if (valid && val !== undefined && val !== null) {
                     const numVal = Number(val);
                     let displayVal = numVal;
                     if (type === 'percent') {
                        const target = parseFloat(correctValue || "0");
                        if (Math.abs(numVal) <= 1 && target > 1) { displayVal = (numVal * 100).toFixed(1); }
                        else { displayVal = numVal.toFixed(1); }
                     } else {
                        displayVal = Number.isInteger(numVal) ? numVal.toString() : numVal.toFixed(2);
                     }
                     onChange(id, displayVal.toString()); 
                }
            };

            const isActive = activeInput === id;

            return (
                <div className={`${isTable ? "w-full min-w-[140px]" : "mb-4 w-full"}`}>
                    {!isTable && <label className="block text-xs font-bold text-slate-500 mb-1 uppercase tracking-wider">{label}</label>}
                    <div className="flex flex-col gap-1 relative">
                        {options && (
                            <select
                                value={acctValue || ""}
                                onChange={(e) => onAcctChange(id + "_acct", e.target.value)}
                                className={`w-full text-[10px] p-1 border rounded bg-slate-50 outline-none focus:border-blue-500 ${
                                    acctValue && !isAcctCorrect ? "border-red-300 text-red-600" : "border-slate-200 text-slate-700"
                                }`}
                            >
                                <option value="">Select Account...</option>
                                {options.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                            </select>
                        )}
                        <div className="relative flex-grow">
                            <input 
                                type="text" 
                                id={id}
                                value={value || ""}
                                onChange={(e) => { setLocalError(null); onChange(id, e.target.value); }}
                                onFocus={() => setActiveInput(id)}
                                onBlur={handleBlurOrEnter}
                                onKeyDown={(e) => {
                                    if (e.key === 'Enter') {
                                        e.preventDefault();
                                        handleBlurOrEnter(e);
                                        e.target.blur();
                                    }
                                }}
                                className={`w-full ${isTable ? "p-2 text-xs" : "p-3 pr-10 text-sm"} border rounded-lg font-mono shadow-sm transition-all ${
                                    isFullyCorrect ? "input-correct" : (value && !isActive && !isFullyCorrect) ? "input-incorrect" : "input-neutral"
                                }`}
                                placeholder={isTable ? (type === 'percent' ? "%" : "0") : (type === 'text' ? "Type answer..." : "Calculate...")}
                            />
                            {!isTable && !options && type !== 'text' && (
                                <div className="absolute right-3 top-3 text-slate-400 pointer-events-none">
                                    {isFullyCorrect ? <span className="text-green-600"><Icon name="check-circle" size={18} /></span> : 
                                    localError ? <span className="text-red-500 font-bold">!</span> :
                                    <Icon name="calculator" size={16} />}
                                </div>
                            )}
                        </div>
                        {hint && !isTable && (
                            <div className="w-1/3 shrink-0 bg-blue-50 border border-blue-100 rounded p-2 flex flex-col justify-center min-h-[46px]">
                                <span className="text-[10px] text-blue-500 font-bold uppercase tracking-wider block mb-0.5">Formula / Logic</span>
                                <span className="text-xs text-blue-800 font-medium leading-tight">{hint}</span>
                            </div>
                        )}
                    </div>
                    {localError && !isTable && <p className="text-xs text-red-500 mt-1">{localError}</p>}
                    
                    {/* FEEDBACK SECTION */}
                    {(isFullyCorrect || instructorMode) && explanation && (
                        <div className={`mt-1 p-1.5 text-[10px] leading-tight rounded border border-l-2 shadow-sm animate-fade-in ${isFullyCorrect ? "bg-green-50 border-green-200 border-l-green-500 text-green-900" : "bg-purple-50 border-purple-200 border-l-purple-500 text-purple-900"}`}>
                           {instructorMode && !isTable && <div className="font-bold mb-1 opacity-75 uppercase tracking-wide text-[10px]">Instructor Solution:</div>}
                           <div className="whitespace-pre-line font-mono">
                                {explanation}
                           </div>
                        </div>
                    )}
                    
                    {instructorMode && (correctValue || correctAcct) && !explanation && (
                        <div className="mt-1 bg-purple-100 border border-purple-200 text-purple-800 text-[10px] p-1 rounded font-mono animate-fade-in truncate">
                            {options && correctAcct ? `[${correctAcct}] ` : ""}Key: {correctValue}
                        </div>
                    )}
                </div>
            );
        };

        const RatioTable = ({ tables, inputs, handleInputChange, activeKey, instructorMode, activeInput, setActiveInput, explanationMap }) => {
            const [showChart, setShowChart] = useState(false);
            return (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {tables.map((table, tIdx) => (
                        <div key={tIdx} className="border border-slate-200 rounded-xl overflow-hidden shadow-sm bg-white flex flex-col">
                            <div className="bg-slate-50 p-3 border-b border-slate-200 flex justify-between items-center">
                                <h3 className="font-bold text-slate-700 text-sm flex items-center gap-2">
                                    {table.title}
                                    <button onClick={() => setShowChart(!showChart)} className={`p-1 rounded hover:bg-slate-200 transition ${showChart ? 'text-blue-600 bg-blue-100' : 'text-slate-400'}`} title="Toggle Trend Chart">
                                        <Icon name="line-chart" size={14} />
                                    </button>
                                </h3>
                                <div className="text-[10px] text-blue-600 bg-blue-50 px-2 py-1 rounded border border-blue-100 font-mono font-bold uppercase tracking-wide">
                                    {table.hint}
                                </div>
                            </div>
                            <div className="flex flex-1 overflow-x-auto custom-scrollbar">
                                <div className="flex-1 p-4 min-w-[300px]">
                                    <table className="w-full text-sm">
                                        <thead className="text-slate-400 text-[10px] uppercase tracking-wider border-b border-slate-100">
                                            <tr>
                                                <th className="pb-2 text-left font-bold">{table.headers[0]}</th>
                                                <th className="pb-2 text-right font-bold">{table.headers[1]}</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {table.rows.map((row, rIdx) => (
                                                <tr key={rIdx}>
                                                    <td className="py-3 font-medium text-slate-600 text-xs align-top pt-3">{row.label}</td>
                                                    <td className="py-2 pl-4 align-top">
                                                        <SmartInput
                                                            id={row.id}
                                                            value={inputs[row.id]}
                                                            onChange={handleInputChange}
                                                            correctValue={activeKey[row.id]}
                                                            instructorMode={instructorMode}
                                                            activeInput={activeInput}
                                                            setActiveInput={setActiveInput}
                                                            isTable={true}
                                                            type="percent"
                                                            explanation={explanationMap ? explanationMap[row.id] : null}
                                                        />
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                                {showChart && (
                                    <div className="w-32 bg-slate-50 border-l border-slate-100 flex flex-col items-center justify-center p-4 animate-fade-in">
                                        <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">Trend</span>
                                        <Sparkline data={CHART_DATA[table.chartKey]} />
                                    </div>
                                )}
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        const ReferenceTable = ({ title, headers, rows, onValueClick }) => {
            const [isOpen, setIsOpen] = useState(true);
            const renderInteractiveCell = (text) => {
                if (typeof text !== 'string') return text;
                const parts = text.split(/([$]?\d[\d,\.]*%?)/g);
                return parts.map((part, i) => {
                    if (/[\d]/.test(part) && onValueClick) {
                        return (
                            <span key={i} onClick={(e) => { e.stopPropagation(); onValueClick(part); }} 
                                className="cursor-pointer text-blue-600 font-bold hover:bg-blue-100 hover:text-blue-800 rounded px-0.5 transition-colors"
                                title="Click to insert value">
                                {part}
                            </span>
                        );
                    }
                    return <span key={i}>{part}</span>;
                });
            };

            return (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-4">
                    <button onClick={() => setIsOpen(!isOpen)} className="w-full flex items-center justify-between p-3 bg-slate-50 border-b border-slate-100 hover:bg-slate-100 transition">
                        <h4 className="font-bold text-slate-700 text-sm flex items-center gap-2">
                            <Icon name="table" size={16} /> {title}
                        </h4>
                        <Icon name={isOpen ? "chevron-up" : "chevron-down"} size={16} />
                    </button>
                    {isOpen && (
                        <div className="overflow-x-auto max-h-80 custom-scrollbar">
                            <table className="w-full text-xs text-left">
                                <thead className="bg-slate-50 text-slate-500 uppercase tracking-wider sticky top-0 shadow-sm z-10">
                                    <tr>{headers.map((h, i) => <th key={i} className={`p-2 border-b font-medium bg-slate-50 ${i > 0 ? "text-right" : ""}`}>{h}</th>)}</tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {rows.map((row, rI) => (
                                        <tr key={rI} className="hover:bg-blue-50 transition-colors">
                                            <td className="p-2 font-medium text-slate-700 border-r border-slate-50">{row[0]}</td>
                                            {row.slice(1).map((cell, cI) => (
                                                <td key={cI} className="p-2 text-right font-mono text-slate-600 whitespace-nowrap">
                                                    {renderInteractiveCell(cell)}
                                                </td>
                                            ))}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };

        const FSETable = ({ config, inputs, handleInputChange, activeKey, instructorMode, activeInput, setActiveInput }) => {
            return (
                <div className="overflow-x-auto border border-slate-200 rounded-lg shadow-sm custom-scrollbar">
                    <table className="w-full text-sm">
                        <thead className="bg-slate-50 text-slate-700 font-bold border-b border-slate-200">
                            <tr>
                                <th className="p-3 text-left sticky left-0 bg-slate-50 min-w-[200px] border-r border-slate-200 shadow-[4px_0_8px_-2px_rgba(0,0,0,0.05)] z-20">Transaction</th>
                                {config.columns.map(col => (
                                    <th key={col.key} className="p-3 text-center min-w-[120px] whitespace-normal leading-tight">
                                        {col.label}
                                        <div className="text-[10px] font-normal text-slate-400 uppercase mt-1">{col.type}</div>
                                    </th>
                                ))}
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100">
                            {config.transactions.map((txn, idx) => (
                                <tr key={txn.id} className={idx % 2 === 0 ? "bg-white" : "bg-slate-50/50"}>
                                    <td className="p-3 font-medium text-slate-700 border-r border-slate-100 sticky left-0 bg-inherit shadow-[4px_0_8px_-2px_rgba(0,0,0,0.05)] z-10">
                                        {txn.label}
                                    </td>
                                    {config.columns.map(col => {
                                        const inputId = `${txn.id}_${col.key}`;
                                        return (
                                            <td key={col.key} className="p-2 align-top">
                                                <SmartInput
                                                    id={inputId}
                                                    value={inputs[inputId]}
                                                    onChange={handleInputChange}
                                                    correctValue={activeKey[inputId]}
                                                    options={col.options}
                                                    acctValue={inputs[inputId + "_acct"]}
                                                    onAcctChange={handleInputChange}
                                                    correctAcct={activeKey[inputId + "_acct"]}
                                                    instructorMode={instructorMode}
                                                    activeInput={activeInput}
                                                    setActiveInput={setActiveInput}
                                                    isTable={true}
                                                    type="currency"
                                                />
                                            </td>
                                        );
                                    })}
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('campbell');
            const [inputs, setInputs] = useState({});
            const [activeInput, setActiveInput] = useState(null);
            const [sidebarWidth, setSidebarWidth] = useState(400); 
            const [isResizing, setIsResizing] = useState(false);
            
            // Instructor State
            const [instructorMode, setInstructorMode] = useState(false);
            const [showLogin, setShowLogin] = useState(false);
            const [password, setPassword] = useState("");
            const [clearModalOpen, setClearModalOpen] = useState(false);
            
            // Hash Tool
            const [hashInput, setHashInput] = useState("");
            const [verifiedResult, setVerifiedResult] = useState(null);
            const [studentName, setStudentName] = useState("");
            const [showDownload, setShowDownload] = useState(false);

            // Resizing Logic
            const startResizing = useCallback(() => setIsResizing(true), []);
            const stopResizing = useCallback(() => setIsResizing(false), []);
            const resize = useCallback((mouseMoveEvent) => {
                if (isResizing) {
                    const newWidth = mouseMoveEvent.clientX;
                    if (newWidth > 250 && newWidth < 800) {
                        setSidebarWidth(newWidth);
                    }
                }
            }, [isResizing]);

            useEffect(() => {
                window.addEventListener('mousemove', resize);
                window.addEventListener('mouseup', stopResizing);
                return () => {
                    window.removeEventListener('mousemove', resize);
                    window.removeEventListener('mouseup', stopResizing);
                };
            }, [resize, stopResizing]);

            // Data getters
            const getActiveData = () => {
                switch(activeTab) {
                    case 'campbell': return CAMPBELL_DATA;
                    case 'sysco': return SYSCO_DATA;
                    case 'xpress': return XPRESS_DATA;
                    default: return CAMPBELL_DATA;
                }
            };
            const activeData = getActiveData();

            const getActiveQuestions = () => {
                switch(activeTab) {
                    case 'campbell': return CAMPBELL_QUESTIONS;
                    case 'sysco': return SYSCO_QUESTIONS;
                    case 'xpress': return XPRESS_QUESTIONS;
                    default: return [];
                }
            };
            const activeQuestions = getActiveQuestions();

            const getActiveKey = () => {
                switch(activeTab) {
                    case 'campbell': return CAMPBELL_ANSWER_KEY;
                    case 'sysco': return SYSCO_ANSWER_KEY;
                    case 'xpress': return XPRESS_ANSWER_KEY;
                    default: return {};
                }
            };
            const activeKey = getActiveKey();

            const getExplanations = () => {
                switch(activeTab) {
                    case 'campbell': return CAMPBELL_EXPLANATIONS;
                    case 'sysco': return SYSCO_EXPLANATIONS;
                    case 'xpress': return XPRESS_EXPLANATIONS;
                    default: return {};
                }
            }
            const activeExplanations = getExplanations();

            const handleInputChange = (id, val) => setInputs(prev => ({ ...prev, [id]: val }));

            // Smart Number Replacement Logic
            const handleValueClick = (val) => {
                if (!activeInput) return;
                const cleanVal = val.replace(/,/g, '').replace(/[()]/g, (m) => m === '(' ? '-' : '').replace(/\$/g, '');
                
                setInputs(prev => {
                    const cur = (prev[activeInput] || "").toString();
                    const endsWithOperator = /[+\-*/(]\s*$/;
                    const endsWithNumber = /(-?\d*\.?\d+)$/;
                    let newVal = cur;
                    if (cur === "") {
                        newVal = cleanVal;
                    } else if (endsWithOperator.test(cur)) {
                        newVal = cur + cleanVal;
                    } else {
                        newVal = cur.replace(endsWithNumber, cleanVal);
                    }
                    return { ...prev, [activeInput]: newVal };
                });
                
                setTimeout(() => {
                    const el = document.getElementById(activeInput);
                    if (el) {
                        el.focus();
                        const len = el.value.length;
                        el.setSelectionRange(len, len);
                    }
                }, 50);
            };

            const unlockInstructor = () => {
                if (password.toLowerCase() === "teacher") {
                    setInstructorMode(true);
                    setShowLogin(false);
                    setPassword("");
                } else {
                    alert("Incorrect Password");
                }
            };

            const handleAutoFill = () => {
                setInputs(prev => ({ ...prev, ...activeKey }));
            };

            const handleClearConfirm = () => {
                setInputs({});
                setClearModalOpen(false);
                setInstructorMode(false); 
            };

            const verifyHash = () => {
                try {
                    const decoded = atob(hashInput);
                    const data = JSON.parse(decoded);
                    setVerifiedResult(data);
                } catch (e) {
                    setVerifiedResult({ error: "Invalid Hash" });
                }
            };

            const handleDownload = () => {
                const timestamp = new Date().toLocaleString();
                let correctCount = 0;
                let totalCount = 0;
                
                Object.keys(activeKey).forEach(key => {
                    totalCount++;
                    const userVal = (inputs[key] || "").toString().trim().toLowerCase();
                    const keyVal = (activeKey[key] || "").toString().trim().toLowerCase();
                    let isCorrect = false;
                    
                    if(!isNaN(parseFloat(keyVal)) && !isNaN(parseFloat(userVal.replace(/,/g,'')))) {
                         const u = parseFloat(userVal.replace(/,/g,''));
                         const k = parseFloat(keyVal);
                         if (Math.abs(u-k) < Math.max(k*0.02, 0.5)) isCorrect = true;
                    } else {
                        if (userVal === keyVal || userVal.includes(keyVal)) isCorrect = true;
                    }
                    if (isCorrect) correctCount++;
                });
                
                const verificationHash = btoa(JSON.stringify({ name: studentName, score: `${correctCount}/${totalCount}`, date: new Date().toISOString(), module: activeTab }));

                const content = `
FINANCIAL SIMULATION REPORT: ${activeTab.toUpperCase()}
-------------------------------------
Student: ${studentName}
Date: ${timestamp}
Score: ${correctCount} / ${totalCount}
Verification Hash: ${verificationHash}

ANSWERS SUBMITTED (${activeTab}):
-------------------------------------
${Object.keys(activeKey).map(k => `${k}: ${inputs[k] || "[Empty]"}`).join('\n')}
                `.trim();

                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${studentName.replace(/\s+/g, '_')}_${activeTab}_Submission.txt`;
                a.click();
                setShowDownload(false);
            };

            return (
                <div className="flex h-screen bg-slate-100 overflow-hidden font-sans">
                    
                    {/* LEFT SIDEBAR: REFERENCE */}
                    <div style={{ width: sidebarWidth }} className="bg-slate-50 border-r border-slate-200 overflow-y-auto custom-scrollbar flex flex-col relative z-0 shrink-0">
                        <div className="sticky top-0 bg-white p-4 border-b border-slate-200 shadow-sm z-20">
                            <div className="flex items-center gap-2 text-blue-800 font-bold text-lg mb-1">
                                <Icon name="library" /> Reference Data
                            </div>
                            <p className="text-xs text-slate-500 font-bold uppercase tracking-wider">{activeData.metadata.name}</p>
                            {activeTab !== 'sysco' && (
                                <p className="text-xs text-blue-600 mt-1 flex items-center gap-1">
                                    <Icon name="mouse-pointer-click" size={12} /> Click values to insert/replace
                                </p>
                            )}
                        </div>
                        <div className="p-4 space-y-2">
                            {activeData.tables.map((tbl, i) => (
                                <ReferenceTable 
                                    key={i}
                                    title={tbl.title} 
                                    headers={tbl.headers} 
                                    rows={tbl.rows} 
                                    onValueClick={handleValueClick} 
                                />
                            ))}
                             {activeTab === 'xpress' && (
                                <div className="bg-emerald-50 p-4 rounded-lg border border-emerald-100 text-sm text-emerald-800">
                                    <p className="font-bold flex items-center gap-2 mb-2"><Icon name="table-2" size={16}/> Instructions</p>
                                    <p>Enter the financial statement effects for each transaction. Select the <strong>Account</strong> from the dropdown menu where applicable and enter the <strong>Amount</strong> (use negative numbers for decreases).</p>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* DRAG HANDLE */}
                    <div className="resizer" onMouseDown={startResizing}></div>

                    {/* MAIN CONTENT */}
                    <div className="flex-1 flex flex-col h-screen overflow-hidden relative">
                        
                        {/* TOP NAV TABS */}
                        <div className="bg-slate-800 text-white flex shrink-0">
                            <button 
                                onClick={() => setActiveTab('campbell')}
                                className={`flex-1 py-3 text-sm font-bold flex items-center justify-center gap-2 transition-colors ${activeTab === 'campbell' ? 'bg-blue-600 text-white' : 'hover:bg-slate-700 text-slate-400'}`}
                            >
                                <Icon name="soup" size={16} /> Campbell Soup (E8-37)
                            </button>
                            <button 
                                onClick={() => setActiveTab('sysco')}
                                className={`flex-1 py-3 text-sm font-bold flex items-center justify-center gap-2 transition-colors ${activeTab === 'sysco' ? 'bg-blue-600 text-white' : 'hover:bg-slate-700 text-slate-400'}`}
                            >
                                <Icon name="activity" size={16} /> Sysco (8-44)
                            </button>
                            <button 
                                onClick={() => setActiveTab('xpress')}
                                className={`flex-1 py-3 text-sm font-bold flex items-center justify-center gap-2 transition-colors ${activeTab === 'xpress' ? 'bg-blue-600 text-white' : 'hover:bg-slate-700 text-slate-400'}`}
                            >
                                <Icon name="newspaper" size={16} /> XPress Media (8-45)
                            </button>
                        </div>

                        {/* INSTRUCTOR TOOLBAR (STICKY) */}
                        {instructorMode && (
                            <div className="bg-purple-700 text-white p-2 shadow-md flex items-center justify-between z-20 animate-fade-in shrink-0">
                                <div className="flex items-center gap-3 px-4">
                                    <span className="bg-white/20 p-1.5 rounded"><Icon name="graduation-cap" /></span>
                                    <span className="font-bold tracking-wide">INSTRUCTOR MODE</span>
                                </div>
                                <div className="flex gap-2 px-4">
                                    <button onClick={handleAutoFill} className="flex items-center gap-2 px-3 py-1 bg-green-500 hover:bg-green-600 rounded text-sm font-bold transition">
                                        <Icon name="wand-2" size={14} /> Auto-Fill Tab
                                    </button>
                                    <button onClick={() => setClearModalOpen(true)} className="flex items-center gap-2 px-3 py-1 bg-red-500 hover:bg-red-600 rounded text-sm font-bold transition">
                                        <Icon name="log-out" size={14} /> Clear & Exit
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* HEADER */}
                        <header className="bg-white border-b border-slate-200 p-6 flex justify-between items-center shrink-0">
                            <div>
                                <h1 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
                                    <Icon name="file-bar-chart-2" className="text-blue-600" /> {activeData.metadata.name}
                                </h1>
                                <p className="text-slate-500 text-sm mt-1">
                                    {activeTab === 'campbell' ? 'Analysis of Shareowners\' Equity & Treasury Stock' : activeTab === 'sysco' ? 'Case 8-44: Adjusting Returns for Comprehensive Income' : 'Case 8-45: Stockholders’ Equity Transactions'}
                                </p>
                            </div>
                            <div className="flex gap-3">
                                <button onClick={() => setShowDownload(true)} className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-sm transition">
                                    <Icon name="save" size={18} /> Save Work
                                </button>
                                {!instructorMode && (
                                    <button onClick={() => setShowLogin(true)} className="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-medium transition border border-slate-300">
                                        <Icon name="lock" size={16} /> Instructor
                                    </button>
                                )}
                            </div>
                        </header>

                        {/* SCROLLABLE FORM AREA */}
                        <main className="flex-1 overflow-y-auto custom-scrollbar bg-slate-50/50 p-8 pb-20">
                            <div className="max-w-6xl mx-auto space-y-8">
                                
                                {activeQuestions.map((q) => (
                                    <div key={q.id} className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 animate-fade-in">
                                        <h2 className="text-lg font-bold text-slate-800 mb-2 border-b pb-2 flex items-center gap-2">
                                            <span className="bg-blue-100 text-blue-700 w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold">{q.id.replace(/^(cq|sq|xq|_a)/,'')}</span>
                                            {q.title}
                                        </h2>
                                        <p className="text-sm text-slate-500 mb-6 italic">{q.desc}</p>
                                        
                                        {q.type === 'fse_table' ? (
                                            <FSETable 
                                                config={XPRESS_FSE_CONFIG} 
                                                inputs={inputs} 
                                                handleInputChange={handleInputChange} 
                                                activeKey={activeKey}
                                                instructorMode={instructorMode}
                                                activeInput={activeInput}
                                                setActiveInput={setActiveInput}
                                            />
                                        ) : q.type === 'ratio_table' ? (
                                            <RatioTable 
                                                tables={q.tables} 
                                                inputs={inputs} 
                                                handleInputChange={handleInputChange} 
                                                activeKey={activeKey}
                                                instructorMode={instructorMode}
                                                activeInput={activeInput}
                                                setActiveInput={setActiveInput}
                                                explanationMap={activeExplanations}
                                            />
                                        ) : q.type === 'interpretation_text' ? (
                                            <div className="text-sm leading-8 text-slate-700">
                                                The company reports other comprehensive losses in the current year and two years prior and a gain in the prior year. These losses and gain are relatively
                                                <span className="inline-block mx-2 align-middle">
                                                    <select 
                                                        value={inputs["s_interp_mag"] || ""} 
                                                        onChange={(e) => handleInputChange("s_interp_mag", e.target.value)}
                                                        className={`border rounded p-1 text-sm font-bold ${inputs["s_interp_mag"] === activeKey["s_interp_mag"] ? "text-green-600 border-green-400 bg-green-50" : inputs["s_interp_mag"] ? "text-red-600 border-red-300" : "border-slate-300"}`}
                                                    >
                                                        <option value="">Select...</option>
                                                        <option value="small">small</option>
                                                        <option value="large">large</option>
                                                    </select>
                                                </span>
                                                and 
                                                <span className="inline-block mx-2 align-middle">
                                                    <select 
                                                        value={inputs["s_interp_impact"] || ""} 
                                                        onChange={(e) => handleInputChange("s_interp_impact", e.target.value)}
                                                        className={`border rounded p-1 text-sm font-bold ${inputs["s_interp_impact"] === activeKey["s_interp_impact"] ? "text-green-600 border-green-400 bg-green-50" : inputs["s_interp_impact"] ? "text-red-600 border-red-300" : "border-slate-300"}`}
                                                    >
                                                        <option value="">Select...</option>
                                                        <option value="are">are</option>
                                                        <option value="are not">are not</option>
                                                    </select>
                                                </span>
                                                impactful.
                                                {(instructorMode || (inputs["s_interp_mag"] === activeKey["s_interp_mag"] && inputs["s_interp_impact"] === activeKey["s_interp_impact"])) && (
                                                    <div className="mt-2 p-3 text-xs bg-purple-50 border-l-4 border-purple-500 text-purple-900 animate-fade-in">
                                                        <div className="font-bold mb-1 opacity-75 uppercase tracking-wide text-[10px]">Instructor Solution:</div>
                                                        {activeExplanations["s_interp_mag"]}
                                                    </div>
                                                )}
                                            </div>
                                        ) : (
                                            q.sections && q.sections.map((sec, idx) => (
                                                <div key={idx} className="mb-6 last:mb-0 bg-slate-50 p-4 rounded-lg border border-slate-100">
                                                    <h3 className="font-bold text-slate-700 mb-4 text-sm uppercase">{sec.subtitle}</h3>
                                                    <div className={`grid gap-4 ${sec.fields.some(f => f.fullWidth) ? 'grid-cols-1' : 'grid-cols-1 md:grid-cols-2'}`}>
                                                        {sec.fields.map(f => (
                                                            <SmartInput 
                                                                key={f.id}
                                                                id={f.id}
                                                                label={f.label}
                                                                type={f.type}
                                                                hint={f.hint}
                                                                value={inputs[f.id]}
                                                                onChange={handleInputChange}
                                                                correctValue={activeKey[f.id]}
                                                                instructorMode={instructorMode}
                                                                activeInput={activeInput}
                                                                setActiveInput={setActiveInput}
                                                                isTable={false}
                                                                fullWidth={f.fullWidth}
                                                                explanation={activeExplanations[f.id]}
                                                            />
                                                        ))}
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                ))}

                                {/* Instructor Only: Hash Verification Tool */}
                                {instructorMode && (
                                    <div className="bg-slate-800 rounded-xl shadow-lg border border-slate-700 p-6 text-slate-200 mt-12">
                                        <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                                            <Icon name="shield-check" className="text-green-400" /> Verification Tool
                                        </h3>
                                        <div className="flex gap-4 items-start">
                                            <div className="flex-1">
                                                <label className="text-xs font-bold text-slate-400 mb-1 block">PASTE STUDENT HASH</label>
                                                <textarea 
                                                    className="w-full bg-slate-900 border-slate-700 rounded p-2 text-xs font-mono text-green-400 focus:ring-1 focus:ring-green-500 outline-none"
                                                    rows="3"
                                                    placeholder="Paste base64 hash string here..."
                                                    value={hashInput}
                                                    onChange={(e) => setHashInput(e.target.value)}
                                                ></textarea>
                                            </div>
                                            <button 
                                                onClick={verifyHash}
                                                className="mt-6 px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded font-bold text-sm"
                                            >
                                                Verify
                                            </button>
                                        </div>
                                        {verifiedResult && (
                                            <div className="mt-4 p-4 bg-slate-900 rounded border border-slate-700">
                                                {verifiedResult.error ? (
                                                    <p className="text-red-400 font-bold flex items-center gap-2"><Icon name="x-circle" /> {verifiedResult.error}</p>
                                                ) : (
                                                    <div className="grid grid-cols-2 gap-4 text-sm">
                                                        <div><span className="text-slate-500">Student:</span> <span className="text-white font-bold">{verifiedResult.name}</span></div>
                                                        <div><span className="text-slate-500">Score:</span> <span className="text-green-400 font-bold">{verifiedResult.score}</span></div>
                                                        <div><span className="text-slate-500">Date:</span> <span className="text-slate-300">{new Date(verifiedResult.date).toLocaleString()}</span></div>
                                                        <div><span className="text-slate-500">Module:</span> <span className="text-blue-400 font-bold uppercase">{verifiedResult.module}</span></div>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </main>
                    </div>

                    {/* MODALS */}
                    
                    {/* Login Modal */}
                    {showLogin && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center animate-fade-in">
                            <div className="bg-white p-6 rounded-xl shadow-2xl w-80 transform transition-all">
                                <h3 className="font-bold text-lg mb-4 text-slate-800 flex items-center gap-2">
                                    <Icon name="lock" size={20} className="text-blue-600" /> Instructor Access
                                </h3>
                                <input 
                                    type="password" 
                                    className="w-full border p-3 rounded-lg mb-4 outline-none focus:border-blue-500" 
                                    placeholder="Enter password"
                                    value={password} 
                                    onChange={(e) => setPassword(e.target.value)}
                                    onKeyDown={(e) => e.key === 'Enter' && unlockInstructor()}
                                    autoFocus
                                />
                                <div className="flex justify-end gap-2">
                                    <button onClick={() => setShowLogin(false)} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg text-sm font-medium">Cancel</button>
                                    <button onClick={unlockInstructor} className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-bold">Unlock</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Download Modal */}
                    {showDownload && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center animate-fade-in">
                            <div className="bg-white p-8 rounded-xl shadow-2xl w-96">
                                <div className="text-center mb-6">
                                    <div className="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3 text-blue-600">
                                        <Icon name="download-cloud" size={24} />
                                    </div>
                                    <h3 className="text-xl font-bold text-slate-800">Submit Assignment</h3>
                                    <p className="text-slate-500 text-sm mt-1">Enter your name to generate your submission file.</p>
                                </div>
                                <input 
                                    type="text" 
                                    value={studentName} 
                                    onChange={(e) => setStudentName(e.target.value)} 
                                    placeholder="Your Full Name" 
                                    className="w-full p-3 border border-slate-300 rounded-lg mb-4 text-center focus:border-blue-500 outline-none font-bold text-slate-700"
                                    autoFocus 
                                />
                                <div className="flex flex-col gap-2">
                                    <button 
                                        onClick={() => studentName.trim() ? handleDownload() : alert("Name required")} 
                                        className="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition flex items-center justify-center gap-2"
                                    >
                                        Download Submission
                                    </button>
                                    <button onClick={() => setShowDownload(false)} className="w-full py-2 text-slate-500 hover:bg-slate-50 rounded-lg text-sm">Cancel</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Clear Confirmation Modal */}
                    <ConfirmationModal 
                        isOpen={clearModalOpen}
                        title="Clear All & Exit?"
                        message="This will remove all student answers and lock Instructor Mode. This action cannot be undone."
                        onConfirm={handleClearConfirm}
                        onCancel={() => setClearModalOpen(false)}
                    />

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
