<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Financial Analyst Simulation: Merck & Co. 2022</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            /* Improved touch response */
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Custom Scrollbar */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
        
        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }
        .animate-slideDown { animation: slideDown 0.3s ease-out forwards; }

        /* Resizer Handle Styling */
        .resizer-handle {
            width: 4px;
            cursor: col-resize;
            transition: background-color 0.2s;
            z-index: 30;
        }
        .resizer-handle:hover, .resizer-handle:active {
            background-color: #3b82f6;
        }

        /* Mobile Overlay Transition */
        .sidebar-transition {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 h-screen overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- SECURITY UTILS ---
        const d = (s) => {
            try {
                const decoded = atob(s);
                return isNaN(parseFloat(decoded)) ? decoded : parseFloat(decoded);
            } catch (e) {
                return s;
            }
        };

        // --- MATH EVALUATION UTILS ---
        const evaluateMathExpression = (expression) => {
            if (!expression) return "";
            let cleanExpr = expression.toString().replace(/,/g, '').replace(/\s/g, '');
            // Handle 15% as (15/100)
            cleanExpr = cleanExpr.replace(/(\d+(\.\d+)?)%/g, '($1/100)');

            try {
                // Security check: ensure only math characters are present
                if (!/^[\d\.\+\-\*\/\(\)]+$/.test(cleanExpr)) {
                    return expression;
                }
                // eslint-disable-next-line no-new-func
                return new Function('return ' + cleanExpr)();
            } catch (e) {
                return expression;
            }
        };

        // --- DATA ---
        const FINANCIAL_DATA = {
            company: "Merck & Co. Inc.",
            year: 2022,
            incomeStatement: [
                { item: "Sales", value: 59283 },
                { item: "Cost of Sales", value: 17411 },
                { item: "SG&A", value: 10042 },
                { item: "R&D", value: 13548 },
                { item: "Restructuring Costs", value: 337 },
                { item: "Other Expense (Income), net", value: 1501, note: "Non-operating" },
                { item: "Earnings Before Taxes", value: 16444 },
                { item: "Provision for Income Tax", value: 1918 },
                { item: "Net Income (Consolidated)", value: 14526 },
                { item: "Net Income (Attrib. to Merck)", value: 14519 }
            ],
            balanceSheet: {
                assets: [
                    { item: "Cash & Equivalents", value22: 12694, value21: 8096, type: "non-op" },
                    { item: "Short-term Investments", value22: 498, value21: 0, type: "non-op" },
                    { item: "Accounts Receivable", value22: 9450, value21: 9230, type: "op" },
                    { item: "Inventories", value22: 5911, value21: 5953, type: "op" },
                    { item: "Other Current Assets", value22: 7169, value21: 6987, type: "op" },
                    { item: "Total Current Assets", value22: 35722, value21: 30266, bold: true },
                    { item: "PPE, Net", value22: 21422, value21: 19279, type: "op" },
                    { item: "Investments (Long-term)", value22: 1015, value21: 370, type: "non-op" },
                    { item: "Goodwill", value22: 21204, value21: 21264, type: "op" },
                    { item: "Other Intangibles", value22: 20269, value21: 22933, type: "op" },
                    { item: "Other Assets", value22: 9528, value21: 11582, type: "op" },
                    { item: "Total Assets", value22: 109160, value21: 105694, bold: true }
                ],
                liabilitiesAndEquity: [
                    { item: "Trade Accounts Payable", value22: 4264, value21: 4609, type: "op" },
                    { item: "Accrued and Other Current Liabilities", value22: 13878, value21: 13555, type: "op" },
                    { item: "Loans Payable & Current Portion LT Debt", value22: 1946, value21: 2412, type: "non-op" },
                    { item: "Lease Liabilities (Current)", value22: 281, value21: 304, type: "non-op" },
                    { item: "Income Taxes Payable", value22: 1986, value21: 1224, type: "op" },
                    { item: "Dividends Payable", value22: 1884, value21: 1768, type: "non-op" },
                    { item: "Total Current Liabilities", value22: 24239, value21: 23872, bold: true },
                    { item: "Long-term Debt", value22: 28745, value21: 30690, type: "non-op" },
                    { item: "Lease Liabilities (Non-current)", value22: 1013, value21: 1225, type: "non-op" },
                    { item: "Deferred Income Taxes", value22: 1795, value21: 3441, type: "op" },
                    { item: "Other Noncurrent Liabilities", value22: 7310, value21: 8209, type: "op" }, 
                    { item: "Total Liabilities", value22: 63102, value21: 67437, bold: true }, 
                    { item: "Total Merck Equity", value22: 45991, value21: 38184 },
                    { item: "Noncontrolling Interests", value22: 67, value21: 73 },
                    { item: "Total Equity", value22: 46058, value21: 38257, bold: true },
                    { item: "Total Liabilities and Equity", value22: 109160, value21: 105694, bold: true, isDouble: true }
                ]
            },
            supplemental: {
                noa2021: 66190, 
                ncir: 1.00118 
            }
        };

        const _DATA_MATRIX = [
            {
                id: "3-1",
                title: "3-1: Return on Equity (ROE)",
                description: "Calculate ROE. Use the 2022 and 2021 Merck Equity values to compute the average denominator.",
                inputs: [
                    { id: "ni_merck", label: "Net Income Attrib. to Merck", correct: "MTQ1MTk=" },
                    { id: "eq_22", label: "Merck Equity 2022", correct: "NDU5OTE=" },
                    { id: "eq_21", label: "Merck Equity 2021", correct: "MzgxODQ=" }
                ],
                type: "average_ratio",
                formulaDisplay: "ROE = Net Income / ((Equity'22 + Equity'21) / 2)",
                targetValue: "MzQuNQ==",
                tolerance: 0.5,
                unit: "%",
                resultLabel: "Calculated ROE",
                avgLabel: "Average Merck Equity",
                solutionNote: "Avg Equity = (45,991 + 38,184)/2 = 42,087.5. ROE = 14,519 / 42,087.5 = 34.5%."
            },
            {
                id: "3-2",
                title: "3-2: ROA & Financial Leverage",
                description: "Compute ROA and Financial Leverage (FL) using averages. Then confirm the relationship with ROE.",
                inputs: [
                    { id: "ni_consol", label: "Net Income (Consolidated)", correct: "MTQ1MjY=" },
                    { id: "assets_22", label: "Total Assets 2022", correct: "MTA5MTYw" },
                    { id: "assets_21", label: "Total Assets 2021", correct: "MTA1Njk0" },
                    { id: "eq_tot_22", label: "Total Equity 2022", correct: "NDYwNTg=" },
                    { id: "eq_tot_21", label: "Total Equity 2021", correct: "MzgyNTc=" }
                ],
                type: "multi_average",
                checks: [
                    { id: "roa", label: "Calculated ROA", correctVal: "MTMuNTI=", tolerance: 0.5, unit: "%" },
                    { id: "fl", label: "Calculated Fin. Leverage", correctVal: "Mi41NQ==", tolerance: 0.05, unit: "x" }
                ],
                formulaDisplay: "ROA = NI / Avg Assets | FL = Avg Assets / Avg Tot. Equity",
                hasRelationshipCheck: true,
                relationshipVars: { ncir: 1.00118, roeTarget: 34.5 },
                avgLabel: "Assets & Equity", 
                solutionNote: "Avg Assets = 107,427. Avg Tot Equity = 42,157.5. ROA = 13.52%. FL = 2.55. Check: 13.52% * 2.55 * 1.00118 (NCIR) ≈ 34.5% (ROE)."
            },
            {
                id: "3-3",
                title: "3-3: Disaggregate ROA",
                description: "Disaggregate ROA into Profit Margin (PM) and Asset Turnover (AT).",
                inputs: [
                    { id: "ni", label: "Net Income", correct: "MTQ1MjY=" },
                    { id: "sales", label: "Sales", correct: "NTkyODM=" },
                    { id: "avg_assets", label: "Average Total Assets", correct: "MTA3NDI3" } 
                ],
                type: "disaggregation", 
                checks: [
                    { id: "pm", label: "Calculated PM", correctVal: "MjQuNTA=", tolerance: 0.5, unit: "%" },
                    { id: "at", label: "Calculated AT", correctVal: "MC41NQ==", tolerance: 0.05, unit: "x" }
                ],
                formulaDisplay: "PM = NI / Sales | AT = Sales / Avg Assets",
                solutionNote: "PM = 14,526 / 59,283 = 24.5%. AT = 59,283 / 107,427 = 0.55."
            },
            {
                id: "3-4",
                title: "3-4: Net Operating Assets (NOA)",
                description: "Select Operating Assets and Liabilities for 2022. NOTE: Deferred Income Taxes should be classified as Operating.",
                type: "classification_sum",
                formulaDisplay: "NOA = Operating Assets - Operating Liabilities",
                targetValue: "NjU3MjA=",
                tolerance: 10, 
                unit: "$M",
                resultLabel: "Calculated NOA",
                solutionNote: "Operating Assets (94,953). Operating Liab (29,233) = AP + Accrued + Tax + DefTax + OtherNC(7310). NOA = 94,953 - 29,233 = 65,720."
            },
            {
                id: "3-5",
                title: "3-5: NOPAT",
                description: "Calculate NOPAT. Method 1: Net Income + Net Nonoperating Expense (NNE). Method 2: NOPBT - Tax on Operating Profit. Note: NNE (Net nonoperating expense after tax) = NOPAT – Total net income; or [Nonoperating expenses × (1 – Statutory Tax Rate)].",
                type: "nopat_detailed",
                inputs: [
                    { id: "sales", label: "Sales", correct: "NTkyODM=" },
                    { id: "op_exp", label: "Total Operating Expenses", correct: "NDEzMzg=" },
                    { id: "tax_prov", label: "Provision for Income Tax", correct: "MTkxOA==" },
                    { id: "non_op_exp", label: "Non-Operating Expenses", correct: "MTUwMQ==" },
                    { id: "stat_rate", label: "Statutory Tax Rate (e.g. 22%)", correct: "MjI=", isPct: true },
                    { id: "net_income", label: "Net Income (Consolidated)", correct: "MTQ1MjY=" }
                ],
                checks: [
                    { id: "nopbt", label: "NOPBT", correctVal: "MTc5NDU=", tolerance: 10, unit: "$M" },
                    { id: "tax_op", label: "Tax on Operating Profit", correctVal: "MjI0OC4yMg==", tolerance: 1, unit: "$M" },
                    { id: "nopat_alt", label: "NOPAT (Method 1)", correctVal: "MTU2OTYuNzg=", tolerance: 1, unit: "$M" },
                    { id: "nne", label: "NNE (Net Non-Op Exp)", correctVal: "MTE3MC43OA==", tolerance: 1, unit: "$M" },
                    { id: "nopat", label: "NOPAT (Method 2)", correctVal: "MTU2OTYuNzg=", tolerance: 1, unit: "$M" }
                ],
                formulaDisplay: "Method 1: Net Income + NNE | Method 2: NOPBT - Tax on Ops",
                solutionNote: "Method 1: NNE = 1501 * (1-0.22) = 1170.78. NOPAT = NI (14526) + NNE (1170.78) = 15,696.78. Method 2: NOPBT (17,945) - Tax on Ops (2248.22) = 15,696.78."
            },
            {
                id: "3-6",
                title: "3-6: RNOA vs ROE",
                description: "Calculate RNOA. Then calculate the proportion of ROE from operations vs financial leverage.",
                type: "rnoa_roe_compare",
                inputs: [
                    { id: "nopat", label: "NOPAT (from 3-5)", correct: "MTU2OTc=" },
                    { id: "noa_22", label: "NOA 2022 (from 3-4)", correct: "NjU3MjA=" }, 
                    { id: "noa_21", label: "NOA 2021", correct: "NjYxOTA=" },
                    { id: "roe", label: "ROE (from 3-1)", correct: "MzQuNQ==", isPct: true }
                ],
                checks: [
                    { id: "rnoa", label: "Calculated RNOA", correctVal: "MjMuOA==", tolerance: 0.5, unit: "%" },
                    { id: "non_op_return", label: "Non-Operating Return", correctVal: "MTAuNw==", tolerance: 0.5, unit: "%" },
                    { id: "prop_ops", label: "Prop. from Operations", correctVal: "NjkuMA==", tolerance: 1.0, unit: "%" },
                    { id: "prop_lev", label: "Prop. from Leverage", correctVal: "MzEuMA==", tolerance: 1.0, unit: "%" }
                ],
                formulaDisplay: "RNOA = NOPAT / Avg NOA | Prop Ops = RNOA/ROE | Prop Lev = 1 - Prop Ops",
                solutionNote: "Avg NOA = (65,720 + 66,190)/2 = 65,955. RNOA = 15,697 / 65,955 = 23.8%. Non-Op Return = 34.5% - 23.8% = 10.7%. Prop Ops = 23.8/34.5 = 69%. Prop Lev = 10.7/34.5 = 31%."
            },
            {
                id: "3-7",
                title: "3-7: Disaggregate RNOA",
                description: "Disaggregate RNOA into Net Operating Profit Margin (NOPM) and Net Operating Asset Turnover (NOAT).",
                inputs: [
                    { id: "nopat", label: "NOPAT", correct: "MTU2OTc=" },
                    { id: "sales", label: "Sales", correct: "NTkyODM=" },
                    { id: "avg_noa", label: "Average NOA", correct: "NjU5MDUuNQ==" }
                ],
                type: "disaggregation",
                checks: [
                    { id: "nopm", label: "Calculated NOPM", correctVal: "MjYuNDg=", tolerance: 0.5, unit: "%" },
                    { id: "noat", label: "Calculated NOAT", correctVal: "MC45MA==", tolerance: 0.05, unit: "x" }
                ],
                formulaDisplay: "NOPM = NOPAT / Sales | NOAT = Sales / Avg NOA",
                solutionNote: "NOPM = 26.48%. NOAT = 0.90."
            },
            {
                id: "3-8",
                title: "3-8: Non-Operating Return Analysis",
                description: "Analyze the non-operating return component. Calculate Financial Leverage (FLEV), Net Nonoperating Expense (NNE), Spread, and verify ROE.",
                type: "non_operating_return",
                inputs: [
                    { id: "avg_nno", label: "Average NNO", correct: "MjM3OTcuNQ==" },
                    { id: "avg_equity", label: "Average Total Equity", correct: "NDIxNTcuNQ==" },
                    { id: "non_op_exp", label: "Non-Operating Expenses", correct: "MTUwMQ==" },
                    { id: "stat_rate", label: "Statutory Tax Rate (e.g. 22%)", correct: "MjI=", isPct: true },
                    { id: "rnoa", label: "RNOA (e.g. 23.8%)", correct: "MjMuOA==", isPct: true }
                ],
                checks: [
                    { id: "flev", label: "FLEV (NNO/Equity)", correctVal: "MC41NjQ1", tolerance: 0.01, unit: "x" },
                    { id: "nne", label: "NNE (Net Non-Op Exp)", correctVal: "MTE3MC43OA==", tolerance: 1, unit: "$M" },
                    { id: "nnep", label: "NNEP (NNE/Avg NNO)", correctVal: "NC45Mg==", tolerance: 0.1, unit: "%" },
                    { id: "spread", label: "Spread (RNOA - NNEP)", correctVal: "MTguODg=", tolerance: 0.2, unit: "%" },
                    { id: "roe_check", label: "Check: ROE= RNOA + (FLEV × Spread)", correctVal: "MzQuNQ==", tolerance: 0.5, unit: "%" }
                ],
                formulaDisplay: (
                    <div className="space-y-2 text-xs">
                        <div><strong>NNO</strong>: Net nonoperating obligations (Nonoperating liabilities – Nonoperating assets)</div>
                        <div><strong>FLEV</strong>: Financial leverage (Average NNO / Average total stockholders’ equity)</div>
                        <div><strong>NNE</strong>: Net nonoperating expense after tax (NOPAT – Total net income; or [Nonoperating expenses × (1 – Statutory Tax Rate)])</div>
                        <div><strong>NNEP</strong>: Net nonoperating expense % (NNE / Average NNO)</div>
                        <div><strong>Spread</strong>: Operational Spread (RNOA – NNEP)</div>
                    </div>
                ),
                solutionNote: "NNE = 1501 * (1-0.22) = 1170.78. FLEV = 23,797.5 / 42,157.5 = 0.5645. NNEP = 1,170.78 / 23,797.5 = 4.92%. Spread = 23.8% - 4.92% = 18.88%. Implication: Positive spread means debt is effectively boosting ROE."
            }
        ];

        // --- COMPONENTS ---

        const Icon = ({ name, size = 18, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (!window.lucide) return;
                const iElement = document.createElement('i');
                iElement.setAttribute('data-lucide', name);
                iElement.setAttribute('width', size);
                iElement.setAttribute('height', size);
                if (className) iElement.setAttribute('class', className);
                const tempContainer = document.createElement('div');
                tempContainer.appendChild(iElement);
                window.lucide.createIcons({
                    root: tempContainer,
                    nameAttr: 'data-lucide',
                    attrs: { class: className }
                });
                const svgElement = tempContainer.firstChild;
                if (iconRef.current) {
                    iconRef.current.innerHTML = '';
                    if (svgElement) iconRef.current.appendChild(svgElement);
                }
            }, [name, size, className]);
            return <span ref={iconRef} style={{ display: 'inline-flex', verticalAlign: 'middle' }}></span>;
        };

        const ClickableNumber = ({ value, onClick }) => (
            <span 
                className="cursor-pointer hover:bg-blue-600 hover:text-white px-1 py-0.5 rounded transition-colors border border-transparent hover:border-blue-700 select-none active:bg-blue-700"
                onMouseDown={(e) => { e.preventDefault(); onClick(value); }}
                title="Click to insert into active field"
            >
                {value.toLocaleString()}
            </span>
        );

        const SmartInput = ({ id, value, onChange, correctValueEncoded, isPct = false, teacherMode, onFocus, onBlur }) => {
            const [localValue, setLocalValue] = useState(value || "");
            const [status, setStatus] = useState("neutral");

            const correctValue = d(correctValueEncoded);

            useEffect(() => {
                if (value !== undefined && value !== null) {
                    setLocalValue(value);
                    validate(value);
                } else if (value === "") {
                    setLocalValue("");
                    setStatus("neutral");
                }
            }, [value]);

            const handleChange = (e) => {
                const newVal = e.target.value;
                setLocalValue(newVal);
                // CRITICAL FIX: Propagate changes immediately to parent state 
                // so handleDataClick can see the current typed value
                onChange(newVal); 
            };

            const validate = (val) => {
                if (val === "" || val === undefined || val === null) {
                    setStatus("neutral");
                    return;
                }
                const numVal = parseFloat(val);
                if (isNaN(numVal)) {
                    setStatus("incorrect");
                    return;
                }
                
                const tolerance = 0.02; 
                const isCloseEnough = (input, target) => {
                    if (Math.abs(target) < 0.00001) return Math.abs(input) < 0.001; 
                    const diff = Math.abs(input - target);
                    const percentageDiff = diff / Math.abs(target);
                    return percentageDiff <= tolerance;
                };

                let isCorrect = false;
                if (isCloseEnough(numVal, correctValue)) isCorrect = true;
                if (!isCorrect) {
                      if (isCloseEnough(numVal * 100, correctValue)) isCorrect = true;
                      if (isCloseEnough(numVal / 100, correctValue)) isCorrect = true;
                }
                setStatus(isCorrect ? "correct" : "incorrect");
            };

            const handleBlur = () => {
                if (onBlur) onBlur();
                const evaluated = evaluateMathExpression(localValue);
                if (evaluated !== "" && !isNaN(evaluated)) {
                    const rounded = Math.round(evaluated * 10000) / 10000; 
                    setLocalValue(rounded.toString());
                    onChange(rounded);
                } else {
                    onChange(localValue);
                }
            };

            let borderClass = "border-slate-300 focus:border-blue-500 focus:ring-blue-500";
            let bgClass = "bg-white";
            let icon = null;
            if (status === "correct") {
                borderClass = "border-green-500";
                bgClass = "bg-green-50";
                icon = <div className="absolute right-2 top-2.5 text-green-600 animate-fadeIn"><Icon name="check" size={16} /></div>;
            } else if (status === "incorrect") {
                borderClass = "border-red-500";
                bgClass = "bg-red-50";
            }

            return (
                <div className="relative">
                    <input 
                        type="text"
                        inputMode="decimal" 
                        value={localValue}
                        onChange={handleChange}
                        onBlur={handleBlur}
                        onFocus={onFocus}
                        onKeyDown={(e) => e.key === 'Enter' && e.target.blur()}
                        className={`w-full border rounded-lg py-3 md:py-2 pl-3 pr-8 text-slate-800 outline-none font-mono text-base md:text-sm transition-colors ${borderClass} ${bgClass}`}
                        placeholder="0.00 or calc..."
                    />
                    {icon}
                    {teacherMode && (
                        <div className="mt-1 text-xs font-bold text-purple-700 bg-purple-100 border border-purple-200 px-2 py-0.5 rounded inline-block">
                            Key: {correctValue}{isPct ? '%' : ''}
                        </div>
                    )}
                </div>
            );
        };

        const ConfirmModal = ({ isOpen, onClose, onConfirm, title, message }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 animate-fadeIn">
                    <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6">
                        <h3 className="text-lg font-bold text-slate-800 mb-2">{title}</h3>
                        <p className="text-slate-600 mb-6 text-sm">{message}</p>
                        <div className="flex justify-end gap-3">
                            <button onClick={onClose} className="px-4 py-3 md:py-2 rounded-lg text-slate-600 hover:bg-slate-100 font-medium text-sm">Cancel</button>
                            <button onClick={onConfirm} className="px-4 py-3 md:py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-medium text-sm">Confirm</button>
                        </div>
                    </div>
                </div>
            );
        };

        const InstructorToolbar = ({ onAutoFill, onClearExit }) => {
            return (
                <div className="fixed top-0 left-0 right-0 bg-purple-900 text-white h-14 flex items-center justify-between px-4 md:px-6 shadow-lg z-50 animate-slideDown">
                    <div className="flex items-center gap-2">
                        <div className="bg-purple-700 p-1.5 rounded-lg"><Icon name="shield" size={18} /></div>
                        <span className="font-bold text-xs md:text-sm tracking-wide">SECURE VIEW</span>
                    </div>
                    <div className="flex items-center gap-2 md:gap-3">
                        <button onClick={onAutoFill} className="flex items-center gap-2 px-3 py-1.5 bg-purple-700 hover:bg-purple-600 rounded text-xs font-semibold transition-colors">
                            <Icon name="zap" size={14} /> <span className="hidden md:inline">Auto-Fill</span>
                        </button>
                        <button onClick={onClearExit} className="flex items-center gap-2 px-3 py-1.5 bg-red-600 hover:bg-red-500 rounded text-xs font-semibold transition-colors">
                            <Icon name="log-out" size={14} /> <span className="hidden md:inline">Exit</span>
                        </button>
                    </div>
                </div>
            );
        };

        const Sidebar = ({ isOpen, toggleSidebar, onDataClick, width, setWidth }) => {
            const [expandedSection, setExpandedSection] = useState('assets');
            const isResizing = useRef(false);

            const startResizing = useCallback(() => {
                isResizing.current = true;
                document.body.style.cursor = 'col-resize';
            }, []);

            const stopResizing = useCallback(() => {
                isResizing.current = false;
                document.body.style.cursor = 'default';
            }, []);

            const resize = useCallback((e) => {
                if (!isResizing.current) return;
                const newWidth = e.clientX;
                if (newWidth > 150 && newWidth < 600) {
                    setWidth(newWidth);
                }
            }, [setWidth]);

            useEffect(() => {
                window.addEventListener('mousemove', resize);
                window.addEventListener('mouseup', stopResizing);
                return () => {
                    window.removeEventListener('mousemove', resize);
                    window.removeEventListener('mouseup', stopResizing);
                };
            }, [resize, stopResizing]);

            const mobileClasses = `fixed inset-y-0 left-0 z-40 bg-slate-800 transition-transform transform ${isOpen ? 'translate-x-0' : '-translate-x-full'} w-3/4 max-w-xs shadow-2xl md:hidden`;
            const desktopClasses = `hidden md:flex relative h-full border-r border-slate-700 bg-slate-800 transition-all duration-300 ease-out shrink-0`;
            const desktopStyle = { width: isOpen ? `${width}px` : '48px' };
            const backdrop = isOpen ? <div className="fixed inset-0 bg-black/50 z-30 md:hidden" onClick={toggleSidebar}></div> : null;

            const SidebarContent = () => (
                <div className="flex flex-col w-full h-full text-slate-100 overflow-hidden">
                    <div className="p-4 border-b border-slate-700 flex justify-between items-center whitespace-nowrap h-16">
                        {isOpen && <h2 className="font-bold text-lg text-blue-400">Financial Data</h2>}
                        <button onClick={toggleSidebar} className="p-2 hover:bg-slate-700 rounded text-slate-300">
                            <Icon name={isOpen ? "panel-left-close" : "panel-left-open"} />
                        </button>
                    </div>

                    {isOpen && (
                        <div className="flex-1 overflow-y-auto scrollbar-hide p-4 space-y-6 pb-20">
                            <div>
                                <button onClick={() => setExpandedSection(expandedSection === 'income' ? '' : 'income')} className="flex items-center justify-between w-full font-semibold text-slate-300 mb-2 hover:text-white py-2">
                                    <span>Income Statement (2022)</span>
                                    <Icon name={expandedSection === 'income' ? "chevron-up" : "chevron-down"} size={16} />
                                </button>
                                {expandedSection === 'income' && (
                                    <table className="w-full text-xs text-left text-slate-400">
                                            <tbody>
                                                {FINANCIAL_DATA.incomeStatement.map((row, idx) => (
                                                    <tr key={idx} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                                                        <td className="py-2 pl-1">{row.item}</td>
                                                        <td className="py-2 pr-1 text-right font-mono text-slate-200">
                                                            <ClickableNumber value={row.value} onClick={onDataClick} />
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                    </table>
                                )}
                            </div>
                            <div>
                                <button onClick={() => setExpandedSection(expandedSection === 'assets' ? '' : 'assets')} className="flex items-center justify-between w-full font-semibold text-slate-300 mb-2 hover:text-white py-2">
                                    <span>Balance Sheet: Assets</span>
                                    <Icon name={expandedSection === 'assets' ? "chevron-up" : "chevron-down"} size={16} />
                                </button>
                                {expandedSection === 'assets' && (
                                    <table className="w-full text-xs text-left text-slate-400">
                                            <thead>
                                                <tr className="text-slate-500 border-b border-slate-600">
                                                    <th className="pb-1 font-normal">Item</th>
                                                    <th className="pb-1 text-right font-normal">2022</th>
                                                    <th className="pb-1 text-right font-normal">2021</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {FINANCIAL_DATA.balanceSheet.assets.map((row, idx) => (
                                                    <tr key={idx} className={`border-b border-slate-700/50 hover:bg-slate-700/30 ${row.bold ? 'font-bold text-white bg-slate-700/50' : ''}`}>
                                                        <td className="py-2 pl-1">{row.item}</td>
                                                        <td className="py-2 text-right font-mono text-slate-200">
                                                            <ClickableNumber value={row.value22} onClick={onDataClick} />
                                                        </td>
                                                        <td className="py-2 pr-1 text-right font-mono text-slate-400">
                                                            <ClickableNumber value={row.value21} onClick={onDataClick} />
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                    </table>
                                )}
                            </div>
                            <div>
                                <button onClick={() => setExpandedSection(expandedSection === 'liab' ? '' : 'liab')} className="flex items-center justify-between w-full font-semibold text-slate-300 mb-2 hover:text-white py-2">
                                    <span>Liabilities & Equity</span>
                                    <Icon name={expandedSection === 'liab' ? "chevron-up" : "chevron-down"} size={16} />
                                </button>
                                {expandedSection === 'liab' && (
                                    <table className="w-full text-xs text-left text-slate-400">
                                            <thead>
                                                <tr className="text-slate-500 border-b border-slate-600">
                                                    <th className="pb-1 font-normal">Item</th>
                                                    <th className="pb-1 text-right font-normal">2022</th>
                                                    <th className="pb-1 text-right font-normal">2021</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {FINANCIAL_DATA.balanceSheet.liabilitiesAndEquity.map((row, idx) => (
                                                    <tr key={idx} className={`border-b border-slate-700/50 hover:bg-slate-700/30 ${row.bold ? 'font-bold text-white bg-slate-700/50' : ''} ${row.isDouble ? 'border-t-4 border-double border-slate-600' : ''}`}>
                                                        <td className="py-2 pl-1">{row.item}</td>
                                                        <td className="py-2 text-right font-mono text-slate-200">
                                                            <ClickableNumber value={row.value22} onClick={onDataClick} />
                                                        </td>
                                                        <td className="py-2 pr-1 text-right font-mono text-slate-400">
                                                            <ClickableNumber value={row.value21} onClick={onDataClick} />
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                    </table>
                                )}
                            </div>
                            <div className="bg-slate-700/40 p-3 rounded text-xs border border-slate-600 whitespace-nowrap">
                                <h3 className="font-semibold text-blue-300 mb-2">Supplemental Data</h3>
                                <div className="flex justify-between mb-1 gap-2">
                                    <span>NOA 2021:</span> 
                                    <span className="font-mono text-slate-300"><ClickableNumber value={FINANCIAL_DATA.supplemental.noa2021} onClick={onDataClick} /></span>
                                </div>
                                <div className="flex justify-between mb-1 gap-2">
                                    <span>NCIR (Given):</span> 
                                    <span className="font-mono text-slate-300"><ClickableNumber value={FINANCIAL_DATA.supplemental.ncir} onClick={onDataClick} /></span>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );

            return (
                <>
                    {backdrop}
                    <aside className={mobileClasses}>
                        <SidebarContent />
                    </aside>
                    <div className={desktopClasses} style={desktopStyle}>
                        <SidebarContent />
                        {isOpen && <div className="resizer-handle absolute right-0 top-0 bottom-0" onMouseDown={startResizing}></div>}
                    </div>
                </>
            );
        };

        const Header = ({ teacherMode, onRequestTeacherMode, studentName, setStudentName, onExport, onMobileMenu }) => {
            return (
                <header className="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-4 md:px-6 shadow-sm z-10 sticky top-0">
                    <div className="flex items-center gap-3">
                        <button onClick={onMobileMenu} className="md:hidden text-slate-600 p-1">
                            <Icon name="menu" size={24} />
                        </button>
                        <div className="bg-blue-600 p-2 rounded-lg text-white hidden md:block">
                            <Icon name="bar-chart-2" />
                        </div>
                        <div className="leading-tight">
                            <h1 className="font-bold text-base md:text-lg text-slate-800 truncate max-w-[150px] md:max-w-none">Fin. Analyst Sim.</h1>
                            <p className="text-xs text-slate-500 hidden md:block">Merck & Co. 2022 Case Study</p>
                        </div>
                    </div>
                    <div className="flex items-center gap-2 md:gap-4">
                        <div className="flex items-center gap-2">
                            <span className="text-sm font-medium text-slate-600 hidden md:block">Analyst:</span>
                            <input 
                                type="text" 
                                value={studentName}
                                onChange={(e) => setStudentName(e.target.value)}
                                placeholder="Your Name"
                                className="border border-slate-300 rounded px-2 py-1 text-sm w-28 md:w-48 focus:border-blue-500 outline-none"
                            />
                        </div>
                        <button onClick={onExport} className="flex items-center gap-2 text-sm bg-slate-800 text-white hover:bg-slate-700 font-medium px-3 py-2 rounded-lg transition-colors">
                            <Icon name="download" size={16} /> <span className="hidden md:inline">Submit</span>
                        </button>
                        {!teacherMode && (
                            <button onClick={onRequestTeacherMode} className="opacity-10 hover:opacity-100 transition-opacity p-1">
                                <Icon name="lock" size={14} />
                            </button>
                        )}
                    </div>
                </header>
            );
        };

        const ExerciseCard = ({ exercise, inputs, updateInput, notes, updateNotes, teacherMode, onInputFocus, onInputBlur }) => {
            const [showHint, setShowHint] = useState(false);
            const calculation = useMemo(() => {
                const getVal = (idx) => {
                    const id = exercise.inputs?.[idx]?.id;
                    if (!id) return 0;
                    let val = parseFloat(inputs[id] || 0);
                    const isPctField = exercise.inputs?.[idx]?.isPct;
                    if (isPctField && Math.abs(val) > 1) return val / 100;
                    return val;
                };

                if (exercise.type === "classification_sum") {
                    let opAssets = 0; let opLiabs = 0;
                    FINANCIAL_DATA.balanceSheet.assets.forEach(a => { if (inputs[`asset_${a.item}`]) opAssets += a.value22; });
                    FINANCIAL_DATA.balanceSheet.liabilitiesAndEquity.forEach(l => { if (inputs[`liab_${l.item}`]) opLiabs += l.value22; });
                    return { result: opAssets - opLiabs, opAssets, opLiabs };
                }
                if (exercise.type === "nopat_detailed") {
                    const sales = getVal(0); const opExp = getVal(1); const taxProv = getVal(2);
                    const nonOpExp = getVal(3); const statRate = getVal(4); const netIncome = getVal(5);
                    const nopbt = sales - opExp; const taxShield = nonOpExp * statRate;
                    const taxOp = taxProv + taxShield; const nopat = nopbt - taxOp;
                    const nne = nonOpExp * (1 - statRate); const nopatAlt = netIncome + nne;
                    return { nopbt, taxOp, nopat, nne, nopatAlt };
                }
                if (exercise.type === "rnoa_roe_compare") {
                    const nopat = getVal(0); const noa22 = getVal(1); const noa21 = getVal(2); 
                    const roe = getVal(3);
                    const avgNoa = (noa22 + noa21) / 2; 
                    const rnoa = avgNoa !== 0 ? (nopat / avgNoa) : 0;
                    const nonOpReturn = (roe - rnoa) * 100; 
                    const propOps = roe !== 0 ? (rnoa / roe) * 100 : 0;
                    return { rnoa: rnoa * 100, avgNoa, nonOpReturn, propOps, propLev: 100 - propOps };
                }
                if (exercise.type === "non_operating_return") {
                    const avgNno = getVal(0); const avgEquity = getVal(1); const nonOpExp = getVal(2);
                    const statRate = getVal(3); const rnoaInput = getVal(4);
                    const nne = nonOpExp * (1 - statRate); 
                    const flev = avgEquity !== 0 ? avgNno / avgEquity : 0;
                    const nnep = avgNno !== 0 ? (nne / avgNno) : 0;
                    const spread = (rnoaInput - nnep) * 100; 
                    const roeCheck = (rnoaInput + (flev * (rnoaInput - nnep))) * 100;
                    return { flev, nne, nnep: nnep * 100, spread, roeCheck };
                }
                if (exercise.type === "average_ratio") {
                    const num = getVal(0); const v22 = getVal(1); const v21 = getVal(2);
                    const avg = (v22 + v21) / 2; 
                    const res = avg !== 0 ? (num / avg) : 0;
                    return { result: res * 100, avg };
                }
                if (exercise.type === "multi_average") {
                    const ni = getVal(0); const a22 = getVal(1); const a21 = getVal(2); const e22 = getVal(3); const e21 = getVal(4);
                    const avgAssets = (a22 + a21) / 2; const avgEquity = (e22 + e21) / 2;
                    const roa = avgAssets !== 0 ? (ni / avgAssets) : 0;
                    const fl = avgEquity !== 0 ? (avgAssets / avgEquity) : 0;
                    return { res1: roa * 100, res2: fl, avgAssets, avgEquity };
                }
                if (exercise.type === "disaggregation") {
                    const num = getVal(0); const sales = getVal(1); const denom = getVal(2);
                    const pm = sales !== 0 ? (num / sales) : 0;
                    const at = denom !== 0 ? (sales / denom) : 0;
                    return { res1: pm * 100, res2: at };
                }
                return { result: 0 };
            }, [inputs, exercise]);

            const checkDisplay = (val, correctEnc, tol) => {
                const numVal = Number(val) || 0;
                const correctValue = Number(d(correctEnc)) || 0;
                
                const isCloseEnough = (input, target) => {
                    if (Math.abs(target) < 0.00001) return Math.abs(input) < 0.001; 
                    const diff = Math.abs(input - target);
                    const percentageDiff = diff / Math.abs(target);
                    return percentageDiff <= tol;
                };

                if (isCloseEnough(numVal, correctValue)) return true;
                if (isCloseEnough(numVal * 100, correctValue)) return true;
                if (isCloseEnough(numVal / 100, correctValue)) return true;
                
                return false;
            };

            return (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6">
                    <div className="bg-slate-50 border-b border-slate-200 p-4 flex justify-between items-center">
                        <div className="flex items-center gap-3">
                            <span className="bg-blue-100 text-blue-700 font-bold px-2.5 py-1 rounded text-sm shrink-0">{exercise.id}</span>
                            <h3 className="font-bold text-slate-800 text-sm md:text-base leading-tight">{exercise.title}</h3>
                        </div>
                        <button onClick={() => setShowHint(!showHint)} className="text-slate-400 hover:text-blue-500 p-2"><Icon name="help-circle" size={20} /></button>
                    </div>
                    <div className="p-4 md:p-6">
                        <p className="text-slate-600 mb-6 text-sm">{exercise.description}</p>
                        {showHint && <div className="bg-blue-50 text-blue-800 p-3 rounded-lg mb-6 text-sm font-mono border border-blue-100 animate-fadeIn">{exercise.formulaDisplay}</div>}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div className="space-y-4">
                                <h4 className="text-xs font-semibold text-slate-400 uppercase tracking-wider">Inputs</h4>
                                {exercise.type === "classification_sum" ? (
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                            <div className="border rounded p-3 bg-slate-50/50">
                                                <h5 className="font-bold text-xs text-slate-500 uppercase mb-2">Assets</h5>
                                                <div className="space-y-1 max-h-48 overflow-y-auto pr-1 scrollbar-hide">
                                                    {FINANCIAL_DATA.balanceSheet.assets.map((item, idx) => !item.bold && (
                                                        <label key={idx} className="flex items-center space-x-2 text-xs cursor-pointer hover:bg-slate-100 p-2 rounded active:bg-slate-200">
                                                            <input type="checkbox" checked={!!inputs[`asset_${item.item}`]} onChange={(e) => updateInput(exercise.id, `asset_${item.item}`, e.target.checked)} className="rounded text-blue-600 w-4 h-4" />
                                                            <div className="flex-1 flex justify-between"><span>{item.item}</span><span className="font-mono">{item.value22.toLocaleString()}</span></div>
                                                        </label>
                                                    ))}
                                                </div>
                                            </div>
                                            <div className="border rounded p-3 bg-slate-50/50">
                                                <h5 className="font-bold text-xs text-slate-500 uppercase mb-2">Liabilities</h5>
                                                <div className="space-y-1 max-h-48 overflow-y-auto pr-1 scrollbar-hide">
                                                    {FINANCIAL_DATA.balanceSheet.liabilitiesAndEquity.map((item, idx) => !item.bold && !item.item.includes("Total") && (
                                                        <label key={idx} className="flex items-center space-x-2 text-xs cursor-pointer hover:bg-slate-100 p-2 rounded active:bg-slate-200">
                                                            <input type="checkbox" checked={!!inputs[`liab_${item.item}`]} onChange={(e) => updateInput(exercise.id, `liab_${item.item}`, e.target.checked)} className="rounded text-blue-600 w-4 h-4" />
                                                            <div className="flex-1 flex justify-between"><span>{item.item}</span><span className="font-mono">{item.value22.toLocaleString()}</span></div>
                                                        </label>
                                                    ))}
                                                </div>
                                            </div>
                                    </div>
                                ) : (
                                    exercise.inputs.map((input) => (
                                        <div key={input.id}>
                                            <label className="block text-sm font-medium text-slate-700 mb-1">{input.label}</label>
                                            <SmartInput id={input.id} value={inputs[input.id]} onChange={(val) => updateInput(exercise.id, input.id, val)} correctValueEncoded={input.correct} isPct={input.isPct} teacherMode={teacherMode} onFocus={() => onInputFocus(exercise.id, input.id)} onBlur={onInputBlur} />
                                        </div>
                                    ))
                                )}
                            </div>
                            <div className="space-y-4">
                                <h4 className="text-xs font-semibold text-slate-400 uppercase tracking-wider">Analysis</h4>
                                <div className="bg-slate-50 rounded-lg p-4 border border-slate-200 space-y-3">
                                    {(exercise.type === "rnoa_roe_compare" || exercise.type === "non_operating_return") ? (
                                        <div className="space-y-4">
                                            {exercise.checks.map((check, idx) => {
                                                let val = 0;
                                                if (check.id === "rnoa") val = calculation.rnoa;
                                                else if (check.id === "non_op_return") val = calculation.nonOpReturn;
                                                else if (check.id === "prop_ops") val = calculation.propOps;
                                                else if (check.id === "prop_lev") val = calculation.propLev;
                                                else if (check.id === "flev") val = calculation.flev;
                                                else if (check.id === "nne") val = calculation.nne;
                                                else if (check.id === "nnep") val = calculation.nnep;
                                                else if (check.id === "spread") val = calculation.spread;
                                                else if (check.id === "roe_check") val = calculation.roeCheck;
                                                
                                                const displayVal = Number(val) || 0;
                                                const isCorrect = checkDisplay(displayVal, check.correctVal, check.tolerance);
                                                
                                                return (
                                                    <div key={idx} className="flex flex-col sm:flex-row sm:items-center justify-between gap-1">
                                                        <span className="text-sm font-medium text-slate-600">{check.label}:</span>
                                                        <div className="flex items-center gap-3 self-end sm:self-auto">
                                                            <span className={`font-mono text-lg font-bold ${isCorrect ? 'text-green-600' : 'text-slate-400'}`}>
                                                                {displayVal.toFixed(2)}{check.unit}
                                                            </span>
                                                            {isCorrect ? <Icon name="check-circle" className="text-green-500" /> : <div className="w-5 h-5 rounded-full border-2 border-slate-300"></div>}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    ) : (exercise.type === "multi_average" || exercise.type === "disaggregation") ? (
                                        exercise.checks.map((check, idx) => {
                                            const val = idx === 0 ? (calculation.res1 || 0) : (calculation.res2 || 0);
                                            const isCorrect = checkDisplay(val, check.correctVal, check.tolerance);
                                            return (
                                                <div key={idx} className="flex flex-col sm:flex-row sm:items-center justify-between gap-1">
                                                    <span className="text-sm font-medium text-slate-600">{check.label}:</span>
                                                    <div className="flex items-center gap-3 self-end sm:self-auto">
                                                        <span className={`font-mono text-lg font-bold ${isCorrect ? 'text-green-600' : 'text-slate-400'}`}>
                                                            {Number(val).toFixed(2)}{check.unit}
                                                        </span>
                                                        {isCorrect ? <Icon name="check-circle" className="text-green-500" /> : <div className="w-5 h-5 rounded-full border-2 border-slate-300"></div>}
                                                    </div>
                                                </div>
                                            );
                                        })
                                    ) : exercise.type === "nopat_detailed" ? (
                                        <div className="space-y-2">
                                            <div className="flex justify-between text-xs text-slate-500">
                                                <span>NOPBT:</span>
                                                <span className="font-mono">{(calculation.nopbt || 0).toLocaleString()}</span>
                                            </div>
                                            <div className="flex justify-between text-xs text-slate-500">
                                                <span>Tax on Operations:</span>
                                                <span className="font-mono">{(calculation.taxOp || 0).toFixed(2)}</span>
                                            </div>
                                            <div className="flex justify-between text-xs text-slate-500">
                                                <span>NNE:</span>
                                                <span className="font-mono">{(calculation.nne || 0).toFixed(2)}</span>
                                            </div>
                                            <div className="border-t pt-2 mt-2 flex justify-between font-bold text-blue-700">
                                                <span>NOPAT:</span>
                                                <span className="font-mono">{(calculation.nopat || 0).toFixed(2)}</span>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="flex items-center justify-between">
                                            <span className="text-sm font-medium text-slate-600">{exercise.resultLabel || "Calculated Result"}:</span>
                                            <div className="flex items-center gap-3">
                                                <span className={`font-mono text-xl font-bold ${checkDisplay(calculation.result || 0, exercise.targetValue, exercise.tolerance) ? 'text-green-600' : 'text-slate-400'}`}>
                                                    {(Number(calculation.result) || 0).toFixed(2)}{exercise.unit}
                                                </span>
                                                {checkDisplay(calculation.result || 0, exercise.targetValue, exercise.tolerance) ? <Icon name="check-circle" className="text-green-500" /> : <div className="w-5 h-5 rounded-full border-2 border-slate-300"></div>}
                                            </div>
                                        </div>
                                    )}
                                </div>
                                <textarea className="w-full border border-slate-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none h-20 resize-none" placeholder="Enter findings here..." value={notes} onChange={(e) => updateNotes(exercise.id, e.target.value)}></textarea>
                            </div>
                        </div>
                        {teacherMode && (
                            <div className="mt-6 bg-purple-50 border border-purple-200 rounded-lg p-4 animate-fadeIn">
                                <h5 className="text-purple-800 font-bold text-sm mb-1 flex items-center gap-2"><Icon name="key" size={14}/> Instructor Detail</h5>
                                <p className="text-purple-900 text-sm">{exercise.solutionNote}</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const MultipleChoiceQuestion = ({ id, question, options, correctIndex, explanation, selectedOption, onSelect, teacherMode }) => {
            const isCorrect = selectedOption === correctIndex;
            const hasSelected = selectedOption !== null && selectedOption !== undefined;
            return (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-4">
                    <h4 className="font-bold text-slate-800 mb-4 flex items-start gap-2">
                        <span className="bg-blue-100 text-blue-700 text-xs px-2 py-0.5 rounded-full mt-0.5 shrink-0">Q{id}</span>
                        <span>{question}</span>
                    </h4>
                    <div className="space-y-2">
                        {options.map((opt, idx) => {
                            let itemClass = "border-slate-200 hover:bg-slate-50";
                            let icon = null;
                            if (hasSelected) {
                                if (idx === correctIndex) { itemClass = "border-green-300 bg-green-50 text-green-800"; icon = <Icon name="check-circle" size={18} className="text-green-600" />; }
                                else if (idx === selectedOption) { itemClass = "border-red-300 bg-red-50 text-red-800"; icon = <Icon name="x-circle" size={18} className="text-red-600" />; }
                                else { itemClass = "border-slate-100 text-slate-400 opacity-60"; }
                            }
                            return (
                                <button key={idx} onClick={() => !hasSelected && onSelect(idx)} disabled={hasSelected} className={`w-full text-left p-3 border rounded-lg text-sm transition-all flex justify-between items-center ${itemClass}`}>
                                    <span>{opt}</span>{icon}
                                </button>
                            );
                        })}
                    </div>
                    {hasSelected && (
                        <div className={`mt-4 p-4 rounded-lg text-sm animate-fadeIn ${isCorrect ? 'bg-green-50 text-green-900 border border-green-200' : 'bg-red-50 text-red-900 border border-red-200'}`}>
                            <p className="font-bold mb-1">{isCorrect ? "Insight Confirmed" : "Review Calculation"}</p>
                            <p>{explanation}</p>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            // Default sidebar closed on mobile (but check screen width)
            const [sidebarOpen, setSidebarOpen] = useState(window.innerWidth > 768);
            const [sidebarWidth, setSidebarWidth] = useState(320);
            const [activeTab, setActiveTab] = useState('exercises');
            const [teacherMode, setTeacherMode] = useState(false);
            const [inputs, setInputs] = useState({});
            const [notes, setNotes] = useState({});
            const [studentName, setStudentName] = useState("");
            const [mcqSelections, setMcqSelections] = useState({});
            const [activeInput, setActiveInput] = useState(null);
            const [showLoginModal, setShowLoginModal] = useState(false);
            const [showConfirmClear, setShowConfirmClear] = useState(false);
            const [authCode, setAuthCode] = useState("");

            useEffect(() => {
                // Adjust sidebar state on resize
                const handleResize = () => {
                    if (window.innerWidth > 768 && !sidebarOpen) {
                        setSidebarOpen(true);
                    }
                };
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, [sidebarOpen]);

            const updateInput = (exerciseId, inputId, value) => {
                setInputs(prev => ({ ...prev, [exerciseId]: { ...prev[exerciseId], [inputId]: value } }));
            };
            const updateNotes = (exerciseId, value) => setNotes(prev => ({ ...prev, [exerciseId]: value }));

            const unlockInstructor = () => {
                // Password: "review"
                if (btoa(authCode) === 'cmV2aWV3') {
                    setTeacherMode(true);
                    setShowLoginModal(false);
                    setAuthCode("");
                }
            };

            const autoFill = () => {
                const newInputs = {};
                _DATA_MATRIX.forEach(ex => {
                    newInputs[ex.id] = {};
                    if (ex.type === "classification_sum") {
                        FINANCIAL_DATA.balanceSheet.assets.forEach(a => { if (a.type === 'op') newInputs[ex.id][`asset_${a.item}`] = true; });
                        FINANCIAL_DATA.balanceSheet.liabilitiesAndEquity.forEach(l => { if (l.type === 'op') newInputs[ex.id][`liab_${l.item}`] = true; });
                    } else {
                        ex.inputs.forEach(inp => newInputs[ex.id][inp.id] = d(inp.correct));
                    }
                });
                setInputs(newInputs);
            };

            const clearAndExit = () => {
                setInputs({}); setNotes({}); setMcqSelections({}); setTeacherMode(false); setShowConfirmClear(false);
            };

            const handleDataClick = (val) => {
                if (!activeInput) return;
                const { exerciseId, inputId } = activeInput;
                const currentVal = inputs[exerciseId]?.[inputId] || "";
                
                // Safety check and conversion
                const valStr = val.toString();
                const strVal = currentVal.toString();
                
                // Check if the current value is empty
                if (strVal.trim() === "") {
                    updateInput(exerciseId, inputId, valStr);
                    return;
                }

                // Check for operator or parenthesis at the end of the current string
                // \s* allows for optional spaces
                const isOperatorLast = /[\+\-\*\/\(]\s*$/.test(strVal);

                if (isOperatorLast) {
                    // Append mode: If there is already a space, append directly, otherwise add space
                    const separator = strVal.endsWith(" ") ? "" : " ";
                    updateInput(exerciseId, inputId, strVal + separator + valStr);
                } else {
                    // Replace mode: If user didn't type an operator, assume they want to replace the number
                    updateInput(exerciseId, inputId, valStr);
                }
            };

            const handleExport = () => {
                if (!studentName.trim()) return;
                let content = `Submission: ${studentName}\n----------------\n`;
                _DATA_MATRIX.forEach(ex => {
                    content += `[${ex.id}]\nInputs: ${JSON.stringify(inputs[ex.id] || {})}\nNotes: ${notes[ex.id] || "N/A"}\n\n`;
                });
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `${studentName.replace(/\s+/g, '_')}_analysis.txt`;
                a.click(); URL.revokeObjectURL(url);
            };

            const DISCUSSION_QUESTIONS = [
                { 
                    id: 1, 
                    question: "Merck (23.8%) and Pfizer (32.1%) both exhibit RNOA levels far above the S&P 500 median (~10-12%). What structural characteristic of the Pharma industry best explains this?", 
                    options: ["Low operating margins and high asset turnover.", "High barriers to entry (patents) and strong pricing power.", "Heavy reliance on debt financing."], 
                    correctIndex: 1, 
                    explanation: "Pharmaceutical companies benefit from patent protection and R&D moats, allowing for premium pricing and high returns on operating capital compared to competitive industries." 
                },
                { id: 2, question: "Pfizer generated double Merck's NOPAT with a higher RNOA. Implication?", options: ["Diseconomies of scale.", "Pfizer is leveraging scale or unique product success.", "Scale is irrelevant."], correctIndex: 1, explanation: "Scale and pandemic windfalls likely boosted Pfizer's efficiency above Merck's." }
            ];

            return (
                <div className="flex h-screen bg-slate-100 relative overflow-hidden">
                    {teacherMode && <InstructorToolbar onAutoFill={autoFill} onClearExit={() => setShowConfirmClear(true)} />}
                    {showLoginModal && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 animate-fadeIn">
                            <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 relative">
                                <button onClick={() => setShowLoginModal(false)} className="absolute top-4 right-4 text-slate-400 p-2"><Icon name="x" size={18}/></button>
                                <h3 className="text-lg font-bold text-slate-800 mb-4 uppercase tracking-tighter">System Access</h3>
                                <input type="password" placeholder="Enter Access Code" className="w-full border p-3 rounded mb-4 text-base" value={authCode} onChange={(e) => setAuthCode(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && unlockInstructor()} />
                                <button onClick={unlockInstructor} className="w-full bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700">Validate</button>
                            </div>
                        </div>
                    )}
                    <ConfirmModal isOpen={showConfirmClear} title="Clear Data?" message="This resets all inputs and exits the instructor view." onClose={() => setShowConfirmClear(false)} onConfirm={clearAndExit} />
                    
                    <Sidebar isOpen={sidebarOpen} toggleSidebar={() => setSidebarOpen(!sidebarOpen)} onDataClick={handleDataClick} width={sidebarWidth} setWidth={setSidebarWidth} />
                    
                    <div className={`flex-1 flex flex-col min-w-0 transition-all ${teacherMode ? 'pt-14' : ''}`}>
                        <Header 
                            teacherMode={teacherMode} 
                            onRequestTeacherMode={() => setShowLoginModal(true)} 
                            studentName={studentName} 
                            setStudentName={setStudentName} 
                            onExport={handleExport}
                            onMobileMenu={() => setSidebarOpen(true)}
                        />
                        <main className="flex-1 overflow-y-auto p-4 md:p-8">
                            <div className="max-w-4xl mx-auto pb-10">
                                <div className="bg-gradient-to-r from-blue-900 to-blue-800 rounded-2xl p-6 md:p-8 mb-6 md:mb-8 text-white shadow-lg">
                                    <h1 className="text-2xl md:text-3xl font-bold mb-2">Profitability & Efficiency</h1>
                                    <p className="text-blue-100 text-sm md:text-base">Merck & Co. (2022) Strategic Financial Review</p>
                                </div>
                                <div className="flex space-x-1 mb-6 bg-slate-200 p-1 rounded-lg w-fit">
                                    <button onClick={() => setActiveTab('exercises')} className={`px-4 py-2 rounded-md text-sm font-medium transition-colors ${activeTab === 'exercises' ? 'bg-white text-blue-700 shadow-sm' : 'text-slate-600'}`}>Simulation</button>
                                    <button onClick={() => setActiveTab('summary')} className={`px-4 py-2 rounded-md text-sm font-medium transition-colors ${activeTab === 'summary' ? 'bg-white text-blue-700 shadow-sm' : 'text-slate-600'}`}>Insights</button>
                                </div>
                                {activeTab === 'exercises' ? (
                                    <div className="space-y-6">
                                        {_DATA_MATRIX.map(ex => (
                                            <ExerciseCard key={ex.id} exercise={ex} inputs={inputs[ex.id] || {}} updateInput={updateInput} notes={notes[ex.id] || ""} updateNotes={updateNotes} teacherMode={teacherMode} onInputFocus={(eid, iid) => setActiveInput({ exerciseId: eid, inputId: iid })} onInputBlur={() => setActiveInput(null)} />
                                        ))}
                                    </div>
                                ) : (
                                    <div className="space-y-6 animate-fadeIn">
                                        {DISCUSSION_QUESTIONS.map(q => (
                                            <MultipleChoiceQuestion key={q.id} id={q.id} question={q.question} options={q.options} correctIndex={q.correctIndex} explanation={q.explanation} selectedOption={mcqSelections[q.id]} onSelect={(idx) => setMcqSelections(prev => ({ ...prev, [q.id]: idx }))} teacherMode={teacherMode} />
                                        ))}
                                    </div>
                                )}
                            </div>
                        </main>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
